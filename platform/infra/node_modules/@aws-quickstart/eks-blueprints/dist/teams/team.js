"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PlatformTeam = exports.ApplicationTeam = exports.TeamProps = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const iam = require("aws-cdk-lib/aws-iam");
const csi_driver_provider_aws_secrets_1 = require("../addons/secrets-store/csi-driver-provider-aws-secrets");
const yaml_utils_1 = require("../utils/yaml-utils");
const default_team_roles_1 = require("./default-team-roles");
const utils_1 = require("../utils");
/**
 * Team properties.
 */
class TeamProps {
    constructor() {
        /**
         *  Annotations such as necessary for GitOps engine.
         */
        this.namespaceAnnotations = { "argocd.argoproj.io/sync-wave": "-1" };
        /**
         * Optional, but highly recommended setting to ensure predictable demands.
         */
        this.namespaceHardLimits = {
            'requests.cpu': '10',
            'requests.memory': '10Gi',
            'limits.cpu': '20',
            'limits.memory': '20Gi'
        };
    }
}
exports.TeamProps = TeamProps;
class ApplicationTeam {
    constructor(teamProps) {
        var _a;
        this.name = teamProps.name;
        this.teamProps = {
            name: teamProps.name,
            namespace: (_a = teamProps.namespace) !== null && _a !== void 0 ? _a : "team-" + teamProps.name,
            users: teamProps.users,
            namespaceAnnotations: teamProps.namespaceAnnotations,
            namespaceLabels: teamProps.namespaceLabels,
            namespaceHardLimits: teamProps.namespaceHardLimits,
            serviceAccountName: teamProps.serviceAccountName,
            serviceAccountPolicies: teamProps.serviceAccountPolicies,
            userRoleArn: teamProps.userRoleArn,
            teamSecrets: teamProps.teamSecrets,
            teamManifestDir: teamProps.teamManifestDir
        };
    }
    setup(clusterInfo) {
        this.defaultSetupAccess(clusterInfo);
        this.setupNamespace(clusterInfo);
        this.setupServiceAccount(clusterInfo);
        this.setupSecrets(clusterInfo);
    }
    defaultSetupAccess(clusterInfo) {
        var _a;
        const props = this.teamProps;
        if (!(clusterInfo.cluster instanceof aws_eks_1.Cluster)) {
            utils_1.logger.warn(`Team ${props.name} has cluster access updates that are not supported with imported clusters`);
            return;
        }
        const eksCluster = clusterInfo.cluster;
        const awsAuth = eksCluster.awsAuth;
        const users = (_a = this.teamProps.users) !== null && _a !== void 0 ? _a : [];
        const teamRole = this.getOrCreateRole(clusterInfo, users, props.userRoleArn);
        if (teamRole) {
            awsAuth.addRoleMapping(teamRole, { groups: [props.namespace + "-team-group"], username: props.name });
            new aws_cdk_lib_1.CfnOutput(clusterInfo.cluster.stack, props.name + ' team role ', { value: teamRole ? teamRole.roleArn : "none" });
        }
    }
    /**
     *
     * @param clusterInfo
     */
    defaultSetupAdminAccess(clusterInfo) {
        var _a;
        const props = this.teamProps;
        if (!(clusterInfo.cluster instanceof aws_eks_1.Cluster)) {
            utils_1.logger.warn(`Team ${props.name} has cluster access updates that are not supported with imported clusters`);
            return;
        }
        const admins = (_a = this.teamProps.users) !== null && _a !== void 0 ? _a : [];
        const adminRole = this.getOrCreateRole(clusterInfo, admins, props.userRoleArn);
        new aws_cdk_lib_1.CfnOutput(clusterInfo.cluster.stack, props.name + ' team admin ', { value: adminRole ? adminRole.roleArn : "none" });
        if (adminRole) {
            const eksCluster = clusterInfo.cluster;
            eksCluster.awsAuth.addMastersRole(adminRole, this.teamProps.name);
        }
    }
    /**
     * Creates a new role with trust relationship or adds trust relationship for an existing role.
     * @param clusterInfo
     * @param users
     * @param role may be null if both role and users were not provided
     * @returns
     */
    getOrCreateRole(clusterInfo, users, roleArn) {
        let role = undefined;
        if (roleArn) {
            role = iam.Role.fromRoleArn(clusterInfo.cluster.stack, `${this.name}-team-role`, roleArn);
            users.forEach(user => role === null || role === void 0 ? void 0 : role.grant(user, "sts:assumeRole"));
        }
        else if (users && users.length > 0) {
            role = new iam.Role(clusterInfo.cluster.stack, this.teamProps.namespace + 'AccessRole', {
                assumedBy: new iam.CompositePrincipal(...users)
            });
            role.addToPrincipalPolicy(new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                resources: [clusterInfo.cluster.clusterArn],
                actions: [
                    "eks:DescribeNodegroup",
                    "eks:ListNodegroups",
                    "eks:DescribeCluster",
                    "eks:ListClusters",
                    "eks:AccessKubernetesApi",
                    "ssm:GetParameter",
                    "eks:ListUpdates",
                    "eks:ListFargateProfiles"
                ]
            }));
            role.addToPrincipalPolicy(new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                resources: ["*"],
                actions: [
                    "eks:ListClusters"
                ]
            }));
        }
        return role;
    }
    /**
     * Creates namespace and sets up policies.
     * @param clusterInfo
     */
    setupNamespace(clusterInfo) {
        const props = this.teamProps;
        const namespaceName = props.namespace;
        const teamManifestDir = props.teamManifestDir;
        this.namespaceManifest = new aws_eks_1.KubernetesManifest(clusterInfo.cluster.stack, props.name, {
            cluster: clusterInfo.cluster,
            manifest: [{
                    apiVersion: 'v1',
                    kind: 'Namespace',
                    metadata: {
                        name: namespaceName,
                        annotations: props.namespaceAnnotations,
                        labels: props.namespaceLabels
                    }
                }],
            overwrite: true,
            prune: true
        });
        if (props.namespaceHardLimits) {
            this.setupNamespacePolicies(clusterInfo, namespaceName);
        }
        const defaultRoles = new default_team_roles_1.DefaultTeamRoles().createManifest(namespaceName); //TODO: add support for custom RBAC
        const rbacManifest = new aws_eks_1.KubernetesManifest(clusterInfo.cluster.stack, namespaceName + "-rbac", {
            cluster: clusterInfo.cluster,
            manifest: defaultRoles,
            overwrite: true,
            prune: true
        });
        rbacManifest.node.addDependency(this.namespaceManifest);
        if (teamManifestDir) {
            (0, yaml_utils_1.applyYamlFromDir)(teamManifestDir, clusterInfo.cluster, this.namespaceManifest);
        }
    }
    /**
     * Sets up quotas
     * @param clusterInfo
     * @param namespaceName
     */
    setupNamespacePolicies(clusterInfo, namespaceName) {
        const quotaName = this.teamProps.name + "-quota";
        const quotaManifest = clusterInfo.cluster.addManifest(quotaName, {
            apiVersion: 'v1',
            kind: 'ResourceQuota',
            metadata: {
                name: quotaName,
                namespace: namespaceName
            },
            spec: {
                hard: this.teamProps.namespaceHardLimits
            }
        });
        quotaManifest.node.addDependency(this.namespaceManifest);
    }
    /**
     * Sets up ServiceAccount for the team namespace
     * @param clusterInfo
     */
    setupServiceAccount(clusterInfo) {
        const serviceAccountName = this.teamProps.serviceAccountName ? this.teamProps.serviceAccountName : `${this.teamProps.name}-sa`;
        const cluster = clusterInfo.cluster;
        this.serviceAccount = cluster.addServiceAccount(`${this.teamProps.name}-service-account`, {
            name: serviceAccountName,
            namespace: this.teamProps.namespace
        });
        this.serviceAccount.node.addDependency(this.namespaceManifest);
        if (this.teamProps.serviceAccountPolicies) {
            this.teamProps.serviceAccountPolicies.forEach(policy => this.serviceAccount.role.addManagedPolicy(policy));
        }
        const serviceAccountOutput = new aws_cdk_lib_1.CfnOutput(clusterInfo.cluster.stack, `${this.teamProps.name}-sa`, {
            value: serviceAccountName
        });
        serviceAccountOutput.node.addDependency(this.namespaceManifest);
    }
    /**
     * Sets up secrets
     * @param clusterInfo
     */
    setupSecrets(clusterInfo) {
        if (this.teamProps.teamSecrets) {
            const secretProviderClassName = this.teamProps.name + '-aws-secrets';
            new csi_driver_provider_aws_secrets_1.SecretProviderClass(clusterInfo, this.serviceAccount, secretProviderClassName, ...this.teamProps.teamSecrets);
        }
    }
}
exports.ApplicationTeam = ApplicationTeam;
/**
 * Platform team will setup all team members as admin access to the cluster by adding them to the master group.
 * The setup skips namespace/quota configuration.
 */
class PlatformTeam extends ApplicationTeam {
    constructor(teamProps) {
        super(teamProps);
    }
    /**
     * Override
     * @param clusterInfo
     */
    setup(clusterInfo) {
        this.defaultSetupAdminAccess(clusterInfo);
    }
}
exports.PlatformTeam = PlatformTeam;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi90ZWFtcy90ZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUF3QztBQUN4QyxpREFBa0Y7QUFDbEYsMkNBQTJDO0FBRTNDLDZHQUE4RztBQUU5RyxvREFBdUQ7QUFDdkQsNkRBQXdEO0FBQ3hELG9DQUFrQztBQUVsQzs7R0FFRztBQUNILE1BQWEsU0FBUztJQUF0QjtRQWFJOztXQUVHO1FBQ00seUJBQW9CLEdBQThCLEVBQUUsOEJBQThCLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFPcEc7O1dBRUc7UUFDTSx3QkFBbUIsR0FBWTtZQUNwQyxjQUFjLEVBQUUsSUFBSTtZQUNwQixpQkFBaUIsRUFBRSxNQUFNO1lBQ3pCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLGVBQWUsRUFBRSxNQUFNO1NBQzFCLENBQUM7SUFxQ04sQ0FBQztDQUFBO0FBcEVELDhCQW9FQztBQUVELE1BQWEsZUFBZTtJQVV4QixZQUFZLFNBQW9COztRQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRztZQUNiLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSTtZQUNwQixTQUFTLEVBQUUsTUFBQSxTQUFTLENBQUMsU0FBUyxtQ0FBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLElBQUk7WUFDMUQsS0FBSyxFQUFFLFNBQVMsQ0FBQyxLQUFLO1lBQ3RCLG9CQUFvQixFQUFFLFNBQVMsQ0FBQyxvQkFBb0I7WUFDcEQsZUFBZSxFQUFFLFNBQVMsQ0FBQyxlQUFlO1lBQzFDLG1CQUFtQixFQUFFLFNBQVMsQ0FBQyxtQkFBbUI7WUFDbEQsa0JBQWtCLEVBQUUsU0FBUyxDQUFDLGtCQUFrQjtZQUNoRCxzQkFBc0IsRUFBRSxTQUFTLENBQUMsc0JBQXNCO1lBQ3hELFdBQVcsRUFBRSxTQUFTLENBQUMsV0FBVztZQUNsQyxXQUFXLEVBQUUs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LEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNySDtJQUNMLENBQUM7Q0FDSjtBQTVORCwwQ0E0TkM7QUFFRDs7O0dBR0c7QUFDSCxNQUFhLFlBQWEsU0FBUSxlQUFlO0lBRTdDLFlBQVksU0FBb0I7UUFDNUIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsV0FBd0I7UUFDMUIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzlDLENBQUM7Q0FDSjtBQWJELG9DQWFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2ZuT3V0cHV0IH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQ2x1c3RlciwgS3ViZXJuZXRlc01hbmlmZXN0LCBTZXJ2aWNlQWNjb3VudCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgSVJvbGUgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgQ3NpU2VjcmV0UHJvcHMsIFNlY3JldFByb3ZpZGVyQ2xhc3MgfSBmcm9tICcuLi9hZGRvbnMvc2VjcmV0cy1zdG9yZS9jc2ktZHJpdmVyLXByb3ZpZGVyLWF3cy1zZWNyZXRzJztcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBUZWFtLCBWYWx1ZXMgfSBmcm9tICcuLi9zcGknO1xuaW1wb3J0IHsgYXBwbHlZYW1sRnJvbURpciB9IGZyb20gJy4uL3V0aWxzL3lhbWwtdXRpbHMnO1xuaW1wb3J0IHsgRGVmYXVsdFRlYW1Sb2xlcyB9IGZyb20gJy4vZGVmYXVsdC10ZWFtLXJvbGVzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzJztcblxuLyoqXG4gKiBUZWFtIHByb3BlcnRpZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBUZWFtUHJvcHMge1xuXG4gICAgLyoqXG4gICAgICogUmVxdWlyZWQgdW5pcXVlIG5hbWUgZm9yIG9yZ2FuaXphdGlvbi5cbiAgICAgKiBNYXkgbWFwIHRvIGFuIE9VIG5hbWUuIFxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIERlZmF1bHRzIHRvIHRlYW0gbmFtZSBwcmVmaXhlZCBieSBcInRlYW0tXCJcbiAgICAgKi9cbiAgICByZWFkb25seSBuYW1lc3BhY2U/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiAgQW5ub3RhdGlvbnMgc3VjaCBhcyBuZWNlc3NhcnkgZm9yIEdpdE9wcyBlbmdpbmUuIFxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5hbWVzcGFjZUFubm90YXRpb25zPyA6IHsgW2tleTogc3RyaW5nXTogYW55OyB9ID0geyBcImFyZ29jZC5hcmdvcHJvai5pby9zeW5jLXdhdmVcIjogXCItMVwiIH07XG5cbiAgICAvKipcbiAgICAgKiBMYWJlbHMgc3VjaCBhcyBuZWNlc3NhcnkgZm9yIEFXUyBBcHBNZXNoIFxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5hbWVzcGFjZUxhYmVscz8gOiB7IFtrZXk6IHN0cmluZ106IGFueTsgfTtcblxuICAgIC8qKlxuICAgICAqIE9wdGlvbmFsLCBidXQgaGlnaGx5IHJlY29tbWVuZGVkIHNldHRpbmcgdG8gZW5zdXJlIHByZWRpY3RhYmxlIGRlbWFuZHMuXG4gICAgICovXG4gICAgcmVhZG9ubHkgbmFtZXNwYWNlSGFyZExpbWl0cz86IFZhbHVlcyA9IHtcbiAgICAgICAgJ3JlcXVlc3RzLmNwdSc6ICcxMCcsIC8vIFRPRE8gdmVyaWZ5IHNhbmUgZGVmYXVsdHNcbiAgICAgICAgJ3JlcXVlc3RzLm1lbW9yeSc6ICcxMEdpJyxcbiAgICAgICAgJ2xpbWl0cy5jcHUnOiAnMjAnLFxuICAgICAgICAnbGltaXRzLm1lbW9yeSc6ICcyMEdpJ1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBTZXJ2aWNlIEFjY291bnQgTmFtZVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHNlcnZpY2VBY2NvdW50TmFtZT86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIElmIHNwZWNpZmllZCwgdGhlIElSU0EgYWNjb3VudCB3aWxsIGJlIGNyZWF0ZWQgZm9yIHdpdGggdGhlIElSU0Egcm9sZVxuICAgICAqIGhhdmluZyB0aGUgc3BlY2lmaWVkIG1hbmFnZWQgcG9saWNpZXMuIFxuICAgICAqIFxuICAgICAqIEBleGFtcGxlXG4gICAgICogc2VydmljZUFjY291bnRQb2xpY2llczogW01hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiXCIpXVxuICAgICAqIFxuICAgICAqL1xuICAgIHJlYWRvbmx5IHNlcnZpY2VBY2NvdW50UG9saWNpZXM/OiBpYW0uSU1hbmFnZWRQb2xpY3lbXTtcblxuICAgIC8qKlxuICAgICAqICBUZWFtIG1lbWJlcnMgd2hvIG5lZWQgdG8gZ2V0IGFjY2VzcyB0byB0aGUgY2x1c3RlclxuICAgICAqL1xuICAgIHJlYWRvbmx5IHVzZXJzPzogQXJyYXk8aWFtLkFyblByaW5jaXBhbD47XG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25zIGV4aXN0aW5nIHJvbGUgdGhhdCBzaG91bGQgYmUgdXNlZCBmb3IgY2x1c3RlciBhY2Nlc3MuIFxuICAgICAqIElmIHVzZXJSb2xlIGFuZCB1c2VycyBhcmUgbm90IHByb3ZpZGVkLCB0aGVuIG5vIElBTSBzZXR1cCBpcyBwZXJmb3JtZWQuIFxuICAgICAqL1xuICAgIHJlYWRvbmx5IHVzZXJSb2xlQXJuPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGVhbSBTZWNyZXRzXG4gICAgICovXG4gICAgcmVhZG9ubHkgdGVhbVNlY3JldHM/OiBDc2lTZWNyZXRQcm9wc1tdO1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwsIGRpcmVjdG9yeSB3aGVyZSBhIHRlYW0ncyBtYW5pZmVzdHMgYXJlIHN0b3JlZFxuICAgICAqL1xuICAgICByZWFkb25seSB0ZWFtTWFuaWZlc3REaXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvblRlYW0gaW1wbGVtZW50cyBUZWFtIHtcblxuICAgIHJlYWRvbmx5IHRlYW1Qcm9wczogVGVhbVByb3BzO1xuXG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuXG4gICAgcHVibGljIG5hbWVzcGFjZU1hbmlmZXN0OiBLdWJlcm5ldGVzTWFuaWZlc3Q7XG5cbiAgICBwdWJsaWMgc2VydmljZUFjY291bnQ6IFNlcnZpY2VBY2NvdW50O1xuXG4gICAgY29uc3RydWN0b3IodGVhbVByb3BzOiBUZWFtUHJvcHMpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gdGVhbVByb3BzLm5hbWU7XG4gICAgICAgIHRoaXMudGVhbVByb3BzID0ge1xuICAgICAgICAgICAgbmFtZTogdGVhbVByb3BzLm5hbWUsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRlYW1Qcm9wcy5uYW1lc3BhY2UgPz8gXCJ0ZWFtLVwiICsgdGVhbVByb3BzLm5hbWUsXG4gICAgICAgICAgICB1c2VyczogdGVhbVByb3BzLnVzZXJzLFxuICAgICAgICAgICAgbmFtZXNwYWNlQW5ub3RhdGlvbnM6IHRlYW1Qcm9wcy5uYW1lc3BhY2VBbm5vdGF0aW9ucyxcbiAgICAgICAgICAgIG5hbWVzcGFjZUxhYmVsczogdGVhbVByb3BzLm5hbWVzcGFjZUxhYmVscyxcbiAgICAgICAgICAgIG5hbWVzcGFjZUhhcmRMaW1pdHM6IHRlYW1Qcm9wcy5uYW1lc3BhY2VIYXJkTGltaXRzLFxuICAgICAgICAgICAgc2VydmljZUFjY291bnROYW1lOiB0ZWFtUHJvcHMuc2VydmljZUFjY291bnROYW1lLFxuICAgICAgICAgICAgc2VydmljZUFjY291bnRQb2xpY2llczogdGVhbVByb3BzLnNlcnZpY2VBY2NvdW50UG9saWNpZXMsXG4gICAgICAgICAgICB1c2VyUm9sZUFybjogdGVhbVByb3BzLnVzZXJSb2xlQXJuLFxuICAgICAgICAgICAgdGVhbVNlY3JldHM6IHRlYW1Qcm9wcy50ZWFtU2VjcmV0cyxcbiAgICAgICAgICAgIHRlYW1NYW5pZmVzdERpcjogdGVhbVByb3BzLnRlYW1NYW5pZmVzdERpclxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXR1cChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kZWZhdWx0U2V0dXBBY2Nlc3MoY2x1c3RlckluZm8pO1xuICAgICAgICB0aGlzLnNldHVwTmFtZXNwYWNlKGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgdGhpcy5zZXR1cFNlcnZpY2VBY2NvdW50KGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgdGhpcy5zZXR1cFNlY3JldHMoY2x1c3RlckluZm8pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBkZWZhdWx0U2V0dXBBY2Nlc3MoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKSB7XG4gICAgICAgIGNvbnN0IHByb3BzID0gdGhpcy50ZWFtUHJvcHM7ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmKCEoY2x1c3RlckluZm8uY2x1c3RlciBpbnN0YW5jZW9mIENsdXN0ZXIpKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybihgVGVhbSAke3Byb3BzLm5hbWV9IGhhcyBjbHVzdGVyIGFjY2VzcyB1cGRhdGVzIHRoYXQgYXJlIG5vdCBzdXBwb3J0ZWQgd2l0aCBpbXBvcnRlZCBjbHVzdGVyc2AgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBla3NDbHVzdGVyIDogQ2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGNvbnN0IGF3c0F1dGggPSBla3NDbHVzdGVyLmF3c0F1dGg7XG5cbiAgICAgICAgY29uc3QgdXNlcnMgPSB0aGlzLnRlYW1Qcm9wcy51c2VycyA/PyBbXTtcbiAgICAgICAgY29uc3QgdGVhbVJvbGUgPSB0aGlzLmdldE9yQ3JlYXRlUm9sZShjbHVzdGVySW5mbywgdXNlcnMsIHByb3BzLnVzZXJSb2xlQXJuKTtcblxuICAgICAgICBpZiAodGVhbVJvbGUpIHtcbiAgICAgICAgICAgIGF3c0F1dGguYWRkUm9sZU1hcHBpbmcodGVhbVJvbGUsIHsgZ3JvdXBzOiBbcHJvcHMubmFtZXNwYWNlISArIFwiLXRlYW0tZ3JvdXBcIl0sIHVzZXJuYW1lOiBwcm9wcy5uYW1lIH0pO1xuICAgICAgICAgICAgbmV3IENmbk91dHB1dChjbHVzdGVySW5mby5jbHVzdGVyLnN0YWNrLCBwcm9wcy5uYW1lICsgJyB0ZWFtIHJvbGUgJywgeyB2YWx1ZTogdGVhbVJvbGUgPyB0ZWFtUm9sZS5yb2xlQXJuIDogXCJub25lXCIgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm8gXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGRlZmF1bHRTZXR1cEFkbWluQWNjZXNzKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbykge1xuICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMudGVhbVByb3BzOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZighKGNsdXN0ZXJJbmZvLmNsdXN0ZXIgaW5zdGFuY2VvZiBDbHVzdGVyKSkge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oYFRlYW0gJHtwcm9wcy5uYW1lfSBoYXMgY2x1c3RlciBhY2Nlc3MgdXBkYXRlcyB0aGF0IGFyZSBub3Qgc3VwcG9ydGVkIHdpdGggaW1wb3J0ZWQgY2x1c3RlcnNgICk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWRtaW5zID0gdGhpcy50ZWFtUHJvcHMudXNlcnMgPz8gW107XG4gICAgICAgIGNvbnN0IGFkbWluUm9sZSA9IHRoaXMuZ2V0T3JDcmVhdGVSb2xlKGNsdXN0ZXJJbmZvLCBhZG1pbnMsIHByb3BzLnVzZXJSb2xlQXJuKTtcblxuICAgICAgICBuZXcgQ2ZuT3V0cHV0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2ssIHByb3BzLm5hbWUgKyAnIHRlYW0gYWRtaW4gJywgeyB2YWx1ZTogYWRtaW5Sb2xlID8gYWRtaW5Sb2xlLnJvbGVBcm4gOiBcIm5vbmVcIiB9KTtcblxuICAgICAgICBpZiAoYWRtaW5Sb2xlKSB7XG4gICAgICAgICAgICBjb25zdCBla3NDbHVzdGVyOiBDbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgICAgIGVrc0NsdXN0ZXIuYXdzQXV0aC5hZGRNYXN0ZXJzUm9sZShhZG1pblJvbGUsIHRoaXMudGVhbVByb3BzLm5hbWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIG5ldyByb2xlIHdpdGggdHJ1c3QgcmVsYXRpb25zaGlwIG9yIGFkZHMgdHJ1c3QgcmVsYXRpb25zaGlwIGZvciBhbiBleGlzdGluZyByb2xlLlxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKiBAcGFyYW0gdXNlcnMgXG4gICAgICogQHBhcmFtIHJvbGUgbWF5IGJlIG51bGwgaWYgYm90aCByb2xlIGFuZCB1c2VycyB3ZXJlIG5vdCBwcm92aWRlZFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRPckNyZWF0ZVJvbGUoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCB1c2VyczogQXJyYXk8aWFtLkFyblByaW5jaXBhbD4sIHJvbGVBcm4/OiBzdHJpbmcpOiBpYW0uSVJvbGUgfCB1bmRlZmluZWQge1xuICAgICAgICBsZXQgcm9sZTogSVJvbGUgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICBpZiAocm9sZUFybikge1xuICAgICAgICAgICAgcm9sZSA9IGlhbS5Sb2xlLmZyb21Sb2xlQXJuKGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2ssIGAke3RoaXMubmFtZX0tdGVhbS1yb2xlYCwgcm9sZUFybik7XG4gICAgICAgICAgICB1c2Vycy5mb3JFYWNoKHVzZXIgPT4gcm9sZT8uZ3JhbnQodXNlciwgXCJzdHM6YXNzdW1lUm9sZVwiKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZih1c2VycyAmJiB1c2Vycy5sZW5ndGggPiAwKXtcbiAgICAgICAgICAgIHJvbGUgPSBuZXcgaWFtLlJvbGUoY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjaywgdGhpcy50ZWFtUHJvcHMubmFtZXNwYWNlICsgJ0FjY2Vzc1JvbGUnLCB7XG4gICAgICAgICAgICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLkNvbXBvc2l0ZVByaW5jaXBhbCguLi51c2VycylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcm9sZS5hZGRUb1ByaW5jaXBhbFBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW2NsdXN0ZXJJbmZvLmNsdXN0ZXIuY2x1c3RlckFybl0sXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcImVrczpEZXNjcmliZU5vZGVncm91cFwiLFxuICAgICAgICAgICAgICAgICAgICBcImVrczpMaXN0Tm9kZWdyb3Vwc1wiLFxuICAgICAgICAgICAgICAgICAgICBcImVrczpEZXNjcmliZUNsdXN0ZXJcIixcbiAgICAgICAgICAgICAgICAgICAgXCJla3M6TGlzdENsdXN0ZXJzXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZWtzOkFjY2Vzc0t1YmVybmV0ZXNBcGlcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzc206R2V0UGFyYW1ldGVyXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZWtzOkxpc3RVcGRhdGVzXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZWtzOkxpc3RGYXJnYXRlUHJvZmlsZXNcIlxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJvbGUuYWRkVG9QcmluY2lwYWxQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcImVrczpMaXN0Q2x1c3RlcnNcIlxuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcm9sZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIG5hbWVzcGFjZSBhbmQgc2V0cyB1cCBwb2xpY2llcy5cbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm8gXG4gICAgICovXG4gICAgcHJvdGVjdGVkIHNldHVwTmFtZXNwYWNlKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbykge1xuICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMudGVhbVByb3BzO1xuICAgICAgICBjb25zdCBuYW1lc3BhY2VOYW1lID0gcHJvcHMubmFtZXNwYWNlITtcbiAgICAgICAgY29uc3QgdGVhbU1hbmlmZXN0RGlyID0gcHJvcHMudGVhbU1hbmlmZXN0RGlyO1xuXG4gICAgICAgIHRoaXMubmFtZXNwYWNlTWFuaWZlc3QgPSBuZXcgS3ViZXJuZXRlc01hbmlmZXN0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2ssIHByb3BzLm5hbWUsIHtcbiAgICAgICAgICAgIGNsdXN0ZXI6IGNsdXN0ZXJJbmZvLmNsdXN0ZXIsXG4gICAgICAgICAgICBtYW5pZmVzdDogW3tcbiAgICAgICAgICAgICAgICBhcGlWZXJzaW9uOiAndjEnLFxuICAgICAgICAgICAgICAgIGtpbmQ6ICdOYW1lc3BhY2UnLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWVzcGFjZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiBwcm9wcy5uYW1lc3BhY2VBbm5vdGF0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWxzOiBwcm9wcy5uYW1lc3BhY2VMYWJlbHNcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICAgIG92ZXJ3cml0ZTogdHJ1ZSxcbiAgICAgICAgICAgIHBydW5lOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChwcm9wcy5uYW1lc3BhY2VIYXJkTGltaXRzKSB7XG4gICAgICAgICAgICB0aGlzLnNldHVwTmFtZXNwYWNlUG9saWNpZXMoY2x1c3RlckluZm8sIG5hbWVzcGFjZU5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdFJvbGVzID0gbmV3IERlZmF1bHRUZWFtUm9sZXMoKS5jcmVhdGVNYW5pZmVzdChuYW1lc3BhY2VOYW1lKTsgLy9UT0RPOiBhZGQgc3VwcG9ydCBmb3IgY3VzdG9tIFJCQUNcblxuICAgICAgICBjb25zdCByYmFjTWFuaWZlc3QgPSBuZXcgS3ViZXJuZXRlc01hbmlmZXN0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2ssIG5hbWVzcGFjZU5hbWUgKyBcIi1yYmFjXCIsIHtcbiAgICAgICAgICAgIGNsdXN0ZXI6IGNsdXN0ZXJJbmZvLmNsdXN0ZXIsXG4gICAgICAgICAgICBtYW5pZmVzdDogZGVmYXVsdFJvbGVzLFxuICAgICAgICAgICAgb3ZlcndyaXRlOiB0cnVlLFxuICAgICAgICAgICAgcHJ1bmU6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmJhY01hbmlmZXN0Lm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzLm5hbWVzcGFjZU1hbmlmZXN0KTtcblxuICAgICAgICBpZiAodGVhbU1hbmlmZXN0RGlyKXtcbiAgICAgICAgICAgIGFwcGx5WWFtbEZyb21EaXIodGVhbU1hbmlmZXN0RGlyLCBjbHVzdGVySW5mby5jbHVzdGVyLCB0aGlzLm5hbWVzcGFjZU1hbmlmZXN0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldHMgdXAgcXVvdGFzXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvIFxuICAgICAqIEBwYXJhbSBuYW1lc3BhY2VOYW1lIFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBzZXR1cE5hbWVzcGFjZVBvbGljaWVzKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgbmFtZXNwYWNlTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHF1b3RhTmFtZSA9IHRoaXMudGVhbVByb3BzLm5hbWUgKyBcIi1xdW90YVwiO1xuICAgICAgICBjb25zdCBxdW90YU1hbmlmZXN0ID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRNYW5pZmVzdChxdW90YU5hbWUsIHtcbiAgICAgICAgICAgIGFwaVZlcnNpb246ICd2MScsXG4gICAgICAgICAgICBraW5kOiAnUmVzb3VyY2VRdW90YScsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICAgIG5hbWU6IHF1b3RhTmFtZSxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZU5hbWVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgaGFyZDogdGhpcy50ZWFtUHJvcHMubmFtZXNwYWNlSGFyZExpbWl0c1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcXVvdGFNYW5pZmVzdC5ub2RlLmFkZERlcGVuZGVuY3kodGhpcy5uYW1lc3BhY2VNYW5pZmVzdCk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFNldHMgdXAgU2VydmljZUFjY291bnQgZm9yIHRoZSB0ZWFtIG5hbWVzcGFjZVxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgc2V0dXBTZXJ2aWNlQWNjb3VudChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pIHtcbiAgICAgICAgY29uc3Qgc2VydmljZUFjY291bnROYW1lID0gdGhpcy50ZWFtUHJvcHMuc2VydmljZUFjY291bnROYW1lPyB0aGlzLnRlYW1Qcm9wcy5zZXJ2aWNlQWNjb3VudE5hbWUgOiBgJHt0aGlzLnRlYW1Qcm9wcy5uYW1lfS1zYWA7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5zZXJ2aWNlQWNjb3VudCA9IGNsdXN0ZXIuYWRkU2VydmljZUFjY291bnQoYCR7dGhpcy50ZWFtUHJvcHMubmFtZX0tc2VydmljZS1hY2NvdW50YCwge1xuICAgICAgICAgICAgbmFtZTogc2VydmljZUFjY291bnROYW1lLFxuICAgICAgICAgICAgbmFtZXNwYWNlOiB0aGlzLnRlYW1Qcm9wcy5uYW1lc3BhY2VcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2VydmljZUFjY291bnQubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMubmFtZXNwYWNlTWFuaWZlc3QpO1xuXG4gICAgICAgIGlmKHRoaXMudGVhbVByb3BzLnNlcnZpY2VBY2NvdW50UG9saWNpZXMpIHtcbiAgICAgICAgICAgIHRoaXMudGVhbVByb3BzLnNlcnZpY2VBY2NvdW50UG9saWNpZXMuZm9yRWFjaChwb2xpY3kgPT4gdGhpcy5zZXJ2aWNlQWNjb3VudC5yb2xlLmFkZE1hbmFnZWRQb2xpY3kocG9saWN5KSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXJ2aWNlQWNjb3VudE91dHB1dCA9IG5ldyBDZm5PdXRwdXQoY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjaywgYCR7dGhpcy50ZWFtUHJvcHMubmFtZX0tc2FgLCB7XG4gICAgICAgICAgICB2YWx1ZTogc2VydmljZUFjY291bnROYW1lXG4gICAgICAgIH0pO1xuICAgICAgICBzZXJ2aWNlQWNjb3VudE91dHB1dC5ub2RlLmFkZERlcGVuZGVuY3kodGhpcy5uYW1lc3BhY2VNYW5pZmVzdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyB1cCBzZWNyZXRzXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvXG4gICAgICovXG4gICAgcHJvdGVjdGVkIHNldHVwU2VjcmV0cyhjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pIHtcbiAgICAgICAgaWYgKHRoaXMudGVhbVByb3BzLnRlYW1TZWNyZXRzKSB7XG4gICAgICAgICAgICBjb25zdCBzZWNyZXRQcm92aWRlckNsYXNzTmFtZSA9IHRoaXMudGVhbVByb3BzLm5hbWUgKyAnLWF3cy1zZWNyZXRzJztcbiAgICAgICAgICAgIG5ldyBTZWNyZXRQcm92aWRlckNsYXNzKGNsdXN0ZXJJbmZvLCB0aGlzLnNlcnZpY2VBY2NvdW50LCBzZWNyZXRQcm92aWRlckNsYXNzTmFtZSwgLi4udGhpcy50ZWFtUHJvcHMudGVhbVNlY3JldHMpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIFBsYXRmb3JtIHRlYW0gd2lsbCBzZXR1cCBhbGwgdGVhbSBtZW1iZXJzIGFzIGFkbWluIGFjY2VzcyB0byB0aGUgY2x1c3RlciBieSBhZGRpbmcgdGhlbSB0byB0aGUgbWFzdGVyIGdyb3VwLlxuICogVGhlIHNldHVwIHNraXBzIG5hbWVzcGFjZS9xdW90YSBjb25maWd1cmF0aW9uLlxuICovXG5leHBvcnQgY2xhc3MgUGxhdGZvcm1UZWFtIGV4dGVuZHMgQXBwbGljYXRpb25UZWFtIHtcblxuICAgIGNvbnN0cnVjdG9yKHRlYW1Qcm9wczogVGVhbVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHRlYW1Qcm9wcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGVcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm9cbiAgICAgKi9cbiAgICBzZXR1cChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kZWZhdWx0U2V0dXBBZG1pbkFjY2VzcyhjbHVzdGVySW5mbyk7XG4gICAgfVxufSJdfQ==