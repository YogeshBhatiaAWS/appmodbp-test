"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BatchEksTeam = void 0;
const cluster_providers_1 = require("../../cluster-providers");
const team_1 = require("../team");
const kubectl_provider_1 = require("../../addons/helm-addon/kubectl-provider");
const yaml_utils_1 = require("../../utils/yaml-utils");
const batch = require("aws-cdk-lib/aws-batch");
const iam = require("aws-cdk-lib/aws-iam");
const assert = require("assert");
const NAMESPACE = 'aws-batch';
const defaultProps = {
    name: NAMESPACE,
    namespace: NAMESPACE,
};
/*
 *This class define the Team that can be used with AWS Batch on EKS
 */
class BatchEksTeam extends team_1.ApplicationTeam {
    /**
     * @public
     * @param {BatchEksTeamProps} props the Batch team definition {@link BatchEksTeamProps}
     */
    constructor(props) {
        const teamProps = { ...defaultProps, ...props };
        super(teamProps);
        this.batchTeamProps = teamProps;
    }
    setup(clusterInfo) {
        const computeResources = this.batchTeamProps.computeResources;
        const priority = computeResources.priority;
        assert(computeResources.minvCpus < computeResources.maxvCpus, 'Max vCPU must be greater than Min vCPU');
        assert((priority >= 0) && (priority % 1 == 0), 'Priority must be a whole number.');
        const awsBatchAddOn = clusterInfo.getProvisionedAddOn('AwsBatchAddOn');
        if (awsBatchAddOn === undefined) {
            throw new Error("AwsBatchAddOn must be deployed before creating AWS Batch on EKS team.");
        }
        // Set AWS Batch namespace and necessary RBACs
        const statement = this.setBatchEksResources(clusterInfo, this.batchTeamProps.namespace);
        // Create compute environment
        const computeEnv = this.setComputeEnvironment(clusterInfo, this.batchTeamProps.namespace, computeResources);
        computeEnv.node.addDependency(awsBatchAddOn);
        computeEnv.node.addDependency(statement);
        // Create a job queue
        const jobQueue = new batch.CfnJobQueue(clusterInfo.cluster.stack, 'batch-eks-job-queue', {
            jobQueueName: this.batchTeamProps.jobQueueName,
            priority: priority,
            computeEnvironmentOrder: [
                {
                    order: 1,
                    computeEnvironment: computeEnv.attrComputeEnvironmentArn
                }
            ]
        });
        jobQueue.node.addDependency(computeEnv);
    }
    /**
     * method to to apply k8s RBAC to the service account used by Batch service role
     * @param ClusterInfo EKS cluster where to apply the RBAC
     * @param namespace Namespace where the RBAC are applied
     * @param createNamespace flag to create namespace if not already created
     * @returns
     */
    setBatchEksResources(clusterInfo, namespace) {
        let doc = (0, yaml_utils_1.readYamlDocument)(`${__dirname}/aws-batch-rbac-config.ytpl`);
        //Get the RBAC definition and replace with the namespace provided by the user
        const manifest = doc.split("---").map(e => (0, yaml_utils_1.loadYaml)(e));
        const values = {
            namespace: namespace
        };
        const manifestDeployment = {
            name: 'aws-batch-rbacs',
            namespace: namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        return statement;
    }
    setComputeEnvironment(clusterInfo, namespace, computeResources) {
        const nodeGroups = (0, cluster_providers_1.assertEC2NodeGroup)(clusterInfo, "Batch Compute Environment");
        const ngRoleNames = nodeGroups.map((ng) => { return ng.role.roleName; });
        const cluster = clusterInfo.cluster;
        const ngRole = ngRoleNames[0];
        // Need to create instance profile for the nodegroup role
        const instanceProfile = new iam.CfnInstanceProfile(cluster, 'ng-role-instance-profile', {
            instanceProfileName: ngRole,
            roles: [ngRole]
        });
        const batchComputeEnv = new batch.CfnComputeEnvironment(cluster, "batch-eks-compute-environment", {
            type: 'MANAGED',
            computeEnvironmentName: this.batchTeamProps.envName,
            state: 'ENABLED',
            eksConfiguration: {
                eksClusterArn: cluster.clusterArn,
                kubernetesNamespace: namespace,
            },
            computeResources: {
                type: computeResources.envType,
                allocationStrategy: computeResources.allocationStrategy,
                minvCpus: computeResources.minvCpus,
                maxvCpus: computeResources.maxvCpus,
                instanceTypes: computeResources.instanceTypes,
                subnets: cluster.vpc.publicSubnets.map((e) => { return e.subnetId; }),
                securityGroupIds: [cluster.clusterSecurityGroupId],
                instanceRole: ngRole,
            }
        });
        batchComputeEnv.node.addDependency(instanceProfile);
        return batchComputeEnv;
    }
}
exports.BatchEksTeam = BatchEksTeam;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLWJhdGNoLW9uLWVrcy10ZWFtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL3RlYW1zL2F3cy1iYXRjaC9hd3MtYmF0Y2gtb24tZWtzLXRlYW0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0RBQTZEO0FBRTdELGtDQUFxRDtBQUNyRCwrRUFBK0Y7QUFDL0YsdURBQW9FO0FBR3BFLCtDQUErQztBQUkvQywyQ0FBMkM7QUFFM0MsaUNBQWlDO0FBRWpDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztBQTBFOUIsTUFBTSxZQUFZLEdBQWM7SUFDOUIsSUFBSSxFQUFFLFNBQVM7SUFDZixTQUFTLEVBQUUsU0FBUztDQUNyQixDQUFDO0FBRUY7O0dBRUc7QUFFSCxNQUFhLFlBQWEsU0FBUSxzQkFBZTtJQUcvQzs7O09BR0c7SUFDSCxZQUFZLEtBQXdCO1FBQ2xDLE1BQU0sU0FBUyxHQUFHLEVBQUUsR0FBRyxZQUFZLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQztRQUNoRCxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUM7SUFDbEMsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUF3QjtRQUM1QixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUM7UUFDOUQsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsUUFBUSxDQUFDO1FBQzNDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLHdDQUF3QyxDQUFDLENBQUM7UUFDeEcsTUFBTSxDQUFDLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxrQ0FBa0MsQ0FBQyxDQUFDO1FBRW5GLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxl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LE9BQU8sRUFBRSwrQkFBK0IsRUFBRTtZQUNoRyxJQUFJLEVBQUUsU0FBUztZQUNmLHNCQUFzQixFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTztZQUNuRCxLQUFLLEVBQUUsU0FBUztZQUNoQixnQkFBZ0IsRUFBRTtnQkFDaEIsYUFBYSxFQUFFLE9BQU8sQ0FBQyxVQUFVO2dCQUNqQyxtQkFBbUIsRUFBRSxTQUFTO2FBQy9CO1lBQ0QsZ0JBQWdCLEVBQUU7Z0JBQ2hCLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPO2dCQUM5QixrQkFBa0IsRUFBRSxnQkFBZ0IsQ0FBQyxrQkFBa0I7Z0JBQ3ZELFFBQVEsRUFBRSxnQkFBZ0IsQ0FBQyxRQUFRO2dCQUNuQyxRQUFRLEVBQUUsZ0JBQWdCLENBQUMsUUFBUTtnQkFDbkMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLGFBQWE7Z0JBQzdDLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFjLEVBQUUsRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEYsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUM7Z0JBQ2xELFlBQVksRUFBRSxNQUFNO2FBQ3JCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsZUFBZSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDcEQsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBekhELG9DQXlIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydEVDMk5vZGVHcm91cCB9IGZyb20gXCIuLi8uLi9jbHVzdGVyLXByb3ZpZGVyc1wiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gXCIuLi8uLi9zcGlcIjtcbmltcG9ydCB7IEFwcGxpY2F0aW9uVGVhbSwgVGVhbVByb3BzIH0gZnJvbSBcIi4uL3RlYW1cIjtcbmltcG9ydCB7IEt1YmVjdGxQcm92aWRlciwgTWFuaWZlc3REZXBsb3ltZW50IH0gZnJvbSBcIi4uLy4uL2FkZG9ucy9oZWxtLWFkZG9uL2t1YmVjdGwtcHJvdmlkZXJcIjtcbmltcG9ydCB7IGxvYWRZYW1sLCByZWFkWWFtbERvY3VtZW50IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3lhbWwtdXRpbHNcIjtcblxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBiYXRjaCBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYmF0Y2gnO1xuaW1wb3J0ICogYXMgZWtzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0IHsgQXV0b1NjYWxpbmdHcm91cCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXV0b3NjYWxpbmdcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuXG5pbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSBcImFzc2VydFwiO1xuXG5jb25zdCBOQU1FU1BBQ0UgPSAnYXdzLWJhdGNoJztcblxuLyoqXG4gKiBFbnVtIGZvciBBbGxvY2F0aW9uIFN0cmF0ZWd5OlxuICogQmVzdCAtIEJlc3QgRml0IFByb2dyZXNzaXZlOiBBV1MgQmF0Y2ggc2VsZWN0cyBhZGRpdGlvbmFsIGluc3RhbmNlIHR5cGVzIHRoYXQgYXJlIGxhcmdlIGVub3VnaCB0byBtZWV0IHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIGpvYnMuIFxuICogSW5zdGFuY2UgdHlwZXMgd2l0aCBhIGxvd2VyIGNvc3QgZm9yIGVhY2ggdW5pdCB2Q1BVIGFyZSBwcmVmZXJyZWQuXG4gKiBTcG90IC0gU3BvdCBDYXBhY2l0eSBPcHRpbWl6ZWQ6IEFXUyBCYXRjaCBzZWxlY3RzIG9uZSBvciBtb3JlIGluc3RhbmNlIHR5cGVzIHRoYXQgYXJlIGxhcmdlIGVub3VnaCB0byBtZWV0IHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIGpvYnMgaW4gdGhlIHF1ZXVlLiBcbiAqIEluc3RhbmNlIHR5cGVzIHRoYXQgYXJlIGxlc3MgbGlrZWx5IHRvIGJlIGludGVycnVwdGVkIGFyZSBwcmVmZXJyZWQuIFRoaXMgYWxsb2NhdGlvbiBzdHJhdGVneSBpcyBvbmx5IGF2YWlsYWJsZSBmb3IgU3BvdCBJbnN0YW5jZSBjb21wdXRlIHJlc291cmNlcy5cbiAqL1xuZXhwb3J0IGNvbnN0IGVudW0gQmF0Y2hBbGxvY2F0aW9uU3RyYXRlZ3kge1xuICBCRVNUID0gJ0JFU1RfRklUX1BST0dSRVNTSVZFJyxcbiAgU1BPVCA9ICdTUE9UX0NBUEFDSVRZX09QVElNSVpFRCdcbn1cblxuLyoqXG4gKiBFbnVtIGZvciBCYXRjaCBDb21wdXRlIEVudmlyb25tZW50IFR5cGVcbiAqL1xuZXhwb3J0IGNvbnN0IGVudW0gQmF0Y2hFbnZUeXBlIHtcbiAgRUMyID0gJ0VDMicsXG4gIFNQT1QgPSAnU1BPVCcsXG4gIEZBUkdBVEUgPSAnRkFSR0FURScsXG4gIEZBUkdBVEVfU1BPVCA9ICdGQVJHQVRFX1NQT1QnXG59XG5cbi8qKlxuICogSW50ZXJmYWNlIHRvIGRlZmluZSBhbiBBV1MgQmF0Y2ggb24gRUtTIHRlYW1cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCYXRjaEVrc1RlYW1Qcm9wcyBleHRlbmRzIFRlYW1Qcm9wcyB7XG4gIC8qKlxuICAgKiBDb21wdXRlIEVudmlyb25tZW50IG5hbWVcbiAgICovXG4gIGVudk5hbWU6IHN0cmluZ1xuXG4gIC8qKlxuICAgKiBDb21wdXRlIEVudmlyb25tZW50IGNvbXB1dGUgcmVzb3VyY2VzXG4gICAqL1xuICBjb21wdXRlUmVzb3VyY2VzOiB7XG4gICAgLyoqXG4gICAgICogQ29tcHV0ZSBFbnZpcm9ubWVudCByZXNvdXJjZXMgVHlwZSAtIHNlZSBlbnVtIEJhdGNoRW52VHlwZSBmb3Igb3B0aW9uc1xuICAgICAqL1xuICAgIGVudlR5cGU6IEJhdGNoRW52VHlwZVxuXG4gICAgLyoqXG4gICAgICogQWxsb2NhdGlvbiBzdHJhdGVnaWVzIGZvciBFS1MgQ29tcHV0ZSBlbnZpcm9ubWVudCAtIHNlZSBlbnVtIEFsbG9jYXRpb24gZm9yIG9wdGlvbnMuXG4gICAgICovXG4gICAgYWxsb2NhdGlvblN0cmF0ZWd5OiBCYXRjaEFsbG9jYXRpb25TdHJhdGVneVxuXG4gICAgLyoqXG4gICAgICogUHJpb3JpdHkgb2YgdGhlIGpvYiBxdWV1ZSAtIHByaW9yaXR5IGlzIHNldCBpbiBkZXNjZW5kaW5nIG9yZGVyXG4gICAgICovXG4gICAgcHJpb3JpdHk6IG51bWJlclxuXG4gICAgLyoqXG4gICAgICogVGhlIG1pbmltdW0gbnVtYmVyIG9mIEFtYXpvbiBFQzIgdkNQVXMgdGhhdCBhbiBlbnZpcm9ubWVudCBzaG91bGQgbWFpbnRhaW4uXG4gICAgICovXG4gICAgbWludkNwdXM6IG51bWJlclxuXG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIEFtYXpvbiBFQzIgdkNQVXMgdGhhdCBhbiBlbnZpcm9ubWVudCBjYW4gcmVhY2guXG4gICAgICovXG4gICAgbWF4dkNwdXM6IG51bWJlcixcblxuICAgIC8qKlxuICAgICAqIExpc3Qgb2YgaW5zdGFuY2UgdHlwZXMgLSBjYW4gYmUgYSBsaXN0IHRoYXQgY29udGFpbnMgSW5zdGFuY2UgVHlwZSBmYW1pbHkgKGkuZS4gXCJtNVwiKSBvciBhIHNwZWNpZmljIFR5cGUgKGkuZS4gXCJtNS40eGxhcmdlXCIpXG4gICAgICovXG4gICAgaW5zdGFuY2VUeXBlczogc3RyaW5nW10sXG4gIH1cblxuICAvKipcbiAgICogTmFtZSBvZiB0aGUgSm9iIFF1ZXVlXG4gICAqL1xuICBqb2JRdWV1ZU5hbWU6IHN0cmluZ1xufVxuXG5jb25zdCBkZWZhdWx0UHJvcHM6IFRlYW1Qcm9wcyA9IHtcbiAgbmFtZTogTkFNRVNQQUNFLFxuICBuYW1lc3BhY2U6IE5BTUVTUEFDRSxcbn07XG5cbi8qXG4gKlRoaXMgY2xhc3MgZGVmaW5lIHRoZSBUZWFtIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBBV1MgQmF0Y2ggb24gRUtTXG4gKi9cblxuZXhwb3J0IGNsYXNzIEJhdGNoRWtzVGVhbSBleHRlbmRzIEFwcGxpY2F0aW9uVGVhbSB7XG5cbiAgcmVhZG9ubHkgYmF0Y2hUZWFtUHJvcHM6IEJhdGNoRWtzVGVhbVByb3BzO1xuICAvKipcbiAgICogQHB1YmxpY1xuICAgKiBAcGFyYW0ge0JhdGNoRWtzVGVhbVByb3BzfSBwcm9wcyB0aGUgQmF0Y2ggdGVhbSBkZWZpbml0aW9uIHtAbGluayBCYXRjaEVrc1RlYW1Qcm9wc31cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBCYXRjaEVrc1RlYW1Qcm9wcykge1xuICAgIGNvbnN0IHRlYW1Qcm9wcyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9O1xuICAgIHN1cGVyKHRlYW1Qcm9wcyk7XG4gICAgdGhpcy5iYXRjaFRlYW1Qcm9wcyA9IHRlYW1Qcm9wcztcbiAgfVxuXG4gIHNldHVwKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IHZvaWQge1xuICAgIGNvbnN0IGNvbXB1dGVSZXNvdXJjZXMgPSB0aGlzLmJhdGNoVGVhbVByb3BzLmNvbXB1dGVSZXNvdXJjZXM7XG4gICAgY29uc3QgcHJpb3JpdHkgPSBjb21wdXRlUmVzb3VyY2VzLnByaW9yaXR5O1xuICAgIGFzc2VydChjb21wdXRlUmVzb3VyY2VzLm1pbnZDcHVzIDwgY29tcHV0ZVJlc291cmNlcy5tYXh2Q3B1cywgJ01heCB2Q1BVIG11c3QgYmUgZ3JlYXRlciB0aGFuIE1pbiB2Q1BVJyk7XG4gICAgYXNzZXJ0KChwcmlvcml0eSA+PSAwKSAmJiAocHJpb3JpdHkgJSAxID09IDApLCAnUHJpb3JpdHkgbXVzdCBiZSBhIHdob2xlIG51bWJlci4nKTtcblxuICAgIGNvbnN0IGF3c0JhdGNoQWRkT24gPSBjbHVzdGVySW5mby5nZXRQcm92aXNpb25lZEFkZE9uKCdBd3NCYXRjaEFkZE9uJyk7XG5cbiAgICBpZiAoYXdzQmF0Y2hBZGRPbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBd3NCYXRjaEFkZE9uIG11c3QgYmUgZGVwbG95ZWQgYmVmb3JlIGNyZWF0aW5nIEFXUyBCYXRjaCBvbiBFS1MgdGVhbS5cIik7XG4gICAgfVxuXG4gICAgLy8gU2V0IEFXUyBCYXRjaCBuYW1lc3BhY2UgYW5kIG5lY2Vzc2FyeSBSQkFDc1xuICAgIGNvbnN0IHN0YXRlbWVudCA9IHRoaXMuc2V0QmF0Y2hFa3NSZXNvdXJjZXMoY2x1c3RlckluZm8sIHRoaXMuYmF0Y2hUZWFtUHJvcHMubmFtZXNwYWNlISk7XG5cbiAgICAvLyBDcmVhdGUgY29tcHV0ZSBlbnZpcm9ubWVudFxuICAgIGNvbnN0IGNvbXB1dGVFbnYgPSB0aGlzLnNldENvbXB1dGVFbnZpcm9ubWVudChjbHVzdGVySW5mbywgdGhpcy5iYXRjaFRlYW1Qcm9wcy5uYW1lc3BhY2UhLCBjb21wdXRlUmVzb3VyY2VzKTtcbiAgICBjb21wdXRlRW52Lm5vZGUuYWRkRGVwZW5kZW5jeShhd3NCYXRjaEFkZE9uKTtcbiAgICBjb21wdXRlRW52Lm5vZGUuYWRkRGVwZW5kZW5jeShzdGF0ZW1lbnQpO1xuXG4gICAgLy8gQ3JlYXRlIGEgam9iIHF1ZXVlXG4gICAgY29uc3Qgam9iUXVldWUgPSBuZXcgYmF0Y2guQ2ZuSm9iUXVldWUoY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjaywgJ2JhdGNoLWVrcy1qb2ItcXVldWUnLCB7XG4gICAgICBqb2JRdWV1ZU5hbWU6IHRoaXMuYmF0Y2hUZWFtUHJvcHMuam9iUXVldWVOYW1lISxcbiAgICAgIHByaW9yaXR5OiBwcmlvcml0eSxcbiAgICAgIGNvbXB1dGVFbnZpcm9ubWVudE9yZGVyOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBvcmRlcjogMSxcbiAgICAgICAgICBjb21wdXRlRW52aXJvbm1lbnQ6IGNvbXB1dGVFbnYuYXR0ckNvbXB1dGVFbnZpcm9ubWVudEFyblxuICAgICAgICB9XG4gICAgICBdXG4gICAgfSk7XG5cbiAgICBqb2JRdWV1ZS5ub2RlLmFkZERlcGVuZGVuY3koY29tcHV0ZUVudik7XG4gIH1cblxuICAvKipcbiAgICogbWV0aG9kIHRvIHRvIGFwcGx5IGs4cyBSQkFDIHRvIHRoZSBzZXJ2aWNlIGFjY291bnQgdXNlZCBieSBCYXRjaCBzZXJ2aWNlIHJvbGVcbiAgICogQHBhcmFtIENsdXN0ZXJJbmZvIEVLUyBjbHVzdGVyIHdoZXJlIHRvIGFwcGx5IHRoZSBSQkFDXG4gICAqIEBwYXJhbSBuYW1lc3BhY2UgTmFtZXNwYWNlIHdoZXJlIHRoZSBSQkFDIGFyZSBhcHBsaWVkXG4gICAqIEBwYXJhbSBjcmVhdGVOYW1lc3BhY2UgZmxhZyB0byBjcmVhdGUgbmFtZXNwYWNlIGlmIG5vdCBhbHJlYWR5IGNyZWF0ZWRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcml2YXRlIHNldEJhdGNoRWtzUmVzb3VyY2VzKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgbmFtZXNwYWNlOiBzdHJpbmcpOiBDb25zdHJ1Y3Qge1xuXG4gICAgbGV0IGRvYyA9IHJlYWRZYW1sRG9jdW1lbnQoYCR7X19kaXJuYW1lfS9hd3MtYmF0Y2gtcmJhYy1jb25maWcueXRwbGApO1xuXG4gICAgLy9HZXQgdGhlIFJCQUMgZGVmaW5pdGlvbiBhbmQgcmVwbGFjZSB3aXRoIHRoZSBuYW1lc3BhY2UgcHJvdmlkZWQgYnkgdGhlIHVzZXJcbiAgICBjb25zdCBtYW5pZmVzdCA9IGRvYy5zcGxpdChcIi0tLVwiKS5tYXAoZSA9PiBsb2FkWWFtbChlKSk7XG5cbiAgICBjb25zdCB2YWx1ZXM6IFZhbHVlcyA9IHtcbiAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlXG4gICAgfTtcblxuICAgIGNvbnN0IG1hbmlmZXN0RGVwbG95bWVudDogTWFuaWZlc3REZXBsb3ltZW50ID0ge1xuICAgICAgbmFtZTogJ2F3cy1iYXRjaC1yYmFjcycsXG4gICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZSxcbiAgICAgIG1hbmlmZXN0LFxuICAgICAgdmFsdWVzXG4gICAgfTtcblxuICAgIGNvbnN0IGt1YmVjdGxQcm92aWRlciA9IG5ldyBLdWJlY3RsUHJvdmlkZXIoY2x1c3RlckluZm8pO1xuICAgIGNvbnN0IHN0YXRlbWVudCA9IGt1YmVjdGxQcm92aWRlci5hZGRNYW5pZmVzdChtYW5pZmVzdERlcGxveW1lbnQpO1xuXG4gICAgcmV0dXJuIHN0YXRlbWVudDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q29tcHV0ZUVudmlyb25tZW50KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgbmFtZXNwYWNlOiBzdHJpbmcsIGNvbXB1dGVSZXNvdXJjZXM6IHtcbiAgICBlbnZUeXBlOiBCYXRjaEVudlR5cGU7XG4gICAgYWxsb2NhdGlvblN0cmF0ZWd5OiBCYXRjaEFsbG9jYXRpb25TdHJhdGVneTtcbiAgICBwcmlvcml0eTogbnVtYmVyO1xuICAgIG1pbnZDcHVzOiBudW1iZXI7XG4gICAgbWF4dkNwdXM6IG51bWJlcjtcbiAgICBpbnN0YW5jZVR5cGVzOiBzdHJpbmdbXTtcbiAgfSk6IGJhdGNoLkNmbkNvbXB1dGVFbnZpcm9ubWVudCB7XG4gICAgY29uc3Qgbm9kZUdyb3VwcyA9IGFzc2VydEVDMk5vZGVHcm91cChjbHVzdGVySW5mbywgXCJCYXRjaCBDb21wdXRlIEVudmlyb25tZW50XCIpO1xuICAgIGNvbnN0IG5nUm9sZU5hbWVzID0gbm9kZUdyb3Vwcy5tYXAoKG5nOiBla3MuTm9kZWdyb3VwIHwgQXV0b1NjYWxpbmdHcm91cCkgPT4geyByZXR1cm4gbmcucm9sZS5yb2xlTmFtZTsgfSk7XG4gICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgY29uc3QgbmdSb2xlID0gbmdSb2xlTmFtZXNbMF07XG5cbiAgICAvLyBOZWVkIHRvIGNyZWF0ZSBpbnN0YW5jZSBwcm9maWxlIGZvciB0aGUgbm9kZWdyb3VwIHJvbGVcbiAgICBjb25zdCBpbnN0YW5jZVByb2ZpbGUgPSBuZXcgaWFtLkNmbkluc3RhbmNlUHJvZmlsZShjbHVzdGVyLCAnbmctcm9sZS1pbnN0YW5jZS1wcm9maWxlJywge1xuICAgICAgaW5zdGFuY2VQcm9maWxlTmFtZTogbmdSb2xlLFxuICAgICAgcm9sZXM6IFtuZ1JvbGVdXG4gICAgfSk7XG4gIFxuICAgIGNvbnN0IGJhdGNoQ29tcHV0ZUVudiA9IG5ldyBiYXRjaC5DZm5Db21wdXRlRW52aXJvbm1lbnQoY2x1c3RlciwgXCJiYXRjaC1la3MtY29tcHV0ZS1lbnZpcm9ubWVudFwiLCB7XG4gICAgICB0eXBlOiAnTUFOQUdFRCcsXG4gICAgICBjb21wdXRlRW52aXJvbm1lbnROYW1lOiB0aGlzLmJhdGNoVGVhbVByb3BzLmVudk5hbWUsXG4gICAgICBzdGF0ZTogJ0VOQUJMRUQnLFxuICAgICAgZWtzQ29uZmlndXJhdGlvbjoge1xuICAgICAgICBla3NDbHVzdGVyQXJuOiBjbHVzdGVyLmNsdXN0ZXJBcm4sXG4gICAgICAgIGt1YmVybmV0ZXNOYW1lc3BhY2U6IG5hbWVzcGFjZSxcbiAgICAgIH0sXG4gICAgICBjb21wdXRlUmVzb3VyY2VzOiB7XG4gICAgICAgIHR5cGU6IGNvbXB1dGVSZXNvdXJjZXMuZW52VHlwZSxcbiAgICAgICAgYWxsb2NhdGlvblN0cmF0ZWd5OiBjb21wdXRlUmVzb3VyY2VzLmFsbG9jYXRpb25TdHJhdGVneSxcbiAgICAgICAgbWludkNwdXM6IGNvbXB1dGVSZXNvdXJjZXMubWludkNwdXMsXG4gICAgICAgIG1heHZDcHVzOiBjb21wdXRlUmVzb3VyY2VzLm1heHZDcHVzLFxuICAgICAgICBpbnN0YW5jZVR5cGVzOiBjb21wdXRlUmVzb3VyY2VzLmluc3RhbmNlVHlwZXMsXG4gICAgICAgIHN1Ym5ldHM6IGNsdXN0ZXIudnBjLnB1YmxpY1N1Ym5ldHMubWFwKChlOiBlYzIuSVN1Ym5ldCkgPT4geyByZXR1cm4gZS5zdWJuZXRJZDsgfSksXG4gICAgICAgIHNlY3VyaXR5R3JvdXBJZHM6IFtjbHVzdGVyLmNsdXN0ZXJTZWN1cml0eUdyb3VwSWRdLFxuICAgICAgICBpbnN0YW5jZVJvbGU6IG5nUm9sZSxcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGJhdGNoQ29tcHV0ZUVudi5ub2RlLmFkZERlcGVuZGVuY3koaW5zdGFuY2VQcm9maWxlKTtcbiAgICByZXR1cm4gYmF0Y2hDb21wdXRlRW52O1xuICB9XG59XG4iXX0=