"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EmrEksTeam = void 0;
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const nsutils = require("../utils/namespace-utils");
const simplebase = require("simple-base");
const aws_emrcontainers_1 = require("aws-cdk-lib/aws-emrcontainers");
const team_1 = require("./team");
const kubectl_provider_1 = require("../addons/helm-addon/kubectl-provider");
const yaml_utils_1 = require("../utils/yaml-utils");
/*
 *This class define the Team that can be used with EMR on EKS
 *The class will create an EMR on EKS Virtual Cluster to use by the team
 *It can either create a namespace or use an existing one
 *The class will set the necessary k8s RBAC needed by EMR on EKS as defined in the AWS documentation
 * https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-cluster-access.html
 * class constructor takes EMR on EKS team definition as a parameter. Pre:requisite: EMR on EKS AddOn is part of the blueprint.
 * The EmrEksTeam will `throw` an error if the EMR on EKS AddOn is not part of the blueprint.
 *
 * The team will create the IAM execution roles based on the IAM policies passed to it.
 *
 * The IAM roles will have the following format: `NAME-AWS-REGION-EKS-CLUSTER-NAME`
 */
class EmrEksTeam extends team_1.ApplicationTeam {
    /**
     * @public
     * @param {EmrEksTeamProps} props the EMR on EKS team definition {@link EmrEksTeamProps}
     */
    constructor(props) {
        super(props);
        this.emrTeam = props;
    }
    setup(clusterInfo) {
        const cluster = clusterInfo.cluster;
        const emrOnEksAddOn = clusterInfo.getProvisionedAddOn('EmrEksAddOn');
        if (emrOnEksAddOn === undefined) {
            throw new Error("EmrEksAddOn must be deployed before creating EMR on EKS team");
        }
        const emrVcPrerequisit = this.setEmrContainersForNamespace(clusterInfo, this.emrTeam.virtualClusterNamespace, this.emrTeam.createNamespace);
        this.emrTeam.executionRoles.forEach(executionRole => {
            const executionRolePolicy = executionRole.excutionRoleIamPolicy ?
                executionRole.excutionRoleIamPolicy :
                new aws_iam_1.ManagedPolicy(cluster.stack, `executionRole-${executionRole.executionRoleName}-Policy`, {
                    statements: executionRole.executionRoleIamPolicyStatement,
                });
            this.createExecutionRole(cluster, executionRolePolicy, this.emrTeam.virtualClusterNamespace, executionRole.executionRoleName);
        });
        const blueprintTag = {
            key: 'created-with',
            value: 'cdk-blueprint',
        };
        let virtualClusterTags = this.emrTeam.virtualClusterTags ? this.emrTeam.virtualClusterTags : [];
        virtualClusterTags.push(blueprintTag);
        const teamVC = new aws_emrcontainers_1.CfnVirtualCluster(cluster.stack, `${this.emrTeam.virtualClusterName}-VirtualCluster`, {
            name: this.emrTeam.virtualClusterName,
            containerProvider: {
                id: cluster.clusterName,
                type: 'EKS',
                info: { eksInfo: { namespace: this.emrTeam.virtualClusterNamespace } },
            },
            tags: virtualClusterTags,
        });
        teamVC.node.addDependency(emrVcPrerequisit);
        teamVC.node.addDependency(emrOnEksAddOn);
        //Force dependency between the EKS cluster and EMR on EKS Virtual cluster
        teamVC.node.addDependency(clusterInfo.cluster);
        new aws_cdk_lib_1.CfnOutput(cluster.stack, `${this.emrTeam.virtualClusterName}-virtual cluster-id`, {
            value: teamVC.attrId
        });
    }
    /**
     * @internal
     * Private method to to apply k8s RBAC to the service account used by EMR on EKS service role
     * For more information on the RBAC read consult the EMR on EKS documentation in this link
     * https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-cluster-access.html
     * This method
     * @param ClusterInfo EKS cluster where to apply the RBAC
     * @param namespace Namespace where the RBAC are applied
     * @param createNamespace flag to create namespace if not already created
     * @returns
     */
    setEmrContainersForNamespace(ClusterInfo, namespace, createNamespace) {
        let doc = (0, yaml_utils_1.readYamlDocument)(`${__dirname}/emr-containers-rbac-config.ytpl`);
        //Get the RBAC definition and replace with the namespace provided by the user
        const manifest = doc.split("---").map(e => (0, yaml_utils_1.loadYaml)(e));
        const values = {
            namespace: namespace
        };
        const manifestDeployment = {
            name: 'emr-containers',
            namespace: namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(ClusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        if (createNamespace) {
            const namespaceManifest = nsutils.createNamespace(namespace, ClusterInfo.cluster, true);
            statement.node.addDependency(namespaceManifest);
        }
        return statement;
    }
    /**
     * @internal
     * private method to create the execution role for EMR on EKS scoped to a namespace and a given IAM role
     * @param cluster EKS cluster
     * @param policy IAM policy to use with the role
     * @param namespace Namespace of the EMR Virtual Cluster
     * @param name Name of the IAM role
     * @returns Role
     */
    createExecutionRole(cluster, policy, namespace, name) {
        const stack = cluster.stack;
        const roleName = `${name}-${aws_cdk_lib_1.Aws.REGION.toString()}-${cluster.clusterName}`;
        let irsaConditionkey = new aws_cdk_lib_1.CfnJson(stack, `${name}roleIrsaConditionkey'`, {
            value: {
                [`${cluster.openIdConnectProvider.openIdConnectProviderIssuer}:sub`]: 'system:serviceaccount:' + namespace + ':emr-containers-sa-*-*-' + aws_cdk_lib_1.Aws.ACCOUNT_ID.toString() + '-' + simplebase.base36.encode(roleName),
            },
        });
        // Create an execution role assumable by EKS OIDC provider and scoped to the service account of the virtual cluster
        return new aws_iam_1.Role(stack, `${name}ExecutionRole`, {
            assumedBy: new aws_iam_1.FederatedPrincipal(cluster.openIdConnectProvider.openIdConnectProviderArn, {
                StringLike: irsaConditionkey,
            }, 'sts:AssumeRoleWithWebIdentity'),
            roleName: roleName,
            managedPolicies: [policy],
        });
    }
}
exports.EmrEksTeam = EmrEksTeam;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1yLW9uLWVrcy10ZWFtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3RlYW1zL2Vtci1vbi1la3MtdGVhbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxpREFBK0c7QUFDL0csNkNBQThEO0FBQzlELG9EQUFvRDtBQUNwRCwwQ0FBMEM7QUFDMUMscUVBQWtFO0FBRWxFLGlDQUFvRDtBQUNwRCw0RUFBNEY7QUFDNUYsb0RBQWlFO0FBa0RqRTs7Ozs7Ozs7Ozs7O0dBWUc7QUFFSCxNQUFhLFVBQVcsU0FBUSxzQkFBZTtJQUc3Qzs7O09BR0c7SUFDSCxZQUFZLEtBQXNCO1FBQ2hDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNiLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBd0I7UUFDNUIsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUVwQyxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsbUJBQW1CLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFckUsSUFBSSxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsOERBQThELENBQUMsQ0FBQztTQUNqRjtRQUVELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLHVCQUF1QixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFNUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBRWxELE1BQU0sbUJBQW1CLEdBQUcsYUFBYSxDQUFDLHFCQUFxQixDQUFDLENBQUM7Z0JBQy9ELGFBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2dCQUNyQyxJQUFJLHVCQUFhLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxp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Q2pEO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0ssbUJBQW1CLENBQUMsT0FBaUIsRUFBRSxNQUFzQixFQUFFLFNBQWlCLEVBQUUsSUFBWTtRQUVwRyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBRTVCLE1BQU0sUUFBUSxHQUFHLEdBQUcsSUFBSSxJQUFJLGlCQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxJQUFJLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUUzRSxJQUFJLGdCQUFnQixHQUFZLElBQUkscUJBQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLHVCQUF1QixFQUFFO1lBQ2pGLEtBQUssRUFBRTtnQkFDTCxDQUFDLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLDJCQUEyQixNQUFNLENBQUMsRUFBRSx3QkFBd0IsR0FBRyxTQUFTLEdBQUcseUJBQXlCLEdBQUcsaUJBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQzthQUM5TTtTQUNGLENBQUMsQ0FBQztRQUVILG1IQUFtSDtRQUNuSCxPQUFPLElBQUksY0FBSSxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksZUFBZSxFQUFFO1lBQzdDLFNBQVMsRUFBRSxJQUFJLDRCQUFrQixDQUMvQixPQUFPLENBQUMscUJBQXFCLENBQUMsd0JBQXdCLEVBQ3REO2dCQUNFLFVBQVUsRUFBRSxnQkFBZ0I7YUFDN0IsRUFDRCwrQkFBK0IsQ0FBQztZQUNsQyxRQUFRLEVBQUUsUUFBUTtZQUNsQixlQUFlLEVBQUUsQ0FBQyxNQUFNLENBQUM7U0FDMUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUdGO0FBOUlELGdDQThJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElDbHVzdGVyIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbmltcG9ydCB7IEZlZGVyYXRlZFByaW5jaXBhbCwgSU1hbmFnZWRQb2xpY3ksIE1hbmFnZWRQb2xpY3ksIFBvbGljeVN0YXRlbWVudCwgUm9sZSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgeyBBd3MsIENmbkpzb24sIENmbk91dHB1dCwgQ2ZuVGFnIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBuc3V0aWxzIGZyb20gJy4uL3V0aWxzL25hbWVzcGFjZS11dGlscyc7XG5pbXBvcnQgKiBhcyBzaW1wbGViYXNlIGZyb20gJ3NpbXBsZS1iYXNlJztcbmltcG9ydCB7IENmblZpcnR1YWxDbHVzdGVyIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1lbXJjb250YWluZXJzXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uL3NwaVwiO1xuaW1wb3J0IHsgQXBwbGljYXRpb25UZWFtLCBUZWFtUHJvcHMgfSBmcm9tIFwiLi90ZWFtXCI7XG5pbXBvcnQgeyBLdWJlY3RsUHJvdmlkZXIsIE1hbmlmZXN0RGVwbG95bWVudCB9IGZyb20gXCIuLi9hZGRvbnMvaGVsbS1hZGRvbi9rdWJlY3RsLXByb3ZpZGVyXCI7XG5pbXBvcnQgeyBsb2FkWWFtbCwgcmVhZFlhbWxEb2N1bWVudCB9IGZyb20gXCIuLi91dGlscy95YW1sLXV0aWxzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG4vKipcbiAqIEludGVyZmFjZSBkZWZpbmUgdGhlIG9iamVjdCB0byBjcmVhdGUgYW4gZXhlY3V0aW9uIHJvbGVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRpb25Sb2xlRGVmaW5pdGlvbiB7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgSUFNIHJvbGUgdG8gY3JlYXRlLCB0aGlzIG5hbWUgaXMgdXNlZCBhcyBiYXNlIGZvciB0aGUgZXhjdXRpb24gUm9sZSBuYW1lXG4gICAqIFRoZSBuYW1lIHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGZvcm1hdCBhZnRlciBkZXBsb3ltZW50OiBgTkFNRS1BV1MtUkVHSU9OLUVLUy1DTFVTVEVSLU5BTUVgLlxuICAgKi9cbiAgZXhlY3V0aW9uUm9sZU5hbWU6IHN0cmluZztcbiAgLyoqXG4gICAgKiBUaGUgSUFNIHBvbGljeSB0byB1c2Ugd2l0aCBJQU0gcm9sZSBpZiBpdCBhbHJlYWR5IGV4aXN0c1xuICAgICogQ2FuIGJlIGluaXRpYWxpemVkIGZvciBleGFtcGxlIGJ5IGBmcm9tUG9saWN5TmFtZWAgaW4gUG9saWN5IGNsYXNzXG4gICAgKi9cbiAgZXhjdXRpb25Sb2xlSWFtUG9saWN5PzogSU1hbmFnZWRQb2xpY3k7XG4gIC8qKlxuICAgICogVGFrZXMgYW4gYXJyYXkgb2YgSUFNIFBvbGljeSBTdGF0ZW1lbnQsIHlvdSBzaG91bGQgcGFzcyB0aGlzIFxuICAgICogaWYgeW91IHdhbnQgdGhlIFRlYW0gdG8gY3JlYXRlIHRoZSBwb2xpY3kgYWxvbmcgdGhlIElBTSByb2xlIFxuICAgICovXG4gIGV4ZWN1dGlvblJvbGVJYW1Qb2xpY3lTdGF0ZW1lbnQ/OiBQb2xpY3lTdGF0ZW1lbnRbXTtcbn1cblxuLyoqXG4gKiBJbnRlcmZhY2UgdG8gZGVmaW5lIGEgRU1SIG9uIEVLUyB0ZWFtXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRW1yRWtzVGVhbVByb3BzIGV4dGVuZHMgVGVhbVByb3BzIHtcbiAgLypcbiAgKiBUaGUgbmFtZXNwYWNlIG9mIHdoZXJlIHRoZSB2aXJ0dWFsIGNsdXN0ZXIgd2lsbCBiZSBjcmVhdGVkXG4gICovXG4gIHZpcnR1YWxDbHVzdGVyTmFtZXNwYWNlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUbyBkZWZpbmUgaWYgdGhlIG5hbWVzcGFjZSB0aGF0IHRlYW0gd2lsbCB1c2UgbmVlZCB0byBiZSBjcmVhdGVkXG4gICAqL1xuICBjcmVhdGVOYW1lc3BhY2U6IGJvb2xlYW47XG4gIC8qXG4gICogVGhlIG5hbWUgb2YgdGhlIHZpcnR1YWwgY2x1c3RlciB0aGUgdGVhbSB3aWxsIHVzZVxuICAqL1xuICB2aXJ0dWFsQ2x1c3Rlck5hbWU6IHN0cmluZztcbiAgLyoqXG4gICAqIExpc3Qgb2YgZXhlY3V0aW9uIHJvbGUgdG8gYXNzb2NpYXRlZCB3aXRoIHRoZSBWQyBuYW1lc3BhY2Uge0BsaW5rIEV4ZWN1dGlvblJvbGVEZWZpbml0aW9ufVxuICAgKi9cbiAgZXhlY3V0aW9uUm9sZXM6IEV4ZWN1dGlvblJvbGVEZWZpbml0aW9uW107XG4gIC8qKlxuICAgKiBUYWdzIHRvIGFwcGx5IHRvIEVNUiBvbiBFS1MgVmlydHVhbCBDbHVzdGVyXG4gICAqL1xuICAgdmlydHVhbENsdXN0ZXJUYWdzPzogQ2ZuVGFnW107XG59XG5cbi8qXG4gKlRoaXMgY2xhc3MgZGVmaW5lIHRoZSBUZWFtIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBFTVIgb24gRUtTXG4gKlRoZSBjbGFzcyB3aWxsIGNyZWF0ZSBhbiBFTVIgb24gRUtTIFZpcnR1YWwgQ2x1c3RlciB0byB1c2UgYnkgdGhlIHRlYW1cbiAqSXQgY2FuIGVpdGhlciBjcmVhdGUgYSBuYW1lc3BhY2Ugb3IgdXNlIGFuIGV4aXN0aW5nIG9uZVxuICpUaGUgY2xhc3Mgd2lsbCBzZXQgdGhlIG5lY2Vzc2FyeSBrOHMgUkJBQyBuZWVkZWQgYnkgRU1SIG9uIEVLUyBhcyBkZWZpbmVkIGluIHRoZSBBV1MgZG9jdW1lbnRhdGlvbiBcbiAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9lbXIvbGF0ZXN0L0VNUi1vbi1FS1MtRGV2ZWxvcG1lbnRHdWlkZS9zZXR0aW5nLXVwLWNsdXN0ZXItYWNjZXNzLmh0bWxcbiAqIGNsYXNzIGNvbnN0cnVjdG9yIHRha2VzIEVNUiBvbiBFS1MgdGVhbSBkZWZpbml0aW9uIGFzIGEgcGFyYW1ldGVyLiBQcmU6cmVxdWlzaXRlOiBFTVIgb24gRUtTIEFkZE9uIGlzIHBhcnQgb2YgdGhlIGJsdWVwcmludC5cbiAqIFRoZSBFbXJFa3NUZWFtIHdpbGwgYHRocm93YCBhbiBlcnJvciBpZiB0aGUgRU1SIG9uIEVLUyBBZGRPbiBpcyBub3QgcGFydCBvZiB0aGUgYmx1ZXByaW50LlxuICogXG4gKiBUaGUgdGVhbSB3aWxsIGNyZWF0ZSB0aGUgSUFNIGV4ZWN1dGlvbiByb2xlcyBiYXNlZCBvbiB0aGUgSUFNIHBvbGljaWVzIHBhc3NlZCB0byBpdC5cbiAqIFxuICogVGhlIElBTSByb2xlcyB3aWxsIGhhdmUgdGhlIGZvbGxvd2luZyBmb3JtYXQ6IGBOQU1FLUFXUy1SRUdJT04tRUtTLUNMVVNURVItTkFNRWBcbiAqL1xuXG5leHBvcnQgY2xhc3MgRW1yRWtzVGVhbSBleHRlbmRzIEFwcGxpY2F0aW9uVGVhbSB7XG5cbiAgcHJpdmF0ZSBlbXJUZWFtOiBFbXJFa3NUZWFtUHJvcHM7XG4gIC8qKlxuICAgKiBAcHVibGljXG4gICAqIEBwYXJhbSB7RW1yRWtzVGVhbVByb3BzfSBwcm9wcyB0aGUgRU1SIG9uIEVLUyB0ZWFtIGRlZmluaXRpb24ge0BsaW5rIEVtckVrc1RlYW1Qcm9wc31cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBFbXJFa3NUZWFtUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgdGhpcy5lbXJUZWFtID0gcHJvcHM7XG4gIH1cblxuICBzZXR1cChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiB2b2lkIHtcbiAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcblxuICAgIGNvbnN0IGVtck9uRWtzQWRkT24gPSBjbHVzdGVySW5mby5nZXRQcm92aXNpb25lZEFkZE9uKCdFbXJFa3NBZGRPbicpO1xuXG4gICAgaWYgKGVtck9uRWtzQWRkT24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRW1yRWtzQWRkT24gbXVzdCBiZSBkZXBsb3llZCBiZWZvcmUgY3JlYXRpbmcgRU1SIG9uIEVLUyB0ZWFtXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGVtclZjUHJlcmVxdWlzaXQgPSB0aGlzLnNldEVtckNvbnRhaW5lcnNGb3JOYW1lc3BhY2UoY2x1c3RlckluZm8sIHRoaXMuZW1yVGVhbS52aXJ0dWFsQ2x1c3Rlck5hbWVzcGFjZSwgdGhpcy5lbXJUZWFtLmNyZWF0ZU5hbWVzcGFjZSk7XG5cbiAgICB0aGlzLmVtclRlYW0uZXhlY3V0aW9uUm9sZXMuZm9yRWFjaChleGVjdXRpb25Sb2xlID0+IHtcblxuICAgICAgY29uc3QgZXhlY3V0aW9uUm9sZVBvbGljeSA9IGV4ZWN1dGlvblJvbGUuZXhjdXRpb25Sb2xlSWFtUG9saWN5ID9cbiAgICAgICAgZXhlY3V0aW9uUm9sZS5leGN1dGlvblJvbGVJYW1Qb2xpY3kgOlxuICAgICAgICBuZXcgTWFuYWdlZFBvbGljeShjbHVzdGVyLnN0YWNrLCBgZXhlY3V0aW9uUm9sZS0ke2V4ZWN1dGlvblJvbGUuZXhlY3V0aW9uUm9sZU5hbWV9LVBvbGljeWAsIHtcbiAgICAgICAgICBzdGF0ZW1lbnRzOiBleGVjdXRpb25Sb2xlLmV4ZWN1dGlvblJvbGVJYW1Qb2xpY3lTdGF0ZW1lbnQsXG4gICAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNyZWF0ZUV4ZWN1dGlvblJvbGUoXG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIGV4ZWN1dGlvblJvbGVQb2xpY3ksXG4gICAgICAgIHRoaXMuZW1yVGVhbS52aXJ0dWFsQ2x1c3Rlck5hbWVzcGFjZSxcbiAgICAgICAgZXhlY3V0aW9uUm9sZS5leGVjdXRpb25Sb2xlTmFtZSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBibHVlcHJpbnRUYWc6IENmblRhZyA9IHtcbiAgICAgIGtleTogJ2NyZWF0ZWQtd2l0aCcsXG4gICAgICB2YWx1ZTogJ2Nkay1ibHVlcHJpbnQnLFxuICAgIH07XG5cbiAgICBsZXQgdmlydHVhbENsdXN0ZXJUYWdzOiBDZm5UYWcgW10gPSB0aGlzLmVtclRlYW0udmlydHVhbENsdXN0ZXJUYWdzID8gdGhpcy5lbXJUZWFtLnZpcnR1YWxDbHVzdGVyVGFncyA6IFtdIDtcbiAgICB2aXJ0dWFsQ2x1c3RlclRhZ3MucHVzaChibHVlcHJpbnRUYWcpO1xuXG4gICAgY29uc3QgdGVhbVZDID0gbmV3IENmblZpcnR1YWxDbHVzdGVyKGNsdXN0ZXIuc3RhY2ssIGAke3RoaXMuZW1yVGVhbS52aXJ0dWFsQ2x1c3Rlck5hbWV9LVZpcnR1YWxDbHVzdGVyYCwge1xuICAgICAgbmFtZTogdGhpcy5lbXJUZWFtLnZpcnR1YWxDbHVzdGVyTmFtZSxcbiAgICAgIGNvbnRhaW5lclByb3ZpZGVyOiB7XG4gICAgICAgIGlkOiBjbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICB0eXBlOiAnRUtTJyxcbiAgICAgICAgaW5mbzogeyBla3NJbmZvOiB7IG5hbWVzcGFjZTogdGhpcy5lbXJUZWFtLnZpcnR1YWxDbHVzdGVyTmFtZXNwYWNlIH0gfSxcbiAgICAgIH0sXG4gICAgICB0YWdzOiB2aXJ0dWFsQ2x1c3RlclRhZ3MsXG4gICAgfSk7XG5cbiAgICB0ZWFtVkMubm9kZS5hZGREZXBlbmRlbmN5KGVtclZjUHJlcmVxdWlzaXQpO1xuICAgIHRlYW1WQy5ub2RlLmFkZERlcGVuZGVuY3koZW1yT25Fa3NBZGRPbik7XG4gICAgLy9Gb3JjZSBkZXBlbmRlbmN5IGJldHdlZW4gdGhlIEVLUyBjbHVzdGVyIGFuZCBFTVIgb24gRUtTIFZpcnR1YWwgY2x1c3RlclxuICAgIHRlYW1WQy5ub2RlLmFkZERlcGVuZGVuY3koY2x1c3RlckluZm8uY2x1c3Rlcik7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KGNsdXN0ZXIuc3RhY2ssIGAke3RoaXMuZW1yVGVhbS52aXJ0dWFsQ2x1c3Rlck5hbWV9LXZpcnR1YWwgY2x1c3Rlci1pZGAsIHtcbiAgICAgIHZhbHVlOiB0ZWFtVkMuYXR0cklkXG4gICAgfSk7XG5cbiAgfVxuICAvKipcbiAgICogQGludGVybmFsXG4gICAqIFByaXZhdGUgbWV0aG9kIHRvIHRvIGFwcGx5IGs4cyBSQkFDIHRvIHRoZSBzZXJ2aWNlIGFjY291bnQgdXNlZCBieSBFTVIgb24gRUtTIHNlcnZpY2Ugcm9sZVxuICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiB0aGUgUkJBQyByZWFkIGNvbnN1bHQgdGhlIEVNUiBvbiBFS1MgZG9jdW1lbnRhdGlvbiBpbiB0aGlzIGxpbmsgXG4gICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9lbXIvbGF0ZXN0L0VNUi1vbi1FS1MtRGV2ZWxvcG1lbnRHdWlkZS9zZXR0aW5nLXVwLWNsdXN0ZXItYWNjZXNzLmh0bWxcbiAgICogVGhpcyBtZXRob2QgXG4gICAqIEBwYXJhbSBDbHVzdGVySW5mbyBFS1MgY2x1c3RlciB3aGVyZSB0byBhcHBseSB0aGUgUkJBQ1xuICAgKiBAcGFyYW0gbmFtZXNwYWNlIE5hbWVzcGFjZSB3aGVyZSB0aGUgUkJBQyBhcmUgYXBwbGllZFxuICAgKiBAcGFyYW0gY3JlYXRlTmFtZXNwYWNlIGZsYWcgdG8gY3JlYXRlIG5hbWVzcGFjZSBpZiBub3QgYWxyZWFkeSBjcmVhdGVkXG4gICAqIEByZXR1cm5zIFxuICAgKi9cblxuICBwcml2YXRlIHNldEVtckNvbnRhaW5lcnNGb3JOYW1lc3BhY2UoQ2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBuYW1lc3BhY2U6IHN0cmluZywgY3JlYXRlTmFtZXNwYWNlOiBib29sZWFuKTogQ29uc3RydWN0IHtcblxuICAgIGxldCBkb2MgPSByZWFkWWFtbERvY3VtZW50KGAke19fZGlybmFtZX0vZW1yLWNvbnRhaW5lcnMtcmJhYy1jb25maWcueXRwbGApO1xuXG4gICAgLy9HZXQgdGhlIFJCQUMgZGVmaW5pdGlvbiBhbmQgcmVwbGFjZSB3aXRoIHRoZSBuYW1lc3BhY2UgcHJvdmlkZWQgYnkgdGhlIHVzZXJcbiAgICBjb25zdCBtYW5pZmVzdCA9IGRvYy5zcGxpdChcIi0tLVwiKS5tYXAoZSA9PiBsb2FkWWFtbChlKSk7XG5cbiAgICBjb25zdCB2YWx1ZXM6IFZhbHVlcyA9IHtcbiAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlXG4gICAgfTtcblxuICAgIGNvbnN0IG1hbmlmZXN0RGVwbG95bWVudDogTWFuaWZlc3REZXBsb3ltZW50ID0ge1xuICAgICAgbmFtZTogJ2Vtci1jb250YWluZXJzJyxcbiAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlLFxuICAgICAgbWFuaWZlc3QsXG4gICAgICB2YWx1ZXNcbiAgICB9O1xuXG4gICAgY29uc3Qga3ViZWN0bFByb3ZpZGVyID0gbmV3IEt1YmVjdGxQcm92aWRlcihDbHVzdGVySW5mbyk7XG4gICAgY29uc3Qgc3RhdGVtZW50ID0ga3ViZWN0bFByb3ZpZGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0RGVwbG95bWVudCk7XG5cbiAgICBpZiAoY3JlYXRlTmFtZXNwYWNlKSB7XG4gICAgICBjb25zdCBuYW1lc3BhY2VNYW5pZmVzdCA9IG5zdXRpbHMuY3JlYXRlTmFtZXNwYWNlKG5hbWVzcGFjZSwgQ2x1c3RlckluZm8uY2x1c3RlciwgdHJ1ZSk7XG4gICAgICBzdGF0ZW1lbnQubm9kZS5hZGREZXBlbmRlbmN5KG5hbWVzcGFjZU1hbmlmZXN0KTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhdGVtZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKiBwcml2YXRlIG1ldGhvZCB0byBjcmVhdGUgdGhlIGV4ZWN1dGlvbiByb2xlIGZvciBFTVIgb24gRUtTIHNjb3BlZCB0byBhIG5hbWVzcGFjZSBhbmQgYSBnaXZlbiBJQU0gcm9sZVxuICAgKiBAcGFyYW0gY2x1c3RlciBFS1MgY2x1c3RlclxuICAgKiBAcGFyYW0gcG9saWN5IElBTSBwb2xpY3kgdG8gdXNlIHdpdGggdGhlIHJvbGVcbiAgICogQHBhcmFtIG5hbWVzcGFjZSBOYW1lc3BhY2Ugb2YgdGhlIEVNUiBWaXJ0dWFsIENsdXN0ZXJcbiAgICogQHBhcmFtIG5hbWUgTmFtZSBvZiB0aGUgSUFNIHJvbGVcbiAgICogQHJldHVybnMgUm9sZVxuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVFeGVjdXRpb25Sb2xlKGNsdXN0ZXI6IElDbHVzdGVyLCBwb2xpY3k6IElNYW5hZ2VkUG9saWN5LCBuYW1lc3BhY2U6IHN0cmluZywgbmFtZTogc3RyaW5nKTogUm9sZSB7XG5cbiAgICBjb25zdCBzdGFjayA9IGNsdXN0ZXIuc3RhY2s7XG5cbiAgICBjb25zdCByb2xlTmFtZSA9IGAke25hbWV9LSR7QXdzLlJFR0lPTi50b1N0cmluZygpfS0ke2NsdXN0ZXIuY2x1c3Rlck5hbWV9YDtcblxuICAgIGxldCBpcnNhQ29uZGl0aW9ua2V5OiBDZm5Kc29uID0gbmV3IENmbkpzb24oc3RhY2ssIGAke25hbWV9cm9sZUlyc2FDb25kaXRpb25rZXknYCwge1xuICAgICAgdmFsdWU6IHtcbiAgICAgICAgW2Ake2NsdXN0ZXIub3BlbklkQ29ubmVjdFByb3ZpZGVyLm9wZW5JZENvbm5lY3RQcm92aWRlcklzc3Vlcn06c3ViYF06ICdzeXN0ZW06c2VydmljZWFjY291bnQ6JyArIG5hbWVzcGFjZSArICc6ZW1yLWNvbnRhaW5lcnMtc2EtKi0qLScgKyBBd3MuQUNDT1VOVF9JRC50b1N0cmluZygpICsgJy0nICsgc2ltcGxlYmFzZS5iYXNlMzYuZW5jb2RlKHJvbGVOYW1lKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgYW4gZXhlY3V0aW9uIHJvbGUgYXNzdW1hYmxlIGJ5IEVLUyBPSURDIHByb3ZpZGVyIGFuZCBzY29wZWQgdG8gdGhlIHNlcnZpY2UgYWNjb3VudCBvZiB0aGUgdmlydHVhbCBjbHVzdGVyXG4gICAgcmV0dXJuIG5ldyBSb2xlKHN0YWNrLCBgJHtuYW1lfUV4ZWN1dGlvblJvbGVgLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgIGNsdXN0ZXIub3BlbklkQ29ubmVjdFByb3ZpZGVyLm9wZW5JZENvbm5lY3RQcm92aWRlckFybixcbiAgICAgICAge1xuICAgICAgICAgIFN0cmluZ0xpa2U6IGlyc2FDb25kaXRpb25rZXksXG4gICAgICAgIH0sXG4gICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScpLFxuICAgICAgcm9sZU5hbWU6IHJvbGVOYW1lLFxuICAgICAgbWFuYWdlZFBvbGljaWVzOiBbcG9saWN5XSxcbiAgICB9KTtcbiAgfVxuXG5cbn1cbiJdfQ==