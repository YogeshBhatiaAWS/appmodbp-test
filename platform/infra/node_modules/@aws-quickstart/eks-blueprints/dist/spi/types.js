"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GitOpsMode = exports.ClusterInfo = exports.GlobalResources = exports.ResourceContext = exports.ApplicationRepositoryConstraints = void 0;
const assert = require("assert");
const log_utils_1 = require("../utils/log-utils");
const constraints = require("../utils/constraints-utils");
/**
 * Adds Constraints to application repository
 */
class ApplicationRepositoryConstraints {
    constructor() {
        this.credentialsSecretName = new constraints.InternetHostStringConstraint();
    }
}
exports.ApplicationRepositoryConstraints = ApplicationRepositoryConstraints;
/**
 * Provides API to register resource providers and get access to the provided resources.
 */
class ResourceContext {
    constructor(scope, blueprintProps) {
        this.scope = scope;
        this.blueprintProps = blueprintProps;
        this.resources = new Map();
    }
    /**
     * Adds a new resource provider and specifies the name under which the provided resource will be registered,
     * @param name Specifies the name key under which the provided resources will be registered for subsequent look-ups.
     * @param provider Implementation of the resource provider interface
     * @returns the provided resource
     */
    add(name, provider) {
        const resource = provider.provide(this);
        assert(!this.resources.has(name), `Overwriting ${name} resource during execution is not allowed.`);
        this.resources.set(name, resource);
        return resource;
    }
    /**
     * Gets the provided resource by the supplied name.
     * @param name under which the resource provider was registered
     * @returns the resource or undefined if the specified resource was not found
     */
    get(name) {
        return this.resources.get(name);
    }
}
exports.ResourceContext = ResourceContext;
var GlobalResources;
(function (GlobalResources) {
    GlobalResources["Vpc"] = "vpc";
    GlobalResources["HostedZone"] = "hosted-zone";
    GlobalResources["Certificate"] = "certificate";
    GlobalResources["KmsKey"] = "kms-key";
    GlobalResources["Amp"] = "amp";
})(GlobalResources || (exports.GlobalResources = GlobalResources = {}));
/**
 * Cluster info supplies required information on the cluster configuration, registered resources and add-ons
 * which could be leveraged by the framework, add-on implementations and teams.
 */
class ClusterInfo {
    /**
     * Constructor for ClusterInfo
     * @param props
     */
    constructor(cluster, version, nodeGroups, autoscalingGroups, fargateProfiles) {
        this.cluster = cluster;
        this.version = version;
        this.nodeGroups = nodeGroups;
        this.autoscalingGroups = autoscalingGroups;
        this.fargateProfiles = fargateProfiles;
        this.cluster = cluster;
        this.provisionedAddOns = new Map();
        this.scheduledAddOns = new Map();
        this.orderedAddOns = [];
        this.addonContext = new Map();
    }
    /**
     * Provides the resource context object associated with this instance of the EKS Blueprint.
     * @returns resource context object
     */
    getResourceContext() {
        return this.resourceContext;
    }
    /**
     * Injection method to provide resource context.
     * @param resourceContext
     */
    setResourceContext(resourceContext) {
        this.resourceContext = resourceContext;
    }
    /**
     * Update provisionedAddOns map
     * @param addOn
     * @param construct
     */
    addProvisionedAddOn(addOn, construct) {
        this.orderedAddOns.forEach(e => {
            const provisionedOrdered = this.provisionedAddOns.get(e);
            if (provisionedOrdered) {
                log_utils_1.logger.debug(`Adding dependency from ${addOn} to ${e}`);
                construct.node.addDependency(provisionedOrdered);
            }
        });
        this.provisionedAddOns.set(addOn, construct);
    }
    /**
     * Given the addOn name, return the provisioned addOn construct
     * @param addOn
     * @returns undefined
     */
    getProvisionedAddOn(addOn) {
        return this.provisionedAddOns.get(addOn);
    }
    /**
     * Returns all provisioned addons
     * @returns scheduledAddOns: Map<string, cdk.Construct>
     */
    getAllProvisionedAddons() {
        return this.provisionedAddOns;
    }
    /**
     * Set the preProvisionedAddOn map with the promise for the construct
     * of the addon being provisioned
     * @param addOn
     * @param promise
     * @param ordered if addon depends on previous addons for completion (runs serially)
     */
    addScheduledAddOn(addOn, promise, ordered) {
        this.scheduledAddOns.set(addOn, promise);
        if (ordered) {
            this.orderedAddOns.push(addOn);
        }
    }
    /**
     * Indicates if strict ordering is applied to the addon
     * @param addOn addOn key
     * @returns
     */
    isOrderedAddOn(addOn) {
        return this.orderedAddOns.includes(addOn);
    }
    /**
     * Returns the promise for the Addon construct
     * @param addOn
     * @returns Promise<cdk.Construct>
     */
    getScheduledAddOn(addOn) {
        return this.scheduledAddOns.get(addOn);
    }
    /**
     * Returns all scheduled addons
     * @returns scheduledAddOns: Map<string, Promise<cdk.Construct>>
     */
    getAllScheduledAddons() {
        return this.scheduledAddOns;
    }
    /**
     * Provides the resource registered under supplied name
     * @param name of the resource to be returned
     * @returns Resource object or undefined if no resource was found
     */
    getResource(name) {
        return this.resourceContext.get(name);
    }
    /**
     * Same as {@link getResource} but will fail if the specified resource is not found
     * @param name of the resource to be returned
     * @returns Resource object (fails if not found)
     */
    getRequiredResource(name) {
        const result = this.resourceContext.get(name);
        assert(result, 'Required resource ' + name + ' is missing.');
        return result;
    }
    /**
     * Update addonContext map
     * @param addOn
     * @param Values
     */
    addAddOnContext(addOn, values) {
        this.addonContext.set(addOn, values);
    }
    /**
    * Returns all addon contexts
    * @returns addonContext: Map<string, Values>
    */
    getAddOnContexts() {
        return this.addonContext;
    }
}
exports.ClusterInfo = ClusterInfo;
/**
 * Enum type for two different GitOps operating modes
 */
var GitOpsMode;
(function (GitOpsMode) {
    /**
     * CDK deploys the `Application` resource for each AddOn enabled or customer workloads,
     * and ArgoCD deploys the actual AddOn and workloads via GitOps based on the `Application` resource.
     */
    GitOpsMode[GitOpsMode["APPLICATION"] = 0] = "APPLICATION";
    /**
     * CDK deploys only one `Application` resource for the App of Apps, aka `bootstrap-apps`,
     * and ArgoCD deploys all the AddOns based on the child `Application` defined in `bootstrap-apps`.
     */
    GitOpsMode[GitOpsMode["APP_OF_APPS"] = 1] = "APP_OF_APPS";
})(GitOpsMode || (exports.GitOpsMode = GitOpsMode = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvc3BpL3R5cGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFpQztBQU9qQyxrREFBNEM7QUFDNUMsMERBQTBEO0FBNEUxRDs7R0FFRztBQUNILE1BQWEsZ0NBQWdDO0lBQTdDO1FBQ0ksMEJBQXFCLEdBQUcsSUFBSSxXQUFXLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztJQUMzRSxDQUFDO0NBQUE7QUFGRCw0RUFFQztBQUVEOztHQUVHO0FBQ0gsTUFBYSxlQUFlO0lBSXhCLFlBQTRCLEtBQWdCLEVBQWtCLGNBQWlDO1FBQW5FLFVBQUssR0FBTCxLQUFLLENBQVc7UUFBa0IsbUJBQWMsR0FBZCxjQUFjLENBQW1CO1FBRjlFLGNBQVMsR0FBNEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUVtQyxDQUFDO0lBRXBHOzs7OztPQUtHO0lBQ0ksR0FBRyxDQUF1QixJQUFZLEVBQUUsUUFBNkI7UUFDeEUsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxlQUFlLElBQUksNENBQTRDLENBQUMsQ0FBQztRQUNuRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDbkMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxHQUFHLENBQW9DLElBQVk7UUFDdEQsT0FBVSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QyxDQUFDO0NBQ0o7QUEzQkQsMENBMkJDO0FBRUQsSUFBWSxlQU1YO0FBTkQsV0FBWSxlQUFlO0lBQ3ZCLDhCQUFXLENBQUE7SUFDWCw2Q0FBMEIsQ0FBQTtJQUMxQiw4Q0FB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QUFDLGVBQWUsQ0FBQyxHQUFHLENBQUksSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxtQkFBbUIsQ0FBMEIsSUFBWTtRQUM1RCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBSSxJQUFJLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsTUFBTSxFQUFFLG9CQUFvQixHQUFHLElBQUksR0FBRyxjQUFjLENBQUMsQ0FBQztRQUM3RCxPQUFPLE1BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLGVBQWUsQ0FBQyxLQUFhLEVBQUUsTUFBYztRQUNoRCxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVEOzs7TUFHRTtJQUNLLGdCQUFnQjtRQUNuQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDN0IsQ0FBQztDQUNKO0FBbkpELGtDQW1KQztBQUVEOztHQUVHO0FBQ0gsSUFBWSxVQVdYO0FBWEQsV0FBWSxVQUFVO0lBQ2xCOzs7T0FHRztJQUNILHlEQUFXLENBQUE7SUFDWDs7O09BR0c7SUFDSCx5REFBVyxDQUFBO0FBQ2YsQ0FBQyxFQVhXLFVBQVUsMEJBQVYsVUFBVSxRQVdyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQXV0b1NjYWxpbmdHcm91cCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hdXRvc2NhbGluZyc7XG5pbXBvcnQgKiBhcyBla3MgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QsIElDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFJlc291cmNlUHJvdmlkZXIgfSBmcm9tICcuJztcbmltcG9ydCB7IEVrc0JsdWVwcmludFByb3BzIH0gZnJvbSAnLi4vc3RhY2tzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuLi91dGlscy9sb2ctdXRpbHNcIjtcbmltcG9ydCAqIGFzIGNvbnN0cmFpbnRzIGZyb20gJy4uL3V0aWxzL2NvbnN0cmFpbnRzLXV0aWxzJztcbi8qKlxuICogRGF0YSB0eXBlIGRlZmluaW5nIGhlbG0gcmVwb3NpdG9yaWVzIGZvciBHaXRPcHMgYm9vdHN0cmFwcGluZy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWxtUmVwb3NpdG9yeSB7XG4gICAgcmVwb1VybDogc3RyaW5nLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB1c2VybmFtZT86IHN0cmluZyxcbiAgICBwYXNzd29yZD86IHN0cmluZ1xufVxuXG4vKipcbiAqIFV0aWxpdHkgdHlwZSBmb3IgdmFsdWVzIHBhc3NlZCB0byBIZWxtIG9yIEdpdE9wcyBhcHBsaWNhdGlvbnMuXG4gKi9cbmV4cG9ydCB0eXBlIFZhbHVlcyA9IHtcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XG59O1xuXG4vKipcbiAqIFV0aWxpdHkgdHlwZSBmb3IgS3ViZXJuZXRlcyB0YWludHMgcGFzc2VkIHRvIEhlbG0gb3IgR2l0T3BzIGFwcGxpY2F0aW9ucy5cbiAqL1xuZXhwb3J0IHR5cGUgVGFpbnQgPSB7XG4gICAga2V5OiBzdHJpbmcsXG4gICAgdmFsdWU6IHN0cmluZyxcbiAgICBlZmZlY3Q6IFwiTm9TY2hlZHVsZVwiIHwgXCJQcmVmZXJOb1NjaGVkdWxlXCIgfCBcIk5vRXhlY3V0ZVwiLFxufTtcblxuLyoqXG4gKiBJbnRlcmZhY2UgdGhhdCBpbmNsdWRlcyBhIHJlZmVyZW5jZSB0byBhIEdpdCByZXBvc2l0b3J5IGZvciByZXVzZSwgd2l0aG91dCBjcmVkZW50aWFsc1xuICogYW5kIG90aGVyIGFjY2VzcyBpbmZvcm1hdGlvbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBHaXRSZXBvc2l0b3J5UmVmZXJlbmNlIHtcbiAgICAvKipcbiAgICAgKiBFeHBlY3RlZCB0byBzdXBwb3J0IGhlbG0gc3R5bGUgcmVwbyBhdCB0aGUgbW9tZW50XG4gICAgICovXG4gICAgcmVwb1VybDogc3RyaW5nLFxuXG4gICAgLyoqXG4gICAgICogUGF0aCB3aXRoaW4gdGhlIHJlcG9zaXRvcnlcbiAgICAgKi9cbiAgICBwYXRoPzogc3RyaW5nLFxuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgbmFtZSBmb3IgdGhlIGJvb3RzdHJhcCBhcHBsaWNhdGlvblxuICAgICAqL1xuICAgIG5hbWU/OiBzdHJpbmcsXG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCB0YXJnZXQgcmV2aXNpb24gZm9yIHRoZSByZXBvc2l0b3J5LlxuICAgICAqIFRhcmdldFJldmlzaW9uIGRlZmluZXMgdGhlIHJldmlzaW9uIG9mIHRoZSBzb3VyY2VcbiAgICAgKiB0byBzeW5jIHRoZSBhcHBsaWNhdGlvbiB0by4gSW4gY2FzZSBvZiBHaXQsIHRoaXMgY2FuIGJlXG4gICAgICogY29tbWl0LCB0YWcsIG9yIGJyYW5jaC4gSWYgb21pdHRlZCwgd2lsbCBlcXVhbCB0byBIRUFELlxuICAgICAqIEluIGNhc2Ugb2YgSGVsbSwgdGhpcyBpcyBhIHNlbXZlciB0YWcgZm9yIHRoZSBDaGFydCdzIHZlcnNpb24uXG4gICAgICovXG4gICAgdGFyZ2V0UmV2aXNpb24/OiBzdHJpbmdcbn1cblxuLyoqXG4gKiBEYXRhIHR5cGUgZGVmaW5pbmcgYW4gYXBwbGljYXRpb24gcmVwb3NpdG9yeSAoZ2l0KS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBcHBsaWNhdGlvblJlcG9zaXRvcnkgZXh0ZW5kcyBHaXRSZXBvc2l0b3J5UmVmZXJlbmNlIHtcblxuICAgIC8qKlxuICAgICAqIFNlY3JldCBmcm9tIEFXUyBTZWNyZXRzIE1hbmFnZXIgdG8gaW1wb3J0IGNyZWRlbnRpYWxzIHRvIGFjY2VzcyB0aGUgc3BlY2lmaWVkIGdpdCByZXBvc2l0b3J5LlxuICAgICAqIFRoZSBzZWNyZXQgbXVzdCBleGlzdCBpbiB0aGUgc2FtZSByZWdpb24gYW5kIGFjY291bnQgd2hlcmUgdGhlIHN0YWNrIHdpbGwgcnVuLlxuICAgICAqL1xuICAgIGNyZWRlbnRpYWxzU2VjcmV0TmFtZT86IHN0cmluZyxcblxuICAgIC8qKlxuICAgICAqIERlcGVuZGluZyBvbiBjcmVkZW50aWFscyB0eXBlIHRoZSBhcm4gc2hvdWxkIGVpdGhlciBwb2ludCB0byBhbiBTU0gga2V5IChwbGFpbiB0ZXh0IHZhbHVlKVxuICAgICAqIG9yIGEganNvbiBmaWxlIHdpdGggdXNlcm5hbWUvcGFzc3dvcmQgYXR0cmlidXRlcy5cbiAgICAgKiBGb3IgVE9LRU4gdHlwZSB1c2VybmFtZSBjYW4gYmUgYW55IG5vbi1lbXB0eSB1c2VybmFtZSBhbmQgdG9rZW4gdmFsdWUgYXMgcGFzc3dvcmQuXG4gICAgICovXG4gICAgY3JlZGVudGlhbHNUeXBlPzogXCJVU0VSTkFNRVwiIHwgXCJUT0tFTlwiIHwgXCJTU0hcIlxuXG59XG4vKipcbiAqIEFkZHMgQ29uc3RyYWludHMgdG8gYXBwbGljYXRpb24gcmVwb3NpdG9yeVxuICovXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25SZXBvc2l0b3J5Q29uc3RyYWludHMgaW1wbGVtZW50cyBjb25zdHJhaW50cy5Db25zdHJhaW50c1R5cGU8QXBwbGljYXRpb25SZXBvc2l0b3J5PiB7XG4gICAgY3JlZGVudGlhbHNTZWNyZXROYW1lID0gbmV3IGNvbnN0cmFpbnRzLkludGVybmV0SG9zdFN0cmluZ0NvbnN0cmFpbnQoKTtcbn1cblxuLyoqXG4gKiBQcm92aWRlcyBBUEkgdG8gcmVnaXN0ZXIgcmVzb3VyY2UgcHJvdmlkZXJzIGFuZCBnZXQgYWNjZXNzIHRvIHRoZSBwcm92aWRlZCByZXNvdXJjZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBSZXNvdXJjZUNvbnRleHQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSByZXNvdXJjZXM6IE1hcDxzdHJpbmcsIElDb25zdHJ1Y3Q+ID0gbmV3IE1hcCgpO1xuXG4gICAgY29uc3RydWN0b3IocHVibGljIHJlYWRvbmx5IHNjb3BlOiBjZGsuU3RhY2ssIHB1YmxpYyByZWFkb25seSBibHVlcHJpbnRQcm9wczogRWtzQmx1ZXByaW50UHJvcHMpIHsgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIG5ldyByZXNvdXJjZSBwcm92aWRlciBhbmQgc3BlY2lmaWVzIHRoZSBuYW1lIHVuZGVyIHdoaWNoIHRoZSBwcm92aWRlZCByZXNvdXJjZSB3aWxsIGJlIHJlZ2lzdGVyZWQsXG4gICAgICogQHBhcmFtIG5hbWUgU3BlY2lmaWVzIHRoZSBuYW1lIGtleSB1bmRlciB3aGljaCB0aGUgcHJvdmlkZWQgcmVzb3VyY2VzIHdpbGwgYmUgcmVnaXN0ZXJlZCBmb3Igc3Vic2VxdWVudCBsb29rLXVwcy5cbiAgICAgKiBAcGFyYW0gcHJvdmlkZXIgSW1wbGVtZW50YXRpb24gb2YgdGhlIHJlc291cmNlIHByb3ZpZGVyIGludGVyZmFjZVxuICAgICAqIEByZXR1cm5zIHRoZSBwcm92aWRlZCByZXNvdXJjZVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGQ8VCBleHRlbmRzIElDb25zdHJ1Y3Q+KG5hbWU6IHN0cmluZywgcHJvdmlkZXI6IFJlc291cmNlUHJvdmlkZXI8VD4pOiBUIHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBwcm92aWRlci5wcm92aWRlKHRoaXMpO1xuICAgICAgICBhc3NlcnQoIXRoaXMucmVzb3VyY2VzLmhhcyhuYW1lKSwgYE92ZXJ3cml0aW5nICR7bmFtZX0gcmVzb3VyY2UgZHVyaW5nIGV4ZWN1dGlvbiBpcyBub3QgYWxsb3dlZC5gKTtcbiAgICAgICAgdGhpcy5yZXNvdXJjZXMuc2V0KG5hbWUsIHJlc291cmNlKTtcbiAgICAgICAgcmV0dXJuIHJlc291cmNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHByb3ZpZGVkIHJlc291cmNlIGJ5IHRoZSBzdXBwbGllZCBuYW1lLlxuICAgICAqIEBwYXJhbSBuYW1lIHVuZGVyIHdoaWNoIHRoZSByZXNvdXJjZSBwcm92aWRlciB3YXMgcmVnaXN0ZXJlZFxuICAgICAqIEByZXR1cm5zIHRoZSByZXNvdXJjZSBvciB1bmRlZmluZWQgaWYgdGhlIHNwZWNpZmllZCByZXNvdXJjZSB3YXMgbm90IGZvdW5kXG4gICAgICovXG4gICAgcHVibGljIGdldDxUIGV4dGVuZHMgSUNvbnN0cnVjdCA9IElDb25zdHJ1Y3Q+KG5hbWU6IHN0cmluZyk6IFQgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gPFQ+dGhpcy5yZXNvdXJjZXMuZ2V0KG5hbWUpO1xuICAgIH1cbn1cblxuZXhwb3J0IGVudW0gR2xvYmFsUmVzb3VyY2VzIHtcbiAgICBWcGMgPSAndnBjJyxcbiAgICBIb3N0ZWRab25lID0gJ2hvc3RlZC16b25lJyxcbiAgICBDZXJ0aWZpY2F0ZSA9ICdjZXJ0aWZpY2F0ZScsXG4gICAgS21zS2V5ID0gJ2ttcy1rZXknLFxuICAgIEFtcCA9ICdhbXAnLFxufVxuXG4vKipcbiAqIENsdXN0ZXIgaW5mbyBzdXBwbGllcyByZXF1aXJlZCBpbmZvcm1hdGlvbiBvbiB0aGUgY2x1c3RlciBjb25maWd1cmF0aW9uLCByZWdpc3RlcmVkIHJlc291cmNlcyBhbmQgYWRkLW9uc1xuICogd2hpY2ggY291bGQgYmUgbGV2ZXJhZ2VkIGJ5IHRoZSBmcmFtZXdvcmssIGFkZC1vbiBpbXBsZW1lbnRhdGlvbnMgYW5kIHRlYW1zLlxuICovXG5leHBvcnQgY2xhc3MgQ2x1c3RlckluZm8ge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm92aXNpb25lZEFkZE9uczogTWFwPHN0cmluZywgQ29uc3RydWN0PjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNjaGVkdWxlZEFkZE9uczogTWFwPHN0cmluZywgUHJvbWlzZTxDb25zdHJ1Y3Q+PjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9yZGVyZWRBZGRPbnM6IHN0cmluZ1tdO1xuICAgIHByaXZhdGUgcmVzb3VyY2VDb250ZXh0OiBSZXNvdXJjZUNvbnRleHQ7XG4gICAgcHJpdmF0ZSBhZGRvbkNvbnRleHQ6IE1hcDxzdHJpbmcsIFZhbHVlcz47XG5cbiAgICAvKipcbiAgICAgKiBDb25zdHJ1Y3RvciBmb3IgQ2x1c3RlckluZm9cbiAgICAgKiBAcGFyYW0gcHJvcHNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSBjbHVzdGVyOiBla3MuSUNsdXN0ZXIsIHJlYWRvbmx5IHZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbixcbiAgICAgICAgcmVhZG9ubHkgbm9kZUdyb3Vwcz86IGVrcy5Ob2RlZ3JvdXBbXSwgcmVhZG9ubHkgYXV0b3NjYWxpbmdHcm91cHM/OiBBdXRvU2NhbGluZ0dyb3VwW10sIHJlYWRvbmx5IGZhcmdhdGVQcm9maWxlcz86IGVrcy5GYXJnYXRlUHJvZmlsZVtdKSB7XG4gICAgICAgIHRoaXMuY2x1c3RlciA9IGNsdXN0ZXI7XG4gICAgICAgIHRoaXMucHJvdmlzaW9uZWRBZGRPbnMgPSBuZXcgTWFwPHN0cmluZywgQ29uc3RydWN0PigpO1xuICAgICAgICB0aGlzLnNjaGVkdWxlZEFkZE9ucyA9IG5ldyBNYXA8c3RyaW5nLCBQcm9taXNlPENvbnN0cnVjdD4+KCk7XG4gICAgICAgIHRoaXMub3JkZXJlZEFkZE9ucyA9IFtdO1xuICAgICAgICB0aGlzLmFkZG9uQ29udGV4dCA9IG5ldyBNYXA8c3RyaW5nLCBWYWx1ZXM+KCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJvdmlkZXMgdGhlIHJlc291cmNlIGNvbnRleHQgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGluc3RhbmNlIG9mIHRoZSBFS1MgQmx1ZXByaW50LlxuICAgICAqIEByZXR1cm5zIHJlc291cmNlIGNvbnRleHQgb2JqZWN0XG4gICAgICovXG4gICAgcHVibGljIGdldFJlc291cmNlQ29udGV4dCgpOiBSZXNvdXJjZUNvbnRleHQge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXNvdXJjZUNvbnRleHQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5qZWN0aW9uIG1ldGhvZCB0byBwcm92aWRlIHJlc291cmNlIGNvbnRleHQuXG4gICAgICogQHBhcmFtIHJlc291cmNlQ29udGV4dFxuICAgICAqL1xuICAgIHB1YmxpYyBzZXRSZXNvdXJjZUNvbnRleHQocmVzb3VyY2VDb250ZXh0OiBSZXNvdXJjZUNvbnRleHQpIHtcbiAgICAgICAgdGhpcy5yZXNvdXJjZUNvbnRleHQgPSByZXNvdXJjZUNvbnRleHQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIHByb3Zpc2lvbmVkQWRkT25zIG1hcFxuICAgICAqIEBwYXJhbSBhZGRPblxuICAgICAqIEBwYXJhbSBjb25zdHJ1Y3RcbiAgICAgKi9cbiAgICBwdWJsaWMgYWRkUHJvdmlzaW9uZWRBZGRPbihhZGRPbjogc3RyaW5nLCBjb25zdHJ1Y3Q6IENvbnN0cnVjdCkge1xuICAgICAgICB0aGlzLm9yZGVyZWRBZGRPbnMuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByb3Zpc2lvbmVkT3JkZXJlZCA9IHRoaXMucHJvdmlzaW9uZWRBZGRPbnMuZ2V0KGUpO1xuICAgICAgICAgICAgaWYocHJvdmlzaW9uZWRPcmRlcmVkKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGBBZGRpbmcgZGVwZW5kZW5jeSBmcm9tICR7YWRkT259IHRvICR7ZX1gKTtcbiAgICAgICAgICAgICAgICBjb25zdHJ1Y3Qubm9kZS5hZGREZXBlbmRlbmN5KHByb3Zpc2lvbmVkT3JkZXJlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnByb3Zpc2lvbmVkQWRkT25zLnNldChhZGRPbiwgY29uc3RydWN0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHaXZlbiB0aGUgYWRkT24gbmFtZSwgcmV0dXJuIHRoZSBwcm92aXNpb25lZCBhZGRPbiBjb25zdHJ1Y3RcbiAgICAgKiBAcGFyYW0gYWRkT25cbiAgICAgKiBAcmV0dXJucyB1bmRlZmluZWRcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0UHJvdmlzaW9uZWRBZGRPbihhZGRPbjogc3RyaW5nKTogQ29uc3RydWN0IHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdmlzaW9uZWRBZGRPbnMuZ2V0KGFkZE9uKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGFsbCBwcm92aXNpb25lZCBhZGRvbnNcbiAgICAgKiBAcmV0dXJucyBzY2hlZHVsZWRBZGRPbnM6IE1hcDxzdHJpbmcsIGNkay5Db25zdHJ1Y3Q+XG4gICAgICovXG4gICAgcHVibGljIGdldEFsbFByb3Zpc2lvbmVkQWRkb25zKCk6IE1hcDxzdHJpbmcsIENvbnN0cnVjdD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm92aXNpb25lZEFkZE9ucztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgdGhlIHByZVByb3Zpc2lvbmVkQWRkT24gbWFwIHdpdGggdGhlIHByb21pc2UgZm9yIHRoZSBjb25zdHJ1Y3RcbiAgICAgKiBvZiB0aGUgYWRkb24gYmVpbmcgcHJvdmlzaW9uZWRcbiAgICAgKiBAcGFyYW0gYWRkT25cbiAgICAgKiBAcGFyYW0gcHJvbWlzZVxuICAgICAqIEBwYXJhbSBvcmRlcmVkIGlmIGFkZG9uIGRlcGVuZHMgb24gcHJldmlvdXMgYWRkb25zIGZvciBjb21wbGV0aW9uIChydW5zIHNlcmlhbGx5KVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRTY2hlZHVsZWRBZGRPbihhZGRPbjogc3RyaW5nLCBwcm9taXNlOiBQcm9taXNlPENvbnN0cnVjdD4sIG9yZGVyZWQ6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5zY2hlZHVsZWRBZGRPbnMuc2V0KGFkZE9uLCBwcm9taXNlKTtcbiAgICAgICAgaWYgKG9yZGVyZWQpIHtcbiAgICAgICAgICAgIHRoaXMub3JkZXJlZEFkZE9ucy5wdXNoKGFkZE9uKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluZGljYXRlcyBpZiBzdHJpY3Qgb3JkZXJpbmcgaXMgYXBwbGllZCB0byB0aGUgYWRkb25cbiAgICAgKiBAcGFyYW0gYWRkT24gYWRkT24ga2V5XG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgcHVibGljIGlzT3JkZXJlZEFkZE9uKGFkZE9uOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3JkZXJlZEFkZE9ucy5pbmNsdWRlcyhhZGRPbik7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBwcm9taXNlIGZvciB0aGUgQWRkb24gY29uc3RydWN0XG4gICAgICogQHBhcmFtIGFkZE9uXG4gICAgICogQHJldHVybnMgUHJvbWlzZTxjZGsuQ29uc3RydWN0PlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRTY2hlZHVsZWRBZGRPbihhZGRPbjogc3RyaW5nKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2NoZWR1bGVkQWRkT25zLmdldChhZGRPbik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBhbGwgc2NoZWR1bGVkIGFkZG9uc1xuICAgICAqIEByZXR1cm5zIHNjaGVkdWxlZEFkZE9uczogTWFwPHN0cmluZywgUHJvbWlzZTxjZGsuQ29uc3RydWN0Pj5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0QWxsU2NoZWR1bGVkQWRkb25zKCk6IE1hcDxzdHJpbmcsIFByb21pc2U8Q29uc3RydWN0Pj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zY2hlZHVsZWRBZGRPbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJvdmlkZXMgdGhlIHJlc291cmNlIHJlZ2lzdGVyZWQgdW5kZXIgc3VwcGxpZWQgbmFtZVxuICAgICAqIEBwYXJhbSBuYW1lIG9mIHRoZSByZXNvdXJjZSB0byBiZSByZXR1cm5lZFxuICAgICAqIEByZXR1cm5zIFJlc291cmNlIG9iamVjdCBvciB1bmRlZmluZWQgaWYgbm8gcmVzb3VyY2Ugd2FzIGZvdW5kXG4gICAgICovXG4gICAgcHVibGljIGdldFJlc291cmNlPFQgZXh0ZW5kcyBjZGsuSVJlc291cmNlPihuYW1lOiBzdHJpbmcpOiBUIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzb3VyY2VDb250ZXh0LmdldDxUPihuYW1lKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTYW1lIGFzIHtAbGluayBnZXRSZXNvdXJjZX0gYnV0IHdpbGwgZmFpbCBpZiB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGlzIG5vdCBmb3VuZFxuICAgICAqIEBwYXJhbSBuYW1lIG9mIHRoZSByZXNvdXJjZSB0byBiZSByZXR1cm5lZFxuICAgICAqIEByZXR1cm5zIFJlc291cmNlIG9iamVjdCAoZmFpbHMgaWYgbm90IGZvdW5kKVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRSZXF1aXJlZFJlc291cmNlPFQgZXh0ZW5kcyBjZGsuSVJlc291cmNlPihuYW1lOiBzdHJpbmcpOiBUIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5yZXNvdXJjZUNvbnRleHQuZ2V0PFQ+KG5hbWUpO1xuICAgICAgICBhc3NlcnQocmVzdWx0LCAnUmVxdWlyZWQgcmVzb3VyY2UgJyArIG5hbWUgKyAnIGlzIG1pc3NpbmcuJyk7XG4gICAgICAgIHJldHVybiByZXN1bHQhO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhZGRvbkNvbnRleHQgbWFwXG4gICAgICogQHBhcmFtIGFkZE9uXG4gICAgICogQHBhcmFtIFZhbHVlc1xuICAgICAqL1xuICAgIHB1YmxpYyBhZGRBZGRPbkNvbnRleHQoYWRkT246IHN0cmluZywgdmFsdWVzOiBWYWx1ZXMpIHtcbiAgICAgICAgdGhpcy5hZGRvbkNvbnRleHQuc2V0KGFkZE9uLCB2YWx1ZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICogUmV0dXJucyBhbGwgYWRkb24gY29udGV4dHNcbiAgICAqIEByZXR1cm5zIGFkZG9uQ29udGV4dDogTWFwPHN0cmluZywgVmFsdWVzPlxuICAgICovXG4gICAgcHVibGljIGdldEFkZE9uQ29udGV4dHMoKTogTWFwPHN0cmluZywgVmFsdWVzPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZG9uQ29udGV4dDtcbiAgICB9XG59XG5cbi8qKlxuICogRW51bSB0eXBlIGZvciB0d28gZGlmZmVyZW50IEdpdE9wcyBvcGVyYXRpbmcgbW9kZXNcbiAqL1xuZXhwb3J0IGVudW0gR2l0T3BzTW9kZSB7XG4gICAgLyoqXG4gICAgICogQ0RLIGRlcGxveXMgdGhlIGBBcHBsaWNhdGlvbmAgcmVzb3VyY2UgZm9yIGVhY2ggQWRkT24gZW5hYmxlZCBvciBjdXN0b21lciB3b3JrbG9hZHMsXG4gICAgICogYW5kIEFyZ29DRCBkZXBsb3lzIHRoZSBhY3R1YWwgQWRkT24gYW5kIHdvcmtsb2FkcyB2aWEgR2l0T3BzIGJhc2VkIG9uIHRoZSBgQXBwbGljYXRpb25gIHJlc291cmNlLlxuICAgICAqL1xuICAgIEFQUExJQ0FUSU9OLFxuICAgIC8qKlxuICAgICAqIENESyBkZXBsb3lzIG9ubHkgb25lIGBBcHBsaWNhdGlvbmAgcmVzb3VyY2UgZm9yIHRoZSBBcHAgb2YgQXBwcywgYWthIGBib290c3RyYXAtYXBwc2AsXG4gICAgICogYW5kIEFyZ29DRCBkZXBsb3lzIGFsbCB0aGUgQWRkT25zIGJhc2VkIG9uIHRoZSBjaGlsZCBgQXBwbGljYXRpb25gIGRlZmluZWQgaW4gYGJvb3RzdHJhcC1hcHBzYC5cbiAgICAgKi9cbiAgICBBUFBfT0ZfQVBQU1xufVxuIl19