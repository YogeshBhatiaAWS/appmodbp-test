"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FluxCDAddOn = void 0;
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const gitrepository_1 = require("./gitrepository");
const kustomization_1 = require("./kustomization");
/**
 * Default props to be used when creating the Helm chart
 */
const defaultProps = {
    name: "fluxcd-addon",
    namespace: "flux-system",
    chart: "flux2",
    version: "2.9.2",
    release: "blueprints-fluxcd-addon",
    repository: "https://fluxcd-community.github.io/helm-charts",
    values: {},
    createNamespace: true,
};
const defaultRepoProps = {
    syncInterval: "5m0s",
};
const defaultKustomiationProps = {
    kustomizationPath: ".",
    syncInterval: "5m0s",
    prune: true,
    timeout: "1m",
};
/**
 * Main class to instantiate the Helm chart
 */
class FluxCDAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b;
        const cluster = clusterInfo.cluster;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        values = (0, ts_deepmerge_1.default)(values, (_b = this.props.values) !== null && _b !== void 0 ? _b : {});
        const chart = this.addHelmChart(clusterInfo, values);
        if (this.options.createNamespace == true) {
            // Let CDK Create the Namespace
            const namespace = (0, utils_1.createNamespace)(this.options.namespace, cluster);
            chart.node.addDependency(namespace);
        }
        //Create GitRepository sources and Kustomizations
        if (this.options.repositories) {
            this.options.repositories.map((repo) => {
                repo = { ...defaultRepoProps, ...repo };
                const gitRepositoryConstruct = createGitRepository(clusterInfo, this.options.name, this.options.namespace, repo);
                gitRepositoryConstruct.node.addDependency(chart);
                const kustomizationConstructs = createKustomizations(clusterInfo, this.options.name, this.options.namespace, repo);
                kustomizationConstructs.map(kustomizationConstruct => kustomizationConstruct.node.addDependency(gitRepositoryConstruct));
            });
        }
        return Promise.resolve(chart);
    }
}
exports.FluxCDAddOn = FluxCDAddOn;
/**
 * create GitRepository calls the FluxGitRepository().generate to create GitRepostory resource.
 */
function createGitRepository(clusterInfo, name, namespace, fluxGitRepo) {
    var _a;
    if (fluxGitRepo.repository === undefined) {
        throw new Error("Missing Git repository");
    }
    const manifest = new gitrepository_1.FluxGitRepository(fluxGitRepo.repository).generate(fluxGitRepo.name, (_a = fluxGitRepo.namespace) !== null && _a !== void 0 ? _a : namespace, fluxGitRepo.syncInterval, fluxGitRepo.secretRefName);
    let manifestName = name + 'gitrepository' + fluxGitRepo.name;
    const construct = clusterInfo.cluster.addManifest(manifestName, manifest);
    return construct;
}
/**
 * create Kustomizations calls the FluxKustomization().generate multiple times to create Kustomization resources.
 */
function createKustomizations(clusterInfo, name, namespace, fluxGitRepo) {
    var _a;
    const constructs = [];
    const kustomizations = (_a = fluxGitRepo.kustomizations) !== null && _a !== void 0 ? _a : [{ kustomizationPath: "." }];
    const fluxKustomization = new kustomization_1.FluxKustomization();
    kustomizations === null || kustomizations === void 0 ? void 0 : kustomizations.map((kustomization, index) => {
        var _a;
        kustomization = { ...defaultKustomiationProps, ...kustomization };
        const manifest = fluxKustomization.generate(fluxGitRepo.name + "-" + index, fluxGitRepo.name, (_a = fluxGitRepo.namespace) !== null && _a !== void 0 ? _a : namespace, kustomization.syncInterval, kustomization.prune, kustomization.timeout, fluxGitRepo.values, kustomization.kustomizationPath, kustomization.kustomizationTargetNamespace);
        let manifestName = name + 'kustomization' + fluxGitRepo.name + index;
        constructs.push(clusterInfo.cluster.addManifest(manifestName, manifest));
    });
    return constructs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2ZsdXhjZC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwrQ0FBaUM7QUFHakMsdUNBQThDO0FBQzlDLDhDQUE4RTtBQUM5RSxtREFBb0Q7QUFDcEQsbURBQW9EO0FBa0ZwRDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFzQztJQUN0RCxJQUFJLEVBQUUsY0FBYztJQUNwQixTQUFTLEVBQUUsYUFBYTtJQUN4QixLQUFLLEVBQUUsT0FBTztJQUNkLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLE9BQU8sRUFBRSx5QkFBeUI7SUFDbEMsVUFBVSxFQUFFLGdEQUFnRDtJQUM1RCxNQUFNLEVBQUUsRUFBRTtJQUNWLGVBQWUsRUFBRSxJQUFJO0NBQ3RCLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUF5QjtJQUMzQyxZQUFZLEVBQUUsTUFBTTtDQUN2QixDQUFDO0FBRUYsTUFBTSx3QkFBd0IsR0FBMkI7SUFDckQsaUJBQWlCLEVBQUUsR0FBRztJQUN0QixZQUFZLEVBQUUsTUFBTTtJQUNwQixLQUFLLEVBQUUsSUFBSTtJQUNYLE9BQU8sRUFBRSxJQUFJO0NBQ2hCLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQWEsV0FBWSxTQUFRLHNCQUFTO0lBSXhDLFlBQVksS0FBd0I7UUFDbEMsS0FBSyxDQUFDLEVBQUMsR0FBRyxZQUFZLEVBQUUsR0FBRyxLQUFLLEVBQUMsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQXlCLENBQUM7SUFDaEQsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUF3Qjs7UUFDN0IsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFJLE1BQU0sR0FBVyxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxtQ0FBSSxFQUFFLENBQUM7UUFDL0MsTUFBTSxHQUFHLElBQUEs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QUFFLEdBQUcsQ0FBQyxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsRUFBRTs7UUFDM0MsYUFBYSxHQUFHLEVBQUMsR0FBRyx3QkFBd0IsRUFBRSxHQUFHLGFBQWEsRUFBQyxDQUFDO1FBQ2hFLE1BQU0sUUFBUSxHQUFFLGlCQUFpQixDQUFDLFFBQVEsQ0FDeEMsV0FBVyxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsS0FBSyxFQUM5QixXQUFXLENBQUMsSUFBSSxFQUNoQixNQUFBLFdBQVcsQ0FBQyxTQUFTLG1DQUFJLFNBQVMsRUFDbEMsYUFBYSxDQUFDLFlBQWEsRUFDM0IsYUFBYSxDQUFDLEtBQU0sRUFDcEIsYUFBYSxDQUFDLE9BQVEsRUFDdEIsV0FBVyxDQUFDLE1BQU0sRUFDbEIsYUFBYSxDQUFDLGlCQUFpQixFQUMvQixhQUFhLENBQUMsNEJBQTRCLENBQzNDLENBQUM7UUFDRixJQUFJLFlBQVksR0FBdUIsSUFBSSxHQUFHLGVBQWUsR0FBRSxXQUFXLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUN4RixVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFlBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBRTVFLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGxpYi9mbHV4Y2RfYWRkb24udHNcclxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tIFwidHMtZGVlcG1lcmdlXCI7XHJcbmltcG9ydCAqIGFzIHNwaSBmcm9tIFwiLi4vLi4vc3BpXCI7XHJcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tIFwiLi4vLi4vc3BpXCI7XHJcbmltcG9ydCB7IGNyZWF0ZU5hbWVzcGFjZSB9IGZyb20gXCIuLi8uLi91dGlsc1wiO1xyXG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblByb3BzLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xyXG5pbXBvcnQgeyBGbHV4R2l0UmVwb3NpdG9yeSB9IGZyb20gXCIuL2dpdHJlcG9zaXRvcnlcIjtcclxuaW1wb3J0IHsgRmx1eEt1c3RvbWl6YXRpb24gfSBmcm9tIFwiLi9rdXN0b21pemF0aW9uXCI7XHJcbmltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MvbGliL2s4cy1tYW5pZmVzdCc7XHJcblxyXG4vKipcclxuICogT3B0aW9ucyBmb3IgYSBGbHV4Q0QgR2l0UmVwb3NpdG9yeVxyXG4gKiBwYXRoIGFuZCBuYW1lIHBhcmFtZXRlciB3aXRoaW4gcmVwb3NpdG9yeSBwYXJhbWV0ZXIgZG8gbm90IGhhdmUgYW55IGFmZmVjdCBpbiBmbHV4LCBtYXkgaGF2ZSBhbiBhZmZlY3QgaW4gYXJnb1xyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBGbHV4R2l0UmVwbyBleHRlbmRzIFJlcXVpcmVkPHNwaS5HaXRPcHNBcHBsaWNhdGlvbkRlcGxveW1lbnQ+IHtcclxuICAvKiogXHJcbiAgKiBGbHV4IFNlY3JldFJlZiAqL1xyXG4gIHNlY3JldFJlZk5hbWU/OiBzdHJpbmc7XHJcblxyXG4gIC8qKiBcclxuICAqIEludGVybmFsIGZvciBGbHV4IHN5bmMuXHJcbiAgKiBEZWZhdWx0IGA1bTBzYCAqL1xyXG4gIHN5bmNJbnRlcnZhbD86IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgKiBMaXN0IG9mIGt1c3RvbWl6YXRpb25zIHRvIGNyZWF0ZSBmcm9tIGRpZmZlcmVudCBwYXRocyBpbiByZXBvLiAqL1xyXG4gIGt1c3RvbWl6YXRpb25zPzogRmx1eEt1c3RvbWl6YXRpb25Qcm9wc1tdO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZsdXhLdXN0b21pemF0aW9uUHJvcHMge1xyXG4gICAgLyoqXHJcbiAgICAgKiBGbHV4IEt1c3RvbWl6YXRpb24gcGF0aCB3aXRoaW4gdGhlIEdpdFJlcG9zaXRvcnkgXHJcbiAgICAgKiBEbyBub3QgdXNlIHRoZSBwYXRoIGluIHRoZSByZXBvc2l0b3J5IGZpZWxkKi9cclxuICAgIGt1c3RvbWl6YXRpb25QYXRoOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIFxyXG4gICAgKiBGbHV4IEt1c3RvbWl6YXRpb24gVGFyZ2V0IE5hbWVzcGFjZS5cclxuICAgICogTm90ZTogd2hlbiBzZXQsIHRoaXMgcGFyYW1ldGVyIHdpbGwgb3ZlcnJpZGUgYWxsIHRoZSBvYmplY3RzIHRoYXQgYXJlIHBhcnQgb2YgdGhlIEt1c3RvbWl6YXRpb24sIHBsZWFzZSBzZWUgaHR0cHM6Ly9mbHV4Y2QuaW8vZmx1eC9jb21wb25lbnRzL2t1c3RvbWl6ZS9rdXN0b21pemF0aW9uLyN0YXJnZXQtbmFtZXNwYWNlICovXHJcbiAgICBrdXN0b21pemF0aW9uVGFyZ2V0TmFtZXNwYWNlPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKiBcclxuICAgICogSW50ZXJuYWwgZm9yIEZsdXggc3luYy5cclxuICAgICogRGVmYXVsdCBgNW0wc2AgKi9cclxuICAgIHN5bmNJbnRlcnZhbD86IHN0cmluZztcclxuXHJcbiAgICAvKiogXHJcbiAgICAqIEZsdXggS3VzdG9taXphdGlvbiBQcnVuZS5cclxuICAgICogRGVmYXVsdCBgdHJ1ZWAgKi9cclxuICAgIHBydW5lPzogYm9vbGVhbjtcclxuXHJcbiAgICAvKiogXHJcbiAgICAqIEZsdXggS3VzdG9taXphdGlvbiBUaW1lb3V0LlxyXG4gICAgKiBEZWZhdWx0IGAxbWAgKi9cclxuICAgIHRpbWVvdXQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBVc2VyIHByb3ZpZGVkIG9wdGlvbnMgZm9yIHRoZSBIZWxtIENoYXJ0XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEZsdXhDREFkZE9uUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMge1xyXG5cclxuICAvKipcclxuICAgKiBOYW1lc3BhY2Ugd2hlcmUgYWRkLW9uIHdpbGwgYmUgZGVwbG95ZWQuIFxyXG4gICAqIEBkZWZhdWx0IGZsdXgtc3lzdGVtXHJcbiAgICovXHJcbiAgbmFtZXNwYWNlPzogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAqIEhlbG0gY2hhcnQgdmVyc2lvbiB0byB1c2UgdG8gaW5zdGFsbC5cclxuICAqIEBkZWZhdWx0IDIuOC4wXHJcbiAgKi9cclxuICB2ZXJzaW9uPzogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBWYWx1ZXMgdG8gcGFzcyB0byB0aGUgY2hhcnQgYXMgcGVyIGh0dHBzOi8vZ2l0aHViLmNvbS9hcmdvcHJvai9hcmdvLWhlbG0vYmxvYi9tYXN0ZXIvY2hhcnRzL2FyZ28tY2QvdmFsdWVzLnlhbWwuXHJcbiAgICovXHJcbiAgdmFsdWVzPzogc3BpLlZhbHVlcztcclxuXHJcbiAgLyoqXHJcbiAgICogVG8gQ3JlYXRlIE5hbWVzcGFjZSB1c2luZyBDREtcclxuICAgKi8gICAgXHJcbiAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbjtcclxuXHJcbiAgLyoqXHJcbiAgICogTGlzdCBvZiByZXBvc2l0b3JpZXMgdG8gc3luYyBmcm9tLlxyXG4gICAqL1xyXG4gIHJlcG9zaXRvcmllcz86IEZsdXhHaXRSZXBvW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEZWZhdWx0IHByb3BzIHRvIGJlIHVzZWQgd2hlbiBjcmVhdGluZyB0aGUgSGVsbSBjaGFydFxyXG4gKi9cclxuY29uc3QgZGVmYXVsdFByb3BzOiBIZWxtQWRkT25Qcm9wcyAmIEZsdXhDREFkZE9uUHJvcHMgPSB7XHJcbiAgbmFtZTogXCJmbHV4Y2QtYWRkb25cIixcclxuICBuYW1lc3BhY2U6IFwiZmx1eC1zeXN0ZW1cIixcclxuICBjaGFydDogXCJmbHV4MlwiLFxyXG4gIHZlcnNpb246IFwiMi45LjJcIixcclxuICByZWxlYXNlOiBcImJsdWVwcmludHMtZmx1eGNkLWFkZG9uXCIsXHJcbiAgcmVwb3NpdG9yeTogXCJodHRwczovL2ZsdXhjZC1jb21tdW5pdHkuZ2l0aHViLmlvL2hlbG0tY2hhcnRzXCIsXHJcbiAgdmFsdWVzOiB7fSxcclxuICBjcmVhdGVOYW1lc3BhY2U6IHRydWUsXHJcbn07XHJcblxyXG5jb25zdCBkZWZhdWx0UmVwb1Byb3BzOiBQYXJ0aWFsPEZsdXhHaXRSZXBvPiA9IHtcclxuICAgIHN5bmNJbnRlcnZhbDogXCI1bTBzXCIsXHJcbn07XHJcblxyXG5jb25zdCBkZWZhdWx0S3VzdG9taWF0aW9uUHJvcHM6IEZsdXhLdXN0b21pemF0aW9uUHJvcHMgPSB7XHJcbiAgICBrdXN0b21pemF0aW9uUGF0aDogXCIuXCIsXHJcbiAgICBzeW5jSW50ZXJ2YWw6IFwiNW0wc1wiLFxyXG4gICAgcHJ1bmU6IHRydWUsXHJcbiAgICB0aW1lb3V0OiBcIjFtXCIsXHJcbn07XHJcblxyXG4vKipcclxuICogTWFpbiBjbGFzcyB0byBpbnN0YW50aWF0ZSB0aGUgSGVsbSBjaGFydFxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEZsdXhDREFkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcclxuXHJcbiAgcmVhZG9ubHkgb3B0aW9uczogRmx1eENEQWRkT25Qcm9wcztcclxuXHJcbiAgY29uc3RydWN0b3IocHJvcHM/OiBGbHV4Q0RBZGRPblByb3BzKSB7XHJcbiAgICBzdXBlcih7Li4uZGVmYXVsdFByb3BzLCAuLi5wcm9wc30pO1xyXG4gICAgdGhpcy5vcHRpb25zID0gdGhpcy5wcm9wcyBhcyBGbHV4Q0RBZGRPblByb3BzO1xyXG4gIH1cclxuXHJcbiAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XHJcbiAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcclxuICAgIGxldCB2YWx1ZXM6IFZhbHVlcyA9IHRoaXMub3B0aW9ucy52YWx1ZXMgPz8ge307XHJcbiAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHRoaXMucHJvcHMudmFsdWVzID8/IHt9KTtcclxuICAgIGNvbnN0IGNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIHZhbHVlcyk7XHJcblxyXG4gICAgaWYoIHRoaXMub3B0aW9ucy5jcmVhdGVOYW1lc3BhY2UgPT0gdHJ1ZSl7XHJcbiAgICAgIC8vIExldCBDREsgQ3JlYXRlIHRoZSBOYW1lc3BhY2VcclxuICAgICAgY29uc3QgbmFtZXNwYWNlID0gY3JlYXRlTmFtZXNwYWNlKHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhICwgY2x1c3Rlcik7XHJcbiAgICAgIGNoYXJ0Lm5vZGUuYWRkRGVwZW5kZW5jeShuYW1lc3BhY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vQ3JlYXRlIEdpdFJlcG9zaXRvcnkgc291cmNlcyBhbmQgS3VzdG9taXphdGlvbnNcclxuICAgIGlmICh0aGlzLm9wdGlvbnMucmVwb3NpdG9yaWVzKSB7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLnJlcG9zaXRvcmllcy5tYXAoKHJlcG8pID0+IHtcclxuICAgICAgICAgICAgcmVwbyA9IHsuLi5kZWZhdWx0UmVwb1Byb3BzLCAuLi5yZXBvfTtcclxuICAgICAgICAgICAgY29uc3QgZ2l0UmVwb3NpdG9yeUNvbnN0cnVjdCA9IGNyZWF0ZUdpdFJlcG9zaXRvcnkoY2x1c3RlckluZm8sIHRoaXMub3B0aW9ucy5uYW1lISwgdGhpcy5vcHRpb25zLm5hbWVzcGFjZSEsIHJlcG8pO1xyXG4gICAgICAgICAgICBnaXRSZXBvc2l0b3J5Q29uc3RydWN0Lm5vZGUuYWRkRGVwZW5kZW5jeShjaGFydCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBrdXN0b21pemF0aW9uQ29uc3RydWN0cyA9IGNyZWF0ZUt1c3RvbWl6YXRpb25zKGNsdXN0ZXJJbmZvLCB0aGlzLm9wdGlvbnMubmFtZSEsIHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLCByZXBvKTtcclxuICAgICAgICAgICAga3VzdG9taXphdGlvbkNvbnN0cnVjdHMubWFwKGt1c3RvbWl6YXRpb25Db25zdHJ1Y3QgPT4ga3VzdG9taXphdGlvbkNvbnN0cnVjdC5ub2RlLmFkZERlcGVuZGVuY3koZ2l0UmVwb3NpdG9yeUNvbnN0cnVjdCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNoYXJ0KTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBjcmVhdGUgR2l0UmVwb3NpdG9yeSBjYWxscyB0aGUgRmx1eEdpdFJlcG9zaXRvcnkoKS5nZW5lcmF0ZSB0byBjcmVhdGUgR2l0UmVwb3N0b3J5IHJlc291cmNlLlxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlR2l0UmVwb3NpdG9yeShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIG5hbWU6IHN0cmluZywgbmFtZXNwYWNlOiBzdHJpbmcsIGZsdXhHaXRSZXBvOiBGbHV4R2l0UmVwbyk6IEt1YmVybmV0ZXNNYW5pZmVzdCB7XHJcbiAgaWYgKGZsdXhHaXRSZXBvLnJlcG9zaXRvcnkgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTWlzc2luZyBHaXQgcmVwb3NpdG9yeVwiKTtcclxuICB9XHJcbiAgXHJcbiAgY29uc3QgbWFuaWZlc3QgPSBuZXcgRmx1eEdpdFJlcG9zaXRvcnkoZmx1eEdpdFJlcG8ucmVwb3NpdG9yeSkuZ2VuZXJhdGUoXHJcbiAgICAgICAgZmx1eEdpdFJlcG8ubmFtZSxcclxuICAgICAgICBmbHV4R2l0UmVwby5uYW1lc3BhY2UgPz8gbmFtZXNwYWNlLFxyXG4gICAgICAgIGZsdXhHaXRSZXBvLnN5bmNJbnRlcnZhbCEsXHJcbiAgICAgICAgZmx1eEdpdFJlcG8uc2VjcmV0UmVmTmFtZSEpO1xyXG4gIGxldCBtYW5pZmVzdE5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCA9IG5hbWUgKyAnZ2l0cmVwb3NpdG9yeScgKyBmbHV4R2l0UmVwby5uYW1lO1xyXG4gIGNvbnN0IGNvbnN0cnVjdCA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXIuYWRkTWFuaWZlc3QobWFuaWZlc3ROYW1lISwgbWFuaWZlc3QpO1xyXG4gIHJldHVybiBjb25zdHJ1Y3Q7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBjcmVhdGUgS3VzdG9taXphdGlvbnMgY2FsbHMgdGhlIEZsdXhLdXN0b21pemF0aW9uKCkuZ2VuZXJhdGUgbXVsdGlwbGUgdGltZXMgdG8gY3JlYXRlIEt1c3RvbWl6YXRpb24gcmVzb3VyY2VzLlxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlS3VzdG9taXphdGlvbnMoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZTogc3RyaW5nLCBmbHV4R2l0UmVwbzogRmx1eEdpdFJlcG8pOiBLdWJlcm5ldGVzTWFuaWZlc3RbXSB7XHJcbiAgY29uc3QgY29uc3RydWN0czogS3ViZXJuZXRlc01hbmlmZXN0W10gPSBbXTtcclxuICBjb25zdCBrdXN0b21pemF0aW9ucyA9IGZsdXhHaXRSZXBvLmt1c3RvbWl6YXRpb25zID8/IFt7a3VzdG9taXphdGlvblBhdGg6IFwiLlwifV07XHJcbiAgY29uc3QgZmx1eEt1c3RvbWl6YXRpb24gPSBuZXcgRmx1eEt1c3RvbWl6YXRpb24oKTtcclxuICBrdXN0b21pemF0aW9ucz8ubWFwKChrdXN0b21pemF0aW9uLCBpbmRleCkgPT4ge1xyXG4gICAga3VzdG9taXphdGlvbiA9IHsuLi5kZWZhdWx0S3VzdG9taWF0aW9uUHJvcHMsIC4uLmt1c3RvbWl6YXRpb259O1xyXG4gICAgY29uc3QgbWFuaWZlc3QgPWZsdXhLdXN0b21pemF0aW9uLmdlbmVyYXRlKFxyXG4gICAgICBmbHV4R2l0UmVwby5uYW1lICsgXCItXCIgKyBpbmRleCxcclxuICAgICAgZmx1eEdpdFJlcG8ubmFtZSxcclxuICAgICAgZmx1eEdpdFJlcG8ubmFtZXNwYWNlID8/IG5hbWVzcGFjZSxcclxuICAgICAga3VzdG9taXphdGlvbi5zeW5jSW50ZXJ2YWwhLFxyXG4gICAgICBrdXN0b21pemF0aW9uLnBydW5lISxcclxuICAgICAga3VzdG9taXphdGlvbi50aW1lb3V0ISxcclxuICAgICAgZmx1eEdpdFJlcG8udmFsdWVzLFxyXG4gICAgICBrdXN0b21pemF0aW9uLmt1c3RvbWl6YXRpb25QYXRoLFxyXG4gICAgICBrdXN0b21pemF0aW9uLmt1c3RvbWl6YXRpb25UYXJnZXROYW1lc3BhY2UsXHJcbiAgICApO1xyXG4gICAgbGV0IG1hbmlmZXN0TmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkID0gbmFtZSArICdrdXN0b21pemF0aW9uJyArZmx1eEdpdFJlcG8ubmFtZSArIGluZGV4O1xyXG4gICAgY29uc3RydWN0cy5wdXNoKGNsdXN0ZXJJbmZvLmNsdXN0ZXIuYWRkTWFuaWZlc3QobWFuaWZlc3ROYW1lISwgbWFuaWZlc3QpKTtcclxuICAgIFxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gY29uc3RydWN0cztcclxufVxyXG4iXX0=