"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmpAddOn = void 0;
const utils_1 = require("../../utils");
const adot_1 = require("../adot");
const kubectl_provider_1 = require("../helm-addon/kubectl-provider");
const aws_aps_1 = require("aws-cdk-lib/aws-aps");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    deploymentMode: "deployment" /* DeploymentMode.DEPLOYMENT */,
    name: 'adot-collector-amp',
    namespace: 'default',
    enableAPIserverJob: false
};
/**
 * Implementation of AMP add-on for EKS Blueprints. Installs ADOT Collector.
 */
class AmpAddOn {
    constructor(props) {
        this.ampAddOnProps = { ...defaultProps, ...props };
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let doc;
        // Applying manifest for configuring ADOT Collector for Amp.
        if (this.ampAddOnProps.deploymentMode == "daemonset" /* DeploymentMode.DAEMONSET */) {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp-daemonset.ytpl');
        }
        else {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp.ytpl');
        }
        doc = (0, utils_1.changeTextBetweenTokens)(doc, "{{ if enableAPIserverJob }}", "{{ end }}", this.ampAddOnProps.enableAPIServerJob);
        const manifest = doc.split("---").map(e => {
            var _a;
            let object = (0, utils_1.loadYaml)(e);
            if (((_a = this.ampAddOnProps.openTelemetryCollector) === null || _a === void 0 ? void 0 : _a.manifestPath) !== undefined && object.kind === "OpenTelemetryCollector") {
                object = (0, utils_1.readYamlDocument)(this.ampAddOnProps.openTelemetryCollector.manifestPath);
                object = (0, utils_1.loadYaml)(object);
            }
            return object;
        });
        const attrPrometheusEndpoint = this.ampAddOnProps.ampPrometheusEndpoint + 'api/v1/remote_write';
        const values = {
            remoteWriteEndpoint: attrPrometheusEndpoint,
            awsRegion: cluster.stack.region,
            deploymentMode: this.ampAddOnProps.deploymentMode,
            namespace: this.ampAddOnProps.namespace,
            clusterName: cluster.clusterName,
            ...(_a = this.ampAddOnProps.openTelemetryCollector) === null || _a === void 0 ? void 0 : _a.manifestParameterMap
        };
        const manifestDeployment = {
            name: this.ampAddOnProps.name,
            namespace: this.ampAddOnProps.namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        const ampRules = this.ampAddOnProps.ampRules;
        if (ampRules !== undefined) {
            const ruleGroupsNamespaces = this.configureRules(cluster, ampRules.ruleFilePaths, ampRules.ampWorkspaceArn);
            statement.node.addDependency(ruleGroupsNamespaces.at(-1));
        }
        return Promise.resolve(statement);
    }
    configureRules(cluster, ruleFilePaths, ampWorkspaceArn) {
        const ruleGroupsNamespaces = [];
        if (ruleFilePaths.length == 0) {
            throw new Error("No paths defined for AMP rules");
        }
        ruleFilePaths.map((ruleFilePath, index) => {
            const ruleGroupsNamespace = new aws_aps_1.CfnRuleGroupsNamespace(cluster, "AmpRulesConfigurator-" + index, {
                data: (0, utils_1.readYamlDocument)(ruleFilePath),
                name: "AmpRulesConfigurator-" + index,
                workspace: ampWorkspaceArn
            });
            if (index > 0) {
                ruleGroupsNamespace.node.addDependency(ruleGroupsNamespaces.at(-1));
            }
            ruleGroupsNamespaces.push(ruleGroupsNamespace);
        });
        return ruleGroupsNamespaces;
    }
}
exports.AmpAddOn = AmpAddOn;
__decorate([
    (0, utils_1.dependable)(adot_1.AdotCollectorAddOn.name)
], AmpAddOn.prototype, "deploy", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FtcC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSx1Q0FBOEY7QUFDOUYsa0NBQTZDO0FBRTdDLHFFQUFxRjtBQUNyRixpREFBNkQ7QUFzRjdEOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUc7SUFDakIsY0FBYyw4Q0FBMkI7SUFDekMsSUFBSSxFQUFFLG9CQUFvQjtJQUMxQixTQUFTLEVBQUUsU0FBUztJQUNwQixrQkFBa0IsRUFBRSxLQUFLO0NBQzVCLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQWEsUUFBUTtJQUlqQixZQUFZLEtBQW9CO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7O1FBQzNCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBSSxHQUFXLENBQUM7UUFFaEIsNERBQTREO1FBQzVELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLDhDQUE0QixFQUFFO1lBQy9ELEdBQUcsR0FBRyxJQUFBLHdCQUFnQixFQUFDLFNBQVMsR0FBRSxzQ0FBc0MsQ0FBQyxDQUFDO1NBQzdFO2FBQ0k7WUFDRCxHQUFHLEdBQUcsSUFBQSx3QkFBZ0IsRUFBQyxTQUFTLEdBQUcsNEJBQTRCLENBQUMsQ0FBQztTQUNwRTtRQUVELEdBQUcsR0FBRyxJQUFBLCtCQUF1QixFQUN6QixHQUFHLEVBQ0gsNkJBQTZCLEVBQzdCLFdBQVcsRUFDWCxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFtQixDQUNyQyxDQUFDO1FBRU4sTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7O1lBQ3RDLElB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QUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxvQkFBb0IsQ0FBQztJQUNoQyxDQUFDO0NBQ0o7QUF0RkQsNEJBc0ZDO0FBN0VHO0lBREMsSUFBQSxrQkFBVSxFQUFDLHlCQUFrQixDQUFDLElBQUksQ0FBQztzQ0F1RG5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2x1c3RlckFkZE9uLCBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgZGVwZW5kYWJsZSwgbG9hZFlhbWwsIHJlYWRZYW1sRG9jdW1lbnQsIGNoYW5nZVRleHRCZXR3ZWVuVG9rZW5zIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgeyBBZG90Q29sbGVjdG9yQWRkT24gfSBmcm9tIFwiLi4vYWRvdFwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBLdWJlY3RsUHJvdmlkZXIsIE1hbmlmZXN0RGVwbG95bWVudCB9IGZyb20gXCIuLi9oZWxtLWFkZG9uL2t1YmVjdGwtcHJvdmlkZXJcIjtcbmltcG9ydCB7IENmblJ1bGVHcm91cHNOYW1lc3BhY2UgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWFwc1wiO1xuaW1wb3J0IHsgSUNsdXN0ZXIgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuXG4vKipcbiAqIFRoaXMgQU1QIGFkZC1vbiBpbnN0YWxscyBhbiBBRE9UIENvbGxlY3RvciBmb3IgQW1hem9uIE1hbmFnZWQgU2VydmljZSBmb3IgUHJvbWV0aGV1cyBcbiAqIChBTVApIGFuZCBjcmVhdGVzIGFuIEFNUCB3b3Jwc2FjZSB0byByZWNlaXZlIE9UTFAgbWV0cmljcyBmcm9tIHRoZSBhcHBsaWNhdGlvbiBhbmQgXG4gKiBQcm9tZXRoZXVzIG1ldHJpY3Mgc2NyYXBlZCBmcm9tIHBvZHMgb24gdGhlIGNsdXN0ZXIgYW5kIHJlbW90ZSB3cml0ZXMgdGhlIG1ldHJpY3MgXG4gKiB0byBBTVAgcmVtb3RlIHdyaXRlIGVuZHBvaW50IG9mIHRoZSBjcmVhdGVkIG9yIHBhc3NlZCBBTVAgd29ya3NwYWNlLlxuICovXG5cbmV4cG9ydCBpbnRlcmZhY2UgQW1wUnVsZXMge1xuICAgIC8qKiBcbiAgICAgKiBBTVAgd29ya3NwYWNlIEFSTi5cbiAgICAgKi9cbiAgICBhbXBXb3Jrc3BhY2VBcm46IHN0cmluZztcblxuICAgIC8qKiBcbiAgICAgKiBQYXRocyBvZiB0aGUgZmlsZXMgbGlzdGluZyB0aGUgQU1QIHJ1bGVzLlxuICAgICAqL1xuICAgIHJ1bGVGaWxlUGF0aHM6IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9wZW5UZWxlbWV0cnlDb2xsZWN0b3Ige1xuICAgICAvKipcbiAgICAgKiBBbiBhbHRlcm5hdGl2ZSBPcGVuVGVsZW1ldHJ5Q29sbGVjdG9yIGlmIHlvdSBuZWVkIGZ1cnRoZXIgY3Vzb21pc2F0aW9uLlxuICAgICAqIElmIG5vdCBwcm92aWRlZCwgdGhlIGRlZmF1bHQgd2lsbCBiZSB1c2VkLlxuICAgICAqL1xuICAgICBtYW5pZmVzdFBhdGg6IHN0cmluZztcbiAgICAgLyoqXG4gICAgICogVGhpcyBwYXJhbWV0ZXIgaXMgb3B0aW9uYWwgYW5kIGhvbGRzIGFuIG9iamVjdCBvZiB0eXBlIFZhbHVlcywgd2l0aCBrZXlzIGFuZCB2YWx1ZXMuXG4gICAgICogVGhlIHNhbWUga2V5IGxpdGVyYWxzIHdpbGwgbmVlZCB0byBiZSB1c2VkIHdpdGhpbiB0aGUgbWFuaWZlc3QgYmV0d2VlbiBkb3VibGUgY3VybHkgYnJhY2VzIHt7fX0gYW5kIHRoZSBhZGQtb24gd2lsbCByZXBsYWNlIHRoZW0gd2l0aCB0aGUgcmVsYXRlZCB2YWx1ZXMuXG4gICAgICogVGhlIGZvbGxvd2luZyBrZXlzIGFyZSBhbHJlYWR5IGluIHVzZSBieSB0aGUgYWRkLW9uIGFuZCB3aWxsIGJlIHJlcGxhY2VkIGluIHlvdXIgbWFuaWZlc3Qgd2l0aCBjb25maWd1cmVkIHZhbHVlcywgaWYgeW91IHdhbnQgdG8gdXNlIHRoZW06XG4gICAgICogcmVtb3RlV3JpdGVFbmRwb2ludCwgYXdzUmVnaW9uLCBkZXBsb3ltZW50TW9kZSwgbmFtZXNwYWNlLCBjbHVzdGVyTmFtZS4gVG8gdXNlIGFueSBvZiB0aG9zZSB5b3UgY2FuIGp1c3QgaW5jbHVkZSBlLmcuIHt7cmVtb3RlV3JpdGVFbmRwb2ludH19IGluc2lkZSB0aGUgbWFuaWZlc3QuXG4gICAgICovXG4gICAgIG1hbmlmZXN0UGFyYW1ldGVyTWFwPzogVmFsdWVzO1xufVxuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgYWRkLW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFtcEFkZE9uUHJvcHMge1xuICAgIC8qKiBcbiAgICAgKiBSZW1vdGUgV3JpdGUgVVJMIG9mIHRoZSBBTVAgV29ya3NwYWNlIHRvIGJlIHVzZWQgZm9yIHNldHRpbmcgdXAgcmVtb3RlIHdyaXRlLlxuICAgICAqICBGb3JtYXQgOiBodHRwczovL2Fwcy13b3Jrc3BhY2VzLjxyZWdpb24+LmFtYXpvbmF3cy5jb20vd29ya3NwYWNlcy88d3Mtd29ya3NwYWNlaWQ+L1wiLFxuICAgICAqL1xuICAgIGFtcFByb21ldGhldXNFbmRwb2ludDogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIE1vZGVzIHN1cHBvcnRlZCA6IGBkZXBsb3ltZW50YCwgYGRhZW1vbnNldGAsIGBzdGF0ZWZ1bFNldGAsIGFuZCBgc2lkZWNhcmBcbiAgICAgKiBAZGVmYXVsdCBkZXBsb3ltZW50XG4gICAgICovXG4gICAgZGVwbG95bWVudE1vZGU/OiBEZXBsb3ltZW50TW9kZTtcbiAgICAvKipcbiAgICAgKiBOYW1lc3BhY2UgdG8gZGVwbG95IHRoZSBBRE9UIENvbGxlY3RvciBmb3IgQU1QLlxuICAgICAqIEBkZWZhdWx0IGRlZmF1bHRcbiAgICAgKi9cbiAgICBuYW1lc3BhY2U/OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogTmFtZSBmb3IgZGVwbG95bWVudCBvZiB0aGUgQURPVCBDb2xsZWN0b3IgZm9yIEFNUC5cbiAgICAgKiBAZGVmYXVsdCAnYWRvdC1jb2xsZWN0b3ItYW1wJ1xuICAgICAqL1xuICAgIG5hbWU/OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogRW5hYmxlIFwiYXBpc2VydmVyXCIgam9iIGluIHRoZSBQcm9tZXRoZXVzIGNvbmZpZ3VyYXRpb24gb2YgdGhlIGRlZmF1bHQgT3BlblRlbGVtZXRyeUNvbGxlY3Rvci5cbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIGVuYWJsZUFQSVNlcnZlckpvYj86IGJvb2xlYW47XG4gICAgLyoqIFxuICAgICAqIEFNUCBydWxlcyBwcm92aWRpbmcgQU1QIHdvcmtzcGFjZSBBUk4gYW5kIHBhdGhzIHRvIGZpbGVzIGVuY29kaW5nIHJlY29yZGluZyBhbmQvb3IgYWxlcnRpbmcgcnVsZXMgZm9sbG93aW5nIHRoZSBzYW1lIGZvcm1hdCBhcyBhIHJ1bGVzIGZpbGUgaW4gc3RhbmRhbG9uZSBQcm9tZXRoZXVzLlxuICAgICAqIFRoaXMgcGFyYW1ldGVyIGlzIG9wdGlvbmFsIGFuZCBpZiBub3QgcHJvdmlkZWQsIG5vIHJ1bGVzIHdpbGwgYmUgYXBwbGllZC5cbiAgICAgKi9cbiAgICBhbXBSdWxlcz86IEFtcFJ1bGVzO1xuICAgICAvKipcbiAgICAgKiBBbiBhbHRlcm5hdGl2ZSBPcGVuVGVsZW1ldHJ5Q29sbGVjdG9yIGlmIHlvdSBuZWVkIGZ1cnRoZXIgY3VzdG9taXNhdGlvbi5cbiAgICAgKiBJZiB5b3UgbmVlZCB0byBjb25maWd1cmUgcnVsZXMsIHBsZWFzZSBkbyBub3QgdXNlIHRoZSBydWxlX2ZpbGVzIGZpZWxkIGxpa2UgaW4gc3RhbmRhbG9uZSBQcm9tZXRoZXVzLCBidXQgcmF0aGVyIHVzZSB0aGUgYW1wUnVsZXMgcGFyYW1ldGVyLlxuICAgICAqIElmIG5vdCBwcm92aWRlZCwgdGhlIGRlZmF1bHQgd2lsbCBiZSB1c2VkLlxuICAgICAqL1xuICAgIG9wZW5UZWxlbWV0cnlDb2xsZWN0b3I/OiBPcGVuVGVsZW1ldHJ5Q29sbGVjdG9yO1xufVxuXG5leHBvcnQgY29uc3QgZW51bSBEZXBsb3ltZW50TW9kZSB7XG4gICAgREVQTE9ZTUVOVCA9ICdkZXBsb3ltZW50JyxcbiAgICBEQUVNT05TRVQgPSAnZGFlbW9uc2V0JyxcbiAgICBTVEFURUZVTFNFVCA9ICdzdGF0ZWZ1bHNldCcsXG4gICAgU0lERUNBUiA9ICdzaWRlY2FyJ1xufVxuXG4vKipcbiAqIERlZmF1bHRzIG9wdGlvbnMgZm9yIHRoZSBhZGQtb25cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzID0ge1xuICAgIGRlcGxveW1lbnRNb2RlOiBEZXBsb3ltZW50TW9kZS5ERVBMT1lNRU5ULFxuICAgIG5hbWU6ICdhZG90LWNvbGxlY3Rvci1hbXAnLFxuICAgIG5hbWVzcGFjZTogJ2RlZmF1bHQnLFxuICAgIGVuYWJsZUFQSXNlcnZlckpvYjogZmFsc2Vcbn07XG5cbi8qKlxuICogSW1wbGVtZW50YXRpb24gb2YgQU1QIGFkZC1vbiBmb3IgRUtTIEJsdWVwcmludHMuIEluc3RhbGxzIEFET1QgQ29sbGVjdG9yLlxuICovXG5leHBvcnQgY2xhc3MgQW1wQWRkT24gaW1wbGVtZW50cyBDbHVzdGVyQWRkT24ge1xuXG4gICAgcmVhZG9ubHkgYW1wQWRkT25Qcm9wczogQW1wQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBBbXBBZGRPblByb3BzKSB7XG4gICAgICAgIHRoaXMuYW1wQWRkT25Qcm9wcyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9O1xuICAgIH1cblxuICAgIEBkZXBlbmRhYmxlKEFkb3RDb2xsZWN0b3JBZGRPbi5uYW1lKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgbGV0IGRvYzogc3RyaW5nO1xuXG4gICAgICAgIC8vIEFwcGx5aW5nIG1hbmlmZXN0IGZvciBjb25maWd1cmluZyBBRE9UIENvbGxlY3RvciBmb3IgQW1wLlxuICAgICAgICBpZiAodGhpcy5hbXBBZGRPblByb3BzLmRlcGxveW1lbnRNb2RlID09IERlcGxveW1lbnRNb2RlLkRBRU1PTlNFVCkge1xuICAgICAgICAgICAgZG9jID0gcmVhZFlhbWxEb2N1bWVudChfX2Rpcm5hbWUgKycvY29sbGVjdG9yLWNvbmZpZy1hbXAtZGFlbW9uc2V0Lnl0cGwnKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRvYyA9IHJlYWRZYW1sRG9jdW1lbnQoX19kaXJuYW1lICsgJy9jb2xsZWN0b3ItY29uZmlnLWFtcC55dHBsJyk7XG4gICAgICAgIH1cblxuICAgICAgICBkb2MgPSBjaGFuZ2VUZXh0QmV0d2VlblRva2VucyhcbiAgICAgICAgICAgIGRvYyxcbiAgICAgICAgICAgIFwie3sgaWYgZW5hYmxlQVBJc2VydmVySm9iIH19XCIsXG4gICAgICAgICAgICBcInt7IGVuZCB9fVwiLFxuICAgICAgICAgICAgdGhpcy5hbXBBZGRPblByb3BzLmVuYWJsZUFQSVNlcnZlckpvYiFcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgbWFuaWZlc3QgPSBkb2Muc3BsaXQoXCItLS1cIikubWFwKGUgPT4ge1xuICAgICAgICAgICAgbGV0IG9iamVjdCA9IGxvYWRZYW1sKGUpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5hbXBBZGRPblByb3BzLm9wZW5UZWxlbWV0cnlDb2xsZWN0b3I/Lm1hbmlmZXN0UGF0aCAhPT0gdW5kZWZpbmVkICYmIG9iamVjdC5raW5kID09PSBcIk9wZW5UZWxlbWV0cnlDb2xsZWN0b3JcIil7XG4gICAgICAgICAgICAgICAgb2JqZWN0ID0gcmVhZFlhbWxEb2N1bWVudCh0aGlzLmFtcEFkZE9uUHJvcHMub3BlblRlbGVtZXRyeUNvbGxlY3Rvci5tYW5pZmVzdFBhdGghKTtcbiAgICAgICAgICAgICAgICBvYmplY3QgPSBsb2FkWWFtbChvYmplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9iamVjdDtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGF0dHJQcm9tZXRoZXVzRW5kcG9pbnQgPSB0aGlzLmFtcEFkZE9uUHJvcHMuYW1wUHJvbWV0aGV1c0VuZHBvaW50ICsgJ2FwaS92MS9yZW1vdGVfd3JpdGUnO1xuICAgICAgICBjb25zdCB2YWx1ZXM6IFZhbHVlcyA9IHtcbiAgICAgICAgICAgIHJlbW90ZVdyaXRlRW5kcG9pbnQ6IGF0dHJQcm9tZXRoZXVzRW5kcG9pbnQsXG4gICAgICAgICAgICBhd3NSZWdpb246IGNsdXN0ZXIuc3RhY2sucmVnaW9uLFxuICAgICAgICAgICAgZGVwbG95bWVudE1vZGU6IHRoaXMuYW1wQWRkT25Qcm9wcy5kZXBsb3ltZW50TW9kZSxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5hbXBBZGRPblByb3BzLm5hbWVzcGFjZSxcbiAgICAgICAgICAgIGNsdXN0ZXJOYW1lOiBjbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgLi4udGhpcy5hbXBBZGRPblByb3BzLm9wZW5UZWxlbWV0cnlDb2xsZWN0b3I/Lm1hbmlmZXN0UGFyYW1ldGVyTWFwXG4gICAgICAgICB9O1xuICAgICAgICAgXG4gICAgICAgICBjb25zdCBtYW5pZmVzdERlcGxveW1lbnQ6IE1hbmlmZXN0RGVwbG95bWVudCA9IHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuYW1wQWRkT25Qcm9wcy5uYW1lISxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5hbXBBZGRPblByb3BzLm5hbWVzcGFjZSEsXG4gICAgICAgICAgICBtYW5pZmVzdCxcbiAgICAgICAgICAgIHZhbHVlc1xuICAgICAgICB9O1xuICAgICAgICBjb25zdCBrdWJlY3RsUHJvdmlkZXIgPSBuZXcgS3ViZWN0bFByb3ZpZGVyKGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgY29uc3Qgc3RhdGVtZW50ID0ga3ViZWN0bFByb3ZpZGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0RGVwbG95bWVudCk7XG5cbiAgICAgICAgY29uc3QgYW1wUnVsZXMgPSB0aGlzLmFtcEFkZE9uUHJvcHMuYW1wUnVsZXM7XG4gICAgICAgIGlmIChhbXBSdWxlcyAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIGNvbnN0IHJ1bGVHcm91cHNOYW1lc3BhY2VzID0gdGhpcy5jb25maWd1cmVSdWxlcyhjbHVzdGVyLCBhbXBSdWxlcy5ydWxlRmlsZVBhdGhzLCBhbXBSdWxlcy5hbXBXb3Jrc3BhY2VBcm4pO1xuICAgICAgICAgICAgc3RhdGVtZW50Lm5vZGUuYWRkRGVwZW5kZW5jeShydWxlR3JvdXBzTmFtZXNwYWNlcy5hdCgtMSkhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RhdGVtZW50KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbmZpZ3VyZVJ1bGVzKGNsdXN0ZXI6IElDbHVzdGVyLCBydWxlRmlsZVBhdGhzOiBzdHJpbmdbXSwgYW1wV29ya3NwYWNlQXJuOiBzdHJpbmcpOiBDZm5SdWxlR3JvdXBzTmFtZXNwYWNlW10ge1xuICAgICAgICBjb25zdCBydWxlR3JvdXBzTmFtZXNwYWNlczogQ2ZuUnVsZUdyb3Vwc05hbWVzcGFjZVtdID0gW107XG5cbiAgICAgICAgaWYgKHJ1bGVGaWxlUGF0aHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHBhdGhzIGRlZmluZWQgZm9yIEFNUCBydWxlc1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJ1bGVGaWxlUGF0aHMubWFwKChydWxlRmlsZVBhdGgsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBydWxlR3JvdXBzTmFtZXNwYWNlID0gbmV3IENmblJ1bGVHcm91cHNOYW1lc3BhY2UoY2x1c3RlciwgXCJBbXBSdWxlc0NvbmZpZ3VyYXRvci1cIiArIGluZGV4LCB7XG4gICAgICAgICAgICAgICAgZGF0YTogcmVhZFlhbWxEb2N1bWVudChydWxlRmlsZVBhdGgpLFxuICAgICAgICAgICAgICAgIG5hbWU6IFwiQW1wUnVsZXNDb25maWd1cmF0b3ItXCIgKyBpbmRleCxcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2U6IGFtcFdvcmtzcGFjZUFyblxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPiAwKXtcbiAgICAgICAgICAgICAgICBydWxlR3JvdXBzTmFtZXNwYWNlLm5vZGUuYWRkRGVwZW5kZW5jeShydWxlR3JvdXBzTmFtZXNwYWNlcy5hdCgtMSkhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJ1bGVHcm91cHNOYW1lc3BhY2VzLnB1c2gocnVsZUdyb3Vwc05hbWVzcGFjZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBydWxlR3JvdXBzTmFtZXNwYWNlcztcbiAgICB9XG59XG4iXX0=