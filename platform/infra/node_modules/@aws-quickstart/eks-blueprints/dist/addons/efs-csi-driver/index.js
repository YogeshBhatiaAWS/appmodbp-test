"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EfsCsiDriverAddOn = void 0;
const helm_addon_1 = require("../helm-addon");
const iam_policy_1 = require("./iam-policy");
const registry_utils_1 = require("../../utils/registry-utils");
const iam = require("aws-cdk-lib/aws-iam");
const utils_1 = require("../../utils");
const EFS_CSI_DRIVER = "aws-efs-csi-driver";
const EFS_CSI_CONTROLLER_SA = "efs-csi-controller-sa";
const EFS_REGISTRY_SUFFIX = "eks/aws-efs-csi-driver";
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    version: '2.4.9',
    namespace: "kube-system",
    repository: "https://kubernetes-sigs.github.io/aws-efs-csi-driver/",
    name: EFS_CSI_DRIVER,
    chart: EFS_CSI_DRIVER,
    replicaCount: 2
};
class EfsCsiDriverAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a;
        // Create service account and policy
        const cluster = clusterInfo.cluster;
        const serviceAccount = cluster.addServiceAccount(EFS_CSI_CONTROLLER_SA, {
            name: EFS_CSI_CONTROLLER_SA,
            namespace: this.options.namespace,
        });
        (0, iam_policy_1.getEfsDriverPolicyStatements)((_a = this.options) === null || _a === void 0 ? void 0 : _a.kmsKeys).forEach((statement) => {
            serviceAccount.addToPrincipalPolicy(iam.PolicyStatement.fromJson(statement));
        });
        // Lookup appropriate image repo
        const repo = registry_utils_1.registries.get(clusterInfo.cluster.stack.region) + EFS_REGISTRY_SUFFIX;
        // setup value for helm chart
        const chartValues = populateValues(this.options, cluster.clusterName, serviceAccount.serviceAccountName, repo);
        // Define chart
        const efsCsiDriverChart = this.addHelmChart(clusterInfo, chartValues);
        efsCsiDriverChart.node.addDependency(serviceAccount);
        // return the Promise Construct for any teams that may depend on this
        return Promise.resolve(efsCsiDriverChart);
    }
}
exports.EfsCsiDriverAddOn = EfsCsiDriverAddOn;
/**
 * populateValues populates the appropriate values used to customize the Helm chart
 * @param helmOptions User provided values to customize the chart
 * @param clusterName Name of the cluster where to deploy the add-on
 * @param serviceAccountName Name of the service account used by the add-on
 * @param repository Repository to pull image for Add_on
 */
function populateValues(helmOptions, clusterName, serviceAccountName, repository) {
    var _a;
    const values = (_a = helmOptions.values) !== null && _a !== void 0 ? _a : {};
    (0, utils_1.setPath)(values, "clusterName", clusterName);
    (0, utils_1.setPath)(values, "controller.serviceAccount.create", false);
    (0, utils_1.setPath)(values, "controller.serviceAccount.name", serviceAccountName);
    (0, utils_1.setPath)(values, "node.serviceAccount.create", false);
    (0, utils_1.setPath)(values, "node.serviceAccount.name", serviceAccountName);
    (0, utils_1.setPath)(values, "replicaCount", helmOptions.replicaCount);
    (0, utils_1.setPath)(values, "image.repository", repository);
    return values;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2Vmcy1jc2ktZHJpdmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDhDQUE4RDtBQUM5RCw2Q0FBNEQ7QUFDNUQsK0RBQXlEO0FBQ3pELDJDQUEyQztBQUMzQyx1Q0FBb0M7QUFJcEMsTUFBTSxjQUFjLEdBQUcsb0JBQW9CLENBQUM7QUFDNUMsTUFBTSxxQkFBcUIsR0FBRyx1QkFBdUIsQ0FBQztBQUN0RCxNQUFNLG1CQUFtQixHQUFHLHdCQUF3QixDQUFDO0FBdUJyRDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFzQjtJQUNwQyxPQUFPLEVBQUUsT0FBTztJQUNoQixTQUFTLEVBQUUsYUFBYTtJQUN4QixVQUFVLEVBQUUsdURBQXVEO0lBQ25FLElBQUksRUFBRSxjQUFjO0lBQ3BCLEtBQUssRUFBRSxjQUFjO0lBQ3JCLFlBQVksRUFBRSxDQUFDO0NBQ2xCLENBQUM7QUFFRixNQUFhLGlCQUFrQixTQUFRLHNCQUFTO0lBSTVDLFlBQVksS0FBeUI7UUFDakMsS0FBSyxDQUFDLEVBQUUsR0FBRyxZQUFtQixFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUEwQixDQUFDO0lBQ25ELENBQUM7SUFFRCxNQUFNLENBQUMsV0FBd0I7O1FBQzNCLG9DQUFvQztRQUNwQyxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUIsRUFBRTtZQUNwRSxJQUFJLEVBQUUscUJBQXFCO1lBQzNCLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVM7U0FDcEMsQ0FBQyxDQUFDO1FBQ0gsSUFBQSx5Q0FBNEIsRUFBQyxNQUFBLElBQUksQ0FBQyxPQUFPLDBDQUFFLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ3RFLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLENBQUMsQ0FBQyxDQUFDO1FBR0gsZ0NBQWdDO1FBQ2hDLE1BQU0sSUFBSSxHQUFHLDJCQUFVLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLG1CQUFtQixDQUFDO1FBQ3BGLDZCQUE2QjtRQUM3QixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUUvRyxlQUFlO1FBQ2YsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUV0RSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3JELHFFQUFxRTtRQUNyRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0o7QUFqQ0QsOENBaUNDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsU0FBUyxjQUFjLENBQUMsV0FBOEIsRUFBRSxXQUFtQixFQUNuRCxrQkFBMEIsRUFBRSxVQUFrQjs7SUFDbEUsTUFBTSxNQUFNLEdBQUcsTUFBQSxXQUFXLENBQUMsTUFBTSxtQ0FBSSxFQUFFLENBQUM7SUFFeEMsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLGFBQWEsRUFBRyxXQUFXLENBQUMsQ0FBQztJQUM3QyxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsa0NBQWtDLEVBQUcsS0FBSyxDQUFDLENBQUM7SUFDNUQsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLGdDQUFnQyxFQUFHLGtCQUFrQixDQUFDLENBQUM7SUFDdkUsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLDRCQUE0QixFQUFHLEtBQUssQ0FBQyxDQUFDO0lBQ3RELElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSwwQkFBMEIsRUFBRyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ2pFLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUcsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzNELElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSxrQkFBa0IsRUFBRyxVQUFVLENBQUMsQ0FBQztJQUVqRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7Q2x1c3RlckluZm8sIFZhbHVlc30gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xuaW1wb3J0IHsgZ2V0RWZzRHJpdmVyUG9saWN5U3RhdGVtZW50cyB9IGZyb20gXCIuL2lhbS1wb2xpY3lcIjtcbmltcG9ydCB7IHJlZ2lzdHJpZXMgfSAgZnJvbSBcIi4uLy4uL3V0aWxzL3JlZ2lzdHJ5LXV0aWxzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7c2V0UGF0aH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgKiBhcyBrbXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1rbXNcIjtcblxuXG5jb25zdCBFRlNfQ1NJX0RSSVZFUiA9IFwiYXdzLWVmcy1jc2ktZHJpdmVyXCI7XG5jb25zdCBFRlNfQ1NJX0NPTlRST0xMRVJfU0EgPSBcImVmcy1jc2ktY29udHJvbGxlci1zYVwiO1xuY29uc3QgRUZTX1JFR0lTVFJZX1NVRkZJWCA9IFwiZWtzL2F3cy1lZnMtY3NpLWRyaXZlclwiO1xuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGFkZC1vbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFZnNDc2lEcml2ZXJQcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVmVyc2lvbiBvZiB0aGUgZHJpdmVyIHRvIGRlcGxveS4gVXNlcyBjaGFydCB2ZXJzaW9uIDIuMi4zIGJ5IGRlZmF1bHQgaWYgdGhpcyB2YWx1ZSBpcyBub3QgcHJvdmlkZWRcbiAgICAgKi9cbiAgICB2ZXJzaW9uPzogc3RyaW5nLFxuICAgIC8qKipcbiAgICAgKiBOdW1iZXIgb2YgcmVwbGljYXMgdG8gYmUgZGVwbG95ZWQuIElmIG5vdCBwcm92aWRlZCwgaXQgZGVmYXVsdHMgdG8gMi4gTm90ZSB0aGF0IHRoZSBudW1iZXIgb2YgcmVwbGljYXNcbiAgICAgKiBzaG91bGQgYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIHRoZSBudW1iZXIgb2Ygbm9kZXMgaW4gdGhlIGNsdXN0ZXIgb3RoZXJ3aXNlIHNvbWVcbiAgICAgKiBwb2RzIHdpbGwgYmUgbGVmdCBvZiBwZW5kaW5nIHN0YXRlXG4gICAgICovXG4gICAgcmVwbGljYUNvdW50PzogbnVtYmVyXG4gICAgLyoqXG4gICAgICogTGlzdCBvZiBLTVMga2V5cyB0byBiZSB1c2VkIGZvciBlbmNyeXB0aW9uXG4gICAgICovXG4gICAga21zS2V5cz86IGttcy5LZXlbXTtcblxufVxuXG4vKipcbiAqIERlZmF1bHRzIG9wdGlvbnMgZm9yIHRoZSBhZGQtb25cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzOiBFZnNDc2lEcml2ZXJQcm9wcyA9IHtcbiAgICB2ZXJzaW9uOiAnMi40LjknLFxuICAgIG5hbWVzcGFjZTogXCJrdWJlLXN5c3RlbVwiLFxuICAgIHJlcG9zaXRvcnk6IFwiaHR0cHM6Ly9rdWJlcm5ldGVzLXNpZ3MuZ2l0aHViLmlvL2F3cy1lZnMtY3NpLWRyaXZlci9cIixcbiAgICBuYW1lOiBFRlNfQ1NJX0RSSVZFUixcbiAgICBjaGFydDogRUZTX0NTSV9EUklWRVIsXG4gICAgcmVwbGljYUNvdW50OiAyXG59O1xuXG5leHBvcnQgY2xhc3MgRWZzQ3NpRHJpdmVyQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcmVhZG9ubHkgb3B0aW9uczogRWZzQ3NpRHJpdmVyUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IEVmc0NzaURyaXZlclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHsgLi4uZGVmYXVsdFByb3BzIGFzIGFueSwgLi4ucHJvcHMgfSk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHMgYXMgRWZzQ3NpRHJpdmVyUHJvcHM7XG4gICAgfVxuXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIC8vIENyZWF0ZSBzZXJ2aWNlIGFjY291bnQgYW5kIHBvbGljeVxuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgY29uc3Qgc2VydmljZUFjY291bnQgPSBjbHVzdGVyLmFkZFNlcnZpY2VBY2NvdW50KEVGU19DU0lfQ09OVFJPTExFUl9TQSwge1xuICAgICAgICAgICAgbmFtZTogRUZTX0NTSV9DT05UUk9MTEVSX1NBLFxuICAgICAgICAgICAgbmFtZXNwYWNlOiB0aGlzLm9wdGlvbnMubmFtZXNwYWNlLFxuICAgICAgICB9KTtcbiAgICAgICAgZ2V0RWZzRHJpdmVyUG9saWN5U3RhdGVtZW50cyh0aGlzLm9wdGlvbnM/Lmttc0tleXMpLmZvckVhY2goKHN0YXRlbWVudCkgPT4ge1xuICAgICAgICAgICAgc2VydmljZUFjY291bnQuYWRkVG9QcmluY2lwYWxQb2xpY3koaWFtLlBvbGljeVN0YXRlbWVudC5mcm9tSnNvbihzdGF0ZW1lbnQpKTtcbiAgICAgICAgfSk7XG5cblxuICAgICAgICAvLyBMb29rdXAgYXBwcm9wcmlhdGUgaW1hZ2UgcmVwb1xuICAgICAgICBjb25zdCByZXBvID0gcmVnaXN0cmllcy5nZXQoY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjay5yZWdpb24pICsgRUZTX1JFR0lTVFJZX1NVRkZJWDtcbiAgICAgICAgLy8gc2V0dXAgdmFsdWUgZm9yIGhlbG0gY2hhcnRcbiAgICAgICAgY29uc3QgY2hhcnRWYWx1ZXMgPSBwb3B1bGF0ZVZhbHVlcyh0aGlzLm9wdGlvbnMsIGNsdXN0ZXIuY2x1c3Rlck5hbWUsIHNlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZSwgcmVwbyk7XG5cbiAgICAgICAgLy8gRGVmaW5lIGNoYXJ0XG4gICAgICAgIGNvbnN0IGVmc0NzaURyaXZlckNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIGNoYXJ0VmFsdWVzKTtcblxuICAgICAgICBlZnNDc2lEcml2ZXJDaGFydC5ub2RlLmFkZERlcGVuZGVuY3koc2VydmljZUFjY291bnQpO1xuICAgICAgICAvLyByZXR1cm4gdGhlIFByb21pc2UgQ29uc3RydWN0IGZvciBhbnkgdGVhbXMgdGhhdCBtYXkgZGVwZW5kIG9uIHRoaXNcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlZnNDc2lEcml2ZXJDaGFydCk7XG4gICAgfVxufVxuXG4vKipcbiAqIHBvcHVsYXRlVmFsdWVzIHBvcHVsYXRlcyB0aGUgYXBwcm9wcmlhdGUgdmFsdWVzIHVzZWQgdG8gY3VzdG9taXplIHRoZSBIZWxtIGNoYXJ0XG4gKiBAcGFyYW0gaGVsbU9wdGlvbnMgVXNlciBwcm92aWRlZCB2YWx1ZXMgdG8gY3VzdG9taXplIHRoZSBjaGFydFxuICogQHBhcmFtIGNsdXN0ZXJOYW1lIE5hbWUgb2YgdGhlIGNsdXN0ZXIgd2hlcmUgdG8gZGVwbG95IHRoZSBhZGQtb25cbiAqIEBwYXJhbSBzZXJ2aWNlQWNjb3VudE5hbWUgTmFtZSBvZiB0aGUgc2VydmljZSBhY2NvdW50IHVzZWQgYnkgdGhlIGFkZC1vblxuICogQHBhcmFtIHJlcG9zaXRvcnkgUmVwb3NpdG9yeSB0byBwdWxsIGltYWdlIGZvciBBZGRfb25cbiAqL1xuZnVuY3Rpb24gcG9wdWxhdGVWYWx1ZXMoaGVsbU9wdGlvbnM6IEVmc0NzaURyaXZlclByb3BzLCBjbHVzdGVyTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZUFjY291bnROYW1lOiBzdHJpbmcsIHJlcG9zaXRvcnk6IHN0cmluZyk6IFZhbHVlcyB7XG4gICAgY29uc3QgdmFsdWVzID0gaGVsbU9wdGlvbnMudmFsdWVzID8/IHt9O1xuXG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwiY2x1c3Rlck5hbWVcIiwgIGNsdXN0ZXJOYW1lKTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJjb250cm9sbGVyLnNlcnZpY2VBY2NvdW50LmNyZWF0ZVwiLCAgZmFsc2UpO1xuICAgIHNldFBhdGgodmFsdWVzLCBcImNvbnRyb2xsZXIuc2VydmljZUFjY291bnQubmFtZVwiLCAgc2VydmljZUFjY291bnROYW1lKTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJub2RlLnNlcnZpY2VBY2NvdW50LmNyZWF0ZVwiLCAgZmFsc2UpO1xuICAgIHNldFBhdGgodmFsdWVzLCBcIm5vZGUuc2VydmljZUFjY291bnQubmFtZVwiLCAgc2VydmljZUFjY291bnROYW1lKTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJyZXBsaWNhQ291bnRcIiwgIGhlbG1PcHRpb25zLnJlcGxpY2FDb3VudCk7XG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwiaW1hZ2UucmVwb3NpdG9yeVwiLCAgcmVwb3NpdG9yeSk7XG5cbiAgICByZXR1cm4gdmFsdWVzO1xufSJdfQ==