"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VeleroAddOn = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const s3 = require("aws-cdk-lib/aws-s3");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: 'velero',
    version: "3.2.0",
    namespace: "velero",
    createNamespace: true,
    chart: "velero",
    repository: "https://vmware-tanzu.github.io/helm-charts/",
    release: "blueprints-addon-velero",
    values: {
        initContainers: [
            {
                name: "velero-plugin-for-aws",
                image: "velero/velero-plugin-for-aws:v1.2.0",
                imagePullPolicy: "IfNotPresent",
                volumeMounts: [
                    {
                        mountPath: "/target",
                        name: "plugins"
                    }
                ]
            }
        ],
        configuration: {
            provider: "aws",
            backupStorageLocation: {
                name: "default",
                config: {}
            },
            volumeSnapshotLocation: {
                name: "default",
                config: {}
            },
        },
        serviceAccount: {
            server: {}
        }
    },
};
class VeleroAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super((0, ts_deepmerge_1.default)(defaultProps, props !== null && props !== void 0 ? props : {}));
        this.options = this.props;
    }
    /**
     * Implementation of the add-on contract deploy method.
    */
    deploy(clusterInfo) {
        var _a, _b, _c, _d;
        const cluster = clusterInfo.cluster;
        const props = this.options;
        // Create S3 bucket if no existing bucket, create s3 bucket and corresponding KMS key
        const s3Bucket = this.getOrCreateS3Bucket(clusterInfo, "backup-bucket", props.values.configuration.backupStorageLocation.bucket);
        // Create Namespace if namespace is not explicied defined.
        const veleroNamespace = this.createNamespaceIfNeeded(clusterInfo, "velero", props.namespace, props.createNamespace);
        // Setup IAM Role for Service Accounts (IRSA) for the Velero Service Account    
        const veleroServiceAccount = this.createServiceAccountWithIamRoles(clusterInfo, "velero-account", veleroNamespace.name, s3Bucket);
        // if veleroName space does not exist and needs creation, add the dependency
        if (veleroNamespace.manifest) {
            veleroServiceAccount.node.addDependency(veleroNamespace.manifest);
        }
        // Setup the values for the helm chart
        const valueVariable = {
            values: {
                configuration: {
                    backupStorageLocation: {
                        prefix: (_a = props.values.configuration.backupStorageLocation.prefix) !== null && _a !== void 0 ? _a : "velero/" + cluster.clusterName,
                        bucket: s3Bucket.bucketName,
                        config: {
                            region: (_b = props.values.configuration.backupStorageLocation.config.region) !== null && _b !== void 0 ? _b : cluster.stack.region,
                        }
                    },
                    volumeSnapshotLocation: {
                        config: {
                            region: (_c = props.values.configuration.backupStorageLocation.config.region) !== null && _c !== void 0 ? _c : cluster.stack.region
                        }
                    }
                },
                // IAM role for Service Account
                serviceAccount: {
                    server: {
                        create: false,
                        name: veleroServiceAccount.serviceAccountName,
                    }
                }
            }
        };
        const values = (_d = (0, ts_deepmerge_1.default)(props.values, valueVariable.values)) !== null && _d !== void 0 ? _d : {};
        const chartNode = this.addHelmChart(clusterInfo, values);
        chartNode.node.addDependency(veleroServiceAccount);
        return Promise.resolve(chartNode);
    }
    /**
     * Return S3 Bucket
     * @param clusterInfo
     * @param id S3-Bucket-Postfix
     * @param existingBucketName exiting provided S3 BucketName if it exists
     * @returns the existing provided S3 bucket  or the newly created S3 bucket as s3.IBucket
     */
    getOrCreateS3Bucket(clusterInfo, id, existingBucketName) {
        if (!existingBucketName) {
            const bucket = new s3.Bucket(clusterInfo.cluster, "velero-${id}", {
                encryption: s3.BucketEncryption.KMS_MANAGED,
                blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
                publicReadAccess: false,
                enforceSSL: true // Encryption in Transit
            });
            return s3.Bucket.fromBucketName(clusterInfo.cluster, 'getOrCreateS3Bucket', bucket.bucketName);
        }
        else {
            return s3.Bucket.fromBucketName(clusterInfo.cluster, 'getOrCreateS3Bucket', existingBucketName);
        }
    }
    /**
     * Return Velero Namespace where Velero will be installed onto
     * @param clusterInfo
     * @param defaultName the Default Namespace for Velero if nothing specified
     * @param namespace
     * @returns the namespace created or existed.
     */
    createNamespaceIfNeeded(clusterInfo, defaultName, namespace, create) {
        // Create Namespace if namespace is not explicied defined.
        if (namespace) {
            // Create Namespace if the "create" option is true
            if (create) {
                const namespaceManifest = (0, utils_1.createNamespace)(namespace, clusterInfo.cluster);
                return { name: namespace, manifest: namespaceManifest };
            }
            // If the "create" option if false, then namespace will not be created, return namespace.name
            else {
                return { name: namespace };
            }
        }
        else {
            return { name: defaultName }; // initial value of veleroNamespace
        }
    }
    /**
     * Return Velero Namespace where Velero will be installed onto
     * @param clusterInfo
     * @param id
     * @param namespace Velero namespace name
     * @param s3BucketName the S3 BucketName where Velero will stores the backup onto
     * @returns the service Account
     */
    createServiceAccountWithIamRoles(clusterInfo, id, namespace, s3Bucket) {
        // Setup IAM Role for Service Accounts (IRSA) for the Velero Service Account
        const veleroServiceAccount = clusterInfo.cluster.addServiceAccount(id, {
            name: id,
            namespace: namespace
        });
        // IAM policy for Velero
        const veleroPolicyDocument = {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": [
                        "ec2:DescribeVolumes",
                        "ec2:DescribeSnapshots",
                        "ec2:CreateTags",
                        "ec2:CreateVolume",
                        "ec2:CreateSnapshot",
                        "ec2:DeleteSnapshot"
                    ],
                    "Resource": "*"
                },
                {
                    "Effect": "Allow",
                    "Action": [
                        "s3:GetObject",
                        "s3:DeleteObject",
                        "s3:PutObject",
                        "s3:AbortMultipartUpload",
                        "s3:ListMultipartUploadParts",
                        "s3:ListBucket"
                    ],
                    "Resource": [
                        s3Bucket.arnForObjects("*"),
                        s3Bucket.bucketArn
                    ]
                }
            ]
        };
        const veleroCustomPolicyDocument = iam.PolicyDocument.fromJson(veleroPolicyDocument);
        const veleroPolicy = new iam.ManagedPolicy(clusterInfo.cluster, "velero-managed-policy", {
            document: veleroCustomPolicyDocument
        });
        veleroServiceAccount.role.addManagedPolicy(veleroPolicy);
        return veleroServiceAccount;
    }
}
exports.VeleroAddOn = VeleroAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL3ZlbGVyby9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSwyQ0FBMkM7QUFDM0MseUNBQXlDO0FBRXpDLCtDQUFpQztBQUVqQyx1Q0FBOEM7QUFDOUMsOENBQThEO0FBUzlEOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUc7SUFDakIsSUFBSSxFQUFFLFFBQVE7SUFDZCxPQUFPLEVBQUUsT0FBTztJQUNoQixTQUFTLEVBQUUsUUFBUTtJQUNuQixlQUFlLEVBQUUsSUFBSTtJQUNyQixLQUFLLEVBQUUsUUFBUTtJQUNmLFVBQVUsRUFBRSw2Q0FBNkM7SUFDekQsT0FBTyxFQUFFLHlCQUF5QjtJQUNsQyxNQUFNLEVBQUM7UUFDSCxjQUFjLEVBQUM7WUFDWDtnQkFDSSxJQUFJLEVBQUUsdUJBQXVCO2dCQUM3QixLQUFLLEVBQUUscUNBQXFDO2dCQUM1QyxlQUFlLEVBQUUsY0FBYztnQkFDL0IsWUFBWSxFQUFDO29CQUNUO3dCQUNJLFNBQVMsRUFBRSxTQUFTO3dCQUNwQixJQUFJLEVBQUUsU0FBUztxQkFDbEI7aUJBQ0o7YUFDSjtTQUNKO1FBQ0QsYUFBYSxFQUFFO1lBQ1gsUUFBUSxFQUFFLEtBQUs7WUFDZixxQkFBcUIsRUFBQztnQkFDbEIsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsTUFBTSxFQUFDLEVBQUU7YUFDWjtZQUNELHNCQUFzQixFQUFDO2dCQUNuQixJQUFJLEVBQUUsU0FBUztnQkFDZixNQUFNLEVBQUMsRUFBRTthQUNaO1NBQ0o7UUFDRCxjQUFjLEVBQUU7WUFDWixNQUFNLEVBQUMsRUFBRTtTQUNaO0tBQ0o7Q0FDSixDQUFDO0FBRUYsTUFBYSxXQUFZLFNBQVEsc0JBQVM7SUFJdEMsWUFBWSxLQUF3QjtRQUNoQyxLQUFLLENBQUMsSUFBQSxzQkFBSyxFQUFDLFlBQVksRUFBRSxLQUFLLGFBQUwsS0FBSyxjQUFMLEtBQUssR0FB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OUQsRUFBRSxFQUNGO1lBQ0ksSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsU0FBUztTQUN2QixDQUNKLENBQUM7UUFFRix3QkFBd0I7UUFDeEIsTUFBTSxvQkFBb0IsR0FBRztZQUN6QixTQUFTLEVBQUUsWUFBWTtZQUN2QixXQUFXLEVBQUU7Z0JBQ1g7b0JBQ0ksUUFBUSxFQUFFLE9BQU87b0JBQ2pCLFFBQVEsRUFBRTt3QkFDTixxQkFBcUI7d0JBQ3JCLHVCQUF1Qjt3QkFDdkIsZ0JBQWdCO3dCQUNoQixrQkFBa0I7d0JBQ2xCLG9CQUFvQjt3QkFDcEIsb0JBQW9CO3FCQUN2QjtvQkFDRCxVQUFVLEVBQUUsR0FBRztpQkFDbEI7Z0JBQ0Q7b0JBQ0UsUUFBUSxFQUFFLE9BQU87b0JBQ2pCLFFBQVEsRUFBRTt3QkFDTixjQUFjO3dCQUNkLGlCQUFpQjt3QkFDakIsY0FBYzt3QkFDZCx5QkFBeUI7d0JBQ3pCLDZCQUE2Qjt3QkFDN0IsZUFBZTtxQkFDbEI7b0JBQ0QsVUFBVSxFQUFFO3dCQUNSLFFBQVEsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO3dCQUMzQixRQUFRLENBQUMsU0FBUztxQkFDckI7aUJBQ0Y7YUFDRjtTQUNKLENBQUM7UUFFRixNQUFNLDBCQUEwQixHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDckYsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUU7WUFDckYsUUFBUSxFQUFFLDBCQUEwQjtTQUN2QyxDQUFDLENBQUM7UUFDSCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDekQsT0FBTyxvQkFBb0IsQ0FBQztJQUNoQyxDQUFDO0NBQ0o7QUExS0Qsa0NBMEtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgS3ViZXJuZXRlc01hbmlmZXN0LCBTZXJ2aWNlQWNjb3VudCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczNcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgbWVyZ2UgZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8gfSBmcm9tIFwiLi4vLi4vc3BpXCI7XG5pbXBvcnQgeyBjcmVhdGVOYW1lc3BhY2UgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcbmltcG9ydCB7IEhlbG1BZGRPbiwgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSBcIi4uL2hlbG0tYWRkb25cIjtcblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBhZGQtb24uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVmVsZXJvQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7ICAgIFxuICAgIGNyZWF0ZU5hbWVzcGFjZTogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBEZWZhdWx0cyBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmNvbnN0IGRlZmF1bHRQcm9wcyA9IHtcbiAgICBuYW1lOiAndmVsZXJvJyxcbiAgICB2ZXJzaW9uOiBcIjMuMi4wXCIsXG4gICAgbmFtZXNwYWNlOiBcInZlbGVyb1wiLFxuICAgIGNyZWF0ZU5hbWVzcGFjZTogdHJ1ZSxcbiAgICBjaGFydDogXCJ2ZWxlcm9cIixcbiAgICByZXBvc2l0b3J5OiBcImh0dHBzOi8vdm13YXJlLXRhbnp1LmdpdGh1Yi5pby9oZWxtLWNoYXJ0cy9cIixcbiAgICByZWxlYXNlOiBcImJsdWVwcmludHMtYWRkb24tdmVsZXJvXCIsXG4gICAgdmFsdWVzOntcbiAgICAgICAgaW5pdENvbnRhaW5lcnM6W1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6IFwidmVsZXJvLXBsdWdpbi1mb3ItYXdzXCIsXG4gICAgICAgICAgICAgICAgaW1hZ2U6IFwidmVsZXJvL3ZlbGVyby1wbHVnaW4tZm9yLWF3czp2MS4yLjBcIixcbiAgICAgICAgICAgICAgICBpbWFnZVB1bGxQb2xpY3k6IFwiSWZOb3RQcmVzZW50XCIsXG4gICAgICAgICAgICAgICAgdm9sdW1lTW91bnRzOltcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW91bnRQYXRoOiBcIi90YXJnZXRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IFwicGx1Z2luc1wiXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9XG4gICAgICAgIF0sXG4gICAgICAgIGNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgIHByb3ZpZGVyOiBcImF3c1wiLFxuICAgICAgICAgICAgYmFja3VwU3RvcmFnZUxvY2F0aW9uOntcbiAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHRcIixcbiAgICAgICAgICAgICAgICBjb25maWc6e31cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB2b2x1bWVTbmFwc2hvdExvY2F0aW9uOntcbiAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHRcIixcbiAgICAgICAgICAgICAgICBjb25maWc6e31cbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICBzZXJ2ZXI6e31cbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG5leHBvcnQgY2xhc3MgVmVsZXJvQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBSZXF1aXJlZDxWZWxlcm9BZGRPblByb3BzPjtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzPzogVmVsZXJvQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcihtZXJnZShkZWZhdWx0UHJvcHMsIHByb3BzID8/IHt9KSk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHMgYXMgUmVxdWlyZWQ8VmVsZXJvQWRkT25Qcm9wcz47XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIGFkZC1vbiBjb250cmFjdCBkZXBsb3kgbWV0aG9kLlxuICAgICovXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMub3B0aW9ucztcbiAgICAgICAgICAgICAgIFxuICAgICAgICAvLyBDcmVhdGUgUzMgYnVja2V0IGlmIG5vIGV4aXN0aW5nIGJ1Y2tldCwgY3JlYXRlIHMzIGJ1Y2tldCBhbmQgY29ycmVzcG9uZGluZyBLTVMga2V5XG4gICAgICAgIGNvbnN0IHMzQnVja2V0ID0gdGhpcy5nZXRPckNyZWF0ZVMzQnVja2V0KGNsdXN0ZXJJbmZvLCBcImJhY2t1cC1idWNrZXRcIiwgcHJvcHMudmFsdWVzLmNvbmZpZ3VyYXRpb24uYmFja3VwU3RvcmFnZUxvY2F0aW9uLmJ1Y2tldCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIE5hbWVzcGFjZSBpZiBuYW1lc3BhY2UgaXMgbm90IGV4cGxpY2llZCBkZWZpbmVkLlxuICAgICAgICBjb25zdCB2ZWxlcm9OYW1lc3BhY2UgPSB0aGlzLmNyZWF0ZU5hbWVzcGFjZUlmTmVlZGVkKGNsdXN0ZXJJbmZvLCBcInZlbGVyb1wiLCBwcm9wcy5uYW1lc3BhY2UsIHByb3BzLmNyZWF0ZU5hbWVzcGFjZSk7XG5cbiAgICAgICAgLy8gU2V0dXAgSUFNIFJvbGUgZm9yIFNlcnZpY2UgQWNjb3VudHMgKElSU0EpIGZvciB0aGUgVmVsZXJvIFNlcnZpY2UgQWNjb3VudCAgICBcbiAgICAgICAgY29uc3QgdmVsZXJvU2VydmljZUFjY291bnQgPSB0aGlzLmNyZWF0ZVNlcnZpY2VBY2NvdW50V2l0aElhbVJvbGVzKGNsdXN0ZXJJbmZvLCBcInZlbGVyby1hY2NvdW50XCIsIHZlbGVyb05hbWVzcGFjZS5uYW1lLCBzM0J1Y2tldCk7XG4gICAgICAgIFxuICAgICAgICAvLyBpZiB2ZWxlcm9OYW1lIHNwYWNlIGRvZXMgbm90IGV4aXN0IGFuZCBuZWVkcyBjcmVhdGlvbiwgYWRkIHRoZSBkZXBlbmRlbmN5XG4gICAgICAgIGlmICh2ZWxlcm9OYW1lc3BhY2UubWFuaWZlc3QpIHtcbiAgICAgICAgICAgIHZlbGVyb1NlcnZpY2VBY2NvdW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh2ZWxlcm9OYW1lc3BhY2UubWFuaWZlc3QpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBTZXR1cCB0aGUgdmFsdWVzIGZvciB0aGUgaGVsbSBjaGFydFxuICAgICAgICBjb25zdCB2YWx1ZVZhcmlhYmxlID0ge1xuICAgICAgICAgICAgdmFsdWVzOiB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICBiYWNrdXBTdG9yYWdlTG9jYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogcHJvcHMudmFsdWVzIS5jb25maWd1cmF0aW9uLmJhY2t1cFN0b3JhZ2VMb2NhdGlvbi5wcmVmaXggPz8gXCJ2ZWxlcm8vXCIgKyBjbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0OiBzM0J1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lvbjogcHJvcHMudmFsdWVzIS5jb25maWd1cmF0aW9uLmJhY2t1cFN0b3JhZ2VMb2NhdGlvbi5jb25maWcucmVnaW9uID8/IGNsdXN0ZXIuc3RhY2sucmVnaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB2b2x1bWVTbmFwc2hvdExvY2F0aW9uOntcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzp7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVnaW9uOiBwcm9wcy52YWx1ZXMhLmNvbmZpZ3VyYXRpb24uYmFja3VwU3RvcmFnZUxvY2F0aW9uLmNvbmZpZy5yZWdpb24gPz8gY2x1c3Rlci5zdGFjay5yZWdpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLy8gSUFNIHJvbGUgZm9yIFNlcnZpY2UgQWNjb3VudFxuICAgICAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcnZlcjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHZlbGVyb1NlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZSwgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IG1lcmdlKHByb3BzLnZhbHVlcyEsIHZhbHVlVmFyaWFibGUudmFsdWVzKSA/PyB7fTsgXG4gXG4gICAgICAgIGNvbnN0IGNoYXJ0Tm9kZSA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB2YWx1ZXMpO1xuICAgICAgICBjaGFydE5vZGUubm9kZS5hZGREZXBlbmRlbmN5KHZlbGVyb1NlcnZpY2VBY2NvdW50KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjaGFydE5vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBTMyBCdWNrZXRcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm8gXG4gICAgICogQHBhcmFtIGlkIFMzLUJ1Y2tldC1Qb3N0Zml4IFxuICAgICAqIEBwYXJhbSBleGlzdGluZ0J1Y2tldE5hbWUgZXhpdGluZyBwcm92aWRlZCBTMyBCdWNrZXROYW1lIGlmIGl0IGV4aXN0cyBcbiAgICAgKiBAcmV0dXJucyB0aGUgZXhpc3RpbmcgcHJvdmlkZWQgUzMgYnVja2V0ICBvciB0aGUgbmV3bHkgY3JlYXRlZCBTMyBidWNrZXQgYXMgczMuSUJ1Y2tldFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRPckNyZWF0ZVMzQnVja2V0KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgaWQ6IHN0cmluZywgZXhpc3RpbmdCdWNrZXROYW1lOiBudWxsfHN0cmluZyApOiBzMy5JQnVja2V0IHtcbiAgICAgICAgaWYgKCFleGlzdGluZ0J1Y2tldE5hbWUpe1xuICAgICAgICAgICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChjbHVzdGVySW5mby5jbHVzdGVyLCBcInZlbGVyby0ke2lkfVwiLCB7XG4gICAgICAgICAgICAgICAgZW5jcnlwdGlvbjogczMuQnVja2V0RW5jcnlwdGlvbi5LTVNfTUFOQUdFRCwgLy8gVmVsZXJvIEtub3duIGJ1ZyBmb3Igc3VwcG9ydCB3aXRoIFMzIHdpdGggU1NFLUtNUyB3aXRoIENNSywgdGh1cyBpdCBkb2VzIG5vdCBzdXBwb3J0IFMzIEJ1Y2tldCBLZXk6IGh0dHBzOi8vZ2l0aHViLmNvbS92bXdhcmUtdGFuenUvaGVsbS1jaGFydHMvaXNzdWVzLzgzXG4gICAgICAgICAgICAgICAgYmxvY2tQdWJsaWNBY2Nlc3M6IHMzLkJsb2NrUHVibGljQWNjZXNzLkJMT0NLX0FMTCwgLy8gQmxvY2sgUHVibGljIEFjY2VzcyBmb3IgUzNcbiAgICAgICAgICAgICAgICBwdWJsaWNSZWFkQWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlbmZvcmNlU1NMOiB0cnVlIC8vIEVuY3J5cHRpb24gaW4gVHJhbnNpdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gczMuQnVja2V0LmZyb21CdWNrZXROYW1lKGNsdXN0ZXJJbmZvLmNsdXN0ZXIsICdnZXRPckNyZWF0ZVMzQnVja2V0JywgYnVja2V0LmJ1Y2tldE5hbWUgKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBzMy5CdWNrZXQuZnJvbUJ1Y2tldE5hbWUoY2x1c3RlckluZm8uY2x1c3RlciwgJ2dldE9yQ3JlYXRlUzNCdWNrZXQnLCBleGlzdGluZ0J1Y2tldE5hbWUgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBWZWxlcm8gTmFtZXNwYWNlIHdoZXJlIFZlbGVybyB3aWxsIGJlIGluc3RhbGxlZCBvbnRvXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvXG4gICAgICogQHBhcmFtIGRlZmF1bHROYW1lIHRoZSBEZWZhdWx0IE5hbWVzcGFjZSBmb3IgVmVsZXJvIGlmIG5vdGhpbmcgc3BlY2lmaWVkIFxuICAgICAqIEBwYXJhbSBuYW1lc3BhY2VcbiAgICAgKiBAcmV0dXJucyB0aGUgbmFtZXNwYWNlIGNyZWF0ZWQgb3IgZXhpc3RlZC5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlTmFtZXNwYWNlSWZOZWVkZWQoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBkZWZhdWx0TmFtZTogc3RyaW5nLCBuYW1lc3BhY2U6IHN0cmluZywgY3JlYXRlOiBib29sZWFuKToge25hbWU6IHN0cmluZywgbWFuaWZlc3Q/OiBLdWJlcm5ldGVzTWFuaWZlc3R9IHtcbiAgICAgICAgLy8gQ3JlYXRlIE5hbWVzcGFjZSBpZiBuYW1lc3BhY2UgaXMgbm90IGV4cGxpY2llZCBkZWZpbmVkLlxuICAgICAgICBpZiAobmFtZXNwYWNlKXtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBOYW1lc3BhY2UgaWYgdGhlIFwiY3JlYXRlXCIgb3B0aW9uIGlzIHRydWVcbiAgICAgICAgICAgIGlmIChjcmVhdGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lc3BhY2VNYW5pZmVzdCA9IGNyZWF0ZU5hbWVzcGFjZShuYW1lc3BhY2UsIGNsdXN0ZXJJbmZvLmNsdXN0ZXIpO1xuICAgICAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IG5hbWVzcGFjZSwgbWFuaWZlc3Q6IG5hbWVzcGFjZU1hbmlmZXN0IH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBJZiB0aGUgXCJjcmVhdGVcIiBvcHRpb24gaWYgZmFsc2UsIHRoZW4gbmFtZXNwYWNlIHdpbGwgbm90IGJlIGNyZWF0ZWQsIHJldHVybiBuYW1lc3BhY2UubmFtZVxuICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBuYW1lOiBuYW1lc3BhY2UgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgcmV0dXJuIHsgbmFtZTogZGVmYXVsdE5hbWUgfTsgLy8gaW5pdGlhbCB2YWx1ZSBvZiB2ZWxlcm9OYW1lc3BhY2VcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBWZWxlcm8gTmFtZXNwYWNlIHdoZXJlIFZlbGVybyB3aWxsIGJlIGluc3RhbGxlZCBvbnRvXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvXG4gICAgICogQHBhcmFtIGlkXG4gICAgICogQHBhcmFtIG5hbWVzcGFjZSBWZWxlcm8gbmFtZXNwYWNlIG5hbWVcbiAgICAgKiBAcGFyYW0gczNCdWNrZXROYW1lIHRoZSBTMyBCdWNrZXROYW1lIHdoZXJlIFZlbGVybyB3aWxsIHN0b3JlcyB0aGUgYmFja3VwIG9udG9cbiAgICAgKiBAcmV0dXJucyB0aGUgc2VydmljZSBBY2NvdW50XG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVNlcnZpY2VBY2NvdW50V2l0aElhbVJvbGVzKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgaWQ6IHN0cmluZywgbmFtZXNwYWNlOiBzdHJpbmcsIHMzQnVja2V0OiBzMy5JQnVja2V0KTogU2VydmljZUFjY291bnQge1xuICAgICAgICAvLyBTZXR1cCBJQU0gUm9sZSBmb3IgU2VydmljZSBBY2NvdW50cyAoSVJTQSkgZm9yIHRoZSBWZWxlcm8gU2VydmljZSBBY2NvdW50XG4gICAgICAgIGNvbnN0IHZlbGVyb1NlcnZpY2VBY2NvdW50ID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCAoXG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiBpZCxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIElBTSBwb2xpY3kgZm9yIFZlbGVyb1xuICAgICAgICBjb25zdCB2ZWxlcm9Qb2xpY3lEb2N1bWVudCA9IHtcbiAgICAgICAgICAgIFwiVmVyc2lvblwiOiBcIjIwMTItMTAtMTdcIixcbiAgICAgICAgICAgIFwiU3RhdGVtZW50XCI6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgICAgICAgXCJBY3Rpb25cIjogW1xuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkRlc2NyaWJlVm9sdW1lc1wiLFxuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkRlc2NyaWJlU25hcHNob3RzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgXCJlYzI6Q3JlYXRlVGFnc1wiLFxuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkNyZWF0ZVZvbHVtZVwiLFxuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkNyZWF0ZVNuYXBzaG90XCIsXG4gICAgICAgICAgICAgICAgICAgICAgXCJlYzI6RGVsZXRlU25hcHNob3RcIlxuICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjogXCIqXCJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFwiRWZmZWN0XCI6IFwiQWxsb3dcIixcbiAgICAgICAgICAgICAgICBcIkFjdGlvblwiOiBbXG4gICAgICAgICAgICAgICAgICAgIFwiczM6R2V0T2JqZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiczM6RGVsZXRlT2JqZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiczM6UHV0T2JqZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiczM6QWJvcnRNdWx0aXBhcnRVcGxvYWRcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzMzpMaXN0TXVsdGlwYXJ0VXBsb2FkUGFydHNcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzMzpMaXN0QnVja2V0XCJcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjogW1xuICAgICAgICAgICAgICAgICAgICBzM0J1Y2tldC5hcm5Gb3JPYmplY3RzKFwiKlwiKSxcbiAgICAgICAgICAgICAgICAgICAgczNCdWNrZXQuYnVja2V0QXJuICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHZlbGVyb0N1c3RvbVBvbGljeURvY3VtZW50ID0gaWFtLlBvbGljeURvY3VtZW50LmZyb21Kc29uKHZlbGVyb1BvbGljeURvY3VtZW50KTtcbiAgICAgICAgY29uc3QgdmVsZXJvUG9saWN5ID0gbmV3IGlhbS5NYW5hZ2VkUG9saWN5KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsIFwidmVsZXJvLW1hbmFnZWQtcG9saWN5XCIsIHtcbiAgICAgICAgICAgIGRvY3VtZW50OiB2ZWxlcm9DdXN0b21Qb2xpY3lEb2N1bWVudFxuICAgICAgICB9KTtcbiAgICAgICAgdmVsZXJvU2VydmljZUFjY291bnQucm9sZS5hZGRNYW5hZ2VkUG9saWN5KHZlbGVyb1BvbGljeSk7XG4gICAgICAgIHJldHVybiB2ZWxlcm9TZXJ2aWNlQWNjb3VudDtcbiAgICB9XG59Il19