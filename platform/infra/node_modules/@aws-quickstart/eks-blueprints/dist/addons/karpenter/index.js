"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KarpenterAddOn = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const iam_1 = require("./iam");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const md5 = require("ts-md5");
const semver = require("semver");
const assert = require("assert");
const sqs = require("aws-cdk-lib/aws-sqs");
const aws_events_1 = require("aws-cdk-lib/aws-events");
const aws_events_targets_1 = require("aws-cdk-lib/aws-events-targets");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const KARPENTER = 'karpenter';
const RELEASE = 'blueprints-addon-karpenter';
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: KARPENTER,
    namespace: KARPENTER,
    version: 'v0.29.2',
    chart: KARPENTER,
    release: KARPENTER,
    repository: 'oci://public.ecr.aws/karpenter/karpenter',
};
/**
 * Implementation of the Karpenter add-on
 */
class KarpenterAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b, _c;
        assert(clusterInfo.cluster instanceof aws_eks_1.Cluster, "KarpenterAddOn cannot be used with imported clusters as it requires changes to the cluster authentication.");
        const cluster = clusterInfo.cluster;
        const endpoint = cluster.clusterEndpoint;
        const name = cluster.clusterName;
        const stackName = cluster.stack.stackName;
        const region = cluster.stack.region;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        const version = this.options.version;
        const requirements = this.options.requirements || [];
        const subnetTags = this.options.subnetTags || {};
        const sgTags = this.options.securityGroupTags || {};
        const taints = this.options.taints || [];
        const startupTaints = this.options.startupTaints || [];
        const labels = this.options.labels || {};
        const annotations = this.options.annotations || {};
        const amiFamily = this.options.amiFamily;
        const amiSelector = this.options.amiSelector;
        const ttlSecondsAfterEmpty = this.options.ttlSecondsAfterEmpty || null;
        const ttlSecondsUntilExpired = this.options.ttlSecondsUntilExpired || null;
        const weight = this.options.weight || null;
        const consol = this.options.consolidation || null;
        const repo = this.options.repository;
        const interruption = this.options.interruptionHandling || false;
        const limits = this.options.limits || null;
        const tags = this.options.tags || null;
        // Various checks for version errors
        const consolidation = this.versionFeatureChecksForError(clusterInfo, version, weight, consol, repo, ttlSecondsAfterEmpty, interruption);
        // Set up the node role and instance profile
        const [karpenterNodeRole, karpenterInstanceProfile] = this.setUpNodeRole(cluster, stackName, region);
        // Create the controller policy
        const karpenterPolicyDocument = iam.PolicyDocument.fromJson(iam_1.KarpenterControllerPolicy);
        karpenterPolicyDocument.addStatements(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "iam:PassRole",
            ],
            resources: [`${karpenterNodeRole.roleArn}`]
        }));
        // Support for Native spot interruption only available on v0.19.0 or later
        if (semver.gte(version, 'v0.19.0') && interruption) {
            // Create Interruption Queue
            const queue = new sqs.Queue(cluster.stack, 'karpenter-queue', {
                queueName: stackName,
                retentionPeriod: aws_cdk_lib_1.Duration.seconds(300),
            });
            queue.addToResourcePolicy(new iam.PolicyStatement({
                sid: 'EC2InterruptionPolicy',
                effect: iam.Effect.ALLOW,
                principals: [
                    new iam.ServicePrincipal('sqs.amazonaws.com'),
                    new iam.ServicePrincipal('events.amazonaws.com'),
                ],
                actions: [
                    "sqs:SendMessage"
                ],
                resources: [`${queue.queueArn}`]
            }));
            // Add Interruption Rules
            new aws_events_1.Rule(cluster.stack, 'schedule-change-rule', {
                eventPattern: {
                    source: ["aws.health"],
                    detailType: ['AWS Health Event']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            new aws_events_1.Rule(cluster.stack, 'spot-interruption-rule', {
                eventPattern: {
                    source: ["aws.ec2"],
                    detailType: ['EC2 Spot Instance Interruption Warning']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            new aws_events_1.Rule(cluster.stack, 'rebalance-rule', {
                eventPattern: {
                    source: ["aws.ec2"],
                    detailType: ['EC2 Instance Rebalance Recommendation']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            new aws_events_1.Rule(cluster.stack, 'inst-state-change-rule', {
                eventPattern: {
                    source: ["aws.ec2"],
                    detailType: ['C2 Instance State-change Notification']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            // Add policy to the node role to allow access to the Interruption Queue
            const interruptionQueueStatement = new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: [
                    "sqs:DeleteMessage",
                    "sqs:GetQueueUrl",
                    "sqs:GetQueueAttributes",
                    "sqs:ReceiveMessage"
                ],
                resources: [`${queue.queueArn}`]
            });
            karpenterPolicyDocument.addStatements(interruptionQueueStatement);
        }
        // Create Namespace
        const ns = (0, utils_1.createNamespace)(KARPENTER, cluster, true, true);
        const sa = (0, utils_1.createServiceAccount)(cluster, RELEASE, KARPENTER, karpenterPolicyDocument);
        sa.node.addDependency(ns);
        // Add helm chart
        if (semver.gte(this.options.version, '0.19.0')) {
            const awsSettings = {
                clusterEndpoint: endpoint,
                clusterName: name,
                defaultInstanceProfile: karpenterInstanceProfile.instanceProfileName,
                interruptionQueueName: interruption ? stackName : "",
            };
            (0, utils_1.setPath)(values, "settings.aws", (0, ts_deepmerge_1.default)(awsSettings, (_c = (_b = values === null || values === void 0 ? void 0 : values.settings) === null || _b === void 0 ? void 0 : _b.aws) !== null && _c !== void 0 ? _c : {}));
        }
        else {
            (0, utils_1.setPath)(values, "clusterEndpoint", endpoint);
            (0, utils_1.setPath)(values, "clusterName", name);
            (0, utils_1.setPath)(values, "aws.defaultInstanceProfile", karpenterInstanceProfile.instanceProfileName);
        }
        const saValues = {
            serviceAccount: {
                create: false,
                name: RELEASE,
                annotations: {
                    "eks.amazonaws.com/role-arn": sa.role.roleArn,
                }
            }
        };
        values = (0, ts_deepmerge_1.default)(values, saValues);
        const karpenterChart = this.addHelmChart(clusterInfo, values, false, true);
        karpenterChart.node.addDependency(ns);
        // (Optional) default provisioner
        if ((Object.keys(subnetTags).length > 0) && (Object.keys(sgTags).length > 0)) {
            const provisioner = cluster.addManifest('default-provisioner', {
                apiVersion: 'karpenter.sh/v1alpha5',
                kind: 'Provisioner',
                metadata: { name: 'default' },
                spec: {
                    providerRef: {
                        name: "default"
                    },
                    taints: taints,
                    startupTaints: startupTaints,
                    labels: labels,
                    annotations: annotations,
                    requirements: this.convert(requirements),
                    limits: limits,
                    consolidation: consolidation,
                    ttlSecondsUntilExpired: ttlSecondsUntilExpired,
                    ttlSecondsAfterEmpty: ttlSecondsAfterEmpty,
                    weight: weight,
                },
            });
            provisioner.node.addDependency(karpenterChart);
            const nodeTemplate = cluster.addManifest('default-node-template', {
                apiVersion: "karpenter.k8s.aws/v1alpha1",
                kind: "AWSNodeTemplate",
                metadata: {
                    name: "default"
                },
                spec: {
                    amiFamily: amiFamily,
                    amiSelector: amiSelector,
                    subnetSelector: subnetTags,
                    securityGroupSelector: sgTags,
                    tags: tags,
                },
            });
            nodeTemplate.node.addDependency(provisioner);
        }
        return Promise.resolve(karpenterChart);
    }
    /**
     * Helper function to convert a key-pair values (with an operator)
     * of spec configurations to appropriate json format for addManifest function
     * @param reqs
     * @returns newReqs
     * */
    convert(reqs) {
        const newReqs = [];
        for (let req of reqs) {
            const key = req['key'];
            const op = req['op'];
            const val = req['vals'];
            const requirement = {
                "key": key,
                "operator": op,
                "values": val
            };
            newReqs.push(requirement);
        }
        return newReqs;
    }
    /**
     * Helper function to ensure right features are added as part of the configuration
     * for the right version of the add-on
     * @param version version of the add-on
     * @param weight weight setting
     * @param consol consolidation setting
     * @param repo repository url of the helm chart
     * @param ttlSecondsAfterEmpty ttlSecondsAfterEmpty setting
     * @returns consolidation
     */
    versionFeatureChecksForError(clusterInfo, version, weight, consol, repo, ttlSecondsAfterEmpty, interruption) {
        // Consolidation only available with v0.15.0 and later
        let consolidation;
        if (semver.lt(version, '0.15.0')) {
            assert(!consol, 'The prop consolidation is only supported on versions v0.15.0 and later.');
        }
        else {
            consolidation = consol || { enabled: false };
            // You cannot enable consolidation and ttlSecondsAfterEmpty values
            assert(!(consolidation.enabled && ttlSecondsAfterEmpty), 'Consolidation and ttlSecondsAfterEmpty must be mutually exclusive.');
        }
        // Weight only available with v0.16.0 and later
        if (semver.lt(version, '0.16.0')) {
            assert(!weight, 'The prop weight is only supported on versions v0.16.0 and later.');
        }
        // Registry changes with v0.17.0 and later
        if (semver.gte(version, '0.17.0')) {
            assert(repo === 'oci://public.ecr.aws/karpenter/karpenter', 'Please provide the OCI repository.');
        }
        else {
            assert(repo === 'https://charts.karpenter.sh', 'Please provide the older Karpenter repository url.');
        }
        // Interruption handling only available with v0.19.0 and later
        // Conversely, we should block Node Termination Handler usage once Karpenter is leveraged
        if (semver.lt(version, '0.19.0')) {
            assert(!interruption, 'Interruption handling is only supported on versions v0.19.0 and later.');
        }
        else {
            assert(!clusterInfo.getProvisionedAddOn('AwsNodeTerminationHandlerAddOn'), 'Karpenter supports native interruption handling, so Node Termination Handler will not be necessary.');
        }
        return consolidation;
    }
    /**
     * Helper function to set up the Karpenter Node Role and Instance Profile
     * Outputs to CloudFormation and map the role to the aws-auth ConfigMap
     * @param cluster EKS Cluster
     * @param stackName Name of the stack
     * @param region Region of the stack
     * @returns [karpenterNodeRole, karpenterInstanceProfile]
     */
    setUpNodeRole(cluster, stackName, region) {
        // Set up Node Role
        const karpenterNodeRole = new iam.Role(cluster, 'karpenter-node-role', {
            assumedBy: new iam.ServicePrincipal(`ec2.${cluster.stack.urlSuffix}`),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKSWorkerNodePolicy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKS_CNI_Policy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEC2ContainerRegistryReadOnly"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonSSMManagedInstanceCore"),
            ],
            //roleName: `KarpenterNodeRole-${name}` // let role name to be generated as unique
        });
        // Set up Instance Profile
        const instanceProfileName = md5.Md5.hashStr(stackName + region);
        const karpenterInstanceProfile = new iam.CfnInstanceProfile(cluster, 'karpenter-instance-profile', {
            roles: [karpenterNodeRole.roleName],
            instanceProfileName: `KarpenterNodeInstanceProfile-${instanceProfileName}`,
            path: '/'
        });
        const clusterId = aws_cdk_lib_1.Names.uniqueId(cluster);
        //Cfn output for Node Role in case of needing to add additional policies
        new aws_cdk_lib_1.CfnOutput(cluster.stack, 'Karpenter Instance Node Role', {
            value: karpenterNodeRole.roleName,
            description: "Karpenter add-on Node Role name",
            exportName: clusterId + "KarpenterNodeRoleName",
        });
        //Cfn output for Instance Profile for creating additional provisioners
        new aws_cdk_lib_1.CfnOutput(cluster.stack, 'Karpenter Instance Profile name', {
            value: karpenterInstanceProfile ? karpenterInstanceProfile.instanceProfileName : "none",
            description: "Karpenter add-on Instance Profile name",
            exportName: clusterId + "KarpenterInstanceProfileName",
        });
        // Map Node Role to aws-auth
        cluster.awsAuth.addRoleMapping(karpenterNodeRole, {
            groups: ['system:bootstrapper', 'system:nodes'],
            username: 'system:node:{{EC2PrivateDNSName}}'
        });
        return [karpenterNodeRole, karpenterInstanceProfile];
    }
}
exports.KarpenterAddOn = KarpenterAddOn;
__decorate([
    (0, utils_1.conflictsWith)('ClusterAutoScalerAddOn')
], KarpenterAddOn.prototype, "deploy", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2thcnBlbnRlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBMkM7QUFFM0MsK0NBQWlDO0FBRWpDLHVDQUE2RjtBQUM3Riw4Q0FBOEU7QUFDOUUsK0JBQWtEO0FBQ2xELDZDQUF5RDtBQUN6RCw4QkFBOEI7QUFDOUIsaUNBQWlDO0FBQ2pDLGlDQUFpQztBQUNqQywyQ0FBMkM7QUFDM0MsdURBQThDO0FBQzlDLHVFQUEwRDtBQUMxRCxpREFBOEM7QUF5SDlDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztBQUM5QixNQUFNLE9BQU8sR0FBRyw0QkFBNEIsQ0FBQztBQUU3Qzs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFtQjtJQUNqQyxJQUFJLEVBQUUsU0FBUztJQUNmLFNBQVMsRUFBRSxTQUFTO0lBQ3BCLE9BQU8sRUFBRSxTQUFTO0lBQ2xCLEtBQUssRUFBRSxTQUFTO0lBQ2hCLE9BQU8sRUFBRSxTQUFTO0lBQ2xCLFVBQVUsRUFBRSwwQ0FBMEM7Q0FDekQsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBYSxjQUFlLFNBQVEsc0JBQVM7SUFJekMsWUFBWSxLQUEyQjtRQUNuQyxLQUFLLENBQUMsRUFBQyxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQzlCLENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7O1FBQzNCLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxZQUFZLGlCQUFPLEVBQUUsNEdBQTRHLENBQUMsQ0FBQztRQUM3SixNQUFNLE9BQU8sR0FBYSxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQzlDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUM7UUFDekMsTUFBTSxJQUFJLEdBQUcsT0FB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LEVBQUUsaUNBQWlDO1lBQzlDLFVBQVUsRUFBRSxTQUFTLEdBQUMsdUJBQXVCO1NBQ2hELENBQUMsQ0FBQztRQUNILHNFQUFzRTtRQUN0RSxJQUFJLHVCQUFTLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxpQ0FBaUMsRUFBRTtZQUM1RCxLQUFLLEVBQUUsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLHdCQUF3QixDQUFDLG1CQUFvQixDQUFDLENBQUMsQ0FBQyxNQUFNO1lBQ3hGLFdBQVcsRUFBRSx3Q0FBd0M7WUFDckQsVUFBVSxFQUFFLFNBQVMsR0FBQyw4QkFBOEI7U0FDdkQsQ0FBQyxDQUFDO1FBRUgsNEJBQTRCO1FBQzVCLE9BQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLGlCQUFpQixFQUFFO1lBQzlDLE1BQU0sRUFBRSxDQUFDLHFCQUFxQixFQUFFLGNBQWMsQ0FBQztZQUMvQyxRQUFRLEVBQUUsbUNBQW1DO1NBQ2hELENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO0lBQ3pELENBQUM7Q0FDSjtBQTVURCx3Q0E0VEM7QUFsVEc7SUFEQyxJQUFBLHFCQUFhLEVBQUMsd0JBQXdCLENBQUM7NENBMEx2QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgbWVyZ2UgZnJvbSAndHMtZGVlcG1lcmdlJztcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMsIFRhaW50IH0gZnJvbSAnLi4vLi4vc3BpJztcbmltcG9ydCB7IGNvbmZsaWN0c1dpdGgsIGNyZWF0ZU5hbWVzcGFjZSwgY3JlYXRlU2VydmljZUFjY291bnQsIHNldFBhdGgsIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Qcm9wcywgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSAnLi4vaGVsbS1hZGRvbic7XG5pbXBvcnQgeyBLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5IH0gZnJvbSAnLi9pYW0nO1xuaW1wb3J0IHsgQ2ZuT3V0cHV0LCBEdXJhdGlvbiwgTmFtZXMgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBtZDUgZnJvbSAndHMtbWQ1JztcbmltcG9ydCAqIGFzIHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbmltcG9ydCAqIGFzIHNxcyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc3FzJztcbmltcG9ydCB7IFJ1bGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcbmltcG9ydCB7IFNxc1F1ZXVlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzJztcbmltcG9ydCB7IENsdXN0ZXIgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcblxuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5pbnRlcmZhY2UgS2FycGVudGVyQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVGFpbnRzIGZvciB0aGUgcHJvdmlzaW9uZWQgbm9kZXMgLSBUYWludHMgbWF5IHByZXZlbnQgcG9kcyBmcm9tIHNjaGVkdWxpbmcgaWYgdGhleSBhcmUgbm90IHRvbGVyYXRlZCBieSB0aGUgcG9kLlxuICAgICAqL1xuICAgIHRhaW50cz86IFRhaW50W10sXG5cbiAgICAvKipcbiAgICAgKiBQcm92aXNpb25lZCBub2RlcyB3aWxsIGhhdmUgdGhlc2UgdGFpbnRzLCBidXQgcG9kcyBkbyBub3QgbmVlZCB0byB0b2xlcmF0ZSB0aGVzZSB0YWludHMgdG8gYmUgcHJvdmlzaW9uZWQgYnkgdGhpc1xcXG4gICAgICogcHJvdmlzaW9uZXIuIFRoZXNlIHRhaW50cyBhcmUgZXhwZWN0ZWQgdG8gYmUgdGVtcG9yYXJ5IGFuZCBzb21lIG90aGVyIGVudGl0eSAoZS5nLiBhIERhZW1vblNldCkgaXMgcmVzcG9uc2libGUgZm9yXG4gICAgICogcmVtb3ZpbmcgdGhlIHRhaW50IGFmdGVyIGl0IGhhcyBmaW5pc2hlZCBpbml0aWFsaXppbmcgdGhlIG5vZGUuXG4gICAgICovXG4gICAgc3RhcnR1cFRhaW50cz86IFRhaW50W10sXG5cbiAgICAvKipcbiAgICAgKiBMYWJlbHMgYXBwbGllZCB0byBhbGwgbm9kZXNcbiAgICAgKi9cbiAgICBsYWJlbHM/OiBWYWx1ZXMsXG5cbiAgICAvKipcbiAgICAgKiBBbm5vdGF0aW9ucyBhcHBsaWVkIHRvIGFsbCBub2Rlc1xuICAgICAqL1xuICAgIGFubm90YXRpb25zPzogVmFsdWVzLFxuXG4gICAgLyoqXG4gICAgICogUmVxdWlyZW1lbnQgcHJvcGVydGllcyBmb3IgYSBQcm92aXNpb25lciAoT3B0aW9uYWwpIC0gSWYgbm90IHByb3ZpZGVkLCB0aGUgYWRkLW9uIHdpbGxcbiAgICAgKiBkZXBsb3kgYSBQcm92aXNpb25lciB3aXRoIGRlZmF1bHQgdmFsdWVzLlxuICAgICAqL1xuICAgIHJlcXVpcmVtZW50cz86IHtcbiAgICAgICAga2V5OiBzdHJpbmcsXG4gICAgICAgIG9wOiAnSW4nIHwgJ05vdEluJyAsXG4gICAgICAgIHZhbHM6IHN0cmluZ1tdLFxuICAgIH1bXVxuXG4gICAgLyoqXG4gICAgICogVGFncyBuZWVkZWQgZm9yIHN1Ym5ldHMgLSBTdWJuZXQgdGFncyBhbmQgc2VjdXJpdHkgZ3JvdXAgdGFncyBhcmUgcmVxdWlyZWQgZm9yIHRoZSBwcm92aXNpb25lciB0byBiZSBjcmVhdGVkXG4gICAgICovXG4gICAgc3VibmV0VGFncz86IFZhbHVlcyxcblxuICAgIC8qKlxuICAgICAqIFRhZ3MgbmVlZGVkIGZvciBzZWN1cml0eSBncm91cHMgLSBTdWJuZXQgdGFncyBhbmQgc2VjdXJpdHkgZ3JvdXAgdGFncyBhcmUgcmVxdWlyZWQgZm9yIHRoZSBwcm92aXNpb25lciB0byBiZSBjcmVhdGVkXG4gICAgICovXG4gICAgc2VjdXJpdHlHcm91cFRhZ3M/OiBWYWx1ZXMsXG5cbiAgICAvKipcbiAgICAgKiBBTUkgRmFtaWx5OiBJZiBwcm92aWRlZCwgS2FycGVudGVyIHdpbGwgYXV0b21hdGljYWxseSBxdWVyeSB0aGUgYXBwcm9wcmlhdGUgRUtTIG9wdGltaXplZCBBTUkgdmlhIEFXUyBTeXN0ZW1zIE1hbmFnZXJcbiAgICAgKi9cbiAgICBhbWlGYW1pbHk/OiBcIkFMMlwiIHwgXCJCb3R0bGVyb2NrZXRcIiB8IFwiVWJ1bnR1XCJcblxuICAgIC8qKlxuICAgICAqIEFNSSBTZWxlY3RvclxuICAgICAqL1xuICAgIGFtaVNlbGVjdG9yPzogVmFsdWVzLFxuXG4gICAgLyoqXG4gICAgICogRW5hYmxlcyBjb25zb2xpZGF0aW9uIHdoaWNoIGF0dGVtcHRzIHRvIHJlZHVjZSBjbHVzdGVyIGNvc3QgYnkgYm90aCByZW1vdmluZyB1bi1uZWVkZWQgbm9kZXMgYW5kIGRvd24tc2l6aW5nIHRob3NlIHRoYXQgY2FuJ3QgYmUgcmVtb3ZlZC4gIFxuICAgICAqIE11dHVhbGx5IGV4Y2x1c2l2ZSB3aXRoIHRoZSB0dGxTZWNvbmRzQWZ0ZXJFbXB0eSBwYXJhbWV0ZXIuXG4gICAgICogT25seSBhcHBsaWNhYmxlIGZvciB2MC4xNS4wIG9yIGxhdGVyLlxuICAgICAqL1xuICAgIGNvbnNvbGlkYXRpb24/OiB7XG4gICAgICAgIGVuYWJsZWQ6IGJvb2xlYW4sXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSWYgb21pdHRlZCwgdGhlIGZlYXR1cmUgaXMgZGlzYWJsZWQgYW5kIG5vZGVzIHdpbGwgbmV2ZXIgZXhwaXJlLiAgXG4gICAgICogSWYgc2V0IHRvIGxlc3MgdGltZSB0aGFuIGl0IHJlcXVpcmVzIGZvciBhIG5vZGUgdG8gYmVjb21lIHJlYWR5LCBcbiAgICAgKiB0aGUgbm9kZSBtYXkgZXhwaXJlIGJlZm9yZSBhbnkgcG9kcyBzdWNjZXNzZnVsbHkgc3RhcnQuXG4gICAgICovXG4gICAgdHRsU2Vjb25kc1VudGlsRXhwaXJlZD86IG51bWJlcixcblxuICAgIC8qKlxuICAgICAqIEhvdyBtYW55IHNlY29uZHMgS2FycGVudGVyIHdpbGwgd2FpbHQgdW50aWwgaXQgZGVsZXRlcyBlbXB0eS91bm5lY2Vzc2FyeSBpbnN0YW5jZXMgKGluIHNlY29uZHMpLlxuICAgICAqIE11dHVhbGx5IGV4Y2x1c2l2ZSB3aXRoIHRoZSBjb25zb2xpZGF0aW9uIHBhcmFtZXRlci5cbiAgICAgKi9cbiAgICB0dGxTZWNvbmRzQWZ0ZXJFbXB0eT86IG51bWJlcixcblxuICAgIC8qKlxuICAgICAqIFByaW9yaXR5IGdpdmVuIHRvIHRoZSBwcm92aXNpb25lciB3aGVuIHRoZSBzY2hlZHVsZXIgY29uc2lkZXJzIHdoaWNoIHByb3Zpc2lvbmVyXG4gICAgICogdG8gc2VsZWN0LiBIaWdoZXIgd2VpZ2h0cyBpbmRpY2F0ZSBoaWdoZXIgcHJpb3JpdHkgd2hlbiBjb21wYXJpbmcgcHJvdmlzaW9uZXJzLlxuICAgICAqL1xuICAgIHdlaWdodD86IG51bWJlcixcblxuICAgIC8qKlxuICAgICAqIEZsYWcgZm9yIGVuYWJsaW5nIEthcnBlbnRlcidzIG5hdGl2ZSBpbnRlcnJ1cHRpb24gaGFuZGxpbmcgXG4gICAgICogT25seSBhcHBsaWNhYmxlIGZvciB2MC4xOS4wIGFuZCBsYXRlclxuICAgICAqL1xuICAgIGludGVycnVwdGlvbkhhbmRsaW5nPzogYm9vbGVhbixcblxuICAgIC8qKlxuICAgICAqIExpbWl0cyBkZWZpbmUgYSBzZXQgb2YgYm91bmRzIGZvciBwcm92aXNpb25pbmcgY2FwYWNpdHkuXG4gICAgICogUmVzb3VyY2UgbGltaXRzIGNvbnN0cmFpbiB0aGUgdG90YWwgc2l6ZSBvZiB0aGUgY2x1c3Rlci5cbiAgICAgKiBMaW1pdHMgcHJldmVudCBLYXJwZW50ZXIgZnJvbSBjcmVhdGluZyBuZXcgaW5zdGFuY2VzIG9uY2UgdGhlIGxpbWl0IGlzIGV4Y2VlZGVkLlxuICAgICAqL1xuICAgIGxpbWl0cz86IHtcbiAgICAgICAgcmVzb3VyY2VzPzoge1xuICAgICAgICAgIGNwdT86IG51bWJlcjtcbiAgICAgICAgICBtZW1vcnk/OiBzdHJpbmc7XG4gICAgICAgICAgLyoqXG4gICAgICAgICAgICogRXh0ZW5kZWQgcmVzb3VyY2VzIGFyZSBmdWxseS1xdWFsaWZpZWQgcmVzb3VyY2UgbmFtZXMgb3V0c2lkZSB0aGUga3ViZXJuZXRlcy5pbyBkb21haW4uXG4gICAgICAgICAgICogVGhleSBhbGxvdyBjbHVzdGVyIG9wZXJhdG9ycyB0byBhZHZlcnRpc2UgYW5kIHVzZXJzIHRvIGNvbnN1bWUgdGhlIG5vbi1LdWJlcm5ldGVzLWJ1aWx0LWluXG4gICAgICAgICAgICogcmVzb3VyY2VzIHN1Y2ggYXMgaGFyZHdhcmUgZGV2aWNlcyBHUFVzLCBSRE1BcywgU1ItSU9Wcy4uLlxuICAgICAgICAgICAqIGUuZyBudmlkaWEuY29tL2dwdSwgYW1kLmNvbS9ncHUsIGV0Yy4uLlxuICAgICAgICAgICAqL1xuICAgICAgICAgIFtrOiBzdHJpbmddOiB1bmtub3duO1xuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBUYWdzIGFkZHMgdGFncyB0byBhbGwgcmVzb3VyY2VzIGNyZWF0ZWQsIGluY2x1ZGluZyBFQzIgSW5zdGFuY2VzLCBFQlMgdm9sdW1lcyBhbmQgTGF1bmNoIFRlbXBsYXRlcy5cbiAgICAgKiBLYXJwZW50ZXIgYWxsb3dzIG92ZXJyaWRlcyBvZiB0aGUgZGVmYXVsdCBcIk5hbWVcIiB0YWcgYnV0IGRvZXMgbm90IGFsbG93IG92ZXJyaWRlcyB0byByZXN0cmljdGVkIGRvbWFpbnMgXG4gICAgICogKHN1Y2ggYXMgXCJrYXJwZW50ZXIuc2hcIiwgXCJrYXJwZW50ZXIuazhzLmF3c1wiLCBhbmQgXCJrdWJlcm5ldGVzLmlvL2NsdXN0ZXJcIikuXG4gICAgICogVGhpcyBlbnN1cmVzIHRoYXQgS2FycGVudGVyIGlzIGFibGUgdG8gY29ycmVjdGx5IGF1dG8tZGlzY292ZXIgbWFjaGluZXMgdGhhdCBpdCBvd25zLlxuICAgICAqL1xuICAgIHRhZ3M/OiBWYWx1ZXM7XG59XG5cbmNvbnN0IEtBUlBFTlRFUiA9ICdrYXJwZW50ZXInO1xuY29uc3QgUkVMRUFTRSA9ICdibHVlcHJpbnRzLWFkZG9uLWthcnBlbnRlcic7XG5cbi8qKlxuICogRGVmYXVsdHMgb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5jb25zdCBkZWZhdWx0UHJvcHM6IEhlbG1BZGRPblByb3BzID0ge1xuICAgIG5hbWU6IEtBUlBFTlRFUixcbiAgICBuYW1lc3BhY2U6IEtBUlBFTlRFUixcbiAgICB2ZXJzaW9uOiAndjAuMjkuMicsXG4gICAgY2hhcnQ6IEtBUlBFTlRFUixcbiAgICByZWxlYXNlOiBLQVJQRU5URVIsXG4gICAgcmVwb3NpdG9yeTogJ29jaTovL3B1YmxpYy5lY3IuYXdzL2thcnBlbnRlci9rYXJwZW50ZXInLFxufTtcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgS2FycGVudGVyIGFkZC1vblxuICovXG5leHBvcnQgY2xhc3MgS2FycGVudGVyQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcmVhZG9ubHkgb3B0aW9uczogS2FycGVudGVyQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzPzogS2FycGVudGVyQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7Li4uZGVmYXVsdFByb3BzLCAuLi5wcm9wc30pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzO1xuICAgIH1cblxuICAgIEBjb25mbGljdHNXaXRoKCdDbHVzdGVyQXV0b1NjYWxlckFkZE9uJylcbiAgICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgYXNzZXJ0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIgaW5zdGFuY2VvZiBDbHVzdGVyLCBcIkthcnBlbnRlckFkZE9uIGNhbm5vdCBiZSB1c2VkIHdpdGggaW1wb3J0ZWQgY2x1c3RlcnMgYXMgaXQgcmVxdWlyZXMgY2hhbmdlcyB0byB0aGUgY2x1c3RlciBhdXRoZW50aWNhdGlvbi5cIik7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgOiBDbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSBjbHVzdGVyLmNsdXN0ZXJFbmRwb2ludDtcbiAgICAgICAgY29uc3QgbmFtZSA9IGNsdXN0ZXIuY2x1c3Rlck5hbWU7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzdGFja05hbWUgPSBjbHVzdGVyLnN0YWNrLnN0YWNrTmFtZTtcbiAgICAgICAgY29uc3QgcmVnaW9uID0gY2x1c3Rlci5zdGFjay5yZWdpb247XG5cbiAgICAgICAgbGV0IHZhbHVlcyA9IHRoaXMub3B0aW9ucy52YWx1ZXMgPz8ge307XG4gICAgICAgIGNvbnN0IHZlcnNpb24gPSB0aGlzLm9wdGlvbnMudmVyc2lvbiE7XG4gICAgICAgIGNvbnN0IHJlcXVpcmVtZW50cyA9IHRoaXMub3B0aW9ucy5yZXF1aXJlbWVudHMgfHwgW107XG4gICAgICAgIGNvbnN0IHN1Ym5ldFRhZ3MgPSB0aGlzLm9wdGlvbnMuc3VibmV0VGFncyB8fCB7fTtcbiAgICAgICAgY29uc3Qgc2dUYWdzID0gdGhpcy5vcHRpb25zLnNlY3VyaXR5R3JvdXBUYWdzIHx8IHt9O1xuICAgICAgICBjb25zdCB0YWludHMgPSB0aGlzLm9wdGlvbnMudGFpbnRzIHx8IFtdO1xuICAgICAgICBjb25zdCBzdGFydHVwVGFpbnRzID0gdGhpcy5vcHRpb25zLnN0YXJ0dXBUYWludHMgfHwgW107XG4gICAgICAgIGNvbnN0IGxhYmVscyA9IHRoaXMub3B0aW9ucy5sYWJlbHMgfHwge307XG4gICAgICAgIGNvbnN0IGFubm90YXRpb25zID0gdGhpcy5vcHRpb25zLmFubm90YXRpb25zIHx8IHt9O1xuICAgICAgICBjb25zdCBhbWlGYW1pbHkgPSB0aGlzLm9wdGlvbnMuYW1pRmFtaWx5O1xuICAgICAgICBjb25zdCBhbWlTZWxlY3RvciA9IHRoaXMub3B0aW9ucy5hbWlTZWxlY3RvcjtcbiAgICAgICAgY29uc3QgdHRsU2Vjb25kc0FmdGVyRW1wdHkgPSB0aGlzLm9wdGlvbnMudHRsU2Vjb25kc0FmdGVyRW1wdHkgfHwgbnVsbDtcbiAgICAgICAgY29uc3QgdHRsU2Vjb25kc1VudGlsRXhwaXJlZCA9IHRoaXMub3B0aW9ucy50dGxTZWNvbmRzVW50aWxFeHBpcmVkIHx8IG51bGw7XG4gICAgICAgIGNvbnN0IHdlaWdodCA9IHRoaXMub3B0aW9ucy53ZWlnaHQgfHwgbnVsbDtcbiAgICAgICAgY29uc3QgY29uc29sID0gdGhpcy5vcHRpb25zLmNvbnNvbGlkYXRpb24gfHwgbnVsbDtcbiAgICAgICAgY29uc3QgcmVwbyA9IHRoaXMub3B0aW9ucy5yZXBvc2l0b3J5ITtcbiAgICAgICAgY29uc3QgaW50ZXJydXB0aW9uID0gdGhpcy5vcHRpb25zLmludGVycnVwdGlvbkhhbmRsaW5nIHx8IGZhbHNlO1xuICAgICAgICBjb25zdCBsaW1pdHMgPSB0aGlzLm9wdGlvbnMubGltaXRzIHx8IG51bGw7XG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLm9wdGlvbnMudGFncyB8fCBudWxsO1xuICAgICAgICBcbiAgICAgICAgLy8gVmFyaW91cyBjaGVja3MgZm9yIHZlcnNpb24gZXJyb3JzXG4gICAgICAgIGNvbnN0IGNvbnNvbGlkYXRpb24gPSB0aGlzLnZlcnNpb25GZWF0dXJlQ2hlY2tzRm9yRXJyb3IoY2x1c3RlckluZm8sIHZlcnNpb24sIHdlaWdodCwgY29uc29sLCByZXBvLCB0dGxTZWNvbmRzQWZ0ZXJFbXB0eSwgaW50ZXJydXB0aW9uKTtcblxuICAgICAgICAvLyBTZXQgdXAgdGhlIG5vZGUgcm9sZSBhbmQgaW5zdGFuY2UgcHJvZmlsZVxuICAgICAgICBjb25zdCBba2FycGVudGVyTm9kZVJvbGUsIGthcnBlbnRlckluc3RhbmNlUHJvZmlsZV0gPSB0aGlzLnNldFVwTm9kZVJvbGUoY2x1c3Rlciwgc3RhY2tOYW1lLCByZWdpb24pO1xuXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgY29udHJvbGxlciBwb2xpY3lcbiAgICAgICAgY29uc3Qga2FycGVudGVyUG9saWN5RG9jdW1lbnQgPSBpYW0uUG9saWN5RG9jdW1lbnQuZnJvbUpzb24oS2FycGVudGVyQ29udHJvbGxlclBvbGljeSk7XG4gICAgICAgIGthcnBlbnRlclBvbGljeURvY3VtZW50LmFkZFN0YXRlbWVudHMobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgIFwiaWFtOlBhc3NSb2xlXCIsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbYCR7a2FycGVudGVyTm9kZVJvbGUucm9sZUFybn1gXVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgLy8gU3VwcG9ydCBmb3IgTmF0aXZlIHNwb3QgaW50ZXJydXB0aW9uIG9ubHkgYXZhaWxhYmxlIG9uIHYwLjE5LjAgb3IgbGF0ZXJcbiAgICAgICAgaWYgKHNlbXZlci5ndGUodmVyc2lvbiwgJ3YwLjE5LjAnKSAmJiBpbnRlcnJ1cHRpb24pe1xuICAgICAgICAgICAgLy8gQ3JlYXRlIEludGVycnVwdGlvbiBRdWV1ZVxuICAgICAgICAgICAgY29uc3QgcXVldWUgPSBuZXcgc3FzLlF1ZXVlKGNsdXN0ZXIuc3RhY2ssICdrYXJwZW50ZXItcXVldWUnLCB7XG4gICAgICAgICAgICAgICAgcXVldWVOYW1lOiBzdGFja05hbWUsXG4gICAgICAgICAgICAgICAgcmV0ZW50aW9uUGVyaW9kOiBEdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHF1ZXVlLmFkZFRvUmVzb3VyY2VQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgIHNpZDogJ0VDMkludGVycnVwdGlvblBvbGljeScsXG4gICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHByaW5jaXBhbHM6IFtcbiAgICAgICAgICAgICAgICAgICAgbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdzcXMuYW1hem9uYXdzLmNvbScpLFxuICAgICAgICAgICAgICAgICAgICBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2V2ZW50cy5hbWF6b25hd3MuY29tJyksXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgIFwic3FzOlNlbmRNZXNzYWdlXCJcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW2Ake3F1ZXVlLnF1ZXVlQXJufWBdXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIC8vIEFkZCBJbnRlcnJ1cHRpb24gUnVsZXNcbiAgICAgICAgICAgIG5ldyBSdWxlKGNsdXN0ZXIuc3RhY2ssICdzY2hlZHVsZS1jaGFuZ2UtcnVsZScsIHtcbiAgICAgICAgICAgICAgICBldmVudFBhdHRlcm46IHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBbXCJhd3MuaGVhbHRoXCJdLFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWxUeXBlOiBbJ0FXUyBIZWFsdGggRXZlbnQnXVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KS5hZGRUYXJnZXQobmV3IFNxc1F1ZXVlKHF1ZXVlKSk7XG5cbiAgICAgICAgICAgIG5ldyBSdWxlKGNsdXN0ZXIuc3RhY2ssICdzcG90LWludGVycnVwdGlvbi1ydWxlJywge1xuICAgICAgICAgICAgICAgIGV2ZW50UGF0dGVybjoge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2U6IFtcImF3cy5lYzJcIl0sXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbFR5cGU6IFsnRUMyIFNwb3QgSW5zdGFuY2UgSW50ZXJydXB0aW9uIFdhcm5pbmcnXVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KS5hZGRUYXJnZXQobmV3IFNxc1F1ZXVlKHF1ZXVlKSk7XG5cbiAgICAgICAgICAgIG5ldyBSdWxlKGNsdXN0ZXIuc3RhY2ssICdyZWJhbGFuY2UtcnVsZScsIHtcbiAgICAgICAgICAgICAgICBldmVudFBhdHRlcm46IHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBbXCJhd3MuZWMyXCJdLFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWxUeXBlOiBbJ0VDMiBJbnN0YW5jZSBSZWJhbGFuY2UgUmVjb21tZW5kYXRpb24nXVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KS5hZGRUYXJnZXQobmV3IFNxc1F1ZXVlKHF1ZXVlKSk7XG5cbiAgICAgICAgICAgIG5ldyBSdWxlKGNsdXN0ZXIuc3RhY2ssICdpbnN0LXN0YXRlLWNoYW5nZS1ydWxlJywge1xuICAgICAgICAgICAgICAgIGV2ZW50UGF0dGVybjoge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2U6IFtcImF3cy5lYzJcIl0sXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbFR5cGU6IFsnQzIgSW5zdGFuY2UgU3RhdGUtY2hhbmdlIE5vdGlmaWNhdGlvbiddXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pLmFkZFRhcmdldChuZXcgU3FzUXVldWUocXVldWUpKTtcblxuICAgICAgICAgICAgLy8gQWRkIHBvbGljeSB0byB0aGUgbm9kZSByb2xlIHRvIGFsbG93IGFjY2VzcyB0byB0aGUgSW50ZXJydXB0aW9uIFF1ZXVlXG4gICAgICAgICAgICBjb25zdCBpbnRlcnJ1cHRpb25RdWV1ZVN0YXRlbWVudCA9IG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcInNxczpEZWxldGVNZXNzYWdlXCIsXG4gICAgICAgICAgICAgICAgICAgIFwic3FzOkdldFF1ZXVlVXJsXCIsXG4gICAgICAgICAgICAgICAgICAgIFwic3FzOkdldFF1ZXVlQXR0cmlidXRlc1wiLFxuICAgICAgICAgICAgICAgICAgICBcInNxczpSZWNlaXZlTWVzc2FnZVwiXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgJHtxdWV1ZS5xdWV1ZUFybn1gXVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBrYXJwZW50ZXJQb2xpY3lEb2N1bWVudC5hZGRTdGF0ZW1lbnRzKGludGVycnVwdGlvblF1ZXVlU3RhdGVtZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBOYW1lc3BhY2VcbiAgICAgICAgY29uc3QgbnMgPSBjcmVhdGVOYW1lc3BhY2UoS0FSUEVOVEVSLCBjbHVzdGVyLCB0cnVlLCB0cnVlKTtcbiAgICAgICAgY29uc3Qgc2EgPSBjcmVhdGVTZXJ2aWNlQWNjb3VudChjbHVzdGVyLCBSRUxFQVNFLCBLQVJQRU5URVIsIGthcnBlbnRlclBvbGljeURvY3VtZW50KTtcbiAgICAgICAgc2Eubm9kZS5hZGREZXBlbmRlbmN5KG5zKTtcblxuICAgICAgICAvLyBBZGQgaGVsbSBjaGFydFxuICAgICAgICBpZiAoc2VtdmVyLmd0ZSh0aGlzLm9wdGlvbnMudmVyc2lvbiEsICcwLjE5LjAnKSl7XG4gICAgICAgICAgICBjb25zdCBhd3NTZXR0aW5ncyA9IHtcbiAgICAgICAgICAgICAgICBjbHVzdGVyRW5kcG9pbnQ6IGVuZHBvaW50LFxuICAgICAgICAgICAgICAgIGNsdXN0ZXJOYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgIGRlZmF1bHRJbnN0YW5jZVByb2ZpbGU6IGthcnBlbnRlckluc3RhbmNlUHJvZmlsZS5pbnN0YW5jZVByb2ZpbGVOYW1lLFxuICAgICAgICAgICAgICAgIGludGVycnVwdGlvblF1ZXVlTmFtZTogaW50ZXJydXB0aW9uID8gc3RhY2tOYW1lIDogXCJcIixcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBzZXRQYXRoKHZhbHVlcywgXCJzZXR0aW5ncy5hd3NcIiwgbWVyZ2UoYXdzU2V0dGluZ3MsIHZhbHVlcz8uc2V0dGluZ3M/LmF3cyA/PyB7fSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiY2x1c3RlckVuZHBvaW50XCIsIGVuZHBvaW50KTtcbiAgICAgICAgICAgIHNldFBhdGgodmFsdWVzLCBcImNsdXN0ZXJOYW1lXCIsIG5hbWUpO1xuICAgICAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiYXdzLmRlZmF1bHRJbnN0YW5jZVByb2ZpbGVcIiwga2FycGVudGVySW5zdGFuY2VQcm9maWxlLmluc3RhbmNlUHJvZmlsZU5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzYVZhbHVlcyA9IHtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBSRUxFQVNFLFxuICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIFwiZWtzLmFtYXpvbmF3cy5jb20vcm9sZS1hcm5cIjogc2Eucm9sZS5yb2xlQXJuLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHNhVmFsdWVzKTtcbiAgICAgICAgY29uc3Qga2FycGVudGVyQ2hhcnQgPSB0aGlzLmFkZEhlbG1DaGFydChjbHVzdGVySW5mbywgdmFsdWVzLCBmYWxzZSwgdHJ1ZSk7XG5cbiAgICAgICAga2FycGVudGVyQ2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KG5zKTtcblxuICAgICAgICAvLyAoT3B0aW9uYWwpIGRlZmF1bHQgcHJvdmlzaW9uZXJcbiAgICAgICAgaWYgKChPYmplY3Qua2V5cyhzdWJuZXRUYWdzKS5sZW5ndGggPiAwKSAmJiAoT2JqZWN0LmtleXMoc2dUYWdzKS5sZW5ndGggPiAwKSl7XG4gICAgICAgICAgICBjb25zdCBwcm92aXNpb25lciA9IGNsdXN0ZXIuYWRkTWFuaWZlc3QoJ2RlZmF1bHQtcHJvdmlzaW9uZXInLCB7XG4gICAgICAgICAgICAgICAgYXBpVmVyc2lvbjogJ2thcnBlbnRlci5zaC92MWFscGhhNScsXG4gICAgICAgICAgICAgICAga2luZDogJ1Byb3Zpc2lvbmVyJyxcbiAgICAgICAgICAgICAgICBtZXRhZGF0YTogeyBuYW1lOiAnZGVmYXVsdCcgfSxcbiAgICAgICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyUmVmOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHRcIlxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB0YWludHM6IHRhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgc3RhcnR1cFRhaW50czogc3RhcnR1cFRhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWxzOiBsYWJlbHMsXG4gICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiBhbm5vdGF0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZW1lbnRzOiB0aGlzLmNvbnZlcnQocmVxdWlyZW1lbnRzKSxcbiAgICAgICAgICAgICAgICAgICAgbGltaXRzOiBsaW1pdHMsXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGlkYXRpb246IGNvbnNvbGlkYXRpb24sXG4gICAgICAgICAgICAgICAgICAgIHR0bFNlY29uZHNVbnRpbEV4cGlyZWQ6IHR0bFNlY29uZHNVbnRpbEV4cGlyZWQsXG4gICAgICAgICAgICAgICAgICAgIHR0bFNlY29uZHNBZnRlckVtcHR5OiB0dGxTZWNvbmRzQWZ0ZXJFbXB0eSxcbiAgICAgICAgICAgICAgICAgICAgd2VpZ2h0OiB3ZWlnaHQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcHJvdmlzaW9uZXIubm9kZS5hZGREZXBlbmRlbmN5KGthcnBlbnRlckNoYXJ0KTtcblxuICAgICAgICAgICAgY29uc3Qgbm9kZVRlbXBsYXRlID0gY2x1c3Rlci5hZGRNYW5pZmVzdCgnZGVmYXVsdC1ub2RlLXRlbXBsYXRlJywge1xuICAgICAgICAgICAgICAgIGFwaVZlcnNpb246IFwia2FycGVudGVyLms4cy5hd3MvdjFhbHBoYTFcIixcbiAgICAgICAgICAgICAgICBraW5kOiBcIkFXU05vZGVUZW1wbGF0ZVwiLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwiZGVmYXVsdFwiXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgICAgIGFtaUZhbWlseTogYW1pRmFtaWx5LFxuICAgICAgICAgICAgICAgICAgICBhbWlTZWxlY3RvcjogYW1pU2VsZWN0b3IsXG4gICAgICAgICAgICAgICAgICAgIHN1Ym5ldFNlbGVjdG9yOiBzdWJuZXRUYWdzLFxuICAgICAgICAgICAgICAgICAgICBzZWN1cml0eUdyb3VwU2VsZWN0b3I6IHNnVGFncyxcbiAgICAgICAgICAgICAgICAgICAgdGFnczogdGFncyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBub2RlVGVtcGxhdGUubm9kZS5hZGREZXBlbmRlbmN5KHByb3Zpc2lvbmVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoa2FycGVudGVyQ2hhcnQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBjb252ZXJ0IGEga2V5LXBhaXIgdmFsdWVzICh3aXRoIGFuIG9wZXJhdG9yKSBcbiAgICAgKiBvZiBzcGVjIGNvbmZpZ3VyYXRpb25zIHRvIGFwcHJvcHJpYXRlIGpzb24gZm9ybWF0IGZvciBhZGRNYW5pZmVzdCBmdW5jdGlvblxuICAgICAqIEBwYXJhbSByZXFzXG4gICAgICogQHJldHVybnMgbmV3UmVxc1xuICAgICAqICovXG4gICAgcHJvdGVjdGVkIGNvbnZlcnQocmVxczoge2tleTogc3RyaW5nLCBvcDogc3RyaW5nLCB2YWxzOiBzdHJpbmdbXX1bXSk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgbmV3UmVxcyA9IFtdO1xuICAgICAgICBmb3IgKGxldCByZXEgb2YgcmVxcyl7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSByZXFbJ2tleSddO1xuICAgICAgICAgICAgY29uc3Qgb3AgPSByZXFbJ29wJ107XG4gICAgICAgICAgICBjb25zdCB2YWwgPSByZXFbJ3ZhbHMnXTtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVpcmVtZW50ID0ge1xuICAgICAgICAgICAgICAgIFwia2V5XCI6IGtleSxcbiAgICAgICAgICAgICAgICBcIm9wZXJhdG9yXCI6IG9wLFxuICAgICAgICAgICAgICAgIFwidmFsdWVzXCI6IHZhbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG5ld1JlcXMucHVzaChyZXF1aXJlbWVudCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ld1JlcXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGVscGVyIGZ1bmN0aW9uIHRvIGVuc3VyZSByaWdodCBmZWF0dXJlcyBhcmUgYWRkZWQgYXMgcGFydCBvZiB0aGUgY29uZmlndXJhdGlvblxuICAgICAqIGZvciB0aGUgcmlnaHQgdmVyc2lvbiBvZiB0aGUgYWRkLW9uXG4gICAgICogQHBhcmFtIHZlcnNpb24gdmVyc2lvbiBvZiB0aGUgYWRkLW9uXG4gICAgICogQHBhcmFtIHdlaWdodCB3ZWlnaHQgc2V0dGluZ1xuICAgICAqIEBwYXJhbSBjb25zb2wgY29uc29saWRhdGlvbiBzZXR0aW5nXG4gICAgICogQHBhcmFtIHJlcG8gcmVwb3NpdG9yeSB1cmwgb2YgdGhlIGhlbG0gY2hhcnRcbiAgICAgKiBAcGFyYW0gdHRsU2Vjb25kc0FmdGVyRW1wdHkgdHRsU2Vjb25kc0FmdGVyRW1wdHkgc2V0dGluZ1xuICAgICAqIEByZXR1cm5zIGNvbnNvbGlkYXRpb25cbiAgICAgKi9cbiAgICBwcml2YXRlIHZlcnNpb25GZWF0dXJlQ2hlY2tzRm9yRXJyb3IoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCB2ZXJzaW9uOiBzdHJpbmcsIHdlaWdodDogYW55LCBjb25zb2w6IGFueSwgcmVwbzogc3RyaW5nLCB0dGxTZWNvbmRzQWZ0ZXJFbXB0eTogYW55LCBpbnRlcnJ1cHRpb246IGJvb2xlYW4pOiBhbnkge1xuICAgICAgICBcbiAgICAgICAgLy8gQ29uc29saWRhdGlvbiBvbmx5IGF2YWlsYWJsZSB3aXRoIHYwLjE1LjAgYW5kIGxhdGVyXG4gICAgICAgIGxldCBjb25zb2xpZGF0aW9uO1xuICAgICAgICBpZiAoc2VtdmVyLmx0KHZlcnNpb24sICcwLjE1LjAnKSl7XG4gICAgICAgICAgICBhc3NlcnQoIWNvbnNvbCwgJ1RoZSBwcm9wIGNvbnNvbGlkYXRpb24gaXMgb25seSBzdXBwb3J0ZWQgb24gdmVyc2lvbnMgdjAuMTUuMCBhbmQgbGF0ZXIuJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xpZGF0aW9uID0gY29uc29sIHx8IHsgZW5hYmxlZDogZmFsc2UgfTsgXG4gICAgICAgICAgICAvLyBZb3UgY2Fubm90IGVuYWJsZSBjb25zb2xpZGF0aW9uIGFuZCB0dGxTZWNvbmRzQWZ0ZXJFbXB0eSB2YWx1ZXNcbiAgICAgICAgICAgIGFzc2VydCggIShjb25zb2xpZGF0aW9uLmVuYWJsZWQgJiYgdHRsU2Vjb25kc0FmdGVyRW1wdHkpICwgJ0NvbnNvbGlkYXRpb24gYW5kIHR0bFNlY29uZHNBZnRlckVtcHR5IG11c3QgYmUgbXV0dWFsbHkgZXhjbHVzaXZlLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gV2VpZ2h0IG9ubHkgYXZhaWxhYmxlIHdpdGggdjAuMTYuMCBhbmQgbGF0ZXJcbiAgICAgICAgaWYgKHNlbXZlci5sdCh2ZXJzaW9uLCAnMC4xNi4wJykpe1xuICAgICAgICAgICAgYXNzZXJ0KCF3ZWlnaHQsICdUaGUgcHJvcCB3ZWlnaHQgaXMgb25seSBzdXBwb3J0ZWQgb24gdmVyc2lvbnMgdjAuMTYuMCBhbmQgbGF0ZXIuJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIFJlZ2lzdHJ5IGNoYW5nZXMgd2l0aCB2MC4xNy4wIGFuZCBsYXRlclxuICAgICAgICBpZiAoc2VtdmVyLmd0ZSh2ZXJzaW9uLCAnMC4xNy4wJykpe1xuICAgICAgICAgICAgYXNzZXJ0KHJlcG8gPT09ICdvY2k6Ly9wdWJsaWMuZWNyLmF3cy9rYXJwZW50ZXIva2FycGVudGVyJywgJ1BsZWFzZSBwcm92aWRlIHRoZSBPQ0kgcmVwb3NpdG9yeS4nKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydChyZXBvID09PSAnaHR0cHM6Ly9jaGFydHMua2FycGVudGVyLnNoJywgJ1BsZWFzZSBwcm92aWRlIHRoZSBvbGRlciBLYXJwZW50ZXIgcmVwb3NpdG9yeSB1cmwuJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJbnRlcnJ1cHRpb24gaGFuZGxpbmcgb25seSBhdmFpbGFibGUgd2l0aCB2MC4xOS4wIGFuZCBsYXRlclxuICAgICAgICAvLyBDb252ZXJzZWx5LCB3ZSBzaG91bGQgYmxvY2sgTm9kZSBUZXJtaW5hdGlvbiBIYW5kbGVyIHVzYWdlIG9uY2UgS2FycGVudGVyIGlzIGxldmVyYWdlZFxuICAgICAgICBpZiAoc2VtdmVyLmx0KHZlcnNpb24sICcwLjE5LjAnKSl7XG4gICAgICAgICAgICBhc3NlcnQoIWludGVycnVwdGlvbiwgJ0ludGVycnVwdGlvbiBoYW5kbGluZyBpcyBvbmx5IHN1cHBvcnRlZCBvbiB2ZXJzaW9ucyB2MC4xOS4wIGFuZCBsYXRlci4nKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydCghY2x1c3RlckluZm8uZ2V0UHJvdmlzaW9uZWRBZGRPbignQXdzTm9kZVRlcm1pbmF0aW9uSGFuZGxlckFkZE9uJyksICdLYXJwZW50ZXIgc3VwcG9ydHMgbmF0aXZlIGludGVycnVwdGlvbiBoYW5kbGluZywgc28gTm9kZSBUZXJtaW5hdGlvbiBIYW5kbGVyIHdpbGwgbm90IGJlIG5lY2Vzc2FyeS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb25zb2xpZGF0aW9uO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBzZXQgdXAgdGhlIEthcnBlbnRlciBOb2RlIFJvbGUgYW5kIEluc3RhbmNlIFByb2ZpbGVcbiAgICAgKiBPdXRwdXRzIHRvIENsb3VkRm9ybWF0aW9uIGFuZCBtYXAgdGhlIHJvbGUgdG8gdGhlIGF3cy1hdXRoIENvbmZpZ01hcFxuICAgICAqIEBwYXJhbSBjbHVzdGVyIEVLUyBDbHVzdGVyXG4gICAgICogQHBhcmFtIHN0YWNrTmFtZSBOYW1lIG9mIHRoZSBzdGFja1xuICAgICAqIEBwYXJhbSByZWdpb24gUmVnaW9uIG9mIHRoZSBzdGFja1xuICAgICAqIEByZXR1cm5zIFtrYXJwZW50ZXJOb2RlUm9sZSwga2FycGVudGVySW5zdGFuY2VQcm9maWxlXVxuICAgICAqL1xuICAgIHByaXZhdGUgc2V0VXBOb2RlUm9sZShjbHVzdGVyOiBDbHVzdGVyLCBzdGFja05hbWU6IHN0cmluZywgcmVnaW9uOiBzdHJpbmcpOiBbaWFtLlJvbGUsIGlhbS5DZm5JbnN0YW5jZVByb2ZpbGVdIHtcbiAgICAgICAgLy8gU2V0IHVwIE5vZGUgUm9sZVxuICAgICAgICBjb25zdCBrYXJwZW50ZXJOb2RlUm9sZSA9IG5ldyBpYW0uUm9sZShjbHVzdGVyLCAna2FycGVudGVyLW5vZGUtcm9sZScsIHtcbiAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKGBlYzIuJHtjbHVzdGVyLnN0YWNrLnVybFN1ZmZpeH1gKSxcbiAgICAgICAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICAgICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcIkFtYXpvbkVLU1dvcmtlck5vZGVQb2xpY3lcIiksXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUtTX0NOSV9Qb2xpY3lcIiksXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUMyQ29udGFpbmVyUmVnaXN0cnlSZWFkT25seVwiKSxcbiAgICAgICAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25TU01NYW5hZ2VkSW5zdGFuY2VDb3JlXCIpLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIC8vcm9sZU5hbWU6IGBLYXJwZW50ZXJOb2RlUm9sZS0ke25hbWV9YCAvLyBsZXQgcm9sZSBuYW1lIHRvIGJlIGdlbmVyYXRlZCBhcyB1bmlxdWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIEluc3RhbmNlIFByb2ZpbGVcbiAgICAgICAgY29uc3QgaW5zdGFuY2VQcm9maWxlTmFtZSA9IG1kNS5NZDUuaGFzaFN0cihzdGFja05hbWUrcmVnaW9uKTtcbiAgICAgICAgY29uc3Qga2FycGVudGVySW5zdGFuY2VQcm9maWxlID0gbmV3IGlhbS5DZm5JbnN0YW5jZVByb2ZpbGUoY2x1c3RlciwgJ2thcnBlbnRlci1pbnN0YW5jZS1wcm9maWxlJywge1xuICAgICAgICAgICAgcm9sZXM6IFtrYXJwZW50ZXJOb2RlUm9sZS5yb2xlTmFtZV0sXG4gICAgICAgICAgICBpbnN0YW5jZVByb2ZpbGVOYW1lOiBgS2FycGVudGVyTm9kZUluc3RhbmNlUHJvZmlsZS0ke2luc3RhbmNlUHJvZmlsZU5hbWV9YCxcbiAgICAgICAgICAgIHBhdGg6ICcvJ1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJJZCA9IE5hbWVzLnVuaXF1ZUlkKGNsdXN0ZXIpO1xuXG4gICAgICAgIC8vQ2ZuIG91dHB1dCBmb3IgTm9kZSBSb2xlIGluIGNhc2Ugb2YgbmVlZGluZyB0byBhZGQgYWRkaXRpb25hbCBwb2xpY2llc1xuICAgICAgICBuZXcgQ2ZuT3V0cHV0KGNsdXN0ZXIuc3RhY2ssICdLYXJwZW50ZXIgSW5zdGFuY2UgTm9kZSBSb2xlJywge1xuICAgICAgICAgICAgdmFsdWU6IGthcnBlbnRlck5vZGVSb2xlLnJvbGVOYW1lLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiS2FycGVudGVyIGFkZC1vbiBOb2RlIFJvbGUgbmFtZVwiLFxuICAgICAgICAgICAgZXhwb3J0TmFtZTogY2x1c3RlcklkK1wiS2FycGVudGVyTm9kZVJvbGVOYW1lXCIsXG4gICAgICAgIH0pO1xuICAgICAgICAvL0NmbiBvdXRwdXQgZm9yIEluc3RhbmNlIFByb2ZpbGUgZm9yIGNyZWF0aW5nIGFkZGl0aW9uYWwgcHJvdmlzaW9uZXJzXG4gICAgICAgIG5ldyBDZm5PdXRwdXQoY2x1c3Rlci5zdGFjaywgJ0thcnBlbnRlciBJbnN0YW5jZSBQcm9maWxlIG5hbWUnLCB7IFxuICAgICAgICAgICAgdmFsdWU6IGthcnBlbnRlckluc3RhbmNlUHJvZmlsZSA/IGthcnBlbnRlckluc3RhbmNlUHJvZmlsZS5pbnN0YW5jZVByb2ZpbGVOYW1lISA6IFwibm9uZVwiLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiS2FycGVudGVyIGFkZC1vbiBJbnN0YW5jZSBQcm9maWxlIG5hbWVcIixcbiAgICAgICAgICAgIGV4cG9ydE5hbWU6IGNsdXN0ZXJJZCtcIkthcnBlbnRlckluc3RhbmNlUHJvZmlsZU5hbWVcIiwgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIE1hcCBOb2RlIFJvbGUgdG8gYXdzLWF1dGhcbiAgICAgICAgY2x1c3Rlci5hd3NBdXRoLmFkZFJvbGVNYXBwaW5nKGthcnBlbnRlck5vZGVSb2xlLCB7XG4gICAgICAgICAgICBncm91cHM6IFsnc3lzdGVtOmJvb3RzdHJhcHBlcicsICdzeXN0ZW06bm9kZXMnXSxcbiAgICAgICAgICAgIHVzZXJuYW1lOiAnc3lzdGVtOm5vZGU6e3tFQzJQcml2YXRlRE5TTmFtZX19J1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gW2thcnBlbnRlck5vZGVSb2xlLCBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGVdO1xuICAgIH1cbn0iXX0=