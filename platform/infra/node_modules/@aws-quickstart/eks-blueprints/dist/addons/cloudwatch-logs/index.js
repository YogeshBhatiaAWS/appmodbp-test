"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CloudWatchLogsAddon = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const namespace_utils_1 = require("../../utils/namespace-utils");
const iam_policy_1 = require("./iam-policy");
/**
 * Default props for the add-on.
 */
const defaultProps = {
    name: 'aws-for-fluent-bit',
    chart: 'aws-for-fluent-bit',
    release: "blueprints-addon-aws-fluent-bit-for-cw",
    version: '0.1.28',
    repository: 'https://aws.github.io/eks-charts',
    namespace: 'aws-for-fluent-bit',
    createNamespace: true,
    serviceAccountName: 'aws-fluent-bit-for-cw-sa',
    logGroupPrefix: '/aws/eks/blueprints-construct-dev',
    logRetentionDays: 90,
    values: {}
};
/**
 * CloudWatchLogsAddon deploys FluentBit into an EKS cluster using the `aws-for-fluent-bit` Helm chart.
 * https://github.com/aws/eks-charts/tree/master/stable/aws-for-fluent-bit
 *
 */
class CloudWatchLogsAddon extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = { ...defaultProps, ...this.props };
    }
    deploy(clusterInfo) {
        var _a;
        let values = populateValues(clusterInfo, this.options);
        values = (0, ts_deepmerge_1.default)(values, (_a = this.props.values) !== null && _a !== void 0 ? _a : {});
        const cluster = clusterInfo.cluster;
        const namespace = this.options.namespace;
        // Create the FluentBut service account.
        const serviceAccountName = this.options.serviceAccountName;
        const sa = cluster.addServiceAccount(serviceAccountName, {
            name: serviceAccountName,
            namespace: namespace
        });
        // Create namespace
        if (this.options.createNamespace) {
            const ns = (0, namespace_utils_1.createNamespace)(namespace, cluster, true);
            sa.node.addDependency(ns);
        }
        // Apply additional IAM policies to the service account.
        (0, iam_policy_1.getCloudWatchLogsPolicyDocument)().forEach((statement) => {
            sa.addToPrincipalPolicy(iam.PolicyStatement.fromJson(statement));
        });
        const helmChart = this.addHelmChart(clusterInfo, values);
        helmChart.node.addDependency(sa);
        return Promise.resolve(helmChart);
    }
}
exports.CloudWatchLogsAddon = CloudWatchLogsAddon;
__decorate([
    (0, utils_1.conflictsWith)('AwsForFluentBitAddOn')
], CloudWatchLogsAddon.prototype, "deploy", null);
/**
 * populateValues populates the appropriate values used to customize the Helm chart
 * @param helmOptions User provided values to customize the chart
 */
function populateValues(clusterInfo, helmOptions) {
    var _a;
    const values = (_a = helmOptions.values) !== null && _a !== void 0 ? _a : {};
    (0, utils_1.setPath)(values, "serviceAccount.name", helmOptions.serviceAccountName);
    (0, utils_1.setPath)(values, "serviceAccount.create", false);
    (0, utils_1.setPath)(values, "cloudWatch.enabled", false);
    (0, utils_1.setPath)(values, "cloudWatchLogs.enabled", true);
    (0, utils_1.setPath)(values, "cloudWatchLogs.region", clusterInfo.cluster.stack.region);
    (0, utils_1.setPath)(values, "cloudWatchLogs.logGroupName", `${helmOptions.logGroupPrefix}/workloads`);
    (0, utils_1.setPath)(values, "cloudWatchLogs.logGroupTemplate", `${helmOptions.logGroupPrefix}/$kubernetes['namespace_name']`);
    (0, utils_1.setPath)(values, "cloudWatchLogs.logStreamTemplate", "$kubernetes['container_name'].$kubernetes['pod_name']");
    (0, utils_1.setPath)(values, "cloudWatchLogs.log_key", "log");
    (0, utils_1.setPath)(values, "cloudWatchLogs.log_retention_days", helmOptions.logRetentionDays);
    return values;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2Nsb3Vkd2F0Y2gtbG9ncy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSwyQ0FBMkM7QUFDM0MsK0NBQWlDO0FBQ2pDLHVDQUFxRDtBQUNyRCw4Q0FBOEQ7QUFFOUQsaUVBQThEO0FBQzlELDZDQUErRDtBQTBCL0Q7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBNkI7SUFDM0MsSUFBSSxFQUFFLG9CQUFvQjtJQUMxQixLQUFLLEVBQUUsb0JBQW9CO0lBQzNCLE9BQU8sRUFBRSx3Q0FBd0M7SUFDakQsT0FBTyxFQUFFLFFBQVE7SUFDakIsVUFBVSxFQUFFLGtDQUFrQztJQUM5QyxTQUFTLEVBQUUsb0JBQW9CO0lBQy9CLGVBQWUsRUFBRSxJQUFJO0lBQ3JCLGtCQUFrQixFQUFFLDBCQUEwQjtJQUM5QyxjQUFjLEVBQUUsbUNBQW1DO0lBQ25ELGdCQUFnQixFQUFFLEVBQUU7SUFDcEIsTUFBTSxFQUFFLEVBQUU7Q0FDYixDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsbUJBQW9CLFNBQVEsc0JBQVM7SUFJOUMsWUFBWSxLQUErQjtRQUN2QyxLQUFLLENBQUMsRUFBRSxHQUFHLFlBQW1CLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN0RCxDQUFDO0lBR0QsTUFBTSxDQUFDLFdBQXdCOztRQUMzQixJQUFJLE1BQU0sR0FBVyxjQUFjLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvRCxNQUFNLEdBQUcsSUFBQSxzQkFBSyxFQUFDLE1BQU0sRUFBRSxNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxtQ0FBSSxFQUFFLENBQUMsQ0FBQztRQUNoRCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBVSxDQUFDO1FBRTFDLHdDQUF3QztRQUN4QyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQW1CLENBQUM7UUFDNUQsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLGtCQUFrQixFQUFFO1lBQ3JELElBQUksRUFBRSxrQkFBa0I7WUFDeEIsU0FBUyxFQUFFLFNBQVM7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsbUJBQW1CO1FBQ25CLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUU7WUFDOUIsTUFBTSxFQUFFLEdBQUcsSUFBQSxpQ0FBZSxFQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDckQsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDN0I7UUFFRCx3REFBd0Q7UUFDeEQsSUFBQSw0Q0FBK0IsR0FBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ3BELEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDekQsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDakMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7Q0FDSjtBQXRDRCxrREFzQ0M7QUE1Qkc7SUFEQyxJQUFBLHFCQUFhLEVBQUMsc0JBQXNCLENBQUM7aURBNEJyQztBQUdMOzs7R0FHRztBQUNILFNBQVMsY0FBYyxDQUFDLFdBQXdCLEVBQUUsV0FBcUM7O0lBQ25GLE1BQU0sTUFBTSxHQUFHLE1BQUEsV0FBVyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDO0lBQ3hDLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSxxQkFBcUIsRUFBRSxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUN2RSxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEQsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzdDLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSx3QkFBd0IsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNoRCxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsdUJBQXVCLEVBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0UsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLDZCQUE2QixFQUFFLEdBQUcsV0FBVyxDQUFDLGNBQWMsWUFBWSxDQUFDLENBQUM7SUFDMUYsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLGlDQUFpQyxFQUFFLEdBQUcsV0FBVyxDQUFDLGNBQWMsZ0NBQWdDLENBQUMsQ0FBQztJQUNsSCxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsa0NBQWtDLEVBQUUsdURBQXVELENBQUMsQ0FBQztJQUM3RyxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDakQsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLG1DQUFtQyxFQUFFLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ25GLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgbWVyZ2UgZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xuaW1wb3J0IHsgY29uZmxpY3RzV2l0aCwgc2V0UGF0aCB9IGZyb20gXCIuLi8uLi91dGlsc1wiO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gXCIuLi8uLi9zcGkvdHlwZXNcIjtcbmltcG9ydCB7IGNyZWF0ZU5hbWVzcGFjZSB9IGZyb20gXCIuLi8uLi91dGlscy9uYW1lc3BhY2UtdXRpbHNcIjtcbmltcG9ydCB7IGdldENsb3VkV2F0Y2hMb2dzUG9saWN5RG9jdW1lbnQgfSBmcm9tIFwiLi9pYW0tcG9saWN5XCI7XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgRmx1ZW50Qml0IGFkZC1vbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDbG91ZFdhdGNoTG9nc0FkZG9uUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMge1xuICAgIC8qKlxuICAgICAqIENyZWF0ZSBOYW1lc3BhY2Ugd2l0aCB0aGUgcHJvdmlkZWQgb25lICh3aWxsIG5vdCBpZiBuYW1lc3BhY2UgaXMga3ViZS1zeXN0ZW0pXG4gICAgICovXG4gICAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhblxuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgc2VydmljZSBhY2NvdW50IGZvciBmbHVlbnQgYml0LlxuICAgICAqL1xuICAgIHNlcnZpY2VBY2NvdW50TmFtZT86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIENsb3VkV2F0Y2ggTG9nIEdyb3VwIE5hbWUuXG4gICAgICovXG4gICAgbG9nR3JvdXBQcmVmaXg6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIENsb3VkV2F0Y2ggTG9nIHJldGVudGlvbiBkYXlzXG4gICAgICovXG4gICAgbG9nUmV0ZW50aW9uRGF5cz86IG51bWJlcjtcbn1cbi8qKlxuICogRGVmYXVsdCBwcm9wcyBmb3IgdGhlIGFkZC1vbi5cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzOiBDbG91ZFdhdGNoTG9nc0FkZG9uUHJvcHMgPSB7XG4gICAgbmFtZTogJ2F3cy1mb3ItZmx1ZW50LWJpdCcsXG4gICAgY2hhcnQ6ICdhd3MtZm9yLWZsdWVudC1iaXQnLFxuICAgIHJlbGVhc2U6IFwiYmx1ZXByaW50cy1hZGRvbi1hd3MtZmx1ZW50LWJpdC1mb3ItY3dcIixcbiAgICB2ZXJzaW9uOiAnMC4xLjI4JyxcbiAgICByZXBvc2l0b3J5OiAnaHR0cHM6Ly9hd3MuZ2l0aHViLmlvL2Vrcy1jaGFydHMnLFxuICAgIG5hbWVzcGFjZTogJ2F3cy1mb3ItZmx1ZW50LWJpdCcsXG4gICAgY3JlYXRlTmFtZXNwYWNlOiB0cnVlLFxuICAgIHNlcnZpY2VBY2NvdW50TmFtZTogJ2F3cy1mbHVlbnQtYml0LWZvci1jdy1zYScsXG4gICAgbG9nR3JvdXBQcmVmaXg6ICcvYXdzL2Vrcy9ibHVlcHJpbnRzLWNvbnN0cnVjdC1kZXYnLCBcbiAgICBsb2dSZXRlbnRpb25EYXlzOiA5MCxcbiAgICB2YWx1ZXM6IHt9XG59O1xuXG4vKipcbiAqIENsb3VkV2F0Y2hMb2dzQWRkb24gZGVwbG95cyBGbHVlbnRCaXQgaW50byBhbiBFS1MgY2x1c3RlciB1c2luZyB0aGUgYGF3cy1mb3ItZmx1ZW50LWJpdGAgSGVsbSBjaGFydC5cbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvZWtzLWNoYXJ0cy90cmVlL21hc3Rlci9zdGFibGUvYXdzLWZvci1mbHVlbnQtYml0XG4gKiBcbiAqL1xuZXhwb3J0IGNsYXNzIENsb3VkV2F0Y2hMb2dzQWRkb24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcmVhZG9ubHkgb3B0aW9uczogQ2xvdWRXYXRjaExvZ3NBZGRvblByb3BzO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IENsb3VkV2F0Y2hMb2dzQWRkb25Qcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLmRlZmF1bHRQcm9wcyBhcyBhbnksIC4uLnByb3BzIH0pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7IC4uLmRlZmF1bHRQcm9wcywgLi4udGhpcy5wcm9wcyB9O1xuICAgIH1cblxuICAgIEBjb25mbGljdHNXaXRoKCdBd3NGb3JGbHVlbnRCaXRBZGRPbicpXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGxldCB2YWx1ZXM6IFZhbHVlcyA9IHBvcHVsYXRlVmFsdWVzKGNsdXN0ZXJJbmZvLCB0aGlzLm9wdGlvbnMpO1xuICAgICAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHRoaXMucHJvcHMudmFsdWVzID8/IHt9KTtcbiAgICAgICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhO1xuXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgRmx1ZW50QnV0IHNlcnZpY2UgYWNjb3VudC5cbiAgICAgICAgY29uc3Qgc2VydmljZUFjY291bnROYW1lID0gdGhpcy5vcHRpb25zLnNlcnZpY2VBY2NvdW50TmFtZSE7XG4gICAgICAgIGNvbnN0IHNhID0gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudChzZXJ2aWNlQWNjb3VudE5hbWUsIHtcbiAgICAgICAgICAgIG5hbWU6IHNlcnZpY2VBY2NvdW50TmFtZSxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIENyZWF0ZSBuYW1lc3BhY2VcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5jcmVhdGVOYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIGNvbnN0IG5zID0gY3JlYXRlTmFtZXNwYWNlKG5hbWVzcGFjZSwgY2x1c3RlciwgdHJ1ZSk7XG4gICAgICAgICAgICBzYS5ub2RlLmFkZERlcGVuZGVuY3kobnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQXBwbHkgYWRkaXRpb25hbCBJQU0gcG9saWNpZXMgdG8gdGhlIHNlcnZpY2UgYWNjb3VudC5cbiAgICAgICAgZ2V0Q2xvdWRXYXRjaExvZ3NQb2xpY3lEb2N1bWVudCgpLmZvckVhY2goKHN0YXRlbWVudCkgPT4ge1xuICAgICAgICAgICAgc2EuYWRkVG9QcmluY2lwYWxQb2xpY3koaWFtLlBvbGljeVN0YXRlbWVudC5mcm9tSnNvbihzdGF0ZW1lbnQpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgaGVsbUNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIHZhbHVlcyk7XG4gICAgICAgIGhlbG1DaGFydC5ub2RlLmFkZERlcGVuZGVuY3koc2EpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGhlbG1DaGFydCk7XG4gICAgfVxufVxuXG4vKipcbiAqIHBvcHVsYXRlVmFsdWVzIHBvcHVsYXRlcyB0aGUgYXBwcm9wcmlhdGUgdmFsdWVzIHVzZWQgdG8gY3VzdG9taXplIHRoZSBIZWxtIGNoYXJ0XG4gKiBAcGFyYW0gaGVsbU9wdGlvbnMgVXNlciBwcm92aWRlZCB2YWx1ZXMgdG8gY3VzdG9taXplIHRoZSBjaGFydFxuICovXG5mdW5jdGlvbiBwb3B1bGF0ZVZhbHVlcyhjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIGhlbG1PcHRpb25zOiBDbG91ZFdhdGNoTG9nc0FkZG9uUHJvcHMpOiBWYWx1ZXMge1xuICAgIGNvbnN0IHZhbHVlcyA9IGhlbG1PcHRpb25zLnZhbHVlcyA/PyB7fTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJzZXJ2aWNlQWNjb3VudC5uYW1lXCIsIGhlbG1PcHRpb25zLnNlcnZpY2VBY2NvdW50TmFtZSk7XG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwic2VydmljZUFjY291bnQuY3JlYXRlXCIsIGZhbHNlKTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJjbG91ZFdhdGNoLmVuYWJsZWRcIiwgZmFsc2UpO1xuICAgIHNldFBhdGgodmFsdWVzLCBcImNsb3VkV2F0Y2hMb2dzLmVuYWJsZWRcIiwgdHJ1ZSk7XG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwiY2xvdWRXYXRjaExvZ3MucmVnaW9uXCIsIGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2sucmVnaW9uKTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJjbG91ZFdhdGNoTG9ncy5sb2dHcm91cE5hbWVcIiwgYCR7aGVsbU9wdGlvbnMubG9nR3JvdXBQcmVmaXh9L3dvcmtsb2Fkc2ApO1xuICAgIHNldFBhdGgodmFsdWVzLCBcImNsb3VkV2F0Y2hMb2dzLmxvZ0dyb3VwVGVtcGxhdGVcIiwgYCR7aGVsbU9wdGlvbnMubG9nR3JvdXBQcmVmaXh9LyRrdWJlcm5ldGVzWyduYW1lc3BhY2VfbmFtZSddYCk7XG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwiY2xvdWRXYXRjaExvZ3MubG9nU3RyZWFtVGVtcGxhdGVcIiwgXCIka3ViZXJuZXRlc1snY29udGFpbmVyX25hbWUnXS4ka3ViZXJuZXRlc1sncG9kX25hbWUnXVwiKTtcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJjbG91ZFdhdGNoTG9ncy5sb2dfa2V5XCIsIFwibG9nXCIpO1xuICAgIHNldFBhdGgodmFsdWVzLCBcImNsb3VkV2F0Y2hMb2dzLmxvZ19yZXRlbnRpb25fZGF5c1wiLCBoZWxtT3B0aW9ucy5sb2dSZXRlbnRpb25EYXlzKTtcbiAgICByZXR1cm4gdmFsdWVzO1xufSJdfQ==