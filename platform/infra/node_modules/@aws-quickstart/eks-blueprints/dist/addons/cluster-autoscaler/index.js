"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClusterAutoScalerAddOn = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const iam = require("aws-cdk-lib/aws-iam");
const cluster_providers_1 = require("../../cluster-providers");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const RELEASE = 'blueprints-addon-cluster-autoscaler';
const NAME = 'cluster-autoscaler';
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    chart: NAME,
    name: NAME,
    namespace: 'kube-system',
    release: RELEASE,
    repository: 'https://kubernetes.github.io/autoscaler',
    version: 'auto'
};
/**
 * Version of the autoscaler, controls the image tag
 */
const versionMap = new Map([
    [aws_eks_1.KubernetesVersion.V1_26, "9.29.0"],
    [aws_eks_1.KubernetesVersion.V1_25, "9.29.0"],
    [aws_eks_1.KubernetesVersion.V1_24, "9.25.0"],
    [aws_eks_1.KubernetesVersion.V1_23, "9.21.0"],
    [aws_eks_1.KubernetesVersion.V1_22, "9.13.1"],
    [aws_eks_1.KubernetesVersion.V1_21, "9.13.1"],
    [aws_eks_1.KubernetesVersion.V1_20, "9.9.2"],
    [aws_eks_1.KubernetesVersion.V1_19, "9.4.0"],
    [aws_eks_1.KubernetesVersion.V1_18, "9.4.0"],
]);
class ClusterAutoScalerAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a;
        if (((_a = this.options.version) === null || _a === void 0 ? void 0 : _a.trim()) === 'auto') {
            this.options.version = versionMap.get(clusterInfo.version);
            if (!this.options.version) {
                this.options.version = versionMap.values().next().value;
                utils_1.logger.warn(`Unable to auto-detect cluster autoscaler version. Applying latest: ${this.options.version}`);
            }
        }
        const cluster = clusterInfo.cluster;
        const nodeGroups = (0, cluster_providers_1.assertEC2NodeGroup)(clusterInfo, "Cluster Autoscaler");
        const values = this.options.values || {};
        const namespace = this.options.namespace;
        // Create IAM Policy
        const autoscalerStmt = new iam.PolicyStatement();
        autoscalerStmt.addResources("*");
        autoscalerStmt.addActions("autoscaling:DescribeAutoScalingGroups", "autoscaling:DescribeAutoScalingInstances", "autoscaling:DescribeLaunchConfigurations", "autoscaling:DescribeTags", "autoscaling:SetDesiredCapacity", "autoscaling:TerminateInstanceInAutoScalingGroup", "ec2:DescribeLaunchTemplateVersions", "ec2:DescribeInstanceTypes", "eks:DescribeNodegroup");
        const autoscalerPolicyDocument = new iam.PolicyDocument({
            statements: [autoscalerStmt]
        });
        // Tag node groups
        const clusterName = new aws_cdk_lib_1.CfnJson(cluster.stack, "clusterName", {
            value: cluster.clusterName,
        });
        for (let ng of nodeGroups) {
            aws_cdk_lib_1.Tags.of(ng).add(`k8s.io/cluster-autoscaler/${clusterName}`, "owned", { applyToLaunchedInstances: true });
            aws_cdk_lib_1.Tags.of(ng).add("k8s.io/cluster-autoscaler/enabled", "true", { applyToLaunchedInstances: true });
        }
        // Create namespace
        if (this.options.createNamespace) {
            (0, utils_1.createNamespace)(namespace, cluster, true);
        }
        // Create IRSA
        const sa = (0, utils_1.createServiceAccount)(cluster, RELEASE, namespace, autoscalerPolicyDocument);
        // Create Helm Chart
        (0, utils_1.setPath)(values, "cloudProvider", "aws");
        (0, utils_1.setPath)(values, "autoDiscovery.clusterName", cluster.clusterName);
        (0, utils_1.setPath)(values, "awsRegion", cluster.stack.region);
        (0, utils_1.setPath)(values, "rbac.serviceAccount.create", false);
        (0, utils_1.setPath)(values, "rbac.serviceAccount.name", RELEASE);
        const clusterAutoscalerChart = this.addHelmChart(clusterInfo, values, false);
        clusterAutoscalerChart.node.addDependency(sa);
        return Promise.resolve(clusterAutoscalerChart);
    }
}
exports.ClusterAutoScalerAddOn = ClusterAutoScalerAddOn;
__decorate([
    (0, utils_1.conflictsWith)('KarpenterAddOn')
], ClusterAutoScalerAddOn.prototype, "deploy", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2NsdXN0ZXItYXV0b3NjYWxlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSw2Q0FBNEM7QUFDNUMsaURBQXdEO0FBQ3hELDJDQUEyQztBQUUzQywrREFBNkQ7QUFFN0QsdUNBQW9HO0FBQ3BHLDhDQUE4RDtBQWtCOUQsTUFBTSxPQUFPLEdBQUcscUNBQXFDLENBQUM7QUFDdEQsTUFBTSxJQUFJLEdBQUcsb0JBQW9CLENBQUM7QUFDbEM7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBZ0M7SUFDOUMsS0FBSyxFQUFFLElBQUk7SUFDWCxJQUFJLEVBQUUsSUFBSTtJQUNWLFNBQVMsRUFBRSxhQUFhO0lBQ3hCLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLFVBQVUsRUFBRSx5Q0FBeUM7SUFDckQsT0FBTyxFQUFFLE1BQU07Q0FDbEIsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSxVQUFVLEdBQW1DLElBQUksR0FBRyxDQUFDO0lBQ3ZELENBQUMsMkJBQWlCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQztJQUNuQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLENBQUM7SUFDbkMsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDO0lBQ25DLENBQUMsMkJBQWlCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQztJQUNuQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLENBQUM7SUFDbkMsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDO0lBQ25DLENBQUMsMkJBQWlCLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQztJQUNsQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssRUFBRSxPQUFPLENBQUM7SUFDbEMsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDO0NBQ3JDLENBQUMs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Q0FBQyxDQUFDO1FBQ3hDLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbEUsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25ELElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSw0QkFBNEIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRCxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsMEJBQTBCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFckQsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0Usc0JBQXNCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUU5QyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNuRCxDQUFDO0NBQ0o7QUF6RUQsd0RBeUVDO0FBL0RHO0lBREMsSUFBQSxxQkFBYSxFQUFDLGdCQUFnQixDQUFDO29EQStEL0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZm5Kc29uLCBUYWdzIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBLdWJlcm5ldGVzVmVyc2lvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBhc3NlcnRFQzJOb2RlR3JvdXAgfSBmcm9tIFwiLi4vLi4vY2x1c3Rlci1wcm92aWRlcnNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgY29uZmxpY3RzV2l0aCwgY3JlYXRlTmFtZXNwYWNlLCBjcmVhdGVTZXJ2aWNlQWNjb3VudCwgbG9nZ2VyLCBzZXRQYXRoIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblVzZXJQcm9wcyB9IGZyb20gXCIuLi9oZWxtLWFkZG9uXCI7XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYWRkLW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENsdXN0ZXJBdXRvU2NhbGVyQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVmVyc2lvbiBvZiB0aGUgQ2x1c3RlciBBdXRvc2NhbGVyXG4gICAgICogQGRlZmF1bHQgYXV0byBkaXNjb3ZlcmVkIGJhc2VkIG9uIEVLUyB2ZXJzaW9uLlxuICAgICAqL1xuICAgIHZlcnNpb24/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgbmFtZXNwYWNlXG4gICAgICovXG4gICAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbjtcbn1cblxuY29uc3QgUkVMRUFTRSA9ICdibHVlcHJpbnRzLWFkZG9uLWNsdXN0ZXItYXV0b3NjYWxlcic7XG5jb25zdCBOQU1FID0gJ2NsdXN0ZXItYXV0b3NjYWxlcic7XG4vKipcbiAqIERlZmF1bHRzIG9wdGlvbnMgZm9yIHRoZSBhZGQtb25cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzOiBDbHVzdGVyQXV0b1NjYWxlckFkZE9uUHJvcHMgPSB7XG4gICAgY2hhcnQ6IE5BTUUsXG4gICAgbmFtZTogTkFNRSxcbiAgICBuYW1lc3BhY2U6ICdrdWJlLXN5c3RlbScsXG4gICAgcmVsZWFzZTogUkVMRUFTRSxcbiAgICByZXBvc2l0b3J5OiAnaHR0cHM6Ly9rdWJlcm5ldGVzLmdpdGh1Yi5pby9hdXRvc2NhbGVyJyxcbiAgICB2ZXJzaW9uOiAnYXV0bydcbn07XG5cbi8qKlxuICogVmVyc2lvbiBvZiB0aGUgYXV0b3NjYWxlciwgY29udHJvbHMgdGhlIGltYWdlIHRhZ1xuICovXG5jb25zdCB2ZXJzaW9uTWFwOiBNYXA8S3ViZXJuZXRlc1ZlcnNpb24sIHN0cmluZz4gPSBuZXcgTWFwKFtcbiAgICBbS3ViZXJuZXRlc1ZlcnNpb24uVjFfMjYsIFwiOS4yOS4wXCJdLFxuICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yNSwgXCI5LjI5LjBcIl0sXG4gICAgW0t1YmVybmV0ZXNWZXJzaW9uLlYxXzI0LCBcIjkuMjUuMFwiXSxcbiAgICBbS3ViZXJuZXRlc1ZlcnNpb24uVjFfMjMsIFwiOS4yMS4wXCJdLFxuICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yMiwgXCI5LjEzLjFcIl0sXG4gICAgW0t1YmVybmV0ZXNWZXJzaW9uLlYxXzIxLCBcIjkuMTMuMVwiXSxcbiAgICBbS3ViZXJuZXRlc1ZlcnNpb24uVjFfMjAsIFwiOS45LjJcIl0sXG4gICAgW0t1YmVybmV0ZXNWZXJzaW9uLlYxXzE5LCBcIjkuNC4wXCJdLFxuICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8xOCwgXCI5LjQuMFwiXSxcbl0pO1xuXG5leHBvcnQgY2xhc3MgQ2x1c3RlckF1dG9TY2FsZXJBZGRPbiBleHRlbmRzIEhlbG1BZGRPbiB7XG5cbiAgICBwcml2YXRlIG9wdGlvbnM6IENsdXN0ZXJBdXRvU2NhbGVyQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzPzogQ2x1c3RlckF1dG9TY2FsZXJBZGRPblByb3BzKSB7XG4gICAgICAgIHN1cGVyKHsgLi4uZGVmYXVsdFByb3BzIGFzIGFueSwgLi4ucHJvcHMgfSk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHM7XG4gICAgfVxuICAgIFxuICAgIEBjb25mbGljdHNXaXRoKCdLYXJwZW50ZXJBZGRPbicpXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG5cbiAgICAgICAgaWYodGhpcy5vcHRpb25zLnZlcnNpb24/LnRyaW0oKSA9PT0gJ2F1dG8nKSB7XG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMudmVyc2lvbiA9IHZlcnNpb25NYXAuZ2V0KGNsdXN0ZXJJbmZvLnZlcnNpb24pO1xuICAgICAgICAgICAgaWYoIXRoaXMub3B0aW9ucy52ZXJzaW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnZlcnNpb24gPSB2ZXJzaW9uTWFwLnZhbHVlcygpLm5leHQoKS52YWx1ZTtcbiAgICAgICAgICAgICAgICBsb2dnZXIud2FybihgVW5hYmxlIHRvIGF1dG8tZGV0ZWN0IGNsdXN0ZXIgYXV0b3NjYWxlciB2ZXJzaW9uLiBBcHBseWluZyBsYXRlc3Q6ICR7dGhpcy5vcHRpb25zLnZlcnNpb259YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gXG5cbiAgICAgICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGNvbnN0IG5vZGVHcm91cHMgPSBhc3NlcnRFQzJOb2RlR3JvdXAoY2x1c3RlckluZm8sIFwiQ2x1c3RlciBBdXRvc2NhbGVyXCIpO1xuICAgICAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLm9wdGlvbnMudmFsdWVzIHx8IHt9O1xuICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLm9wdGlvbnMubmFtZXNwYWNlITtcbiAgICAgICAgXG4gICAgICAgIC8vIENyZWF0ZSBJQU0gUG9saWN5XG4gICAgICAgIGNvbnN0IGF1dG9zY2FsZXJTdG10ID0gbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoKTtcbiAgICAgICAgYXV0b3NjYWxlclN0bXQuYWRkUmVzb3VyY2VzKFwiKlwiKTtcbiAgICAgICAgYXV0b3NjYWxlclN0bXQuYWRkQWN0aW9ucyhcbiAgICAgICAgICAgIFwiYXV0b3NjYWxpbmc6RGVzY3JpYmVBdXRvU2NhbGluZ0dyb3Vwc1wiLFxuICAgICAgICAgICAgXCJhdXRvc2NhbGluZzpEZXNjcmliZUF1dG9TY2FsaW5nSW5zdGFuY2VzXCIsXG4gICAgICAgICAgICBcImF1dG9zY2FsaW5nOkRlc2NyaWJlTGF1bmNoQ29uZmlndXJhdGlvbnNcIixcbiAgICAgICAgICAgIFwiYXV0b3NjYWxpbmc6RGVzY3JpYmVUYWdzXCIsXG4gICAgICAgICAgICBcImF1dG9zY2FsaW5nOlNldERlc2lyZWRDYXBhY2l0eVwiLFxuICAgICAgICAgICAgXCJhdXRvc2NhbGluZzpUZXJtaW5hdGVJbnN0YW5jZUluQXV0b1NjYWxpbmdHcm91cFwiLFxuICAgICAgICAgICAgXCJlYzI6RGVzY3JpYmVMYXVuY2hUZW1wbGF0ZVZlcnNpb25zXCIsXG4gICAgICAgICAgICBcImVjMjpEZXNjcmliZUluc3RhbmNlVHlwZXNcIixcbiAgICAgICAgICAgIFwiZWtzOkRlc2NyaWJlTm9kZWdyb3VwXCJcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBhdXRvc2NhbGVyUG9saWN5RG9jdW1lbnQgPSBuZXcgaWFtLlBvbGljeURvY3VtZW50KHtcbiAgICAgICAgICAgIHN0YXRlbWVudHM6IFthdXRvc2NhbGVyU3RtdF1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVGFnIG5vZGUgZ3JvdXBzXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJOYW1lID0gbmV3IENmbkpzb24oY2x1c3Rlci5zdGFjaywgXCJjbHVzdGVyTmFtZVwiLCB7XG4gICAgICAgICAgICB2YWx1ZTogY2x1c3Rlci5jbHVzdGVyTmFtZSxcbiAgICAgICAgfSk7XG4gICAgICAgIGZvcihsZXQgbmcgb2Ygbm9kZUdyb3Vwcykge1xuICAgICAgICAgICAgVGFncy5vZihuZykuYWRkKGBrOHMuaW8vY2x1c3Rlci1hdXRvc2NhbGVyLyR7Y2x1c3Rlck5hbWV9YCwgXCJvd25lZFwiLCB7IGFwcGx5VG9MYXVuY2hlZEluc3RhbmNlczogdHJ1ZSB9KTtcbiAgICAgICAgICAgIFRhZ3Mub2YobmcpLmFkZChcIms4cy5pby9jbHVzdGVyLWF1dG9zY2FsZXIvZW5hYmxlZFwiLCBcInRydWVcIiwgeyBhcHBseVRvTGF1bmNoZWRJbnN0YW5jZXM6IHRydWUgfSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIENyZWF0ZSBuYW1lc3BhY2VcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5jcmVhdGVOYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIGNyZWF0ZU5hbWVzcGFjZShuYW1lc3BhY2UsIGNsdXN0ZXIsIHRydWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ3JlYXRlIElSU0FcbiAgICAgICAgY29uc3Qgc2EgPSBjcmVhdGVTZXJ2aWNlQWNjb3VudChjbHVzdGVyLCBSRUxFQVNFLCBuYW1lc3BhY2UsIGF1dG9zY2FsZXJQb2xpY3lEb2N1bWVudCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIEhlbG0gQ2hhcnRcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiY2xvdWRQcm92aWRlclwiLCBcImF3c1wiKTtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiYXV0b0Rpc2NvdmVyeS5jbHVzdGVyTmFtZVwiLCBjbHVzdGVyLmNsdXN0ZXJOYW1lKTtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiYXdzUmVnaW9uXCIsIGNsdXN0ZXIuc3RhY2sucmVnaW9uKTtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwicmJhYy5zZXJ2aWNlQWNjb3VudC5jcmVhdGVcIiwgZmFsc2UpO1xuICAgICAgICBzZXRQYXRoKHZhbHVlcywgXCJyYmFjLnNlcnZpY2VBY2NvdW50Lm5hbWVcIiwgUkVMRUFTRSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjbHVzdGVyQXV0b3NjYWxlckNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIHZhbHVlcywgZmFsc2UpO1xuICAgICAgICBjbHVzdGVyQXV0b3NjYWxlckNoYXJ0Lm5vZGUuYWRkRGVwZW5kZW5jeShzYSk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjbHVzdGVyQXV0b3NjYWxlckNoYXJ0KTtcbiAgICB9XG59XG4iXX0=