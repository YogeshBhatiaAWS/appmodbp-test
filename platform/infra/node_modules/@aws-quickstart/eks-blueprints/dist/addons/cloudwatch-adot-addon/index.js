"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CloudWatchAdotAddOn = void 0;
const utils_1 = require("../../utils");
const adot_1 = require("../adot");
const kubectl_provider_1 = require("../helm-addon/kubectl-provider");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    deploymentMode: "deployment" /* cloudWatchDeploymentMode.DEPLOYMENT */,
    namespace: 'default',
    name: 'adot-collector-cloudwatch',
    metricsNameSelectors: ['apiserver_request_.*', 'container_memory_.*', 'container_threads', 'otelcol_process_.*'],
    podLabelRegex: '.*'
};
/**
 * Implementation of CloudWatch ADOT add-on for EKS Blueprints. Installs ADOT Collector.
 */
class CloudWatchAdotAddOn {
    constructor(props) {
        this.cloudWatchAddOnProps = { ...defaultProps, ...props };
    }
    deploy(clusterInfo) {
        var _a, _b;
        const cluster = clusterInfo.cluster;
        // Applying manifest for configuring ADOT Collector for CloudWatch.
        const doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-cloudwatch.ytpl');
        const manifest = doc.split("---").map(e => (0, utils_1.loadYaml)(e));
        const values = {
            awsRegion: cluster.stack.region,
            deploymentMode: this.cloudWatchAddOnProps.deploymentMode,
            namespace: this.cloudWatchAddOnProps.namespace,
            clusterName: cluster.clusterName,
            metricsNameSelectors: (_a = this.cloudWatchAddOnProps.metricsNameSelectors) !== null && _a !== void 0 ? _a : defaultProps.metricsNameSelectors,
            podLabelRegex: (_b = this.cloudWatchAddOnProps.podLabelRegex) !== null && _b !== void 0 ? _b : defaultProps.podLabelRegex
        };
        const manifestDeployment = {
            name: this.cloudWatchAddOnProps.name,
            namespace: this.cloudWatchAddOnProps.namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        return Promise.resolve(statement);
    }
}
exports.CloudWatchAdotAddOn = CloudWatchAdotAddOn;
__decorate([
    (0, utils_1.dependable)(adot_1.AdotCollectorAddOn.name)
], CloudWatchAdotAddOn.prototype, "deploy", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2Nsb3Vkd2F0Y2gtYWRvdC1hZGRvbi9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSx1Q0FBcUU7QUFDckUsa0NBQTZDO0FBRTdDLHFFQUFxRjtBQWdEckY7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBNkI7SUFDM0MsY0FBYyx3REFBcUM7SUFDbkQsU0FBUyxFQUFFLFNBQVM7SUFDcEIsSUFBSSxFQUFFLDJCQUEyQjtJQUNqQyxvQkFBb0IsRUFBRSxDQUFDLHNCQUFzQixFQUFFLHFCQUFxQixFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixDQUFDO0lBQ2hILGFBQWEsRUFBRSxJQUFJO0NBQ3RCLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQWEsbUJBQW1CO0lBSTVCLFlBQVksS0FBZ0M7UUFDeEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsR0FBRyxZQUFZLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQztJQUM5RCxDQUFDO0lBR0QsTUFBTSxDQUFDLFdBQXdCOztRQUMzQixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBRXBDLG1FQUFtRTtRQUNuRSxNQUFNLEdBQUcsR0FBRyxJQUFBLHdCQUFnQixFQUFDLFNBQVMsR0FBRSxtQ0FBbUMsQ0FBQyxDQUFDO1FBQzdFLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBQSxnQkFBUSxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEQsTUFBTSxNQUFNLEdBQVc7WUFDbkIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTTtZQUMvQixjQUFjLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGNBQWM7WUFDeEQsU0FBUyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTO1lBQzlDLFdBQVcsRUFBRSxPQUFPLENBQUMsV0FBVztZQUNoQyxvQkFBb0IsRUFBRSxNQUFBLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxvQkFBb0IsbUNBQUcsWUFBWSxDQUFDLG9CQUFvQjtZQUN4RyxhQUFhLEVBQUUsTUFBQSxJQUFJLENBQUMsb0JBQW9CLENBQUMsYUFBYSxtQ0FBRyxZQUFZLENBQUMsYUFBYTtTQUNyRixDQUFDO1FBRUYsTUFBTSxrQkFBa0IsR0FBdUI7WUFDNUMsSUFBSSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFLO1lBQ3JDLFNBQVMsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBVTtZQUMvQyxRQUFRO1lBQ1IsTUFBTTtTQUNULENBQUM7UUFFRixNQUFNLGVBQWUsR0FBRyxJQUFJLGtDQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekQsTUFBTSxTQUFTLEdBQUcsZUFBZSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2xFLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0QyxDQUFDO0NBQ0o7QUFuQ0Qsa0RBbUNDO0FBMUJHO0lBREMsSUFBQSxrQkFBVSxFQUFDLHlCQUFrQixDQUFDLElBQUksQ0FBQztpREEwQm5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2x1c3RlckFkZE9uLCBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgZGVwZW5kYWJsZSwgbG9hZFlhbWwsIHJlYWRZYW1sRG9jdW1lbnQgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcbmltcG9ydCB7IEFkb3RDb2xsZWN0b3JBZGRPbiB9IGZyb20gXCIuLi9hZG90XCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IEt1YmVjdGxQcm92aWRlciwgTWFuaWZlc3REZXBsb3ltZW50IH0gZnJvbSBcIi4uL2hlbG0tYWRkb24va3ViZWN0bC1wcm92aWRlclwiO1xuXG4vKipcbiAqIFRoaXMgQ2xvdWRXYXRjaCBBRE9UIEFkZG9uIGRlcGxveXMgYW4gQVdTIERpc3RybyBmb3IgT3BlblRlbGVtZXRyeSAoQURPVCkgQ29sbGVjdG9yIGZvciBcbiAqIENsb3VkV2F0Y2ggd2hpY2ggcmVjZWl2ZXMgbWV0cmljcyBhbmQgbG9ncyBmcm9tIHRoZSBhcHBsaWNhdGlvbiBhbmQgc2VuZHMgdGhlIHNhbWUgdG8gXG4gKiBDbG91ZFdhdGNoIGNvbnNvbGUuIFlvdSBjYW4gY2hhbmdlIHRoZSBtb2RlIHRvIERhZW1vbnNldCwgU3RhdGVmdWxTZXQsIGFuZCBTaWRlY2FyIFxuICogZGVwZW5kaW5nIG9uIHlvdXIgZGVwbG95bWVudCBzdHJhdGVneS5cbiAqL1xuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgQ2xvdWRXYXRjaCBBZG90IGFkZC1vbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDbG91ZFdhdGNoQWRvdEFkZE9uUHJvcHMge1xuICAgIC8qKlxuICAgICAqIE1vZGVzIHN1cHBvcnRlZCA6IGBkZXBsb3ltZW50YCwgYGRhZW1vbnNldGAsIGBzdGF0ZWZ1bFNldGAsIGFuZCBgc2lkZWNhcmBcbiAgICAgKiBAZGVmYXVsdCBkZXBsb3ltZW50XG4gICAgICovXG4gICAgZGVwbG95bWVudE1vZGU/OiBjbG91ZFdhdGNoRGVwbG95bWVudE1vZGU7XG4gICAgLyoqXG4gICAgICogTmFtZXNwYWNlIHRvIGRlcGxveSB0aGUgQURPVCBDb2xsZWN0b3IgZm9yIENsb3VkV2F0Y2guXG4gICAgICogQGRlZmF1bHQgZGVmYXVsdFxuICAgICAqL1xuICAgIG5hbWVzcGFjZT86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBOYW1lIHRvIGRlcGxveSB0aGUgQURPVCBDb2xsZWN0b3IgZm9yIENsb3VkV2F0Y2guXG4gICAgICogQGRlZmF1bHQgJ2Fkb3QtY29sbGVjdG9yLWNsb3Vkd2F0Y2gnXG4gICAgICovXG4gICAgbmFtZT86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBNZXRyaWNzIG5hbWUgc2VsZWN0b3JzIHRvIHdyaXRlIHRvIENsb3VkV2F0Y2guXG4gICAgICogQGRlZmF1bHQgXCJbJ2FwaXNlcnZlcl9yZXF1ZXN0Xy4qJywgJ2NvbnRhaW5lcl9tZW1vcnlfLionLCAnY29udGFpbmVyX3RocmVhZHMnLCAnb3RlbGNvbF9wcm9jZXNzXy4qJ11cIlxuICAgICAqL1xuICAgIG1ldHJpY3NOYW1lU2VsZWN0b3JzPzogc3RyaW5nW107XG4gICAgLyoqXG4gICAgICogTGFiZWxzIG9mIFBvZHMgdG8gc2VsZWN0IHlvdXIgYXBwbGljYXRpb24gcG9kcyBlbWl0dGluZyBjdXN0b20gbWV0cmljcy5cbiAgICAgKiBFeGFtcGxlICdmcm9udGVuZHxkb3duc3RyZWFtKC4qKSdcbiAgICAgKiBAZGVmYXVsdCAnLionXG4gICAgICovXG4gICAgIHBvZExhYmVsUmVnZXg/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBlbnVtIGNsb3VkV2F0Y2hEZXBsb3ltZW50TW9kZSB7XG4gICAgREVQTE9ZTUVOVCA9ICdkZXBsb3ltZW50JyxcbiAgICBEQUVNT05TRVQgPSAnZGFlbW9uc2V0JyxcbiAgICBTVEFURUZVTFNFVCA9ICdzdGF0ZWZ1bHNldCcsXG4gICAgU0lERUNBUiA9ICdzaWRlY2FyJ1xufVxuXG4vKipcbiAqIERlZmF1bHRzIG9wdGlvbnMgZm9yIHRoZSBhZGQtb25cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzOiBDbG91ZFdhdGNoQWRvdEFkZE9uUHJvcHMgPSB7XG4gICAgZGVwbG95bWVudE1vZGU6IGNsb3VkV2F0Y2hEZXBsb3ltZW50TW9kZS5ERVBMT1lNRU5ULFxuICAgIG5hbWVzcGFjZTogJ2RlZmF1bHQnLFxuICAgIG5hbWU6ICdhZG90LWNvbGxlY3Rvci1jbG91ZHdhdGNoJyxcbiAgICBtZXRyaWNzTmFtZVNlbGVjdG9yczogWydhcGlzZXJ2ZXJfcmVxdWVzdF8uKicsICdjb250YWluZXJfbWVtb3J5Xy4qJywgJ2NvbnRhaW5lcl90aHJlYWRzJywgJ290ZWxjb2xfcHJvY2Vzc18uKiddLFxuICAgIHBvZExhYmVsUmVnZXg6ICcuKidcbn07XG5cbi8qKlxuICogSW1wbGVtZW50YXRpb24gb2YgQ2xvdWRXYXRjaCBBRE9UIGFkZC1vbiBmb3IgRUtTIEJsdWVwcmludHMuIEluc3RhbGxzIEFET1QgQ29sbGVjdG9yLlxuICovXG5leHBvcnQgY2xhc3MgQ2xvdWRXYXRjaEFkb3RBZGRPbiBpbXBsZW1lbnRzIENsdXN0ZXJBZGRPbiB7XG5cbiAgICByZWFkb25seSBjbG91ZFdhdGNoQWRkT25Qcm9wczogQ2xvdWRXYXRjaEFkb3RBZGRPblByb3BzO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM/OiBDbG91ZFdhdGNoQWRvdEFkZE9uUHJvcHMpIHtcbiAgICAgICAgdGhpcy5jbG91ZFdhdGNoQWRkT25Qcm9wcyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9O1xuICAgIH1cblxuICAgIEBkZXBlbmRhYmxlKEFkb3RDb2xsZWN0b3JBZGRPbi5uYW1lKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcblxuICAgICAgICAvLyBBcHBseWluZyBtYW5pZmVzdCBmb3IgY29uZmlndXJpbmcgQURPVCBDb2xsZWN0b3IgZm9yIENsb3VkV2F0Y2guXG4gICAgICAgIGNvbnN0IGRvYyA9IHJlYWRZYW1sRG9jdW1lbnQoX19kaXJuYW1lICsnL2NvbGxlY3Rvci1jb25maWctY2xvdWR3YXRjaC55dHBsJyk7XG4gICAgICAgIGNvbnN0IG1hbmlmZXN0ID0gZG9jLnNwbGl0KFwiLS0tXCIpLm1hcChlID0+IGxvYWRZYW1sKGUpKTtcbiAgICAgICAgY29uc3QgdmFsdWVzOiBWYWx1ZXMgPSB7XG4gICAgICAgICAgICBhd3NSZWdpb246IGNsdXN0ZXIuc3RhY2sucmVnaW9uLFxuICAgICAgICAgICAgZGVwbG95bWVudE1vZGU6IHRoaXMuY2xvdWRXYXRjaEFkZE9uUHJvcHMuZGVwbG95bWVudE1vZGUsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMuY2xvdWRXYXRjaEFkZE9uUHJvcHMubmFtZXNwYWNlLFxuICAgICAgICAgICAgY2x1c3Rlck5hbWU6IGNsdXN0ZXIuY2x1c3Rlck5hbWUsXG4gICAgICAgICAgICBtZXRyaWNzTmFtZVNlbGVjdG9yczogdGhpcy5jbG91ZFdhdGNoQWRkT25Qcm9wcy5tZXRyaWNzTmFtZVNlbGVjdG9ycz8/IGRlZmF1bHRQcm9wcy5tZXRyaWNzTmFtZVNlbGVjdG9ycyxcbiAgICAgICAgICAgIHBvZExhYmVsUmVnZXg6IHRoaXMuY2xvdWRXYXRjaEFkZE9uUHJvcHMucG9kTGFiZWxSZWdleD8/IGRlZmF1bHRQcm9wcy5wb2RMYWJlbFJlZ2V4XG4gICAgICAgICB9O1xuICAgICAgICAgXG4gICAgICAgICBjb25zdCBtYW5pZmVzdERlcGxveW1lbnQ6IE1hbmlmZXN0RGVwbG95bWVudCA9IHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuY2xvdWRXYXRjaEFkZE9uUHJvcHMubmFtZSEsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMuY2xvdWRXYXRjaEFkZE9uUHJvcHMubmFtZXNwYWNlISxcbiAgICAgICAgICAgIG1hbmlmZXN0LFxuICAgICAgICAgICAgdmFsdWVzXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qga3ViZWN0bFByb3ZpZGVyID0gbmV3IEt1YmVjdGxQcm92aWRlcihjbHVzdGVySW5mbyk7XG4gICAgICAgIGNvbnN0IHN0YXRlbWVudCA9IGt1YmVjdGxQcm92aWRlci5hZGRNYW5pZmVzdChtYW5pZmVzdERlcGxveW1lbnQpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHN0YXRlbWVudCk7XG4gICAgfVxufSJdfQ==