"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SecretProviderClass = exports.KubernetesSecretType = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const assert = require("assert");
const __1 = require("../..");
var AwsSecretType;
(function (AwsSecretType) {
    AwsSecretType["SSMPARAMETER"] = "ssmparameter";
    AwsSecretType["SECRETSMANAGER"] = "secretsmanager";
})(AwsSecretType || (AwsSecretType = {}));
var KubernetesSecretType;
(function (KubernetesSecretType) {
    KubernetesSecretType["OPAQUE"] = "Opaque";
    KubernetesSecretType["BASIC_AUTH"] = "kubernetes.io/basic-auth";
    KubernetesSecretType["TOKEN"] = "bootstrap.kubernetes.io/token";
    KubernetesSecretType["DOCKER_CONFIG_JSON"] = "kubernetes.io/dockerconfigjson";
    KubernetesSecretType["DOCKER_CONFIG"] = "kubernetes.io/dockercfg";
    KubernetesSecretType["SSH_AUTH"] = "kubernetes.io/ssh-auth";
    KubernetesSecretType["SERVICE_ACCOUNT_TOKEN"] = "kubernetes.io/service-account-token";
    KubernetesSecretType["TLS"] = "kubernetes.io/tls";
})(KubernetesSecretType || (exports.KubernetesSecretType = KubernetesSecretType = {}));
function createParameterObject(csiSecret, secretName, secretType) {
    const result = {
        objectName: secretName,
        objectType: secretType,
    };
    if (csiSecret.jmesPath) {
        result.jmesPath = csiSecret.jmesPath;
    }
    return result;
}
class SecretProviderClass {
    constructor(clusterInfo, serviceAccount, secretProviderClassName, ...csiSecrets) {
        this.clusterInfo = clusterInfo;
        this.serviceAccount = serviceAccount;
        this.secretProviderClassName = secretProviderClassName;
        this.parameterObjects = [];
        this.kubernetesSecrets = [];
        this.csiSecrets = csiSecrets;
        this.secretProviderClassPromise = this.setupSecrets();
    }
    addDependent(...constructs) {
        this.secretProviderClassPromise.then(secretProviderClass => {
            constructs.forEach(dependent => dependent.node.addDependency(secretProviderClass));
        });
    }
    /**
     * Optionally returns volume mounts for a pod or helm chart that supports volume mounts.
     */
    getVolumeMounts(volumeName, mountPath) {
        return {
            "volumes": [
                {
                    name: volumeName,
                    csi: {
                        driver: "secrets-store.csi.k8s.io",
                        readOnly: true,
                        volumeAttributes: {
                            secretProviderClass: this.secretProviderClassName
                        }
                    }
                }
            ],
            "volumeMounts": [
                {
                    name: volumeName,
                    mountPath: mountPath !== null && mountPath !== void 0 ? mountPath : "/mnt/secret-store"
                }
            ]
        };
    }
    /**
     * Setup CSI secrets
     * @param clusterInfo
     */
    setupSecrets() {
        const secretsDriverPromise = this.clusterInfo.getScheduledAddOn(__1.SecretsStoreAddOn.name);
        assert(secretsDriverPromise != null, 'SecretsStoreAddOn is required to setup secrets but is not provided in the add-ons.');
        this.addPolicyToServiceAccount();
        // Create and apply SecretProviderClass manifest
        return secretsDriverPromise.then(secretsDriver => this.createSecretProviderClass(secretsDriver));
    }
    /**
     * Creates Service Account for CSI Secrets driver and sets up the IAM Policies
     * needed to access the AWS Secrets
     * @param clusterInfo
     * @param serviceAccount
     */
    addPolicyToServiceAccount() {
        this.csiSecrets.forEach((csiSecret) => {
            var _a, _b;
            const data = [];
            let kubernetesSecret;
            let secretName;
            const secret = csiSecret.secretProvider.provide(this.clusterInfo);
            if (Object.hasOwnProperty.call(secret, 'secretArn')) {
                const secretManagerSecret = secret;
                secretName = secretManagerSecret.secretName;
                const parameterObject = createParameterObject(csiSecret, secretName, AwsSecretType.SECRETSMANAGER);
                this.parameterObjects.push(parameterObject);
                secretManagerSecret.grantRead(this.serviceAccount);
            }
            else {
                const ssmSecret = secret;
                secretName = ssmSecret.parameterName;
                const parameterObject = createParameterObject(csiSecret, secretName, AwsSecretType.SSMPARAMETER);
                this.parameterObjects.push(parameterObject);
                ssmSecret.grantRead(this.serviceAccount);
            }
            if (csiSecret.kubernetesSecret) {
                if (csiSecret.kubernetesSecret.data) {
                    csiSecret.kubernetesSecret.data.forEach((item) => {
                        var _a, _b;
                        const dataObject = {
                            objectName: (_a = item.objectName) !== null && _a !== void 0 ? _a : secretName,
                            key: (_b = item.key) !== null && _b !== void 0 ? _b : secretName
                        };
                        data.push(dataObject);
                    });
                }
                else {
                    const dataObject = {
                        objectName: secretName,
                        key: secretName
                    };
                    data.push(dataObject);
                }
                kubernetesSecret = {
                    secretName: csiSecret.kubernetesSecret.secretName,
                    type: (_a = csiSecret.kubernetesSecret.type) !== null && _a !== void 0 ? _a : KubernetesSecretType.OPAQUE,
                    labels: (_b = csiSecret.kubernetesSecret.labels) !== null && _b !== void 0 ? _b : undefined,
                    data,
                };
                this.kubernetesSecrets.push(kubernetesSecret);
            }
        });
    }
    /**
     * Create and apply the SecretProviderClass manifest
     * @param clusterInfo
     * @param serviceAccount
     * @param csiDriver
     */
    createSecretProviderClass(csiDriver) {
        const cluster = this.clusterInfo.cluster;
        const secretProviderClass = this.secretProviderClassName;
        const secretProviderClassManifest = cluster.addManifest(secretProviderClass, {
            apiVersion: 'secrets-store.csi.x-k8s.io/v1alpha1',
            kind: 'SecretProviderClass',
            metadata: {
                name: secretProviderClass,
                namespace: this.serviceAccount.serviceAccountNamespace
            },
            spec: {
                provider: 'aws',
                parameters: {
                    objects: JSON.stringify(this.parameterObjects),
                },
                secretObjects: this.kubernetesSecrets
            }
        });
        secretProviderClassManifest.node.addDependency(this.serviceAccount, csiDriver);
        new aws_cdk_lib_1.CfnOutput(cluster.stack, `${this.serviceAccount.serviceAccountName}-secret-provider-class `, {
            value: secretProviderClass
        });
        return secretProviderClassManifest;
    }
}
exports.SecretProviderClass = SecretProviderClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NpLWRyaXZlci1wcm92aWRlci1hd3Mtc2VjcmV0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGRvbnMvc2VjcmV0cy1zdG9yZS9jc2ktZHJpdmVyLXByb3ZpZGVyLWF3cy1zZWNyZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLDZDQUF3QztBQUV4QyxpQ0FBaUM7QUFDakMsNkJBQTBDO0FBd0UxQyxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDZCw4Q0FBNkIsQ0FBQTtJQUM3QixrREFBaUMsQ0FBQTtBQUNyQyxDQUFDLEVBSEksYUFBYSxLQUFiLGFBQWEsUUFHakI7QUFFRCxJQUFZLG9CQVNYO0FBVEQsV0FBWSxvQkFBb0I7SUFDNUIseUNBQWlCLENBQUE7SUFDakIsK0RBQXVDLENBQUE7SUFDdkMsK0RBQXVDLENBQUE7SUFDdkMsNkVBQXFELENBQUE7SUFDckQsaUVBQXlDLENBQUE7SUFDekMsMkRBQW1DLENBQUE7SUFDbkMscUZBQTZELENBQUE7SUFDN0QsaURBQXlCLENBQUE7QUFDN0IsQ0FBQyxFQVRXLG9CQUFvQixvQ0FBcEIsb0JBQW9CLFFBUy9CO0FBUUQsU0FBUyxxQkFBcUIsQ0FBQyxTQUF5QixFQUFFLFVBQWtCLEVBQUUsVUFBeUI7SUFDbkcsTUFBTSxNQUFNLEdBQW9CO1FBQzVCLFVBQVUsRUFBRSxVQUFVO1FBQ3RCLFVBQVUsRUFBRSxVQUFVO0tBQ3pCLENBQUM7SUFDRixJQUFJLFNBQVMsQ0FBQyxRQUFRLEVBQUU7UUFDcEIsTUFBTSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDO0tBQ3hDO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQUdELE1BQWEsbUJBQW1CO0lBTzVCLFlBQW9CLFdBQXdCLEVBQVUsY0FBOEIsRUFBVSx1QkFBK0IsRUFBRSxHQUFHLFVBQTRCO1FBQTFJLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQVUsbUJBQWMsR0FBZCxj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QyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDTyx5QkFBeUIsQ0FBQyxTQUFvQjtRQUNwRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQztRQUN6RCxNQUFNLDJCQUEyQixHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsbUJBQW1CLEVBQUU7WUFDekUsVUFBVSxFQUFFLHFDQUFxQztZQUNqRCxJQUFJLEVBQUUscUJBQXFCO1lBQzNCLFFBQVEsRUFBRTtnQkFDTixJQUFJLEVBQUUsbUJBQW1CO2dCQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyx1QkFBdUI7YUFDekQ7WUFDRCxJQUFJLEVBQUU7Z0JBQ0YsUUFBUSxFQUFFLEtBQUs7Z0JBQ2YsVUFBVSxFQUFFO29CQUNSLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztpQkFDakQ7Z0JBQ0QsYUFBYSxFQUFFLElBQUksQ0FBQyxpQkFBaUI7YUFDeEM7U0FDSixDQUFDLENBQUM7UUFFSCwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUMxQyxJQUFJLENBQUMsY0FBYyxFQUNuQixTQUFTLENBQ1osQ0FBQztRQUVGLElBQUksdUJBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IseUJBQXlCLEVBQUU7WUFDN0YsS0FBSyxFQUFFLG1CQUFtQjtTQUM3QixDQUFDLENBQUM7UUFFSCxPQUFPLDJCQUEyQixDQUFDO0lBQ3ZDLENBQUM7Q0FDSjtBQTFKRCxrREEwSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXJ2aWNlQWNjb3VudCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0IHsgSVNlY3JldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlcic7XG5pbXBvcnQgeyBJU3RyaW5nUGFyYW1ldGVyIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXNzbSc7XG5pbXBvcnQgeyBDZm5PdXRwdXQgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbmltcG9ydCB7IFNlY3JldHNTdG9yZUFkZE9uIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gJy4uLy4uL3NwaSc7XG5pbXBvcnQgeyBTZWNyZXRQcm92aWRlciB9IGZyb20gJy4vc2VjcmV0LXByb3ZpZGVyJztcblxuLyoqXG4gKiBDc2lTZWNyZXQgUHJvcHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDc2lTZWNyZXRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIHNlY3JldCBwcm92aWRlciB0aGF0IHJldHVybnMgYSByZWZlcmVuY2UgdG8gYW4gU2VjcmV0cyBNYW5hZ2VyIGVudHJ5IG9yIEJsdWVwcmludHMgUGFyYW1ldGVyLlxuICAgICAqL1xuICAgIHNlY3JldFByb3ZpZGVyOiBTZWNyZXRQcm92aWRlcjtcblxuICAgIC8qKlxuICAgICAqIEZvciBzZWNyZXRzIGNvbnRhaW5pbmcgSlNPTiBzdHJ1Y3R1cmUsIGFuIG9wdGlvbmFsIEpNRVMgUGF0aCAoaHR0cHM6Ly9qbWVzcGF0aC5vcmcvKSBvYmplY3QgdG8gZGVjb21wb3NlIGluZGl2aWR1YWwga2V5cyBhcyBzZXBhcmF0ZSBcbiAgICAgKiBzZWNyZXQgb2JqZWN0IGRhdGEuIFxuICAgICAqL1xuICAgIGptZXNQYXRoPzogSm1lc1BhdGhPYmplY3RbXTtcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgc2VjcmV0IGZvciBjYXNlcyB3aGVuIENTSSBzZWNyZXQgc2hvdWxkIGNyZWF0ZSBhIHN0YW5kYXJkIEt1YmVybmV0ZXMgU2VjcmV0IG9iamVjdC5cbiAgICAgKi9cbiAgICBrdWJlcm5ldGVzU2VjcmV0PzogS3ViZXJuZXRlc1NlY3JldDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBKbWVzUGF0aE9iamVjdCB7XG4gICAgb2JqZWN0QWxpYXM6IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmdcbn1cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIGZvciBLdWJlcm5ldGVzIFNlY3JldHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBLdWJlcm5ldGVzU2VjcmV0IHtcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgU2VjcmV0IE5hbWVcbiAgICAgKi9cbiAgICBzZWNyZXROYW1lOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUeXBlIG9mIEt1YmVybmV0ZXMgU2VjcmV0XG4gICAgICovXG4gICAgdHlwZT86IEt1YmVybmV0ZXNTZWNyZXRUeXBlXG5cbiAgICAvKipcbiAgICAgKiBTZWNyZXQgTGFiZWxzXG4gICAgICovXG4gICAgbGFiZWxzPzogVmFsdWVzO1xuXG4gICAgLyoqXG4gICAgICogS3ViZXJuZXRlcyBTZWNyZXRPYmplY3QgRGF0YVxuICAgICAqL1xuICAgIGRhdGE/OiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YVtdO1xufVxuXG4vKipcbiAqIERhdGEgZm9yIEt1YmVybmV0ZXMgU2VjcmV0c1xuICovXG5pbnRlcmZhY2UgS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGEge1xuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgQVdTIFNlY3JldCB0aGF0IGlzIHN5bmNkXG4gICAgICovXG4gICAgb2JqZWN0TmFtZT86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgU2VjcmV0IEtleVxuICAgICAqL1xuICAgIGtleT86IHN0cmluZztcbn1cblxuZW51bSBBd3NTZWNyZXRUeXBlIHtcbiAgICBTU01QQVJBTUVURVIgPSAnc3NtcGFyYW1ldGVyJyxcbiAgICBTRUNSRVRTTUFOQUdFUiA9ICdzZWNyZXRzbWFuYWdlcidcbn1cblxuZXhwb3J0IGVudW0gS3ViZXJuZXRlc1NlY3JldFR5cGUge1xuICAgIE9QQVFVRSA9ICdPcGFxdWUnLFxuICAgIEJBU0lDX0FVVEggPSAna3ViZXJuZXRlcy5pby9iYXNpYy1hdXRoJyxcbiAgICBUT0tFTiA9ICdib290c3RyYXAua3ViZXJuZXRlcy5pby90b2tlbicsXG4gICAgRE9DS0VSX0NPTkZJR19KU09OID0gJ2t1YmVybmV0ZXMuaW8vZG9ja2VyY29uZmlnanNvbicsXG4gICAgRE9DS0VSX0NPTkZJRyA9ICdrdWJlcm5ldGVzLmlvL2RvY2tlcmNmZycsXG4gICAgU1NIX0FVVEggPSAna3ViZXJuZXRlcy5pby9zc2gtYXV0aCcsXG4gICAgU0VSVklDRV9BQ0NPVU5UX1RPS0VOID0gJ2t1YmVybmV0ZXMuaW8vc2VydmljZS1hY2NvdW50LXRva2VuJyxcbiAgICBUTFMgPSAna3ViZXJuZXRlcy5pby90bHMnXG59XG5cbmludGVyZmFjZSBQYXJhbWV0ZXJPYmplY3Qge1xuICAgIG9iamVjdE5hbWU6IHN0cmluZztcbiAgICBvYmplY3RUeXBlOiBzdHJpbmc7XG4gICAgam1lc1BhdGg/OiBKbWVzUGF0aE9iamVjdFtdO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQYXJhbWV0ZXJPYmplY3QoY3NpU2VjcmV0OiBDc2lTZWNyZXRQcm9wcywgc2VjcmV0TmFtZTogc3RyaW5nLCBzZWNyZXRUeXBlOiBBd3NTZWNyZXRUeXBlKSB7XG4gICAgY29uc3QgcmVzdWx0OiBQYXJhbWV0ZXJPYmplY3QgPSB7XG4gICAgICAgIG9iamVjdE5hbWU6IHNlY3JldE5hbWUsXG4gICAgICAgIG9iamVjdFR5cGU6IHNlY3JldFR5cGUsXG4gICAgfTtcbiAgICBpZiAoY3NpU2VjcmV0LmptZXNQYXRoKSB7XG4gICAgICAgIHJlc3VsdC5qbWVzUGF0aCA9IGNzaVNlY3JldC5qbWVzUGF0aDtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5leHBvcnQgY2xhc3MgU2VjcmV0UHJvdmlkZXJDbGFzcyB7XG5cbiAgICBwcml2YXRlIHBhcmFtZXRlck9iamVjdHM6IFBhcmFtZXRlck9iamVjdFtdO1xuICAgIHByaXZhdGUga3ViZXJuZXRlc1NlY3JldHM6IEt1YmVybmV0ZXNTZWNyZXRbXTtcbiAgICBwcml2YXRlIGNzaVNlY3JldHM6IENzaVNlY3JldFByb3BzW107XG4gICAgcHJpdmF0ZSBzZWNyZXRQcm92aWRlckNsYXNzUHJvbWlzZTogUHJvbWlzZTxDb25zdHJ1Y3Q+O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIHByaXZhdGUgc2VydmljZUFjY291bnQ6IFNlcnZpY2VBY2NvdW50LCBwcml2YXRlIHNlY3JldFByb3ZpZGVyQ2xhc3NOYW1lOiBzdHJpbmcsIC4uLmNzaVNlY3JldHM6IENzaVNlY3JldFByb3BzW10pIHtcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJPYmplY3RzID0gW107XG4gICAgICAgIHRoaXMua3ViZXJuZXRlc1NlY3JldHMgPSBbXTtcbiAgICAgICAgdGhpcy5jc2lTZWNyZXRzID0gY3NpU2VjcmV0cztcbiAgICAgICAgdGhpcy5zZWNyZXRQcm92aWRlckNsYXNzUHJvbWlzZSA9IHRoaXMuc2V0dXBTZWNyZXRzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZERlcGVuZGVudCguLi5jb25zdHJ1Y3RzOiBDb25zdHJ1Y3RbXSkge1xuICAgICAgICB0aGlzLnNlY3JldFByb3ZpZGVyQ2xhc3NQcm9taXNlLnRoZW4oc2VjcmV0UHJvdmlkZXJDbGFzcyA9PiB7XG4gICAgICAgICAgICBjb25zdHJ1Y3RzLmZvckVhY2goZGVwZW5kZW50ID0+IGRlcGVuZGVudC5ub2RlLmFkZERlcGVuZGVuY3koc2VjcmV0UHJvdmlkZXJDbGFzcykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbGx5IHJldHVybnMgdm9sdW1lIG1vdW50cyBmb3IgYSBwb2Qgb3IgaGVsbSBjaGFydCB0aGF0IHN1cHBvcnRzIHZvbHVtZSBtb3VudHMuXG4gICAgICovXG4gICAgcHVibGljIGdldFZvbHVtZU1vdW50cyh2b2x1bWVOYW1lOiBzdHJpbmcsIG1vdW50UGF0aD86IHN0cmluZyk6IFZhbHVlcyB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBcInZvbHVtZXNcIjogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdm9sdW1lTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgY3NpOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkcml2ZXI6IFwic2VjcmV0cy1zdG9yZS5jc2kuazhzLmlvXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWFkT25seTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXRQcm92aWRlckNsYXNzOiB0aGlzLnNlY3JldFByb3ZpZGVyQ2xhc3NOYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgXCJ2b2x1bWVNb3VudHNcIjogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdm9sdW1lTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgbW91bnRQYXRoOiBtb3VudFBhdGggPz8gXCIvbW50L3NlY3JldC1zdG9yZVwiXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldHVwIENTSSBzZWNyZXRzXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvIFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBzZXR1cFNlY3JldHMoKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgY29uc3Qgc2VjcmV0c0RyaXZlclByb21pc2UgPSB0aGlzLmNsdXN0ZXJJbmZvLmdldFNjaGVkdWxlZEFkZE9uKFNlY3JldHNTdG9yZUFkZE9uLm5hbWUpO1xuICAgICAgICBhc3NlcnQoc2VjcmV0c0RyaXZlclByb21pc2UgIT0gbnVsbCwgJ1NlY3JldHNTdG9yZUFkZE9uIGlzIHJlcXVpcmVkIHRvIHNldHVwIHNlY3JldHMgYnV0IGlzIG5vdCBwcm92aWRlZCBpbiB0aGUgYWRkLW9ucy4nKTtcblxuICAgICAgICB0aGlzLmFkZFBvbGljeVRvU2VydmljZUFjY291bnQoKTtcblxuICAgICAgICAvLyBDcmVhdGUgYW5kIGFwcGx5IFNlY3JldFByb3ZpZGVyQ2xhc3MgbWFuaWZlc3RcbiAgICAgICAgcmV0dXJuIHNlY3JldHNEcml2ZXJQcm9taXNlIS50aGVuKHNlY3JldHNEcml2ZXIgPT5cbiAgICAgICAgICAgIHRoaXMuY3JlYXRlU2VjcmV0UHJvdmlkZXJDbGFzcyhzZWNyZXRzRHJpdmVyISlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIFNlcnZpY2UgQWNjb3VudCBmb3IgQ1NJIFNlY3JldHMgZHJpdmVyIGFuZCBzZXRzIHVwIHRoZSBJQU0gUG9saWNpZXNcbiAgICAgKiBuZWVkZWQgdG8gYWNjZXNzIHRoZSBBV1MgU2VjcmV0c1xuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mb1xuICAgICAqIEBwYXJhbSBzZXJ2aWNlQWNjb3VudFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBhZGRQb2xpY3lUb1NlcnZpY2VBY2NvdW50KCkge1xuICAgICAgICB0aGlzLmNzaVNlY3JldHMuZm9yRWFjaCgoY3NpU2VjcmV0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBkYXRhOiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YVtdID0gW107XG4gICAgICAgICAgICBsZXQga3ViZXJuZXRlc1NlY3JldDogS3ViZXJuZXRlc1NlY3JldDtcbiAgICAgICAgICAgIGxldCBzZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgICAgICAgICBjb25zdCBzZWNyZXQ6IElTZWNyZXQgfCBJU3RyaW5nUGFyYW1ldGVyID0gY3NpU2VjcmV0LnNlY3JldFByb3ZpZGVyLnByb3ZpZGUodGhpcy5jbHVzdGVySW5mbyk7XG5cbiAgICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChzZWNyZXQsICdzZWNyZXRBcm4nKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlY3JldE1hbmFnZXJTZWNyZXQgPSBzZWNyZXQgYXMgSVNlY3JldDtcbiAgICAgICAgICAgICAgICBzZWNyZXROYW1lID0gc2VjcmV0TWFuYWdlclNlY3JldC5zZWNyZXROYW1lO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtZXRlck9iamVjdCA9IGNyZWF0ZVBhcmFtZXRlck9iamVjdChjc2lTZWNyZXQsIHNlY3JldE5hbWUsIEF3c1NlY3JldFR5cGUuU0VDUkVUU01BTkFHRVIpO1xuICAgICAgICAgICAgICAgIHRoaXMucGFyYW1ldGVyT2JqZWN0cy5wdXNoKHBhcmFtZXRlck9iamVjdCk7XG4gICAgICAgICAgICAgICAgc2VjcmV0TWFuYWdlclNlY3JldC5ncmFudFJlYWQodGhpcy5zZXJ2aWNlQWNjb3VudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzc21TZWNyZXQgPSBzZWNyZXQgYXMgSVN0cmluZ1BhcmFtZXRlcjtcbiAgICAgICAgICAgICAgICBzZWNyZXROYW1lID0gc3NtU2VjcmV0LnBhcmFtZXRlck5hbWU7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyYW1ldGVyT2JqZWN0ID0gY3JlYXRlUGFyYW1ldGVyT2JqZWN0KGNzaVNlY3JldCwgc2VjcmV0TmFtZSwgQXdzU2VjcmV0VHlwZS5TU01QQVJBTUVURVIpO1xuICAgICAgICAgICAgICAgIHRoaXMucGFyYW1ldGVyT2JqZWN0cy5wdXNoKHBhcmFtZXRlck9iamVjdCk7XG4gICAgICAgICAgICAgICAgc3NtU2VjcmV0LmdyYW50UmVhZCh0aGlzLnNlcnZpY2VBY2NvdW50KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0LmRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQuZGF0YS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhT2JqZWN0OiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3ROYW1lOiBpdGVtLm9iamVjdE5hbWUgPz8gc2VjcmV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk6IGl0ZW0ua2V5ID8/IHNlY3JldE5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goZGF0YU9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YU9iamVjdDogS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3ROYW1lOiBzZWNyZXROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBzZWNyZXROYW1lXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChkYXRhT2JqZWN0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAga3ViZXJuZXRlc1NlY3JldCA9IHtcbiAgICAgICAgICAgICAgICAgICAgc2VjcmV0TmFtZTogY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQuc2VjcmV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQudHlwZSA/PyBLdWJlcm5ldGVzU2VjcmV0VHlwZS5PUEFRVUUsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsczogY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQubGFiZWxzID8/IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHRoaXMua3ViZXJuZXRlc1NlY3JldHMucHVzaChrdWJlcm5ldGVzU2VjcmV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuZCBhcHBseSB0aGUgU2VjcmV0UHJvdmlkZXJDbGFzcyBtYW5pZmVzdFxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mb1xuICAgICAqIEBwYXJhbSBzZXJ2aWNlQWNjb3VudFxuICAgICAqIEBwYXJhbSBjc2lEcml2ZXJcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlU2VjcmV0UHJvdmlkZXJDbGFzcyhjc2lEcml2ZXI6IENvbnN0cnVjdCk6IENvbnN0cnVjdCB7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSB0aGlzLmNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGNvbnN0IHNlY3JldFByb3ZpZGVyQ2xhc3MgPSB0aGlzLnNlY3JldFByb3ZpZGVyQ2xhc3NOYW1lO1xuICAgICAgICBjb25zdCBzZWNyZXRQcm92aWRlckNsYXNzTWFuaWZlc3QgPSBjbHVzdGVyLmFkZE1hbmlmZXN0KHNlY3JldFByb3ZpZGVyQ2xhc3MsIHtcbiAgICAgICAgICAgIGFwaVZlcnNpb246ICdzZWNyZXRzLXN0b3JlLmNzaS54LWs4cy5pby92MWFscGhhMScsXG4gICAgICAgICAgICBraW5kOiAnU2VjcmV0UHJvdmlkZXJDbGFzcycsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICAgIG5hbWU6IHNlY3JldFByb3ZpZGVyQ2xhc3MsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlOiB0aGlzLnNlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZXNwYWNlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICAgIHByb3ZpZGVyOiAnYXdzJyxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgIG9iamVjdHM6IEpTT04uc3RyaW5naWZ5KHRoaXMucGFyYW1ldGVyT2JqZWN0cyksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZWNyZXRPYmplY3RzOiB0aGlzLmt1YmVybmV0ZXNTZWNyZXRzXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNlY3JldFByb3ZpZGVyQ2xhc3NNYW5pZmVzdC5ub2RlLmFkZERlcGVuZGVuY3koXG4gICAgICAgICAgICB0aGlzLnNlcnZpY2VBY2NvdW50LFxuICAgICAgICAgICAgY3NpRHJpdmVyXG4gICAgICAgICk7XG5cbiAgICAgICAgbmV3IENmbk91dHB1dChjbHVzdGVyLnN0YWNrLCBgJHt0aGlzLnNlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZX0tc2VjcmV0LXByb3ZpZGVyLWNsYXNzIGAsIHtcbiAgICAgICAgICAgIHZhbHVlOiBzZWNyZXRQcm92aWRlckNsYXNzXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBzZWNyZXRQcm92aWRlckNsYXNzTWFuaWZlc3Q7XG4gICAgfVxufVxuIl19