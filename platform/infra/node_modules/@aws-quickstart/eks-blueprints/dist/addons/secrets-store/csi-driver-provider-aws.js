"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CsiDriverProviderAws = void 0;
const cdk = require("aws-cdk-lib");
const yaml_utils_1 = require("../../utils/yaml-utils");
const ts_deepmerge_1 = require("ts-deepmerge");
const helm_addon_1 = require("../helm-addon");
class CsiDriverProviderAws {
    constructor(props) {
        this.props = props;
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let values = {
            grpcSupportedProviders: 'aws'
        };
        if (typeof (this.props.rotationPollInterval) === 'string') {
            values.enableSecretRotation = 'true';
            values.rotationPollInterval = this.props.rotationPollInterval;
        }
        if (this.props.syncSecrets === true) {
            values.syncSecret = {
                enabled: 'true'
            };
        }
        values = (0, ts_deepmerge_1.default)(values, (_a = this.props.values) !== null && _a !== void 0 ? _a : {});
        const helmChartOptions = {
            chart: this.props.chart,
            repository: this.props.repository,
            namespace: this.props.namespace,
            release: this.props.release,
            version: this.props.version,
            wait: true,
            timeout: cdk.Duration.minutes(15),
            values,
        };
        helm_addon_1.HelmAddOn.validateVersion({
            chart: helmChartOptions.chart,
            repository: helmChartOptions.repository,
            version: helmChartOptions.version
        });
        const secretStoreCSIDriverHelmChart = cluster.addHelmChart('SecretsStoreCSIDriver', helmChartOptions);
        const manifestUrl = this.props.ascpUrl;
        const manifest = (0, yaml_utils_1.loadExternalYaml)(manifestUrl);
        const secretProviderManifest = clusterInfo.cluster.addManifest('SecretsStoreCsiDriverProviderAws', ...manifest);
        secretProviderManifest.node.addDependency(secretStoreCSIDriverHelmChart);
        return secretProviderManifest;
    }
}
exports.CsiDriverProviderAws = CsiDriverProviderAws;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NpLWRyaXZlci1wcm92aWRlci1hd3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL3NlY3JldHMtc3RvcmUvY3NpLWRyaXZlci1wcm92aWRlci1hd3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBRW5DLHVEQUEwRDtBQUcxRCwrQ0FBaUM7QUFDakMsOENBQTBDO0FBRzFDLE1BQWEsb0JBQW9CO0lBRS9CLFlBQW9CLEtBQTZCO1FBQTdCLFVBQUssR0FBTCxLQUFLLENBQXdCO0lBQUcsQ0FBQztJQUVyRCxNQUFNLENBQUMsV0FBd0I7O1FBQzdCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFFcEMsSUFBSSxNQUFNLEdBQVc7WUFDbkIsc0JBQXNCLEVBQUUsS0FBSztTQUM5QixDQUFDO1FBRUYsSUFBSSxPQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUN4RCxNQUFNLENBQUMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDO1lBQ3JDLE1BQU0sQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDO1NBQy9EO1FBRUQsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsS0FBSyxJQUFJLEVBQUU7WUFDbkMsTUFBTSxDQUFDLFVBQVUsR0FBRztnQkFDbEIsT0FBTyxFQUFFLE1BQU07YUFDaEIsQ0FBQztTQUNIO1FBRUQsTUFBTSxHQUFHLElBQUEsc0JBQUssRUFBQyxNQUFNLEVBQUUsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDLENBQUM7UUFFaEQsTUFBTSxnQkFBZ0IsR0FBRztZQUNyQixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFNO1lBQ3hCLFVBQVUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVc7WUFDbEMsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBVTtZQUNoQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPO1lBQzNCLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU87WUFDM0IsSUFBSSxFQUFFLElBQUk7WUFDVixPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2pDLE1BQU07U0FDUCxDQUFDO1FBRUosc0JBQVMsQ0FBQyxlQUFlLENBQUM7WUFDdEIsS0FBSyxFQUFFLGdCQUFnQixDQUFDLEtBQUs7WUFDN0IsVUFBVSxFQUFFLGdCQUFnQixDQUFDLFVBQVU7WUFDdkMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLE9BQVE7U0FDckMsQ0FBQyxDQUFDO1FBRUgsTUFBTSw2QkFBNkIsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLHVCQUF1QixFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFFdEcsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFRLENBQUM7UUFDeEMsTUFBTSxRQUFRLEdBQTBCLElBQUEsNkJBQWdCLEVBQUMsV0FBVyxDQUFDLENBQUM7UUFDdEUsTUFBTSxzQkFBc0IsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFHLFFBQVEsQ0FBQyxDQUFDO1FBQ2hILHNCQUFzQixDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUN6RSxPQUFPLHNCQUFzQixDQUFDO0lBQ2hDLENBQUM7Q0FDRjtBQWpERCxvREFpREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgbG9hZEV4dGVybmFsWWFtbCB9IGZyb20gXCIuLi8uLi91dGlscy95YW1sLXV0aWxzXCI7XG5pbXBvcnQgeyBLdWJlcm5ldGVzTWFuaWZlc3QgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHsgU2VjcmV0c1N0b3JlQWRkT25Qcm9wcyB9IGZyb20gXCIuXCI7XG5pbXBvcnQgbWVyZ2UgZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xuaW1wb3J0IHsgSGVsbUFkZE9uIH0gZnJvbSBcIi4uL2hlbG0tYWRkb25cIjtcblxuXG5leHBvcnQgY2xhc3MgQ3NpRHJpdmVyUHJvdmlkZXJBd3Mge1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcHJvcHM6IFNlY3JldHNTdG9yZUFkZE9uUHJvcHMpIHt9XG5cbiAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IEt1YmVybmV0ZXNNYW5pZmVzdCB7XG4gICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG5cbiAgICBsZXQgdmFsdWVzOiBWYWx1ZXMgPSB7XG4gICAgICBncnBjU3VwcG9ydGVkUHJvdmlkZXJzOiAnYXdzJ1xuICAgIH07XG5cbiAgICBpZiAodHlwZW9mKHRoaXMucHJvcHMucm90YXRpb25Qb2xsSW50ZXJ2YWwpID09PSAnc3RyaW5nJykge1xuICAgICAgdmFsdWVzLmVuYWJsZVNlY3JldFJvdGF0aW9uID0gJ3RydWUnO1xuICAgICAgdmFsdWVzLnJvdGF0aW9uUG9sbEludGVydmFsID0gdGhpcy5wcm9wcy5yb3RhdGlvblBvbGxJbnRlcnZhbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm9wcy5zeW5jU2VjcmV0cyA9PT0gdHJ1ZSkge1xuICAgICAgdmFsdWVzLnN5bmNTZWNyZXQgPSB7XG4gICAgICAgIGVuYWJsZWQ6ICd0cnVlJ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHRoaXMucHJvcHMudmFsdWVzID8/IHt9KTtcbiAgICBcbiAgICBjb25zdCBoZWxtQ2hhcnRPcHRpb25zID0ge1xuICAgICAgICBjaGFydDogdGhpcy5wcm9wcy5jaGFydCEsXG4gICAgICAgIHJlcG9zaXRvcnk6IHRoaXMucHJvcHMucmVwb3NpdG9yeSEsXG4gICAgICAgIG5hbWVzcGFjZTogdGhpcy5wcm9wcy5uYW1lc3BhY2UhLFxuICAgICAgICByZWxlYXNlOiB0aGlzLnByb3BzLnJlbGVhc2UsXG4gICAgICAgIHZlcnNpb246IHRoaXMucHJvcHMudmVyc2lvbixcbiAgICAgICAgd2FpdDogdHJ1ZSxcbiAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgICB2YWx1ZXMsXG4gICAgICB9O1xuXG4gICAgSGVsbUFkZE9uLnZhbGlkYXRlVmVyc2lvbih7XG4gICAgICAgIGNoYXJ0OiBoZWxtQ2hhcnRPcHRpb25zLmNoYXJ0LFxuICAgICAgICByZXBvc2l0b3J5OiBoZWxtQ2hhcnRPcHRpb25zLnJlcG9zaXRvcnksXG4gICAgICAgIHZlcnNpb246IGhlbG1DaGFydE9wdGlvbnMudmVyc2lvbiFcbiAgICB9KTtcblxuICAgIGNvbnN0IHNlY3JldFN0b3JlQ1NJRHJpdmVySGVsbUNoYXJ0ID0gY2x1c3Rlci5hZGRIZWxtQ2hhcnQoJ1NlY3JldHNTdG9yZUNTSURyaXZlcicsIGhlbG1DaGFydE9wdGlvbnMpO1xuXG4gICAgY29uc3QgbWFuaWZlc3RVcmwgPSB0aGlzLnByb3BzLmFzY3BVcmwhO1xuICAgIGNvbnN0IG1hbmlmZXN0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+W10gPSBsb2FkRXh0ZXJuYWxZYW1sKG1hbmlmZXN0VXJsKTtcbiAgICBjb25zdCBzZWNyZXRQcm92aWRlck1hbmlmZXN0ID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRNYW5pZmVzdCgnU2VjcmV0c1N0b3JlQ3NpRHJpdmVyUHJvdmlkZXJBd3MnLCAuLi5tYW5pZmVzdCk7XG4gICAgc2VjcmV0UHJvdmlkZXJNYW5pZmVzdC5ub2RlLmFkZERlcGVuZGVuY3koc2VjcmV0U3RvcmVDU0lEcml2ZXJIZWxtQ2hhcnQpO1xuICAgIHJldHVybiBzZWNyZXRQcm92aWRlck1hbmlmZXN0O1xuICB9XG59Il19