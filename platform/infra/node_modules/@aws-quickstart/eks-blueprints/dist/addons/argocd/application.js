"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ArgoApplication = void 0;
const dot = require("dot-object");
const utils_1 = require("../../utils");
/**
 * Argo Application is a utility class that can generate an ArgoCD application
 * from generic GitOps application properties.
 */
class ArgoApplication {
    constructor(bootstrapRepo) {
        this.bootstrapRepo = bootstrapRepo;
    }
    generate(deployment, syncOrder) {
        var _a, _b;
        const normalizedValues = this.normalizeValues(deployment.values);
        const flatValues = dot.dot(normalizedValues);
        const nameValues = [];
        for (let key in flatValues) {
            // Avoid passing the undefined values
            if (flatValues[key] !== undefined) {
                // Avoid passing the empty objects, e.g. {}
                if (Object.getPrototypeOf(flatValues[key]) !== Object.prototype) {
                    nameValues.push({ name: key, value: `${flatValues[key]}` });
                }
                else if (Object.getPrototypeOf(flatValues[key]) === Object.prototype && Object.keys(flatValues[key]).length != 0) {
                    nameValues.push({ name: key, value: `${flatValues[key]}` });
                }
            }
        }
        const repository = (_a = deployment.repository) !== null && _a !== void 0 ? _a : this.generateDefaultRepo(deployment.name);
        return {
            apiVersion: "argoproj.io/v1alpha1",
            kind: "Application",
            metadata: {
                name: deployment.name,
                namespace: 'argocd',
                annotations: {
                    "argocd.argoproj.io/sync-wave": syncOrder == undefined ? "-1" : `${syncOrder}`
                }
            },
            spec: {
                destination: {
                    namespace: deployment.namespace,
                    server: "https://kubernetes.default.svc"
                },
                project: "default",
                source: {
                    helm: {
                        valueFiles: ["values.yaml"],
                        parameters: nameValues,
                    },
                    path: repository.path,
                    repoURL: repository.repoUrl,
                    targetRevision: (_b = repository.targetRevision) !== null && _b !== void 0 ? _b : 'HEAD'
                },
                syncPolicy: {
                    automated: {
                        prune: true,
                        selfHeal: true,
                        allowEmpty: true,
                    }
                }
            }
        };
    }
    /**
     * Creates an opinionated path.
     * @param name
     * @returns
     */
    generateDefaultRepo(name) {
        if (this.bootstrapRepo) {
            return {
                name: this.bootstrapRepo.name,
                repoUrl: this.bootstrapRepo.repoUrl,
                path: this.bootstrapRepo.path + `/${name}`,
                targetRevision: this.bootstrapRepo.targetRevision
            };
        }
        throw new Error("With GitOps configuration management enabled either specify GitOps repository for each add-on or provide a bootstrap application to the ArgoCD add-on.");
    }
    /**
     * Iterate an argo Values object to normalize the string format before sending to argocd.
     * For example, escaping the dot from certain keys: "ingress.annotations.kubernetes\\.io/tls-acme"
     * @param values
     * @returns
     */
    normalizeValues(obj) {
        Object.keys(obj).forEach(key => {
            if (typeof obj[key] === 'object' && obj[key] !== null) {
                obj[key] = this.normalizeValues(obj[key]);
            }
            const escapedKey = (0, utils_1.escapeDots)(key);
            if (escapedKey != key) {
                obj[escapedKey] = obj[key];
                delete obj[key];
            }
        });
        return obj;
    }
}
exports.ArgoApplication = ArgoApplication;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FyZ29jZC9hcHBsaWNhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrQ0FBa0M7QUFFbEMsdUNBQXlDO0FBRXpDOzs7R0FHRztBQUNILE1BQWEsZUFBZTtJQUV4QixZQUE2QixhQUFpRDtRQUFqRCxrQkFBYSxHQUFiLGFBQWEsQ0FBb0M7SUFBSSxDQUFDO0lBRTVFLFFBQVEsQ0FBQyxVQUF1QyxFQUFFLFNBQWtCOztRQUV2RSxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWpFLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUU3QyxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFFdEIsS0FBSyxJQUFJLEdBQUcsSUFBSSxVQUFVLEVBQUU7WUFDeEIscUNBQXFDO1lBQ3JDLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDL0IsMkNBQTJDO2dCQUMzQyxJQUFJLE1BQU0sQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLFNBQVMsRUFBRTtvQkFDN0QsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2lCQUMvRDtxQkFBTSxJQUFJLE1BQU0sQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7b0JBQ2hILFVB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ZG90LW9iamVjdCc7XG5pbXBvcnQgeyBHaXRPcHNBcHBsaWNhdGlvbkRlcGxveW1lbnQsIEdpdFJlcG9zaXRvcnlSZWZlcmVuY2UsIFZhbHVlcyB9IGZyb20gJy4uLy4uL3NwaSc7XG5pbXBvcnQgeyBlc2NhcGVEb3RzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuXG4vKipcbiAqIEFyZ28gQXBwbGljYXRpb24gaXMgYSB1dGlsaXR5IGNsYXNzIHRoYXQgY2FuIGdlbmVyYXRlIGFuIEFyZ29DRCBhcHBsaWNhdGlvblxuICogZnJvbSBnZW5lcmljIEdpdE9wcyBhcHBsaWNhdGlvbiBwcm9wZXJ0aWVzLlxuICovXG5leHBvcnQgY2xhc3MgQXJnb0FwcGxpY2F0aW9uIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYm9vdHN0cmFwUmVwbzogR2l0UmVwb3NpdG9yeVJlZmVyZW5jZSB8IHVuZGVmaW5lZCkgeyB9XG5cbiAgICBwdWJsaWMgZ2VuZXJhdGUoZGVwbG95bWVudDogR2l0T3BzQXBwbGljYXRpb25EZXBsb3ltZW50LCBzeW5jT3JkZXI/OiBudW1iZXIpIHtcblxuICAgICAgICBjb25zdCBub3JtYWxpemVkVmFsdWVzID0gdGhpcy5ub3JtYWxpemVWYWx1ZXMoZGVwbG95bWVudC52YWx1ZXMpO1xuXG4gICAgICAgIGNvbnN0IGZsYXRWYWx1ZXMgPSBkb3QuZG90KG5vcm1hbGl6ZWRWYWx1ZXMpO1xuXG4gICAgICAgIGNvbnN0IG5hbWVWYWx1ZXMgPSBbXTtcblxuICAgICAgICBmb3IgKGxldCBrZXkgaW4gZmxhdFZhbHVlcykge1xuICAgICAgICAgICAgLy8gQXZvaWQgcGFzc2luZyB0aGUgdW5kZWZpbmVkIHZhbHVlc1xuICAgICAgICAgICAgaWYgKGZsYXRWYWx1ZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgLy8gQXZvaWQgcGFzc2luZyB0aGUgZW1wdHkgb2JqZWN0cywgZS5nLiB7fVxuICAgICAgICAgICAgICAgIGlmIChPYmplY3QuZ2V0UHJvdG90eXBlT2YoZmxhdFZhbHVlc1trZXldKSAhPT0gT2JqZWN0LnByb3RvdHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBuYW1lVmFsdWVzLnB1c2goeyBuYW1lOiBrZXksIHZhbHVlOiBgJHtmbGF0VmFsdWVzW2tleV19YCB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKE9iamVjdC5nZXRQcm90b3R5cGVPZihmbGF0VmFsdWVzW2tleV0pID09PSBPYmplY3QucHJvdG90eXBlICYmIE9iamVjdC5rZXlzKGZsYXRWYWx1ZXNba2V5XSkubGVuZ3RoICE9IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZVZhbHVlcy5wdXNoKHsgbmFtZToga2V5LCB2YWx1ZTogYCR7ZmxhdFZhbHVlc1trZXldfWAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlcG9zaXRvcnkgPSBkZXBsb3ltZW50LnJlcG9zaXRvcnkgPz8gdGhpcy5nZW5lcmF0ZURlZmF1bHRSZXBvKGRlcGxveW1lbnQubmFtZSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhcGlWZXJzaW9uOiBcImFyZ29wcm9qLmlvL3YxYWxwaGExXCIsXG4gICAgICAgICAgICBraW5kOiBcIkFwcGxpY2F0aW9uXCIsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICAgIG5hbWU6IGRlcGxveW1lbnQubmFtZSxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2U6ICdhcmdvY2QnLFxuICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIFwiYXJnb2NkLmFyZ29wcm9qLmlvL3N5bmMtd2F2ZVwiOiBzeW5jT3JkZXIgPT0gdW5kZWZpbmVkID8gXCItMVwiIDogYCR7c3luY09yZGVyfWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogZGVwbG95bWVudC5uYW1lc3BhY2UsXG4gICAgICAgICAgICAgICAgICAgIHNlcnZlcjogXCJodHRwczovL2t1YmVybmV0ZXMuZGVmYXVsdC5zdmNcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcHJvamVjdDogXCJkZWZhdWx0XCIsIC8vVE9ETzogbWFrZSBwcm9qZWN0IGNvbmZpZ3VyYWJsZVxuICAgICAgICAgICAgICAgIHNvdXJjZToge1xuICAgICAgICAgICAgICAgICAgICBoZWxtOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUZpbGVzOiBbXCJ2YWx1ZXMueWFtbFwiXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IG5hbWVWYWx1ZXMsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6IHJlcG9zaXRvcnkucGF0aCxcbiAgICAgICAgICAgICAgICAgICAgcmVwb1VSTDogcmVwb3NpdG9yeS5yZXBvVXJsLFxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRSZXZpc2lvbjogcmVwb3NpdG9yeS50YXJnZXRSZXZpc2lvbiA/PyAnSEVBRCdcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHN5bmNQb2xpY3k6IHtcbiAgICAgICAgICAgICAgICAgICAgYXV0b21hdGVkOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcnVuZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGZIZWFsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dFbXB0eTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGFuIG9waW5pb25hdGVkIHBhdGguXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIGdlbmVyYXRlRGVmYXVsdFJlcG8obmFtZTogc3RyaW5nKTogR2l0UmVwb3NpdG9yeVJlZmVyZW5jZSB7XG4gICAgICAgIGlmICh0aGlzLmJvb3RzdHJhcFJlcG8pIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5ib290c3RyYXBSZXBvLm5hbWUsXG4gICAgICAgICAgICAgICAgcmVwb1VybDogdGhpcy5ib290c3RyYXBSZXBvLnJlcG9VcmwsXG4gICAgICAgICAgICAgICAgcGF0aDogdGhpcy5ib290c3RyYXBSZXBvLnBhdGggKyBgLyR7bmFtZX1gLFxuICAgICAgICAgICAgICAgIHRhcmdldFJldmlzaW9uOiB0aGlzLmJvb3RzdHJhcFJlcG8udGFyZ2V0UmV2aXNpb25cbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV2l0aCBHaXRPcHMgY29uZmlndXJhdGlvbiBtYW5hZ2VtZW50IGVuYWJsZWQgZWl0aGVyIHNwZWNpZnkgR2l0T3BzIHJlcG9zaXRvcnkgZm9yIGVhY2ggYWRkLW9uIG9yIHByb3ZpZGUgYSBib290c3RyYXAgYXBwbGljYXRpb24gdG8gdGhlIEFyZ29DRCBhZGQtb24uXCIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEl0ZXJhdGUgYW4gYXJnbyBWYWx1ZXMgb2JqZWN0IHRvIG5vcm1hbGl6ZSB0aGUgc3RyaW5nIGZvcm1hdCBiZWZvcmUgc2VuZGluZyB0byBhcmdvY2QuXG4gICAgICogRm9yIGV4YW1wbGUsIGVzY2FwaW5nIHRoZSBkb3QgZnJvbSBjZXJ0YWluIGtleXM6IFwiaW5ncmVzcy5hbm5vdGF0aW9ucy5rdWJlcm5ldGVzXFxcXC5pby90bHMtYWNtZVwiXG4gICAgICogQHBhcmFtIHZhbHVlc1xuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgbm9ybWFsaXplVmFsdWVzKG9iajogVmFsdWVzKTogVmFsdWVzIHtcbiAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9ialtrZXldID09PSAnb2JqZWN0JyAmJiBvYmpba2V5XSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIG9ialtrZXldID0gdGhpcy5ub3JtYWxpemVWYWx1ZXMob2JqW2tleV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBlc2NhcGVkS2V5ID0gZXNjYXBlRG90cyhrZXkpO1xuICAgICAgICAgICAgaWYgKGVzY2FwZWRLZXkgIT0ga2V5KSB7XG4gICAgICAgICAgICAgICAgb2JqW2VzY2FwZWRLZXldID0gb2JqW2tleV07XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9ialtrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gb2JqO1xuICAgIH1cbn1cbiJdfQ==