"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CoreAddOn = exports.CoreAddOnProps = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const utils_1 = require("../../utils");
class CoreAddOnProps {
}
exports.CoreAddOnProps = CoreAddOnProps;
const DEFAULT_NAMESPACE = "kube-system";
/**
 * Implementation of EKS Managed add-ons.
 */
class CoreAddOn {
    constructor(coreAddOnProps) {
        this.coreAddOnProps = coreAddOnProps;
        utils_1.userLog.debug(`Core add-on ${coreAddOnProps.addOnName} is at version ${coreAddOnProps.version}`);
    }
    deploy(clusterInfo) {
        var _a;
        let serviceAccountRoleArn = undefined;
        let serviceAccount = undefined;
        let saNamespace = undefined;
        saNamespace = DEFAULT_NAMESPACE;
        if ((_a = this.coreAddOnProps) === null || _a === void 0 ? void 0 : _a.namespace) {
            saNamespace = this.coreAddOnProps.namespace;
        }
        // Create a service account if user provides namespace, PolicyDocument
        const policies = this.provideManagedPolicies(clusterInfo);
        if (policies) {
            serviceAccount = this.createServiceAccount(clusterInfo, saNamespace, policies);
            serviceAccountRoleArn = serviceAccount.role.roleArn;
        }
        let version = this.coreAddOnProps.version;
        if (this.coreAddOnProps.versionMap) {
            version = this.coreAddOnProps.version != "auto" ? this.coreAddOnProps.version : this.provideVersion(clusterInfo, this.coreAddOnProps.versionMap);
        }
        let addOnProps = {
            addonName: this.coreAddOnProps.addOnName,
            addonVersion: version,
            configurationValues: JSON.stringify(this.coreAddOnProps.configurationValues),
            clusterName: clusterInfo.cluster.clusterName,
            serviceAccountRoleArn: serviceAccountRoleArn,
            resolveConflicts: "OVERWRITE"
        };
        const cfnAddon = new aws_eks_1.CfnAddon(clusterInfo.cluster.stack, this.coreAddOnProps.addOnName + "-addOn", addOnProps);
        if (serviceAccount) {
            cfnAddon.node.addDependency(serviceAccount);
        }
        if (this.coreAddOnProps.controlPlaneAddOn) {
            (0, utils_1.deployBeforeCapacity)(cfnAddon, clusterInfo);
        }
        // Instantiate the Add-on
        return Promise.resolve(cfnAddon);
    }
    createServiceAccount(clusterInfo, saNamespace, policies) {
        return (0, utils_1.createServiceAccountWithPolicy)(clusterInfo.cluster, this.coreAddOnProps.saName, saNamespace, ...policies);
    }
    /**
     * Template method with default implementation to execute the supplied function of policyDocumentProvider.
     * Allows overriding this method in subclasses for more complex cases of policies.
     * @param clusterInfo
     * @returns
     */
    providePolicyDocument(clusterInfo) {
        var _a;
        if ((_a = this.coreAddOnProps) === null || _a === void 0 ? void 0 : _a.policyDocumentProvider) {
            return this.coreAddOnProps.policyDocumentProvider(clusterInfo.cluster.stack.partition);
        }
        return undefined;
    }
    /**
     * Template method to return managed policies for the service account.
     * Allows overriding in subclasses to handle more complex cases of policies.
     */
    provideManagedPolicies(clusterInfo) {
        let result;
        const policyDocument = this.providePolicyDocument(clusterInfo);
        if (policyDocument) {
            const policy = new aws_iam_1.ManagedPolicy(clusterInfo.cluster, `${this.coreAddOnProps.addOnName}-managed-policy`, {
                document: policyDocument
            });
            result = [policy];
        }
        return result;
    }
    provideVersion(clusterInfo, versionMap) {
        var _a;
        let version = (_a = versionMap.get(clusterInfo.version)) !== null && _a !== void 0 ? _a : versionMap.values().next().value;
        utils_1.userLog.debug(`Core add-on ${this.coreAddOnProps.addOnName} has autoselected version ${version}`);
        return version;
    }
}
exports.CoreAddOn = CoreAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2NvcmUtYWRkb24vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaURBQStEO0FBSS9ELGlEQUFvRjtBQUVwRix1Q0FBOEY7QUFFOUYsTUFBYSxjQUFjO0NBcUMxQjtBQXJDRCx3Q0FxQ0M7QUFFRCxNQUFNLGlCQUFpQixHQUFHLGFBQWEsQ0FBQztBQUV4Qzs7R0FFRztBQUNILE1BQWEsU0FBUztJQUlsQixZQUFZLGNBQThCO1FBQ3RDLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLGVBQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxjQUFjLENBQUMsU0FBUyxrQkFBa0IsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDckcsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUF3Qjs7UUFFM0IsSUFBSSxxQkFBcUIsR0FBdUIsU0FBUyxDQUFDO1FBQzFELElBQUksY0FBYyxHQUErQixTQUFTLENBQUM7UUFDM0QsSUFBSSxXQUFXLEdBQXVCLFNBQVMsQ0FBQztRQUVoRCxXQUFXLEdBQUcsaUJBQWlCLENBQUM7UUFDaEMsSUFBSSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFNBQVMsRUFBRTtZQUNoQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUM7U0FDL0M7UUFFRCxzRUFBc0U7UUFDdEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzFELElBQUksUUFBUSxFQUFFO1lBQ1YsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQy9FLHFCQUFxQixHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ3ZEO1FBQ0QsSUFBSSxPQUFPLEdBQVcsSUFBSSxDQUFD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QUUsQ0FBQyxDQUFDO1FBQ2xHLE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7Q0FFSjtBQTlGRCw4QkE4RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZm5BZGRvbiwgU2VydmljZUFjY291bnQgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHsgQ2x1c3RlckFkZE9uIH0gZnJvbSBcIi4uLy4uXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IElNYW5hZ2VkUG9saWN5LCBNYW5hZ2VkUG9saWN5LCBQb2xpY3lEb2N1bWVudCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgeyBLdWJlcm5ldGVzVmVyc2lvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgeyBjcmVhdGVTZXJ2aWNlQWNjb3VudFdpdGhQb2xpY3ksIGRlcGxveUJlZm9yZUNhcGFjaXR5LCB1c2VyTG9nLCAgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcblxuZXhwb3J0IGNsYXNzIENvcmVBZGRPblByb3BzIHtcbiAgICAvKipcbiAgICAgKiBOYW1lIG9mIHRoZSBhZGQtb24gdG8gaW5zdGFudGlhdGVcbiAgICAgKi9cbiAgICByZWFkb25seSBhZGRPbk5hbWU6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBWZXJzaW9uIG9mIHRoZSBhZGQtb24gdG8gdXNlLiBNdXN0IG1hdGNoIHRoZSB2ZXJzaW9uIG9mIHRoZSBjbHVzdGVyIHdoZXJlIGl0XG4gICAgICogd2lsbCBiZSBkZXBsb3llZCBpdFxuICAgICAqL1xuICAgIHJlYWRvbmx5IHZlcnNpb246IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBQb2xpY3kgZG9jdW1lbnQgcHJvdmlkZXIgcmV0dXJucyB0aGUgcG9saWN5IHJlcXVpcmVkIGJ5IHRoZSBhZGQtb24gdG8gYWxsb3cgaXQgdG8gaW50ZXJhY3Qgd2l0aCBBV1MgcmVzb3VyY2VzXG4gICAgICovXG4gICAgcmVhZG9ubHkgcG9saWN5RG9jdW1lbnRQcm92aWRlcj86IChwYXJ0aXRpb246IHN0cmluZykgPT4gUG9saWN5RG9jdW1lbnQ7XG4gICAgLyoqXG4gICAgICogU2VydmljZSBBY2NvdW50IE5hbWUgdG8gYmUgdXNlZCB3aXRoIEFkZE9uLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IHNhTmFtZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIE5hbWVzcGFjZSB0byBjcmVhdGUgdGhlIFNlcnZpY2VBY2NvdW50LlxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5hbWVzcGFjZT86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBDb25maWd1cmF0aW9uVmFsdWVzIGZpZWxkIHRvIHBhc3MgY3VzdG9tIGNvbmZpZ3VyYXRpb25zIHRvIEFkZG9uXG4gICAgICovXG4gICAgcmVhZG9ubHkgY29uZmlndXJhdGlvblZhbHVlcz86IFZhbHVlcztcblxuICAgIC8qKlxuICAgICAqIEluZGljYXRlcyB0aGF0IGFkZC1vbiBtdXN0IGJlIGluc3RhbGxlZCBiZWZvcmUgYW55IGNhcGFjaXR5IGlzIGFkZGVkIGZvciB3b3JrZXIgbm9kZXMgKGluY3VkaW5nIEZhcmdhdGUpLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGNvbnRyb2xQbGFuZUFkZE9uPzogYm9vbGVhbjtcblxuXG4gICAgLyoqIFxuICAgICAqIE1hcCBiZXR3ZWVuIGt1YmVybmV0ZXMgdmVyc2lvbnMgYW5kIGFkZE9uIHZlcnNpb25zIGZvciBhdXRvIHNlbGVjdGlvbi5cbiAgICAgKi9cbiAgICByZWFkb25seSB2ZXJzaW9uTWFwPzogTWFwPEt1YmVybmV0ZXNWZXJzaW9uLCBzdHJpbmc+O1xufVxuXG5jb25zdCBERUZBVUxUX05BTUVTUEFDRSA9IFwia3ViZS1zeXN0ZW1cIjtcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiBFS1MgTWFuYWdlZCBhZGQtb25zLlxuICovXG5leHBvcnQgY2xhc3MgQ29yZUFkZE9uIGltcGxlbWVudHMgQ2x1c3RlckFkZE9uIHtcblxuICAgIHJlYWRvbmx5IGNvcmVBZGRPblByb3BzOiBDb3JlQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKGNvcmVBZGRPblByb3BzOiBDb3JlQWRkT25Qcm9wcykge1xuICAgICAgICB0aGlzLmNvcmVBZGRPblByb3BzID0gY29yZUFkZE9uUHJvcHM7XG4gICAgICAgIHVzZXJMb2cuZGVidWcoYENvcmUgYWRkLW9uICR7Y29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfSBpcyBhdCB2ZXJzaW9uICR7Y29yZUFkZE9uUHJvcHMudmVyc2lvbn1gKTtcbiAgICB9XG5cbiAgICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgXG4gICAgICAgIGxldCBzZXJ2aWNlQWNjb3VudFJvbGVBcm46IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IHNlcnZpY2VBY2NvdW50OiBTZXJ2aWNlQWNjb3VudCB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IHNhTmFtZXNwYWNlOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgc2FOYW1lc3BhY2UgPSBERUZBVUxUX05BTUVTUEFDRTtcbiAgICAgICAgaWYgKHRoaXMuY29yZUFkZE9uUHJvcHM/Lm5hbWVzcGFjZSkge1xuICAgICAgICAgICAgc2FOYW1lc3BhY2UgPSB0aGlzLmNvcmVBZGRPblByb3BzLm5hbWVzcGFjZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBhIHNlcnZpY2UgYWNjb3VudCBpZiB1c2VyIHByb3ZpZGVzIG5hbWVzcGFjZSwgUG9saWN5RG9jdW1lbnRcbiAgICAgICAgY29uc3QgcG9saWNpZXMgPSB0aGlzLnByb3ZpZGVNYW5hZ2VkUG9saWNpZXMoY2x1c3RlckluZm8pO1xuICAgICAgICBpZiAocG9saWNpZXMpIHtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50ID0gdGhpcy5jcmVhdGVTZXJ2aWNlQWNjb3VudChjbHVzdGVySW5mbywgc2FOYW1lc3BhY2UsIHBvbGljaWVzKTtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50Um9sZUFybiA9IHNlcnZpY2VBY2NvdW50LnJvbGUucm9sZUFybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgdmVyc2lvbjogc3RyaW5nID0gdGhpcy5jb3JlQWRkT25Qcm9wcy52ZXJzaW9uO1xuXG4gICAgICAgIGlmICh0aGlzLmNvcmVBZGRPblByb3BzLnZlcnNpb25NYXApIHtcbiAgICAgICAgICAgIHZlcnNpb24gPSB0aGlzLmNvcmVBZGRPblByb3BzLnZlcnNpb24gIT0gXCJhdXRvXCIgPyB0aGlzLmNvcmVBZGRPblByb3BzLnZlcnNpb24gOiB0aGlzLnByb3ZpZGVWZXJzaW9uKGNsdXN0ZXJJbmZvLCB0aGlzLmNvcmVBZGRPblByb3BzLnZlcnNpb25NYXApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFkZE9uUHJvcHMgPSB7XG4gICAgICAgICAgICBhZGRvbk5hbWU6IHRoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lLFxuICAgICAgICAgICAgYWRkb25WZXJzaW9uOiB2ZXJzaW9uLFxuICAgICAgICAgICAgY29uZmlndXJhdGlvblZhbHVlczogSlNPTi5zdHJpbmdpZnkodGhpcy5jb3JlQWRkT25Qcm9wcy5jb25maWd1cmF0aW9uVmFsdWVzKSxcbiAgICAgICAgICAgIGNsdXN0ZXJOYW1lOiBjbHVzdGVySW5mby5jbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgc2VydmljZUFjY291bnRSb2xlQXJuOiBzZXJ2aWNlQWNjb3VudFJvbGVBcm4sXG4gICAgICAgICAgICByZXNvbHZlQ29uZmxpY3RzOiBcIk9WRVJXUklURVwiXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY2ZuQWRkb24gPSBuZXcgQ2ZuQWRkb24oY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjaywgdGhpcy5jb3JlQWRkT25Qcm9wcy5hZGRPbk5hbWUgKyBcIi1hZGRPblwiLCBhZGRPblByb3BzKTtcbiAgICAgICAgaWYgKHNlcnZpY2VBY2NvdW50KSB7XG4gICAgICAgICAgICBjZm5BZGRvbi5ub2RlLmFkZERlcGVuZGVuY3koc2VydmljZUFjY291bnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYodGhpcy5jb3JlQWRkT25Qcm9wcy5jb250cm9sUGxhbmVBZGRPbikge1xuICAgICAgICAgICAgZGVwbG95QmVmb3JlQ2FwYWNpdHkoY2ZuQWRkb24sIGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBJbnN0YW50aWF0ZSB0aGUgQWRkLW9uXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2ZuQWRkb24pO1xuICAgIH1cblxuICAgIGNyZWF0ZVNlcnZpY2VBY2NvdW50KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgc2FOYW1lc3BhY2U6IHN0cmluZywgcG9saWNpZXM6IElNYW5hZ2VkUG9saWN5W10pOiBTZXJ2aWNlQWNjb3VudCB7XG4gICAgICAgIHJldHVybiBjcmVhdGVTZXJ2aWNlQWNjb3VudFdpdGhQb2xpY3koY2x1c3RlckluZm8uY2x1c3RlciwgdGhpcy5jb3JlQWRkT25Qcm9wcy5zYU5hbWUsXG4gICAgICAgICAgICBzYU5hbWVzcGFjZSwgLi4ucG9saWNpZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlbXBsYXRlIG1ldGhvZCB3aXRoIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gdG8gZXhlY3V0ZSB0aGUgc3VwcGxpZWQgZnVuY3Rpb24gb2YgcG9saWN5RG9jdW1lbnRQcm92aWRlci5cbiAgICAgKiBBbGxvd3Mgb3ZlcnJpZGluZyB0aGlzIG1ldGhvZCBpbiBzdWJjbGFzc2VzIGZvciBtb3JlIGNvbXBsZXggY2FzZXMgb2YgcG9saWNpZXMuXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvIFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIHByb3ZpZGVQb2xpY3lEb2N1bWVudChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pIDogUG9saWN5RG9jdW1lbnQgfCB1bmRlZmluZWQge1xuICAgICAgICBpZih0aGlzLmNvcmVBZGRPblByb3BzPy5wb2xpY3lEb2N1bWVudFByb3ZpZGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb3JlQWRkT25Qcm9wcy5wb2xpY3lEb2N1bWVudFByb3ZpZGVyKGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2sucGFydGl0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlbXBsYXRlIG1ldGhvZCB0byByZXR1cm4gbWFuYWdlZCBwb2xpY2llcyBmb3IgdGhlIHNlcnZpY2UgYWNjb3VudC4gXG4gICAgICogQWxsb3dzIG92ZXJyaWRpbmcgaW4gc3ViY2xhc3NlcyB0byBoYW5kbGUgbW9yZSBjb21wbGV4IGNhc2VzIG9mIHBvbGljaWVzLlxuICAgICAqL1xuICAgIHByb3ZpZGVNYW5hZ2VkUG9saWNpZXMoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKSA6IElNYW5hZ2VkUG9saWN5W10gfCB1bmRlZmluZWQge1xuICAgICAgICBsZXQgcmVzdWx0IDogSU1hbmFnZWRQb2xpY3lbXSB8IHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgcG9saWN5RG9jdW1lbnQgPSB0aGlzLnByb3ZpZGVQb2xpY3lEb2N1bWVudChjbHVzdGVySW5mbyk7XG4gICAgICAgIFxuICAgICAgICBpZihwb2xpY3lEb2N1bWVudCkge1xuICAgICAgICAgICAgY29uc3QgcG9saWN5ID0gbmV3IE1hbmFnZWRQb2xpY3koY2x1c3RlckluZm8uY2x1c3RlciwgYCR7dGhpcy5jb3JlQWRkT25Qcm9wcy5hZGRPbk5hbWV9LW1hbmFnZWQtcG9saWN5YCwge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50OiBwb2xpY3lEb2N1bWVudFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXN1bHQgPSBbcG9saWN5XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByb3ZpZGVWZXJzaW9uKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgdmVyc2lvbk1hcDogTWFwPEt1YmVybmV0ZXNWZXJzaW9uLCBzdHJpbmc+KSA6IHN0cmluZyB7XG4gICAgICAgIGxldCB2ZXJzaW9uOiBzdHJpbmcgPSB2ZXJzaW9uTWFwLmdldChjbHVzdGVySW5mby52ZXJzaW9uKSA/PyB2ZXJzaW9uTWFwLnZhbHVlcygpLm5leHQoKS52YWx1ZTtcbiAgICAgICAgdXNlckxvZy5kZWJ1ZyhgQ29yZSBhZGQtb24gJHt0aGlzLmNvcmVBZGRPblByb3BzLmFkZE9uTmFtZX0gaGFzIGF1dG9zZWxlY3RlZCB2ZXJzaW9uICR7dmVyc2lvbn1gKTtcbiAgICAgICAgcmV0dXJuIHZlcnNpb247XG4gICAgfVxuXG59XG4iXX0=