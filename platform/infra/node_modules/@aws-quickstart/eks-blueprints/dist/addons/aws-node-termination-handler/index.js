"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsNodeTerminationHandlerAddOn = exports.Mode = void 0;
const aws_autoscaling_1 = require("aws-cdk-lib/aws-autoscaling");
const aws_autoscaling_hooktargets_1 = require("aws-cdk-lib/aws-autoscaling-hooktargets");
const aws_events_1 = require("aws-cdk-lib/aws-events");
const aws_events_targets_1 = require("aws-cdk-lib/aws-events-targets");
const iam = require("aws-cdk-lib/aws-iam");
const aws_sqs_1 = require("aws-cdk-lib/aws-sqs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const assert = require("assert");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
/**
 * Supported Modes
 */
var Mode;
(function (Mode) {
    /**
     * IMDS Mode
     */
    Mode[Mode["IMDS"] = 0] = "IMDS";
    /**
     * Queue Mode
     */
    Mode[Mode["QUEUE"] = 1] = "QUEUE";
})(Mode || (exports.Mode = Mode = {}));
/**
 * Default options for the add-on
 */
const defaultProps = {
    chart: 'aws-node-termination-handler',
    repository: 'https://aws.github.io/eks-charts',
    version: '0.21.0',
    release: 'blueprints-addon-aws-node-termination-handler',
    name: 'aws-node-termination-handler',
    namespace: 'kube-system',
    mode: Mode.IMDS
};
class AwsNodeTerminationHandlerAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    /**
     * Implementation of the deploy interface
     * @param clusterInfo
     */
    deploy(clusterInfo) {
        const cluster = clusterInfo.cluster;
        const asgCapacity = clusterInfo.autoscalingGroups || [];
        const karpenter = clusterInfo.getScheduledAddOn('KarpenterAddOn');
        if (!karpenter) {
            // No support for Fargate and Managed Node Groups, lets catch that
            assert(asgCapacity && asgCapacity.length > 0, 'AWS Node Termination Handler is only supported for self-managed nodes');
        }
        // Create an SQS Queue
        let helmValues;
        // Create Service Account
        const serviceAccount = cluster.addServiceAccount('aws-nth-sa', {
            name: 'aws-node-termination-handler-sa',
            namespace: this.options.namespace,
        });
        // Get the appropriate Helm Values depending upon the Mode selected
        if (this.options.mode === Mode.IMDS) {
            helmValues = this.configureImdsMode(serviceAccount, karpenter);
        }
        else {
            helmValues = this.configureQueueMode(cluster, serviceAccount, asgCapacity, karpenter);
        }
        // Deploy the helm chart
        const awsNodeTerminationHandlerChart = this.addHelmChart(clusterInfo, helmValues);
        awsNodeTerminationHandlerChart.node.addDependency(serviceAccount);
    }
    /**
     * Configures IMDS Mode
     * @param serviceAccount
     * @returns Helm values
     */
    configureImdsMode(serviceAccount, karpenter) {
        return {
            enableSpotInterruptionDraining: true,
            enableRebalanceMonitoring: true,
            enableRebalanceDraining: karpenter ? true : false,
            enableScheduledEventDraining: true,
            nodeSelector: karpenter ? { 'karpenter.sh/capacity-type': 'spot' } : {},
            serviceAccount: {
                create: false,
                name: serviceAccount.serviceAccountName,
            }
        };
    }
    /**
     * Configures Queue Mode
     * @param cluster
     * @param serviceAccount
     * @param asgCapacity
     * @returns Helm values
     */
    configureQueueMode(cluster, serviceAccount, asgCapacity, karpenter) {
        const queue = new aws_sqs_1.Queue(cluster.stack, "aws-nth-queue", {
            retentionPeriod: aws_cdk_lib_1.Duration.minutes(5)
        });
        queue.addToResourcePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            principals: [
                new iam.ServicePrincipal('events.amazonaws.com'),
                new iam.ServicePrincipal('sqs.amazonaws.com'),
            ],
            actions: ['sqs:SendMessage'],
            resources: [queue.queueArn]
        }));
        const resources = [];
        // This does not apply if you leverage Karpenter (which uses NTH for Spot/Fargate)
        if (!karpenter) {
            for (let i = 0; i < asgCapacity.length; i++) {
                const nodeGroup = asgCapacity[i];
                // Setup a Termination Lifecycle Hook on an ASG
                new aws_autoscaling_1.LifecycleHook(cluster.stack, `aws-${nodeGroup.autoScalingGroupName}-nth-lifecycle-hook`, {
                    lifecycleTransition: aws_autoscaling_1.LifecycleTransition.INSTANCE_TERMINATING,
                    heartbeatTimeout: aws_cdk_lib_1.Duration.minutes(5),
                    notificationTarget: new aws_autoscaling_hooktargets_1.QueueHook(queue),
                    autoScalingGroup: nodeGroup
                });
                // Tag the ASG
                const tags = [{
                        Key: 'aws-node-termination-handler/managed',
                        Value: 'true'
                    }];
                (0, utils_1.tagAsg)(cluster.stack, nodeGroup.autoScalingGroupName, tags);
                resources.push(nodeGroup.autoScalingGroupArn);
            }
        }
        // Create Amazon EventBridge Rules
        this.createEvents(cluster.stack, queue, karpenter);
        // Service Account Policy
        serviceAccount.addToPrincipalPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                'autoscaling:CompleteLifecycleAction',
                'autoscaling:DescribeAutoScalingInstances',
                'autoscaling:DescribeTags'
            ],
            resources: karpenter ? ['*'] : resources
        }));
        serviceAccount.addToPrincipalPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ['ec2:DescribeInstances'],
            resources: ['*']
        }));
        queue.grantConsumeMessages(serviceAccount);
        return {
            enableSqsTerminationDraining: true,
            queueURL: queue.queueUrl,
            awsRegion: karpenter ? cluster.stack.region : '',
            serviceAccount: {
                create: false,
                name: serviceAccount.serviceAccountName,
            },
            checkASGTagBeforeDraining: karpenter ? false : true,
            enableSpotInterruptionDraining: karpenter ? true : false,
        };
    }
    /**
     * Create EventBridge rules with target as SQS queue
     * @param scope
     * @param queue
     */
    createEvents(scope, queue, karpenter) {
        const target = new aws_events_targets_1.SqsQueue(queue);
        const eventPatterns = [
            {
                source: ['aws.ec2'],
                detailType: ['EC2 Spot Instance Interruption Warning']
            },
            {
                source: ['aws.ec2'],
                detailType: ['EC2 Instance Rebalance Recommendation']
            },
            {
                source: ['aws.ec2'],
                detailType: ['EC2 Instance State-change Notification']
            },
            {
                source: ['aws.health'],
                detailType: ['AWS Health Event'],
            }
        ];
        if (!karpenter) {
            eventPatterns.push({
                source: ['aws.autoscaling'],
                detailType: ['EC2 Instance-terminate Lifecycle Action']
            });
        }
        eventPatterns.forEach((event, index) => {
            const rule = new aws_events_1.Rule(scope, `rule-${index}`, { eventPattern: event });
            rule.addTarget(target);
        });
    }
}
exports.AwsNodeTerminationHandlerAddOn = AwsNodeTerminationHandlerAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2F3cy1ub2RlLXRlcm1pbmF0aW9uLWhhbmRsZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaUVBQW1HO0FBQ25HLHlGQUFvRTtBQUVwRSx1REFBNEQ7QUFDNUQsdUVBQTBEO0FBQzFELDJDQUEyQztBQUMzQyxpREFBNEM7QUFDNUMsNkNBQXVDO0FBRXZDLGlDQUFpQztBQUVqQyx1Q0FBcUM7QUFDckMsOENBQThEO0FBRTlEOztHQUVHO0FBQ0gsSUFBWSxJQVVYO0FBVkQsV0FBWSxJQUFJO0lBQ2Q7O09BRUc7SUFDSCwrQkFBSSxDQUFBO0lBRUo7O09BRUc7SUFDSCxpQ0FBSyxDQUFBO0FBQ1AsQ0FBQyxFQVZXLElBQUksb0JBQUosSUFBSSxRQVVmO0FBYUQ7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBbUM7SUFDbkQsS0FBSyxFQUFFLDhCQUE4QjtJQUNyQyxVQUFVLEVBQUUsa0NBQWtDO0lBQzlDLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLE9BQU8sRUFBRSwrQ0FBK0M7SUFDeEQsSUFBSSxFQUFFLDhCQUE4QjtJQUNwQyxTQUFTLEVBQUUsYUFBYTtJQUN4QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Q0FDaEIsQ0FBQztBQUVGLE1BQWEsOEJBQStCLFNBQVEsc0JBQVM7SUFJM0QsWUFBWSxLQUFzQztRQUNoRCxLQUFLLENBQUMsRUFBRSxHQUFHLFlBQW1CLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUM1QixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsTUFBTSxDQUFDLFdBQXdCO1FBQzdCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsTUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixJQUFJLEVBQUUs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WUFDRDtnQkFDRSxNQUFNLEVBQUUsQ0FBQyxZQUFZLENBQUM7Z0JBQ3RCLFVBQVUsRUFBRSxDQUFDLGtCQUFrQixDQUFDO2FBQ2pDO1NBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxTQUFTLEVBQUM7WUFDYixhQUFhLENBQUMsSUFBSSxDQUNoQjtnQkFDRSxNQUFNLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztnQkFDM0IsVUFBVSxFQUFFLENBQUMseUNBQXlDLENBQUM7YUFDeEQsQ0FDRixDQUFDO1NBQ0g7UUFFRCxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3JDLE1BQU0sSUFBSSxHQUFHLElBQUksaUJBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxLQUFLLEVBQUUsRUFBRSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUF2TEQsd0VBdUxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXV0b1NjYWxpbmdHcm91cCwgTGlmZWN5Y2xlSG9vaywgTGlmZWN5Y2xlVHJhbnNpdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hdXRvc2NhbGluZyc7XG5pbXBvcnQgeyBRdWV1ZUhvb2sgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXV0b3NjYWxpbmctaG9va3RhcmdldHMnO1xuaW1wb3J0IHsgSUNsdXN0ZXIsIFNlcnZpY2VBY2NvdW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcyc7XG5pbXBvcnQgeyBFdmVudFBhdHRlcm4sIFJ1bGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcbmltcG9ydCB7IFNxc1F1ZXVlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXNxcyc7XG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSBcImFzc2VydFwiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8gfSBmcm9tICcuLi8uLi9zcGknO1xuaW1wb3J0IHsgdGFnQXNnIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tICcuLi9oZWxtLWFkZG9uJztcblxuLyoqXG4gKiBTdXBwb3J0ZWQgTW9kZXNcbiAqL1xuZXhwb3J0IGVudW0gTW9kZSB7XG4gIC8qKlxuICAgKiBJTURTIE1vZGVcbiAgICovXG4gIElNRFMsXG5cbiAgLyoqXG4gICAqIFF1ZXVlIE1vZGVcbiAgICovXG4gIFFVRVVFXG59XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBmb3IgdGhlIGFkZC1vblxuICovXG5leHBvcnQgaW50ZXJmYWNlIEF3c05vZGVUZXJtaW5hdGlvbkhhbmRsZXJQcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gIC8qKlxuICAgKiBTdXBwb3J0ZWQgTW9kZXMgYXJlIE1vZGUuSU1EUyBhbmQgTW9kZS5RVUVVRVxuICAgKiBAZGVmYXVsdCBNb2RlLklNRFNcbiAgICovXG4gIG1vZGU/OiBNb2RlXG59XG5cbi8qKlxuICogRGVmYXVsdCBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmNvbnN0IGRlZmF1bHRQcm9wczogQXdzTm9kZVRlcm1pbmF0aW9uSGFuZGxlclByb3BzID0ge1xuICBjaGFydDogJ2F3cy1ub2RlLXRlcm1pbmF0aW9uLWhhbmRsZXInLFxuICByZXBvc2l0b3J5OiAnaHR0cHM6Ly9hd3MuZ2l0aHViLmlvL2Vrcy1jaGFydHMnLFxuICB2ZXJzaW9uOiAnMC4yMS4wJyxcbiAgcmVsZWFzZTogJ2JsdWVwcmludHMtYWRkb24tYXdzLW5vZGUtdGVybWluYXRpb24taGFuZGxlcicsXG4gIG5hbWU6ICdhd3Mtbm9kZS10ZXJtaW5hdGlvbi1oYW5kbGVyJyxcbiAgbmFtZXNwYWNlOiAna3ViZS1zeXN0ZW0nLFxuICBtb2RlOiBNb2RlLklNRFNcbn07XG5cbmV4cG9ydCBjbGFzcyBBd3NOb2RlVGVybWluYXRpb25IYW5kbGVyQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gIHByaXZhdGUgb3B0aW9uczogQXdzTm9kZVRlcm1pbmF0aW9uSGFuZGxlclByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzPzogQXdzTm9kZVRlcm1pbmF0aW9uSGFuZGxlclByb3BzKSB7XG4gICAgc3VwZXIoeyAuLi5kZWZhdWx0UHJvcHMgYXMgYW55LCAuLi5wcm9wcyB9KTtcbiAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzO1xuICB9XG5cbiAgLyoqXG4gICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSBkZXBsb3kgaW50ZXJmYWNlXG4gICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICovXG4gIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiB2b2lkIHtcbiAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjsgICAgXG4gICAgY29uc3QgYXNnQ2FwYWNpdHkgPSBjbHVzdGVySW5mby5hdXRvc2NhbGluZ0dyb3VwcyB8fCBbXTtcblxuICAgIGNvbnN0IGthcnBlbnRlciA9IGNsdXN0ZXJJbmZvLmdldFNjaGVkdWxlZEFkZE9uKCdLYXJwZW50ZXJBZGRPbicpO1xuICAgIGlmICgha2FycGVudGVyKXtcbiAgICAgIC8vIE5vIHN1cHBvcnQgZm9yIEZhcmdhdGUgYW5kIE1hbmFnZWQgTm9kZSBHcm91cHMsIGxldHMgY2F0Y2ggdGhhdFxuICAgICAgYXNzZXJ0KGFzZ0NhcGFjaXR5ICYmIGFzZ0NhcGFjaXR5Lmxlbmd0aCA+IDAsICdBV1MgTm9kZSBUZXJtaW5hdGlvbiBIYW5kbGVyIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBzZWxmLW1hbmFnZWQgbm9kZXMnKTtcbiAgICB9ICAgIFxuXG4gICAgLy8gQ3JlYXRlIGFuIFNRUyBRdWV1ZVxuICAgIGxldCBoZWxtVmFsdWVzOiBhbnk7XG5cbiAgICAvLyBDcmVhdGUgU2VydmljZSBBY2NvdW50XG4gICAgY29uc3Qgc2VydmljZUFjY291bnQgPSBjbHVzdGVyLmFkZFNlcnZpY2VBY2NvdW50KCdhd3MtbnRoLXNhJywge1xuICAgICAgICBuYW1lOiAnYXdzLW5vZGUtdGVybWluYXRpb24taGFuZGxlci1zYScsXG4gICAgICAgIG5hbWVzcGFjZTogdGhpcy5vcHRpb25zLm5hbWVzcGFjZSxcbiAgICB9KTtcblxuICAgIC8vIEdldCB0aGUgYXBwcm9wcmlhdGUgSGVsbSBWYWx1ZXMgZGVwZW5kaW5nIHVwb24gdGhlIE1vZGUgc2VsZWN0ZWRcbiAgICBpZiAodGhpcy5vcHRpb25zLm1vZGUgPT09IE1vZGUuSU1EUykge1xuICAgICAgICBoZWxtVmFsdWVzID0gdGhpcy5jb25maWd1cmVJbWRzTW9kZShzZXJ2aWNlQWNjb3VudCwga2FycGVudGVyKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGhlbG1WYWx1ZXMgPSB0aGlzLmNvbmZpZ3VyZVF1ZXVlTW9kZShjbHVzdGVyLCBzZXJ2aWNlQWNjb3VudCwgYXNnQ2FwYWNpdHksIGthcnBlbnRlcik7XG4gICAgfVxuICAgIFxuICAgIC8vIERlcGxveSB0aGUgaGVsbSBjaGFydFxuICAgIGNvbnN0IGF3c05vZGVUZXJtaW5hdGlvbkhhbmRsZXJDaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCBoZWxtVmFsdWVzKTtcbiAgICBhd3NOb2RlVGVybWluYXRpb25IYW5kbGVyQ2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KHNlcnZpY2VBY2NvdW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25maWd1cmVzIElNRFMgTW9kZVxuICAgKiBAcGFyYW0gc2VydmljZUFjY291bnQgXG4gICAqIEByZXR1cm5zIEhlbG0gdmFsdWVzXG4gICAqL1xuICAgIHByaXZhdGUgY29uZmlndXJlSW1kc01vZGUoc2VydmljZUFjY291bnQ6IFNlcnZpY2VBY2NvdW50LCBrYXJwZW50ZXI6IFByb21pc2U8Q29uc3RydWN0PiB8IHVuZGVmaW5lZCk6IGFueSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbmFibGVTcG90SW50ZXJydXB0aW9uRHJhaW5pbmc6IHRydWUsXG4gICAgICAgICAgICBlbmFibGVSZWJhbGFuY2VNb25pdG9yaW5nOiB0cnVlLFxuICAgICAgICAgICAgZW5hYmxlUmViYWxhbmNlRHJhaW5pbmc6IGthcnBlbnRlciA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICAgIGVuYWJsZVNjaGVkdWxlZEV2ZW50RHJhaW5pbmc6IHRydWUsXG4gICAgICAgICAgICBub2RlU2VsZWN0b3I6IGthcnBlbnRlciA/IHsna2FycGVudGVyLnNoL2NhcGFjaXR5LXR5cGUnOiAnc3BvdCd9IDoge30sXG4gICAgICAgICAgICBzZXJ2aWNlQWNjb3VudDoge1xuICAgICAgICAgICAgICAgIGNyZWF0ZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgbmFtZTogc2VydmljZUFjY291bnQuc2VydmljZUFjY291bnROYW1lLFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAvKipcbiAgICogQ29uZmlndXJlcyBRdWV1ZSBNb2RlXG4gICAqIEBwYXJhbSBjbHVzdGVyXG4gICAqIEBwYXJhbSBzZXJ2aWNlQWNjb3VudFxuICAgKiBAcGFyYW0gYXNnQ2FwYWNpdHlcbiAgICogQHJldHVybnMgSGVsbSB2YWx1ZXNcbiAgICovXG4gICAgcHJpdmF0ZSBjb25maWd1cmVRdWV1ZU1vZGUoY2x1c3RlcjogSUNsdXN0ZXIsIHNlcnZpY2VBY2NvdW50OiBTZXJ2aWNlQWNjb3VudCwgYXNnQ2FwYWNpdHk6IEF1dG9TY2FsaW5nR3JvdXBbXSwga2FycGVudGVyOiBQcm9taXNlPENvbnN0cnVjdD4gfCB1bmRlZmluZWQpOiBhbnkge1xuICAgICAgICBjb25zdCBxdWV1ZSA9IG5ldyBRdWV1ZShjbHVzdGVyLnN0YWNrLCBcImF3cy1udGgtcXVldWVcIiwge1xuICAgICAgICAgICAgcmV0ZW50aW9uUGVyaW9kOiBEdXJhdGlvbi5taW51dGVzKDUpXG4gICAgICAgIH0pO1xuICAgICAgICBxdWV1ZS5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgIHByaW5jaXBhbHM6IFtcbiAgICAgICAgICAgICAgICBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2V2ZW50cy5hbWF6b25hd3MuY29tJyksXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdzcXMuYW1hem9uYXdzLmNvbScpLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIGFjdGlvbnM6IFsnc3FzOlNlbmRNZXNzYWdlJ10sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFtxdWV1ZS5xdWV1ZUFybl1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIGNvbnN0IHJlc291cmNlczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICAvLyBUaGlzIGRvZXMgbm90IGFwcGx5IGlmIHlvdSBsZXZlcmFnZSBLYXJwZW50ZXIgKHdoaWNoIHVzZXMgTlRIIGZvciBTcG90L0ZhcmdhdGUpXG4gICAgICAgIGlmICgha2FycGVudGVyKXtcbiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFzZ0NhcGFjaXR5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIGNvbnN0IG5vZGVHcm91cCA9IGFzZ0NhcGFjaXR5W2ldO1xuICAgICAgICAgICAgICAvLyBTZXR1cCBhIFRlcm1pbmF0aW9uIExpZmVjeWNsZSBIb29rIG9uIGFuIEFTR1xuICAgICAgICAgICAgICBuZXcgTGlmZWN5Y2xlSG9vayhjbHVzdGVyLnN0YWNrLCBgYXdzLSR7bm9kZUdyb3VwLmF1dG9TY2FsaW5nR3JvdXBOYW1lfS1udGgtbGlmZWN5Y2xlLWhvb2tgLCB7XG4gICAgICAgICAgICAgICAgICBsaWZlY3ljbGVUcmFuc2l0aW9uOiBMaWZlY3ljbGVUcmFuc2l0aW9uLklOU1RBTkNFX1RFUk1JTkFUSU5HLFxuICAgICAgICAgICAgICAgICAgaGVhcnRiZWF0VGltZW91dDogRHVyYXRpb24ubWludXRlcyg1KSwgLy8gYmFzZWQgb24gaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3Mtbm9kZS10ZXJtaW5hdGlvbi1oYW5kbGVyIGRvY3NcbiAgICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvblRhcmdldDogbmV3IFF1ZXVlSG9vayhxdWV1ZSksXG4gICAgICAgICAgICAgICAgICBhdXRvU2NhbGluZ0dyb3VwOiBub2RlR3JvdXBcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgLy8gVGFnIHRoZSBBU0dcbiAgICAgICAgICAgICAgY29uc3QgdGFncyA9IFt7XG4gICAgICAgICAgICAgICAgICBLZXk6ICdhd3Mtbm9kZS10ZXJtaW5hdGlvbi1oYW5kbGVyL21hbmFnZWQnLFxuICAgICAgICAgICAgICAgICAgVmFsdWU6ICd0cnVlJ1xuICAgICAgICAgICAgICB9XTtcbiAgICAgICAgICAgICAgdGFnQXNnKGNsdXN0ZXIuc3RhY2ssIG5vZGVHcm91cC5hdXRvU2NhbGluZ0dyb3VwTmFtZSwgdGFncyk7XG4gICAgICAgICAgICAgIHJlc291cmNlcy5wdXNoKG5vZGVHcm91cC5hdXRvU2NhbGluZ0dyb3VwQXJuKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgQW1hem9uIEV2ZW50QnJpZGdlIFJ1bGVzXG4gICAgICAgIHRoaXMuY3JlYXRlRXZlbnRzKGNsdXN0ZXIuc3RhY2ssIHF1ZXVlLCBrYXJwZW50ZXIpO1xuXG4gICAgICAgIC8vIFNlcnZpY2UgQWNjb3VudCBQb2xpY3lcbiAgICAgICAgc2VydmljZUFjY291bnQuYWRkVG9QcmluY2lwYWxQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICdhdXRvc2NhbGluZzpDb21wbGV0ZUxpZmVjeWNsZUFjdGlvbicsXG4gICAgICAgICAgICAgICAgJ2F1dG9zY2FsaW5nOkRlc2NyaWJlQXV0b1NjYWxpbmdJbnN0YW5jZXMnLFxuICAgICAgICAgICAgICAgICdhdXRvc2NhbGluZzpEZXNjcmliZVRhZ3MnXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBrYXJwZW50ZXIgPyBbJyonXSA6IHJlc291cmNlc1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgc2VydmljZUFjY291bnQuYWRkVG9QcmluY2lwYWxQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgYWN0aW9uczogWydlYzI6RGVzY3JpYmVJbnN0YW5jZXMnXSxcbiAgICAgICAgICAgIHJlc291cmNlczogWycqJ11cbiAgICAgICAgfSkpO1xuICAgICAgICBxdWV1ZS5ncmFudENvbnN1bWVNZXNzYWdlcyhzZXJ2aWNlQWNjb3VudCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGVuYWJsZVNxc1Rlcm1pbmF0aW9uRHJhaW5pbmc6IHRydWUsXG4gICAgICAgICAgICBxdWV1ZVVSTDogcXVldWUucXVldWVVcmwsXG4gICAgICAgICAgICBhd3NSZWdpb246IGthcnBlbnRlciA/IGNsdXN0ZXIuc3RhY2sucmVnaW9uOiAnJyxcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBzZXJ2aWNlQWNjb3VudC5zZXJ2aWNlQWNjb3VudE5hbWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY2hlY2tBU0dUYWdCZWZvcmVEcmFpbmluZzoga2FycGVudGVyID8gZmFsc2UgOiB0cnVlLFxuICAgICAgICAgICAgZW5hYmxlU3BvdEludGVycnVwdGlvbkRyYWluaW5nOiBrYXJwZW50ZXIgPyB0cnVlIDogZmFsc2UsXG4gICAgICAgIH07XG4gICAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgRXZlbnRCcmlkZ2UgcnVsZXMgd2l0aCB0YXJnZXQgYXMgU1FTIHF1ZXVlXG4gICAqIEBwYXJhbSBzY29wZSBcbiAgICogQHBhcmFtIHF1ZXVlIFxuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVFdmVudHMoc2NvcGU6IENvbnN0cnVjdCwgcXVldWU6IFF1ZXVlLCBrYXJwZW50ZXI6IFByb21pc2U8Q29uc3RydWN0PiB8IHVuZGVmaW5lZCk6IHZvaWQge1xuICAgIGNvbnN0IHRhcmdldCA9IG5ldyBTcXNRdWV1ZShxdWV1ZSk7XG4gICAgY29uc3QgZXZlbnRQYXR0ZXJuczogRXZlbnRQYXR0ZXJuW10gPSBbXG4gICAgICB7XG4gICAgICAgIHNvdXJjZTogWydhd3MuZWMyJ10sXG4gICAgICAgIGRldGFpbFR5cGU6IFsnRUMyIFNwb3QgSW5zdGFuY2UgSW50ZXJydXB0aW9uIFdhcm5pbmcnXVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgc291cmNlOiBbJ2F3cy5lYzInXSxcbiAgICAgICAgZGV0YWlsVHlwZTogWydFQzIgSW5zdGFuY2UgUmViYWxhbmNlIFJlY29tbWVuZGF0aW9uJ11cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHNvdXJjZTogWydhd3MuZWMyJ10sXG4gICAgICAgIGRldGFpbFR5cGU6IFsnRUMyIEluc3RhbmNlIFN0YXRlLWNoYW5nZSBOb3RpZmljYXRpb24nXVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgc291cmNlOiBbJ2F3cy5oZWFsdGgnXSxcbiAgICAgICAgZGV0YWlsVHlwZTogWydBV1MgSGVhbHRoIEV2ZW50J10sXG4gICAgICB9XG4gICAgXTtcblxuICAgIGlmICgha2FycGVudGVyKXtcbiAgICAgIGV2ZW50UGF0dGVybnMucHVzaChcbiAgICAgICAge1xuICAgICAgICAgIHNvdXJjZTogWydhd3MuYXV0b3NjYWxpbmcnXSxcbiAgICAgICAgICBkZXRhaWxUeXBlOiBbJ0VDMiBJbnN0YW5jZS10ZXJtaW5hdGUgTGlmZWN5Y2xlIEFjdGlvbiddXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH1cblxuICAgIGV2ZW50UGF0dGVybnMuZm9yRWFjaCgoZXZlbnQsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBydWxlID0gbmV3IFJ1bGUoc2NvcGUsIGBydWxlLSR7aW5kZXh9YCwgeyBldmVudFBhdHRlcm46IGV2ZW50IH0pO1xuICAgICAgcnVsZS5hZGRUYXJnZXQodGFyZ2V0KTtcbiAgICB9KTtcbiAgfVxufSJdfQ==