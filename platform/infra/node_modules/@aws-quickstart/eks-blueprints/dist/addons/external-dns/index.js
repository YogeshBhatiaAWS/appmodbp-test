"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExternalDnsAddOn = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const helm_addon_1 = require("../helm-addon");
const ts_deepmerge_1 = require("ts-deepmerge");
const defaultProps = {
    name: 'external-dns',
    chart: 'external-dns',
    namespace: 'external-dns',
    repository: 'https://kubernetes-sigs.github.io/external-dns/',
    release: 'blueprints-addon-external-dns',
    version: '1.13.0',
    values: {},
};
/**
 * Implementation of the External DNS service: https://github.com/kubernetes-sigs/external-dns/.
 * It is required to integrate with Route53 for external DNS resolution.
 */
class ExternalDnsAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b;
        const region = clusterInfo.cluster.stack.region;
        const cluster = clusterInfo.cluster;
        const namespace = (_a = this.options.namespace) !== null && _a !== void 0 ? _a : this.options.name;
        const namespaceManifest = new aws_eks_1.KubernetesManifest(cluster.stack, `${this.props.name}-ns`, {
            cluster,
            manifest: [{
                    apiVersion: 'v1',
                    kind: 'Namespace',
                    metadata: { name: namespace },
                }],
            overwrite: true
        });
        const sa = cluster.addServiceAccount(this.props.name, { name: `${this.props.name}-sa`, namespace });
        const hostedZones = this.options.hostedZoneResources.map(e => clusterInfo.getRequiredResource(e));
        sa.addToPrincipalPolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: ['route53:ChangeResourceRecordSets', 'route53:ListResourceRecordSets'],
            resources: hostedZones.map(hostedZone => hostedZone.hostedZoneArn),
        }));
        sa.addToPrincipalPolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: ['route53:ListHostedZones'],
            resources: ['*'],
        }));
        sa.node.addDependency(namespaceManifest);
        // Create a --zone-id-filter arg for each hosted zone
        const zoneIdFilterArgs = hostedZones.map((hostedZone) => `--zone-id-filter=${hostedZone.hostedZoneId}`);
        let values = {
            provider: "aws",
            extraArgs: zoneIdFilterArgs,
            aws: {
                region,
            },
            serviceAccount: {
                create: false,
                name: sa.serviceAccountName,
            },
        };
        values = (0, ts_deepmerge_1.default)(values, (_b = this.props.values) !== null && _b !== void 0 ? _b : {});
        const chart = this.addHelmChart(clusterInfo, values);
        chart.node.addDependency(namespaceManifest);
        // return the Promise Construct for any teams that may depend on this
        return Promise.resolve(chart);
    }
}
exports.ExternalDnsAddOn = ExternalDnsAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2V4dGVybmFsLWRucy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpREFBeUQ7QUFDekQsaURBQThEO0FBSTlELDhDQUE4RDtBQUM5RCwrQ0FBaUM7QUFjakMsTUFBTSxZQUFZLEdBQUc7SUFDakIsSUFBSSxFQUFFLGNBQWM7SUFDcEIsS0FBSyxFQUFFLGNBQWM7SUFDckIsU0FBUyxFQUFFLGNBQWM7SUFDekIsVUFBVSxFQUFFLGlEQUFpRDtJQUM3RCxPQUFPLEVBQUUsK0JBQStCO0lBQ3hDLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLE1BQU0sRUFBRSxFQUFFO0NBQ2IsQ0FBQztBQUVGOzs7R0FHRztBQUNILE1BQWEsZ0JBQWlCLFNBQVEsc0JBQVM7SUFJM0MsWUFBWSxLQUF1QjtRQUMvQixLQUFLLENBQUMsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBeUIsQ0FBQztJQUNsRCxDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQXdCOztRQUMzQixNQUFNLE1BQU0sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDaEQsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLFNBQVMsR0FBRyxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxtQ0FBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztRQUU5RCxNQUFNLGlCQUFpQixHQUFHLElBQUksNEJBQWtCLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLEVBQUU7WUFDckYsT0FBTztZQUNQLFFBQVEsRUFBRSxDQUFDO29CQUNQLFVBQVUsRUFBRSxJQUFJO29CQUNoQixJQUFJLEVBQUUsV0FBVztvQkFDakIsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRTtpQkFDaEMsQ0FBQztZQUNGLFNBQVMsRUFBRSxJQUFJO1NBQ2xCLENBQUMsQ0FBQztRQUVILE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUVwRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRS9HLEVBQUUsQ0FBQyxvQkFBb0IsQ0FDbkIsSUFBSSx5QkFBZSxDQUFDO1lBQ2hCLE1BQU0sRUFBRSxnQkFBTSxDQUFDLEtBQUs7WUFDcEIsT0FBTyxFQUFFLENBQUMsa0NBQWtDLEVBQUUsZ0NBQWdDLENBQUM7WUFDL0UsU0FBUyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxVQUFXLENBQUMsYUFBYSxDQUFDO1NBQ3RFLENBQUMsQ0FDTCxDQUFDO1FBRUYsRUFBRSxDQUFDLG9CQUFvQixDQUNuQixJQUFJLHlCQUFlLENBQUM7WUFDaEIsTUFBTSxFQUFFLGdCQUFNLENBQUMsS0FBSztZQUNwQixPQUFPLEVBQUUsQ0FBQyx5QkFBeUIsQ0FBQztZQUNwQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7U0FDbkIsQ0FBQyxDQUNMLENBQUM7UUFFRixFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRXpDLHFEQUFxRDtRQUNyRCxNQUFNLGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLG9CQUFvQixVQUFXLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUV6RyxJQUFJLE1BQU0sR0FBVztZQUNqQixRQUFRLEVBQUUsS0FBSztZQUNmLFNBQVMsRUFBRSxnQkFBZ0I7WUFDM0IsR0FBRyxFQUFFO2dCQUNILE1BQU07YUFDUDtZQUNELGNBQWMsRUFBRTtnQkFDZCxNQUFNLEVBQUUsS0FBSztnQkFDYixJQUFJLEVBQUUsRUFBRSxDQUFDLGtCQUFrQjthQUM1QjtTQUNKLENBQUM7UUFFRixNQUFNLEdBQUcsSUFBQSxzQkFBSyxFQUFDLE1BQU0sRUFBRSxNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxtQ0FBSSxFQUFFLENBQUMsQ0FBQztRQUNoRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUVyRCxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzVDLHFFQUFxRTtRQUNyRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEMsQ0FBQztDQUNKO0FBcEVELDRDQW9FQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0IHsgRWZmZWN0LCBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IElIb3N0ZWRab25lIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXJvdXRlNTMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tICcuLi8uLi9zcGknO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tICcuLi9oZWxtLWFkZG9uJztcbmltcG9ydCBtZXJnZSBmcm9tIFwidHMtZGVlcG1lcmdlXCI7XG5cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBleHRlcm5hbCBETlMgYWRkLW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVybmFsRG5zUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMge1xuICAgIC8qKlxuICAgICAqIE5hbWVzIG9mIGhvc3RlZCB6b25lIHByb3ZpZGVyIG5hbWVkIHJlc291cmNlcyAoQHNlZSBMb29rdXBIb3N0ZWRab25lUHJvdmlkZXIpIGZvciBleHRlcm5hbCBETlMuXG4gICAgICogSG9zdGVkIHpvbmUgcHJvdmlkZXJzIGFyZSByZWdpc3RlcmVkIGFzIG5hbWVkIHJlc291cmNlIHByb3ZpZGVycyB3aXRoIHRoZSBFa3NCbHVlcHJpbnRQcm9wcy5cbiAgICAgKi9cbiAgICByZWFkb25seSBob3N0ZWRab25lUmVzb3VyY2VzOiBzdHJpbmdbXTtcbn1cblxuY29uc3QgZGVmYXVsdFByb3BzID0ge1xuICAgIG5hbWU6ICdleHRlcm5hbC1kbnMnLFxuICAgIGNoYXJ0OiAnZXh0ZXJuYWwtZG5zJyxcbiAgICBuYW1lc3BhY2U6ICdleHRlcm5hbC1kbnMnLFxuICAgIHJlcG9zaXRvcnk6ICdodHRwczovL2t1YmVybmV0ZXMtc2lncy5naXRodWIuaW8vZXh0ZXJuYWwtZG5zLycsXG4gICAgcmVsZWFzZTogJ2JsdWVwcmludHMtYWRkb24tZXh0ZXJuYWwtZG5zJyxcbiAgICB2ZXJzaW9uOiAnMS4xMy4wJyxcbiAgICB2YWx1ZXM6IHt9LFxufTtcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgRXh0ZXJuYWwgRE5TIHNlcnZpY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rdWJlcm5ldGVzLXNpZ3MvZXh0ZXJuYWwtZG5zLy5cbiAqIEl0IGlzIHJlcXVpcmVkIHRvIGludGVncmF0ZSB3aXRoIFJvdXRlNTMgZm9yIGV4dGVybmFsIEROUyByZXNvbHV0aW9uLiBcbiAqL1xuZXhwb3J0IGNsYXNzIEV4dGVybmFsRG5zQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBFeHRlcm5hbERuc1Byb3BzO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IEV4dGVybmFsRG5zUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoeyAuLi5kZWZhdWx0UHJvcHMsIC4uLnByb3BzIH0pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzIGFzIEV4dGVybmFsRG5zUHJvcHM7XG4gICAgfVxuXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2sucmVnaW9uO1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5vcHRpb25zLm5hbWVzcGFjZSA/PyB0aGlzLm9wdGlvbnMubmFtZTtcblxuICAgICAgICBjb25zdCBuYW1lc3BhY2VNYW5pZmVzdCA9IG5ldyBLdWJlcm5ldGVzTWFuaWZlc3QoY2x1c3Rlci5zdGFjaywgYCR7dGhpcy5wcm9wcy5uYW1lfS1uc2AsIHtcbiAgICAgICAgICAgIGNsdXN0ZXIsXG4gICAgICAgICAgICBtYW5pZmVzdDogW3tcbiAgICAgICAgICAgICAgICBhcGlWZXJzaW9uOiAndjEnLFxuICAgICAgICAgICAgICAgIGtpbmQ6ICdOYW1lc3BhY2UnLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7IG5hbWU6IG5hbWVzcGFjZSB9LFxuICAgICAgICAgICAgfV0sXG4gICAgICAgICAgICBvdmVyd3JpdGU6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2EgPSBjbHVzdGVyLmFkZFNlcnZpY2VBY2NvdW50KHRoaXMucHJvcHMubmFtZSwgeyBuYW1lOiBgJHt0aGlzLnByb3BzLm5hbWV9LXNhYCwgbmFtZXNwYWNlIH0pO1xuXG4gICAgICAgIGNvbnN0IGhvc3RlZFpvbmVzID0gdGhpcy5vcHRpb25zLmhvc3RlZFpvbmVSZXNvdXJjZXMubWFwKGUgPT4gY2x1c3RlckluZm8uZ2V0UmVxdWlyZWRSZXNvdXJjZTxJSG9zdGVkWm9uZT4oZSkpO1xuXG4gICAgICAgIHNhLmFkZFRvUHJpbmNpcGFsUG9saWN5KFxuICAgICAgICAgICAgbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogWydyb3V0ZTUzOkNoYW5nZVJlc291cmNlUmVjb3JkU2V0cycsICdyb3V0ZTUzOkxpc3RSZXNvdXJjZVJlY29yZFNldHMnXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IGhvc3RlZFpvbmVzLm1hcChob3N0ZWRab25lID0+IGhvc3RlZFpvbmUhLmhvc3RlZFpvbmVBcm4pLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICk7XG5cbiAgICAgICAgc2EuYWRkVG9QcmluY2lwYWxQb2xpY3koXG4gICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbJ3JvdXRlNTM6TGlzdEhvc3RlZFpvbmVzJ10sXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICApO1xuXG4gICAgICAgIHNhLm5vZGUuYWRkRGVwZW5kZW5jeShuYW1lc3BhY2VNYW5pZmVzdCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGEgLS16b25lLWlkLWZpbHRlciBhcmcgZm9yIGVhY2ggaG9zdGVkIHpvbmVcbiAgICAgICAgY29uc3Qgem9uZUlkRmlsdGVyQXJncyA9IGhvc3RlZFpvbmVzLm1hcCgoaG9zdGVkWm9uZSkgPT4gYC0tem9uZS1pZC1maWx0ZXI9JHtob3N0ZWRab25lIS5ob3N0ZWRab25lSWR9YCk7XG5cbiAgICAgICAgbGV0IHZhbHVlczogVmFsdWVzID0ge1xuICAgICAgICAgICAgcHJvdmlkZXI6IFwiYXdzXCIsXG4gICAgICAgICAgICBleHRyYUFyZ3M6IHpvbmVJZEZpbHRlckFyZ3MsXG4gICAgICAgICAgICBhd3M6IHtcbiAgICAgICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgIGNyZWF0ZTogZmFsc2UsXG4gICAgICAgICAgICAgIG5hbWU6IHNhLnNlcnZpY2VBY2NvdW50TmFtZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFsdWVzID0gbWVyZ2UodmFsdWVzLCB0aGlzLnByb3BzLnZhbHVlcyA/PyB7fSk7XG4gICAgICAgIGNvbnN0IGNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIHZhbHVlcyk7XG5cbiAgICAgICAgY2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KG5hbWVzcGFjZU1hbmlmZXN0KTtcbiAgICAgICAgLy8gcmV0dXJuIHRoZSBQcm9taXNlIENvbnN0cnVjdCBmb3IgYW55IHRlYW1zIHRoYXQgbWF5IGRlcGVuZCBvbiB0aGlzXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hhcnQpO1xuICAgIH1cbn1cbiJdfQ==