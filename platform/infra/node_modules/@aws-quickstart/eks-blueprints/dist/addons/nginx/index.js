"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NginxAddOn = void 0;
const ts_deepmerge_1 = require("ts-deepmerge");
const __1 = require("..");
const utils_1 = require("../../utils");
const object_utils_1 = require("../../utils/object-utils");
const dot = require("dot-object");
const helm_addon_1 = require("../helm-addon");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: "nginx-ingress",
    chart: "nginx-ingress",
    release: "blueprints-addon-nginx",
    version: "0.18.1",
    repository: "https://helm.nginx.com/stable",
    backendProtocol: 'tcp',
    crossZoneEnabled: true,
    internetFacing: true,
    targetType: 'ip',
    namespace: 'kube-system'
};
class NginxAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b, _c, _d;
        const props = this.options;
        const presetAnnotations = {
            'service.beta.kubernetes.io/aws-load-balancer-backend-protocol': props.backendProtocol,
            'service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled': `${props.crossZoneEnabled}`,
            'service.beta.kubernetes.io/aws-load-balancer-scheme': props.internetFacing ? 'internet-facing' : 'internal',
            'service.beta.kubernetes.io/aws-load-balancer-type': 'external',
            'service.beta.kubernetes.io/aws-load-balancer-nlb-target-type': props.targetType,
            'external-dns.alpha.kubernetes.io/hostname': props.externalDnsHostname,
        };
        const values = {};
        if (props.certificateResourceName) {
            presetAnnotations['service.beta.kubernetes.io/aws-load-balancer-ssl-ports'] = 'https';
            const certificate = clusterInfo.getResource(props.certificateResourceName);
            presetAnnotations['service.beta.kubernetes.io/aws-load-balancer-ssl-cert'] = certificate === null || certificate === void 0 ? void 0 : certificate.certificateArn;
            (0, object_utils_1.setPath)(values, "controller.service.httpPort.enable", false);
            const httpPort = dot.pick("controller.service.httpsPort.targetPort", (_a = props.values) !== null && _a !== void 0 ? _a : {});
            if (httpPort === undefined) {
                (0, object_utils_1.setPath)(values, "controller.service.httpsPort.targetPort", 80);
            }
        }
        const serviceAnnotations = { ...(_c = (_b = values.controller) === null || _b === void 0 ? void 0 : _b.service) === null || _c === void 0 ? void 0 : _c.annotations, ...presetAnnotations };
        (0, object_utils_1.setPath)(values, 'controller.service.annotations', serviceAnnotations);
        const merged = (0, ts_deepmerge_1.default)(values, (_d = this.props.values) !== null && _d !== void 0 ? _d : {});
        const nginxHelmChart = this.addHelmChart(clusterInfo, merged);
        return Promise.resolve(nginxHelmChart);
    }
}
exports.NginxAddOn = NginxAddOn;
__decorate([
    (0, utils_1.dependable)(__1.AwsLoadBalancerControllerAddOn.name)
], NginxAddOn.prototype, "deploy", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL25naW54L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUVBLCtDQUFpQztBQUNqQywwQkFBb0Q7QUFFcEQsdUNBQXlDO0FBQ3pDLDJEQUFtRDtBQUNuRCxrQ0FBa0M7QUFDbEMsOENBQThEO0FBZ0Q5RDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFvQjtJQUNsQyxJQUFJLEVBQUUsZUFBZTtJQUNyQixLQUFLLEVBQUUsZUFBZTtJQUN0QixPQUFPLEVBQUUsd0JBQXdCO0lBQ2pDLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLFVBQVUsRUFBRSwrQkFBK0I7SUFDM0MsZUFBZSxFQUFFLEtBQUs7SUFDdEIsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixjQUFjLEVBQUUsSUFBSTtJQUNwQixVQUFVLEVBQUUsSUFBSTtJQUNoQixTQUFTLEVBQUUsYUFBYTtDQUMzQixDQUFDO0FBRUYsTUFBYSxVQUFXLFNBQVEsc0JBQVM7SUFJckMsWUFBWSxLQUF1QjtRQUMvQixLQUFLLENBQUMsRUFBRSxHQUFHLFlBQW1CLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUM5QixDQUFDO0lBR0QsTUFBTSxDQUFDLFdBQXdCOztRQUUzQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBRTNCLE1BQU0saUJBQWlCLEdBQVE7WUFDM0IsK0RBQStELEVBQUUsS0FBSyxDQUFDLGVBQWU7WUFDdEYsZ0ZBQWdGLEVBQUUsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLEVBQUU7WUFDN0cscURBQXFELEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLFVBQVU7WUFDNUcsbURBQW1ELEVBQUUsVUFBVTtZQUMvRCw4REFBOEQsRUFBRSxLQUFLLENBQUMsVUFBVTtZQUNoRiwyQ0FBMkMsRUFBRSxLQUFLLENBQUMsbUJBQW1CO1NBQ3pFLENBQUM7UUFFRixNQUFNLE1BQU0sR0FBVyxFQUFFLENBQUM7UUFFMUIsSUFBSSxLQUFLLENBQUMsdUJBQXVCLEVBQUU7WUFDL0IsaUJBQWlCLENBQUMsd0RBQXdELENBQUMsR0FBRyxPQUFPLENBQUM7WUFDdEYsTUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBZSxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUN6RixpQkFBaUIsQ0FBQyx1REFBdUQsQ0FBQyxHQUFHLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxjQUFjLENBQUM7WUFDekcsSUFBQSxzQkFBTyxFQUFDLE1BQU0sRUFBRSxvQ0FBb0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RCxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxFQUFFLE1BQUEsS0FBSyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDLENBQUM7WUFDekYsSUFBRyxRQUFRLEtBQUssU0FBUyxFQUFFO2dCQUN4QixJQUFBLHNCQUFPLEVBQUMsTUFBTSxFQUFFLHlDQUF5QyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQ2pFO1NBQ0o7UUFFRCxNQUFNLGtCQUFrQixHQUFHLEVBQUUsR0FBRyxNQUFBLE1BQUEsTUFBTSxDQUFDLFVBQVUsMENBQUUsT0FBTywwQ0FBRSxXQUFXLEVBQUUsR0FBRyxpQkFBaUIsRUFBRSxDQUFDO1FBQ2hHLElBQUEsc0JBQU8sRUFBQyxNQUFNLEVBQUUsZ0NBQWdDLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUV0RSxNQUFNLE1BQU0sR0FBRyxJQUFBLHNCQUFLLEVBQUMsTUFBTSxFQUFFLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLG1DQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRTlELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUMzQyxDQUFDO0NBQ0o7QUE1Q0QsZ0NBNENDO0FBbENHO0lBREMsSUFBQSxrQkFBVSxFQUFDLGtDQUE4QixDQUFDLElBQUksQ0FBQzt3Q0FrQy9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUNlcnRpZmljYXRlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgbWVyZ2UgZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xuaW1wb3J0IHsgQXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlckFkZE9uIH0gZnJvbSBcIi4uXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgZGVwZW5kYWJsZSB9IGZyb20gXCIuLi8uLi91dGlsc1wiO1xuaW1wb3J0IHsgc2V0UGF0aCB9IGZyb20gXCIuLi8uLi91dGlscy9vYmplY3QtdXRpbHNcIjtcbmltcG9ydCAqIGFzIGRvdCBmcm9tICdkb3Qtb2JqZWN0JztcbmltcG9ydCB7IEhlbG1BZGRPbiwgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSBcIi4uL2hlbG0tYWRkb25cIjtcblxuXG4vKipcbiAqIFByb3BlcnRpZXMgYXZhaWxhYmxlIHRvIGNvbmZpZ3VyZSB0aGUgbmdpbnggaW5ncmVzcyBjb250cm9sbGVyLlxuICogVmFsdWVzIHRvIHBhc3MgdG8gdGhlIGNoYXJ0IGFzIHBlciBodHRwczovL2RvY3MubmdpbnguY29tL25naW54LWluZ3Jlc3MtY29udHJvbGxlci9pbnN0YWxsYXRpb24vaW5zdGFsbGF0aW9uLXdpdGgtaGVsbS8jXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTmdpbnhBZGRPblByb3BzIGV4dGVuZHMgSGVsbUFkZE9uVXNlclByb3BzIHtcbiBcbiAgICAvKipcbiAgICAgKiB0Y3AsIGh0dHBcbiAgICAgKiBAZGVmYXVsdCB0Y3BcbiAgICAgKi9cbiAgICBiYWNrZW5kUHJvdG9jb2w/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBFbmFibGluZyBjcm9zcyBBWiBsb2FkYmFsYW5jaW5nIGZvciBcbiAgICAgKiBAZGVmYXVsdCB0cnVlXG4gICAgICovXG4gICAgY3Jvc3Nab25lRW5hYmxlZD86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBJZiB0aGUgbG9hZCBiYWxhbmNlciBjcmVhdGVkIGZvciB0aGUgaW5ncmVzcyBpcyBpbnRlcm5ldCBmYWNpbmcuXG4gICAgICogSW50ZXJuYWwgaWYgc2V0IHRvIGZhbHNlLlxuICAgICAqIEBkZWZhdWx0IHRydWVcbiAgICAgKi9cbiAgICBpbnRlcm5ldEZhY2luZz86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBJUCBvciBpbnN0YW5jZSBtb2RlLiBEZWZhdWx0OiBJUCwgcmVxdWlyZXMgVlBDLUNOSSwgaGFzIGJldHRlciBwZXJmb3JtYW5jZSBlbGltaW5hdGluZyBhIGhvcCB0aHJvdWdoIGt1YmVwcm94eVxuICAgICAqIEluc3RhbmNlIG1vZGU6IHRyYWRpdGlvbmFsIE5vZGVQb3J0IG1vZGUgb24gdGhlIGluc3RhbmNlLiBcbiAgICAgKiBAZGVmYXVsdCBpcFxuICAgICAqL1xuICAgIHRhcmdldFR5cGU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBVc2VkIGluIGNvbmp1bmN0aW9uIHdpdGggZXh0ZXJuYWwgRE5TIGFkZC1vbiB0byBoYW5kbGUgYXV0b21hdGljIHJlZ2lzdHJhdGlvbiBvZiB0aGUgc2VydmljZSB3aXRoIFJvdXRlNTMuICBcbiAgICAgKi9cbiAgICBleHRlcm5hbERuc0hvc3RuYW1lPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgY2VydGlmaWNhdGUge0BsaW5rIE5hbWVkUmVzb3VyY2VQcm92aWRlcn0gdG8gYmUgdXNlZCBmb3IgY2VydGlmaWNhdGUgbG9vayB1cC4gXG4gICAgICogQHNlZSB7QGxpbmsgSW1wb3J0Q2VydGlmaWNhdGVQcm92aWRlcn0gYW5kIHtAbGluayBDcmVhdGVDZXJ0aWZpY2F0ZVByb3ZpZGVyfSBmb3IgZXhhbXBsZXMgb2YgY2VydGlmaWNhdGUgcHJvdmlkZXJzLlxuICAgICAqL1xuICAgIGNlcnRpZmljYXRlUmVzb3VyY2VOYW1lPzogc3RyaW5nLFxufVxuXG5cbi8qKlxuICogRGVmYXVsdHMgb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5jb25zdCBkZWZhdWx0UHJvcHM6IE5naW54QWRkT25Qcm9wcyA9IHtcbiAgICBuYW1lOiBcIm5naW54LWluZ3Jlc3NcIixcbiAgICBjaGFydDogXCJuZ2lueC1pbmdyZXNzXCIsXG4gICAgcmVsZWFzZTogXCJibHVlcHJpbnRzLWFkZG9uLW5naW54XCIsXG4gICAgdmVyc2lvbjogXCIwLjE4LjFcIixcbiAgICByZXBvc2l0b3J5OiBcImh0dHBzOi8vaGVsbS5uZ2lueC5jb20vc3RhYmxlXCIsXG4gICAgYmFja2VuZFByb3RvY29sOiAndGNwJyxcbiAgICBjcm9zc1pvbmVFbmFibGVkOiB0cnVlLFxuICAgIGludGVybmV0RmFjaW5nOiB0cnVlLFxuICAgIHRhcmdldFR5cGU6ICdpcCcsXG4gICAgbmFtZXNwYWNlOiAna3ViZS1zeXN0ZW0nXG59O1xuXG5leHBvcnQgY2xhc3MgTmdpbnhBZGRPbiBleHRlbmRzIEhlbG1BZGRPbiB7XG5cbiAgICByZWFkb25seSBvcHRpb25zOiBOZ2lueEFkZE9uUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IE5naW54QWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLmRlZmF1bHRQcm9wcyBhcyBhbnksIC4uLnByb3BzIH0pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzO1xuICAgIH1cblxuICAgIEBkZXBlbmRhYmxlKEF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJBZGRPbi5uYW1lKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuXG4gICAgICAgIGNvbnN0IHByb3BzID0gdGhpcy5vcHRpb25zO1xuXG4gICAgICAgIGNvbnN0IHByZXNldEFubm90YXRpb25zOiBhbnkgPSB7XG4gICAgICAgICAgICAnc2VydmljZS5iZXRhLmt1YmVybmV0ZXMuaW8vYXdzLWxvYWQtYmFsYW5jZXItYmFja2VuZC1wcm90b2NvbCc6IHByb3BzLmJhY2tlbmRQcm90b2NvbCxcbiAgICAgICAgICAgICdzZXJ2aWNlLmJldGEua3ViZXJuZXRlcy5pby9hd3MtbG9hZC1iYWxhbmNlci1jcm9zcy16b25lLWxvYWQtYmFsYW5jaW5nLWVuYWJsZWQnOiBgJHtwcm9wcy5jcm9zc1pvbmVFbmFibGVkfWAsXG4gICAgICAgICAgICAnc2VydmljZS5iZXRhLmt1YmVybmV0ZXMuaW8vYXdzLWxvYWQtYmFsYW5jZXItc2NoZW1lJzogcHJvcHMuaW50ZXJuZXRGYWNpbmcgPyAnaW50ZXJuZXQtZmFjaW5nJyA6ICdpbnRlcm5hbCcsXG4gICAgICAgICAgICAnc2VydmljZS5iZXRhLmt1YmVybmV0ZXMuaW8vYXdzLWxvYWQtYmFsYW5jZXItdHlwZSc6ICdleHRlcm5hbCcsXG4gICAgICAgICAgICAnc2VydmljZS5iZXRhLmt1YmVybmV0ZXMuaW8vYXdzLWxvYWQtYmFsYW5jZXItbmxiLXRhcmdldC10eXBlJzogcHJvcHMudGFyZ2V0VHlwZSxcbiAgICAgICAgICAgICdleHRlcm5hbC1kbnMuYWxwaGEua3ViZXJuZXRlcy5pby9ob3N0bmFtZSc6IHByb3BzLmV4dGVybmFsRG5zSG9zdG5hbWUsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgdmFsdWVzOiBWYWx1ZXMgPSB7fTtcblxuICAgICAgICBpZiAocHJvcHMuY2VydGlmaWNhdGVSZXNvdXJjZU5hbWUpIHtcbiAgICAgICAgICAgIHByZXNldEFubm90YXRpb25zWydzZXJ2aWNlLmJldGEua3ViZXJuZXRlcy5pby9hd3MtbG9hZC1iYWxhbmNlci1zc2wtcG9ydHMnXSA9ICdodHRwcyc7XG4gICAgICAgICAgICBjb25zdCBjZXJ0aWZpY2F0ZSA9IGNsdXN0ZXJJbmZvLmdldFJlc291cmNlPElDZXJ0aWZpY2F0ZT4ocHJvcHMuY2VydGlmaWNhdGVSZXNvdXJjZU5hbWUpO1xuICAgICAgICAgICAgcHJlc2V0QW5ub3RhdGlvbnNbJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLXNzbC1jZXJ0J10gPSBjZXJ0aWZpY2F0ZT8uY2VydGlmaWNhdGVBcm47XG4gICAgICAgICAgICBzZXRQYXRoKHZhbHVlcywgXCJjb250cm9sbGVyLnNlcnZpY2UuaHR0cFBvcnQuZW5hYmxlXCIsIGZhbHNlKTtcbiAgICAgICAgICAgIGNvbnN0IGh0dHBQb3J0ID0gZG90LnBpY2soXCJjb250cm9sbGVyLnNlcnZpY2UuaHR0cHNQb3J0LnRhcmdldFBvcnRcIiwgcHJvcHMudmFsdWVzID8/IHt9KTtcbiAgICAgICAgICAgIGlmKGh0dHBQb3J0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgIHNldFBhdGgodmFsdWVzLCBcImNvbnRyb2xsZXIuc2VydmljZS5odHRwc1BvcnQudGFyZ2V0UG9ydFwiLCA4MCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXJ2aWNlQW5ub3RhdGlvbnMgPSB7IC4uLnZhbHVlcy5jb250cm9sbGVyPy5zZXJ2aWNlPy5hbm5vdGF0aW9ucywgLi4ucHJlc2V0QW5ub3RhdGlvbnMgfTtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsICdjb250cm9sbGVyLnNlcnZpY2UuYW5ub3RhdGlvbnMnLCBzZXJ2aWNlQW5ub3RhdGlvbnMpO1xuXG4gICAgICAgIGNvbnN0IG1lcmdlZCA9IG1lcmdlKHZhbHVlcywgdGhpcy5wcm9wcy52YWx1ZXMgPz8ge30pO1xuICAgICAgICBjb25zdCBuZ2lueEhlbG1DaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCBtZXJnZWQpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmdpbnhIZWxtQ2hhcnQpO1xuICAgIH1cbn0iXX0=