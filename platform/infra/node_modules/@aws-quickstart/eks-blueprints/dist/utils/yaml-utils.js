"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serializeYaml = exports.loadExternalYaml = exports.loadYaml = exports.readYamlDocument = exports.applyYamlFromDir = void 0;
const fs = require("fs");
const yaml = require("js-yaml");
/**
 * Applies all manifests from a directory. Note: The manifests are not checked,
 * so user must ensure the manifests have the correct namespaces.
 * @param dir
 * @param cluster
 * @param namespaceManifest
 */
function applyYamlFromDir(dir, cluster, namespaceManifest) {
    fs.readdirSync(dir, { encoding: 'utf8' }).forEach((file, index) => {
        if (file.split('.').pop() == 'yaml') {
            const data = fs.readFileSync(dir + file, 'utf8');
            if (data != undefined) {
                yaml.loadAll(data, function (item) {
                    const resources = cluster.addManifest(file.substring(0, file.length - 5) + index, item);
                    resources.node.addDependency(namespaceManifest);
                });
            }
        }
    });
}
exports.applyYamlFromDir = applyYamlFromDir;
function readYamlDocument(path) {
    try {
        const doc = fs.readFileSync(path, 'utf8');
        return doc;
    }
    catch (e) {
        console.log(e + ' for path: ' + path);
        throw e;
    }
}
exports.readYamlDocument = readYamlDocument;
function loadYaml(document) {
    return yaml.load(document);
}
exports.loadYaml = loadYaml;
function loadExternalYaml(url) {
    /* eslint-disable */
    const request = require('sync-request'); // moved away from import as it is causing open handles that prevents jest from completion
    const response = request('GET', url);
    return yaml.loadAll(response.getBody().toString());
}
exports.loadExternalYaml = loadExternalYaml;
function serializeYaml(document) {
    return yaml.dump(document);
}
exports.serializeYaml = serializeYaml;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWFtbC11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi91dGlscy95YW1sLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLHlCQUF5QjtBQUN6QixnQ0FBZ0M7QUFHaEM7Ozs7OztHQU1HO0FBQ0gsU0FBZ0IsZ0JBQWdCLENBQUMsR0FBVyxFQUFFLE9BQXFCLEVBQUUsaUJBQXFDO0lBQ3RHLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQzlELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxNQUFNLEVBQUU7WUFDakMsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ2pELElBQUksSUFBSSxJQUFJLFNBQVMsRUFBRTtnQkFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsVUFBVSxJQUFJO29CQUM3QixNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxFQUF5QixJQUFJLENBQUMsQ0FBQztvQkFDL0csU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsQ0FBQztnQkFDcEQsQ0FBQyxDQUFDLENBQUM7YUFDTjtTQUNKO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBWkQsNENBWUM7QUFFRCxTQUFnQixnQkFBZ0IsQ0FBQyxJQUFZO0lBQ3pDLElBQUk7UUFDQSxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMxQyxPQUFPLEdBQUcsQ0FBQztLQUNkO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxhQUFhLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDdEMsTUFBTSxDQUFDLENBQUM7S0FDWDtBQUNMLENBQUM7QUFSRCw0Q0FRQztBQUdELFNBQWdCLFFBQVEsQ0FBQyxRQUFnQjtJQUNyQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQUZELDRCQUVDO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsR0FBVztJQUN4QyxvQkFBb0I7SUFDcEIsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsMEZBQTBGO0lBQ25JLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDckMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZELENBQUM7QUFMRCw0Q0FLQztBQUVELFNBQWdCLGFBQWEsQ0FBQyxRQUFhO0lBQ3ZDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixDQUFDO0FBRkQsc0NBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBla3MgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcyc7XG5pbXBvcnQgeyBLdWJlcm5ldGVzTWFuaWZlc3QgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHlhbWwgZnJvbSAnanMteWFtbCc7XG5cblxuLyoqXG4gKiBBcHBsaWVzIGFsbCBtYW5pZmVzdHMgZnJvbSBhIGRpcmVjdG9yeS4gTm90ZTogVGhlIG1hbmlmZXN0cyBhcmUgbm90IGNoZWNrZWQsIFxuICogc28gdXNlciBtdXN0IGVuc3VyZSB0aGUgbWFuaWZlc3RzIGhhdmUgdGhlIGNvcnJlY3QgbmFtZXNwYWNlcy4gXG4gKiBAcGFyYW0gZGlyIFxuICogQHBhcmFtIGNsdXN0ZXIgXG4gKiBAcGFyYW0gbmFtZXNwYWNlTWFuaWZlc3QgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhcHBseVlhbWxGcm9tRGlyKGRpcjogc3RyaW5nLCBjbHVzdGVyOiBla3MuSUNsdXN0ZXIsIG5hbWVzcGFjZU1hbmlmZXN0OiBLdWJlcm5ldGVzTWFuaWZlc3QpOiB2b2lkIHtcbiAgICBmcy5yZWFkZGlyU3luYyhkaXIsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KS5mb3JFYWNoKChmaWxlLCBpbmRleCkgPT4ge1xuICAgICAgICBpZiAoZmlsZS5zcGxpdCgnLicpLnBvcCgpID09ICd5YW1sJykge1xuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhkaXIgKyBmaWxlLCAndXRmOCcpO1xuICAgICAgICAgICAgaWYgKGRhdGEgIT0gdW5kZWZpbmVkKSB7ICBcbiAgICAgICAgICAgICAgICB5YW1sLmxvYWRBbGwoZGF0YSwgZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VzID0gY2x1c3Rlci5hZGRNYW5pZmVzdChmaWxlLnN1YnN0cmluZygwLCBmaWxlLmxlbmd0aCAtIDUpICsgaW5kZXgsIDxSZWNvcmQ8c3RyaW5nLCBhbnk+W10+aXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlcy5ub2RlLmFkZERlcGVuZGVuY3kobmFtZXNwYWNlTWFuaWZlc3QpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkWWFtbERvY3VtZW50KHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZG9jID0gZnMucmVhZEZpbGVTeW5jKHBhdGgsICd1dGY4Jyk7XG4gICAgICAgIHJldHVybiBkb2M7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlICsgJyBmb3IgcGF0aDogJyArIHBhdGgpO1xuICAgICAgICB0aHJvdyBlO1xuICAgIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gbG9hZFlhbWwoZG9jdW1lbnQ6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHlhbWwubG9hZChkb2N1bWVudCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkRXh0ZXJuYWxZYW1sKHVybDogc3RyaW5nKTogYW55IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZSAqL1xuICAgIGNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdzeW5jLXJlcXVlc3QnKTsgLy8gbW92ZWQgYXdheSBmcm9tIGltcG9ydCBhcyBpdCBpcyBjYXVzaW5nIG9wZW4gaGFuZGxlcyB0aGF0IHByZXZlbnRzIGplc3QgZnJvbSBjb21wbGV0aW9uXG4gICAgY29uc3QgcmVzcG9uc2UgPSByZXF1ZXN0KCdHRVQnLCB1cmwpO1xuICAgIHJldHVybiB5YW1sLmxvYWRBbGwocmVzcG9uc2UuZ2V0Qm9keSgpLnRvU3RyaW5nKCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplWWFtbChkb2N1bWVudDogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4geWFtbC5kdW1wKGRvY3VtZW50KTtcbn0iXX0=