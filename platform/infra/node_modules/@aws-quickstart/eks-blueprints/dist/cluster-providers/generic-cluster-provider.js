"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GenericClusterProvider = exports.ClusterBuilder = exports.defaultOptions = exports.GenericClusterPropsConstraints = exports.FargateProfileConstraints = exports.AutoscalingNodeGroupConstraints = exports.ManagedNodeGroupConstraints = exports.selectKubectlLayer = exports.clusterBuilder = void 0;
const lambda_layer_kubectl_v23_1 = require("@aws-cdk/lambda-layer-kubectl-v23");
const lambda_layer_kubectl_v24_1 = require("@aws-cdk/lambda-layer-kubectl-v24");
const lambda_layer_kubectl_v25_1 = require("@aws-cdk/lambda-layer-kubectl-v25");
const lambda_layer_kubectl_v26_1 = require("@aws-cdk/lambda-layer-kubectl-v26");
const lambda_layer_kubectl_v27_1 = require("@aws-cdk/lambda-layer-kubectl-v27");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const autoscaling = require("aws-cdk-lib/aws-autoscaling");
const ec2 = require("aws-cdk-lib/aws-ec2");
const eks = require("aws-cdk-lib/aws-eks");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const spi_1 = require("../spi");
const utils = require("../utils");
const constants = require("./constants");
const assert = require("assert");
function clusterBuilder() {
    return new ClusterBuilder();
}
exports.clusterBuilder = clusterBuilder;
/**
 * Function that contains logic to map the correct kunbectl layer based on the passed in version.
 * @param scope in whch the kubectl layer must be created
 * @param version EKS version
 * @returns ILayerVersion or undefined
 */
function selectKubectlLayer(scope, version) {
    switch (version.version) {
        case "1.23":
            return new lambda_layer_kubectl_v23_1.KubectlV23Layer(scope, "kubectllayer23");
        case "1.24":
            return new lambda_layer_kubectl_v24_1.KubectlV24Layer(scope, "kubectllayer24");
        case "1.25":
            return new lambda_layer_kubectl_v25_1.KubectlV25Layer(scope, "kubectllayer25");
        case "1.26":
            return new lambda_layer_kubectl_v26_1.KubectlV26Layer(scope, "kubectllayer26");
        case "1.27":
            return new lambda_layer_kubectl_v27_1.KubectlV27Layer(scope, "kubectllayer27");
    }
    const minor = version.version.split('.')[1];
    if (minor && parseInt(minor, 10) > 27) {
        return new lambda_layer_kubectl_v27_1.KubectlV27Layer(scope, "kubectllayer27"); // for all versions above 1.27 use 1.27 kubectl (unless explicitly supported in CDK)
    }
    return undefined;
}
exports.selectKubectlLayer = selectKubectlLayer;
class ManagedNodeGroupConstraints {
    constructor() {
        /**
         * id can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
         * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
         */
        this.id = new utils.StringConstraint(1, 63);
        /**
        * nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
        * of situations of a hard limit request being accepted, and as a result the limit would be raised
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.minSize = new utils.NumberConstraint(0, 2250);
        /**
         * nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
         * of situations of a hard limit request being accepted, and as a result the limit would be raised
         * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
         */
        this.maxSize = new utils.NumberConstraint(0, 2250);
        /**
         * Nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
         * of situations of a hard limit request being accepted, and as a result the limit would be raised
         * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
         */
        this.desiredSize = new utils.NumberConstraint(0, 2250);
        /**
         * amiReleaseVersion can be no less than 1 character long, and no greater than 1024 characters long.
         * https://docs.aws.amazon.com/imagebuilder/latest/APIReference/API_Ami.html
         */
        this.amiReleaseVersion = new utils.StringConstraint(1, 1024);
    }
}
exports.ManagedNodeGroupConstraints = ManagedNodeGroupConstraints;
class AutoscalingNodeGroupConstraints {
    constructor() {
        /**
        * id can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.id = new utils.StringConstraint(1, 63);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.minSize = new utils.NumberConstraint(0, 5000);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.maxSize = new utils.NumberConstraint(0, 5000);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.desiredSize = new utils.NumberConstraint(0, 5000);
    }
}
exports.AutoscalingNodeGroupConstraints = AutoscalingNodeGroupConstraints;
class FargateProfileConstraints {
    constructor() {
        /**
        * fargateProfileNames can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.fargateProfileName = new utils.StringConstraint(1, 63);
    }
}
exports.FargateProfileConstraints = FargateProfileConstraints;
class GenericClusterPropsConstraints {
    constructor() {
        /**
        * managedNodeGroups per cluster have a soft limit of 30 managed node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 150 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.managedNodeGroups = new utils.ArrayConstraint(0, 150);
        /**
        * autoscalingNodeGroups per cluster have a soft limit of 500 autoscaling node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 2500 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/autoscaling/ec2/userguide/ec2-auto-scaling-quotas.html
        */
        this.autoscalingNodeGroups = new utils.ArrayConstraint(0, 5000);
    }
}
exports.GenericClusterPropsConstraints = GenericClusterPropsConstraints;
exports.defaultOptions = {
    version: eks.KubernetesVersion.V1_25
};
class ClusterBuilder {
    constructor() {
        this.props = {};
        this.privateCluster = false;
        this.managedNodeGroups = [];
        this.autoscalingNodeGroups = [];
        this.fargateProfiles = {};
        this.props = { ...this.props, ...{ version: eks.KubernetesVersion.V1_25 } };
    }
    withCommonOptions(options) {
        this.props = { ...this.props, ...options };
        return this;
    }
    managedNodeGroup(...nodeGroups) {
        this.managedNodeGroups = this.managedNodeGroups.concat(nodeGroups);
        return this;
    }
    autoscalingGroup(...nodeGroups) {
        this.autoscalingNodeGroups = this.autoscalingNodeGroups.concat(nodeGroups);
        return this;
    }
    fargateProfile(name, options) {
        this.fargateProfiles[name] = options;
        return this;
    }
    build() {
        return new GenericClusterProvider({
            ...this.props,
            version: this.props.version,
            privateCluster: this.privateCluster,
            managedNodeGroups: this.managedNodeGroups,
            autoscalingNodeGroups: this.autoscalingNodeGroups,
            fargateProfiles: this.fargateProfiles
        });
    }
}
exports.ClusterBuilder = ClusterBuilder;
/**
 * Cluster provider implementation that supports multiple node groups.
 */
class GenericClusterProvider {
    constructor(props) {
        this.props = props;
        this.validateInput(props);
        assert(!(props.managedNodeGroups && props.managedNodeGroups.length > 0
            && props.autoscalingNodeGroups && props.autoscalingNodeGroups.length > 0), "Mixing managed and autoscaling node groups is not supported. Please file a request on GitHub to add this support if needed.");
    }
    /**
     * @override
     */
    createCluster(scope, vpc, secretsEncryptionKey, kubernetesVersion) {
        var _a, _b, _c, _d, _e, _f, _g;
        const id = scope.node.id;
        // Props for the cluster.
        const clusterName = (_a = this.props.clusterName) !== null && _a !== void 0 ? _a : id;
        const outputClusterName = true;
        if (!kubernetesVersion && !this.props.version) {
            throw new Error("Version was not specified by cluster builder or in cluster provider props, must be specified in one of these");
        }
        const version = kubernetesVersion || this.props.version || eks.KubernetesVersion.V1_27;
        const privateCluster = (_b = this.props.privateCluster) !== null && _b !== void 0 ? _b : utils.valueFromContext(scope, constants.PRIVATE_CLUSTER, false);
        const endpointAccess = (privateCluster === true) ? eks.EndpointAccess.PRIVATE : eks.EndpointAccess.PUBLIC_AND_PRIVATE;
        const vpcSubnets = (_c = this.props.vpcSubnets) !== null && _c !== void 0 ? _c : (privateCluster === true ? [{ subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS }] : undefined);
        const mastersRole = (_d = this.props.mastersRole) !== null && _d !== void 0 ? _d : new aws_iam_1.Role(scope, `${clusterName}-AccessRole`, {
            assumedBy: new aws_iam_1.AccountRootPrincipal()
        });
        const kubectlLayer = this.getKubectlLayer(scope, version);
        const tags = this.props.tags;
        const defaultOptions = {
            vpc,
            secretsEncryptionKey,
            clusterName,
            outputClusterName,
            version,
            vpcSubnets,
            endpointAccess,
            kubectlLayer,
            tags,
            mastersRole,
            defaultCapacity: 0 // we want to manage capacity ourselves
        };
        const clusterOptions = { ...defaultOptions, ...this.props };
        // Create an EKS Cluster
        const cluster = this.internalCreateCluster(scope, id, clusterOptions);
        cluster.node.addDependency(vpc);
        const nodeGroups = [];
        (_e = this.props.managedNodeGroups) === null || _e === void 0 ? void 0 : _e.forEach(n => {
            const nodeGroup = this.addManagedNodeGroup(cluster, n);
            nodeGroups.push(nodeGroup);
        });
        const autoscalingGroups = [];
        (_f = this.props.autoscalingNodeGroups) === null || _f === void 0 ? void 0 : _f.forEach(n => {
            const autoscalingGroup = this.addAutoScalingGroup(cluster, n);
            autoscalingGroups.push(autoscalingGroup);
        });
        const fargateProfiles = Object.entries((_g = this.props.fargateProfiles) !== null && _g !== void 0 ? _g : {});
        const fargateConstructs = [];
        fargateProfiles === null || fargateProfiles === void 0 ? void 0 : fargateProfiles.forEach(([key, options]) => fargateConstructs.push(this.addFargateProfile(cluster, key, options)));
        return new spi_1.ClusterInfo(cluster, version, nodeGroups, autoscalingGroups, fargateConstructs);
    }
    /**
     * Template method that may be overridden by subclasses to create a specific cluster flavor (e.g. FargateCluster vs eks.Cluster)
     * @param scope
     * @param id
     * @param clusterOptions
     * @returns
     */
    internalCreateCluster(scope, id, clusterOptions) {
        return new eks.Cluster(scope, id, clusterOptions);
    }
    /**
     * Can be overridden to provide a custom kubectl layer.
     * @param scope
     * @param version
     * @returns
     */
    getKubectlLayer(scope, version) {
        return selectKubectlLayer(scope, version);
    }
    /**
     * Adds an autoscaling group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addAutoScalingGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g;
        const machineImageType = (_a = nodeGroup.machineImageType) !== null && _a !== void 0 ? _a : eks.MachineImageType.AMAZON_LINUX_2;
        const instanceTypeContext = utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const instanceType = (_b = nodeGroup.instanceType) !== null && _b !== void 0 ? _b : (typeof instanceTypeContext === 'string' ? new ec2.InstanceType(instanceTypeContext) : instanceTypeContext);
        const minSize = (_c = nodeGroup.minSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_d = nodeGroup.maxSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_e = nodeGroup.desiredSize) !== null && _e !== void 0 ? _e : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        const updatePolicy = (_f = nodeGroup.updatePolicy) !== null && _f !== void 0 ? _f : autoscaling.UpdatePolicy.rollingUpdate();
        // Create an autoscaling group
        return cluster.addAutoScalingGroupCapacity(nodeGroup.id, {
            ...nodeGroup,
            ...{
                autoScalingGroupName: (_g = nodeGroup.autoScalingGroupName) !== null && _g !== void 0 ? _g : nodeGroup.id,
                machineImageType,
                instanceType,
                minCapacity: minSize,
                maxCapacity: maxSize,
                desiredCapacity: desiredSize,
                updatePolicy,
                vpcSubnets: nodeGroup.nodeGroupSubnets,
            }
        });
    }
    /**
     * Adds a fargate profile to the cluster
     */
    addFargateProfile(cluster, name, profileOptions) {
        return cluster.addFargateProfile(name, profileOptions);
    }
    /**
     * Adds a managed node group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addManagedNodeGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
        const capacityType = nodeGroup.nodeGroupCapacityType;
        const releaseVersion = nodeGroup.amiReleaseVersion;
        const instanceTypeContext = utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const instanceTypes = (_a = nodeGroup.instanceTypes) !== null && _a !== void 0 ? _a : ([typeof instanceTypeContext === 'string' ? new ec2.InstanceType(instanceTypeContext) : instanceTypeContext]);
        const minSize = (_b = nodeGroup.minSize) !== null && _b !== void 0 ? _b : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_c = nodeGroup.maxSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_d = nodeGroup.desiredSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        // Create a managed node group.
        const nodegroupOptions = {
            ...nodeGroup,
            ...{
                nodegroupName: (_e = nodeGroup.nodegroupName) !== null && _e !== void 0 ? _e : nodeGroup.id,
                capacityType,
                instanceTypes,
                minSize,
                maxSize,
                desiredSize,
                releaseVersion,
                subnets: nodeGroup.nodeGroupSubnets
            }
        };
        if (nodeGroup.launchTemplate) {
            // Create launch template with provided launch template properties
            const lt = new ec2.LaunchTemplate(cluster, `${nodeGroup.id}-lt`, {
                blockDevices: nodeGroup.launchTemplate.blockDevices,
                machineImage: (_f = nodeGroup.launchTemplate) === null || _f === void 0 ? void 0 : _f.machineImage,
                securityGroup: nodeGroup.launchTemplate.securityGroup,
                userData: (_g = nodeGroup.launchTemplate) === null || _g === void 0 ? void 0 : _g.userData,
                requireImdsv2: (_h = nodeGroup.launchTemplate) === null || _h === void 0 ? void 0 : _h.requireImdsv2,
            });
            utils.setPath(nodegroupOptions, "launchTemplateSpec", {
                id: lt.launchTemplateId,
                version: lt.latestVersionNumber,
            });
            const tags = Object.entries((_j = nodeGroup.launchTemplate.tags) !== null && _j !== void 0 ? _j : {});
            tags.forEach(([key, options]) => aws_cdk_lib_1.Tags.of(lt).add(key, options));
            if ((_k = nodeGroup.launchTemplate) === null || _k === void 0 ? void 0 : _k.machineImage) {
                delete nodegroupOptions.amiType;
                delete nodegroupOptions.releaseVersion;
                delete nodeGroup.amiReleaseVersion;
            }
        }
        const result = cluster.addNodegroupCapacity(nodeGroup.id + "-ng", nodegroupOptions);
        if (nodeGroup.enableSsmPermissions) {
            result.role.addManagedPolicy(aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore'));
        }
        return result;
    }
    validateInput(props) {
        utils.validateConstraints(new GenericClusterPropsConstraints, GenericClusterProvider.name, props);
        if (props.managedNodeGroups != undefined)
            utils.validateConstraints(new ManagedNodeGroupConstraints, "ManagedNodeGroup", ...props.managedNodeGroups);
        if (props.autoscalingNodeGroups != undefined)
            utils.validateConstraints(new AutoscalingNodeGroupConstraints, "AutoscalingNodeGroups", ...props.autoscalingNodeGroups);
        if (props.fargateProfiles != undefined)
            utils.validateConstraints(new FargateProfileConstraints, "FargateProfiles", ...Object.values(props.fargateProfiles));
    }
}
exports.GenericClusterProvider = GenericClusterProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJpYy1jbHVzdGVyLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsdXN0ZXItcHJvdmlkZXJzL2dlbmVyaWMtY2x1c3Rlci1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxnRkFBb0U7QUFDcEUsZ0ZBQW9FO0FBQ3BFLGdGQUFvRTtBQUNwRSxnRkFBb0U7QUFDcEUsZ0ZBQW9FO0FBQ3BFLDZDQUFtQztBQUNuQywyREFBMkQ7QUFDM0QsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyxpREFBZ0Y7QUFJaEYsZ0NBQXNEO0FBQ3RELGtDQUFrQztBQUNsQyx5Q0FBeUM7QUFFekMsaUNBQWtDO0FBRWxDLFNBQWdCLGNBQWM7SUFDMUIsT0FBTyxJQUFJLGNBQWMsRUFBRSxDQUFDO0FBQ2hDLENBQUM7QUFGRCx3Q0FFQztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBZ0Isa0JBQWtCLENBQUMsS0FBZ0IsRUFBRSxPQUE4QjtJQUMvRSxRQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUU7UUFDcEIsS0FBSyxNQUFNO1lBQ1AsT0FBTyxJQUFJLDBDQUFlLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsS0FBSyxNQUFNO1lBQ1AsT0FBTyxJQUFJLDBDQUFlLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsS0FBSyxNQUFNO1lBQ1AsT0FBTyxJQUFJLDBDQUFlLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsS0FBSyxNQUFNO1lBQ1AsT0FBTyxJQUFJLDBDQUFlLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsS0FBSyxNQUFNO1lBQ1AsT0FBTyxJQUFJLDBDQUFlLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7S0FDM0Q7SUFFRCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxH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c0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEcsSUFBSSxLQUFLLENBQUMsaUJBQWlCLElBQUksU0FBUztZQUNwQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSwyQkFBMkIsRUFBRSxrQkFBa0IsRUFBRSxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQy9HLElBQUksS0FBSyxDQUFDLHFCQUFxQixJQUFJLFNBQVM7WUFDeEMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksK0JBQStCLEVBQUUsdUJBQXVCLEVBQUUsR0FBRyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUM1SCxJQUFJLEtBQUssQ0FBQyxlQUFzQixJQUFJLFNBQVM7WUFDekMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUkseUJBQXlCLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFzQixDQUFDLENBQUMsQ0FBQztJQUNwSSxDQUFDO0NBQ0o7QUE1TUQsd0RBNE1DIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBLdWJlY3RsVjIzTGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjIzXCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI0TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI0XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI1TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI1XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI2TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI2XCI7XG5pbXBvcnQgeyBLdWJlY3RsVjI3TGF5ZXIgfSBmcm9tIFwiQGF3cy1jZGsvbGFtYmRhLWxheWVyLWt1YmVjdGwtdjI3XCI7XG5pbXBvcnQgeyBUYWdzIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBhdXRvc2NhbGluZyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXV0b3NjYWxpbmcnO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWMyXCI7XG5pbXBvcnQgKiBhcyBla3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbmltcG9ydCB7IEFjY291bnRSb290UHJpbmNpcGFsLCBNYW5hZ2VkUG9saWN5LCBSb2xlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7IElLZXkgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWttc1wiO1xuaW1wb3J0IHsgSUxheWVyVmVyc2lvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIENsdXN0ZXJQcm92aWRlciB9IGZyb20gXCIuLi9zcGlcIjtcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gXCIuLi91dGlsc1wiO1xuaW1wb3J0ICogYXMgY29uc3RhbnRzIGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IEF1dG9zY2FsaW5nTm9kZUdyb3VwLCBNYW5hZ2VkTm9kZUdyb3VwIH0gZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNsdXN0ZXJCdWlsZGVyKCkge1xuICAgIHJldHVybiBuZXcgQ2x1c3RlckJ1aWxkZXIoKTtcbn1cblxuLyoqXG4gKiBGdW5jdGlvbiB0aGF0IGNvbnRhaW5zIGxvZ2ljIHRvIG1hcCB0aGUgY29ycmVjdCBrdW5iZWN0bCBsYXllciBiYXNlZCBvbiB0aGUgcGFzc2VkIGluIHZlcnNpb24uIFxuICogQHBhcmFtIHNjb3BlIGluIHdoY2ggdGhlIGt1YmVjdGwgbGF5ZXIgbXVzdCBiZSBjcmVhdGVkXG4gKiBAcGFyYW0gdmVyc2lvbiBFS1MgdmVyc2lvblxuICogQHJldHVybnMgSUxheWVyVmVyc2lvbiBvciB1bmRlZmluZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdEt1YmVjdGxMYXllcihzY29wZTogQ29uc3RydWN0LCB2ZXJzaW9uOiBla3MuS3ViZXJuZXRlc1ZlcnNpb24pOiBJTGF5ZXJWZXJzaW9uIHwgdW5kZWZpbmVkIHtcbiAgICBzd2l0Y2godmVyc2lvbi52ZXJzaW9uKSB7XG4gICAgICAgIGNhc2UgXCIxLjIzXCI6XG4gICAgICAgICAgICByZXR1cm4gbmV3IEt1YmVjdGxWMjNMYXllcihzY29wZSwgXCJrdWJlY3RsbGF5ZXIyM1wiKTtcbiAgICAgICAgY2FzZSBcIjEuMjRcIjpcbiAgICAgICAgICAgIHJldHVybiBuZXcgS3ViZWN0bFYyNExheWVyKHNjb3BlLCBcImt1YmVjdGxsYXllcjI0XCIpO1xuICAgICAgICBjYXNlIFwiMS4yNVwiOlxuICAgICAgICAgICAgcmV0dXJuIG5ldyBLdWJlY3RsVjI1TGF5ZXIoc2NvcGUsIFwia3ViZWN0bGxheWVyMjVcIik7XG4gICAgICAgIGNhc2UgXCIxLjI2XCI6XG4gICAgICAgICAgICByZXR1cm4gbmV3IEt1YmVjdGxWMjZMYXllcihzY29wZSwgXCJrdWJlY3RsbGF5ZXIyNlwiKTtcbiAgICAgICAgY2FzZSBcIjEuMjdcIjpcbiAgICAgICAgICAgIHJldHVybiBuZXcgS3ViZWN0bFYyN0xheWVyKHNjb3BlLCBcImt1YmVjdGxsYXllcjI3XCIpO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBtaW5vciA9IHZlcnNpb24udmVyc2lvbi5zcGxpdCgnLicpWzFdO1xuXG4gICAgaWYobWlub3IgJiYgcGFyc2VJbnQobWlub3IsIDEwKSA+IDI3KSB7XG4gICAgICAgIHJldHVybiBuZXcgS3ViZWN0bFYyN0xheWVyKHNjb3BlLCBcImt1YmVjdGxsYXllcjI3XCIpOyAvLyBmb3IgYWxsIHZlcnNpb25zIGFib3ZlIDEuMjcgdXNlIDEuMjcga3ViZWN0bCAodW5sZXNzIGV4cGxpY2l0bHkgc3VwcG9ydGVkIGluIENESylcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbi8qKlxuICogUHJvcGVydGllcyBmb3IgdGhlIGdlbmVyaWMgY2x1c3RlciBwcm92aWRlciwgY29udGFpbmluZyBkZWZpbml0aW9ucyBvZiBtYW5hZ2VkIG5vZGUgZ3JvdXBzLFxuICogYXV0by1zY2FsaW5nIGdyb3VwcywgZmFyZ2F0ZSBwcm9maWxlcy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBHZW5lcmljQ2x1c3RlclByb3ZpZGVyUHJvcHMgZXh0ZW5kcyBQYXJ0aWFsPGVrcy5DbHVzdGVyT3B0aW9ucz4ge1xuXG4gICAgLyoqXG4gICAgICogV2hldGhlciBBUEkgc2VydmVyIGlzIHByaXZhdGUuXG4gICAgICovXG4gICAgcHJpdmF0ZUNsdXN0ZXI/OiBib29sZWFuLFxuXG4gICAgLyoqXG4gICAgICogQXJyYXkgb2YgbWFuYWdlZCBub2RlIGdyb3Vwcy5cbiAgICAgKi9cbiAgICBtYW5hZ2VkTm9kZUdyb3Vwcz86IE1hbmFnZWROb2RlR3JvdXBbXTtcblxuICAgIC8qKlxuICAgICAqIEFycmF5IG9mIGF1dG9zY2FsaW5nIG5vZGUgZ3JvdXBzLlxuICAgICAqL1xuICAgIGF1dG9zY2FsaW5nTm9kZUdyb3Vwcz86IEF1dG9zY2FsaW5nTm9kZUdyb3VwW107XG5cbiAgICAvKipcbiAgICAgKiBGYXJnYXRlIHByb2ZpbGVzXG4gICAgICovXG4gICAgZmFyZ2F0ZVByb2ZpbGVzPzoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRhZ3MgZm9yIHRoZSBjbHVzdGVyXG4gICAgICovXG4gICAgdGFncz86IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIE1hbmFnZWROb2RlR3JvdXBDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxNYW5hZ2VkTm9kZUdyb3VwPiB7XG4gICAgLyoqXG4gICAgICogaWQgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZyBkdWUgdG8gRE5TIHN5c3RlbSBsaW1pdGF0aW9ucy5cbiAgICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9jb25jZXB0cy9vdmVydmlldy93b3JraW5nLXdpdGgtb2JqZWN0cy9uYW1lcy9cbiAgICAgKi9cbiAgICBpZCA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcblxuICAgIC8qKlxuICAgICogbm9kZXMgcGVyIG5vZGUgZ3JvdXAgaGFzIGEgc29mdCBsaW1pdCBvZiA0NTAgbm9kZXMsIGFuZCBhcyBsaXR0bGUgYXMgMC4gQnV0IHdlIG11bHRpcGx5IHRoYXQgYnkgYSBmYWN0b3Igb2YgNSB0byAyMjUwIGluIGNhc2VcbiAgICAqIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkXG4gICAgKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vZWtzL2xhdGVzdC91c2VyZ3VpZGUvc2VydmljZS1xdW90YXMuaHRtbFxuICAgICovXG4gICAgbWluU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDIyNTApO1xuXG4gICAgLyoqXG4gICAgICogbm9kZXMgcGVyIG5vZGUgZ3JvdXAgaGFzIGEgc29mdCBsaW1pdCBvZiA0NTAgbm9kZXMsIGFuZCBhcyBsaXR0bGUgYXMgMC4gQnV0IHdlIG11bHRpcGx5IHRoYXQgYnkgYSBmYWN0b3Igb2YgNSB0byAyMjUwIGluIGNhc2VcbiAgICAgKiBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZFxuICAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9la3MvbGF0ZXN0L3VzZXJndWlkZS9zZXJ2aWNlLXF1b3Rhcy5odG1sXG4gICAgICovXG4gICAgbWF4U2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDIyNTApO1xuXG4gICAgLyoqXG4gICAgICogTm9kZXMgcGVyIG5vZGUgZ3JvdXAgaGFzIGEgc29mdCBsaW1pdCBvZiA0NTAgbm9kZXMsIGFuZCBhcyBsaXR0bGUgYXMgMC4gQnV0IHdlIG11bHRpcGx5IHRoYXQgYnkgYSBmYWN0b3Igb2YgNSB0byAyMjUwIGluIGNhc2VcbiAgICAgKiBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZFxuICAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9la3MvbGF0ZXN0L3VzZXJndWlkZS9zZXJ2aWNlLXF1b3Rhcy5odG1sXG4gICAgICovXG4gICAgZGVzaXJlZFNpemUgPSBuZXcgdXRpbHMuTnVtYmVyQ29uc3RyYWludCgwLCAyMjUwKTtcblxuICAgIC8qKlxuICAgICAqIGFtaVJlbGVhc2VWZXJzaW9uIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiAxMDI0IGNoYXJhY3RlcnMgbG9uZy5cbiAgICAgKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vaW1hZ2VidWlsZGVyL2xhdGVzdC9BUElSZWZlcmVuY2UvQVBJX0FtaS5odG1sXG4gICAgICovXG4gICAgYW1pUmVsZWFzZVZlcnNpb24gPSBuZXcgdXRpbHMuU3RyaW5nQ29uc3RyYWludCgxLCAxMDI0KTtcbn1cblxuZXhwb3J0IGNsYXNzIEF1dG9zY2FsaW5nTm9kZUdyb3VwQ29uc3RyYWludHMgaW1wbGVtZW50cyB1dGlscy5Db25zdHJhaW50c1R5cGU8QXV0b3NjYWxpbmdOb2RlR3JvdXA+IHtcbiAgICAvKipcbiAgICAqIGlkIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiA2MyBjaGFyYWN0ZXJzIGxvbmcgZHVlIHRvIEROUyBzeXN0ZW0gbGltaXRhdGlvbnMuXG4gICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9jb25jZXB0cy9vdmVydmlldy93b3JraW5nLXdpdGgtb2JqZWN0cy9uYW1lcy9cbiAgICAqL1xuICAgIGlkID0gbmV3IHV0aWxzLlN0cmluZ0NvbnN0cmFpbnQoMSwgNjMpO1xuXG4gICAgLyoqXG4gICAgKiBBbGxvd2VkIHJhbmdlIGlzIDAgdG8gNTAwMCBpbmNsdXNpdmUuXG4gICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9zZXR1cC9iZXN0LXByYWN0aWNlcy9jbHVzdGVyLWxhcmdlL1xuICAgICovXG4gICAgbWluU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDUwMDApO1xuXG4gICAgLyoqXG4gICAgKiBBbGxvd2VkIHJhbmdlIGlzIDAgdG8gNTAwMCBpbmNsdXNpdmUuXG4gICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9zZXR1cC9iZXN0LXByYWN0aWNlcy9jbHVzdGVyLWxhcmdlL1xuICAgICovXG4gICAgbWF4U2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDUwMDApO1xuXG4gICAgLyoqXG4gICAgKiBBbGxvd2VkIHJhbmdlIGlzIDAgdG8gNTAwMCBpbmNsdXNpdmUuXG4gICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9zZXR1cC9iZXN0LXByYWN0aWNlcy9jbHVzdGVyLWxhcmdlL1xuICAgICovXG4gICAgZGVzaXJlZFNpemUgPSBuZXcgdXRpbHMuTnVtYmVyQ29uc3RyYWludCgwLCA1MDAwKTtcbn1cblxuZXhwb3J0IGNsYXNzIEZhcmdhdGVQcm9maWxlQ29uc3RyYWludHMgaW1wbGVtZW50cyB1dGlscy5Db25zdHJhaW50c1R5cGU8ZWtzLkZhcmdhdGVQcm9maWxlT3B0aW9ucz4ge1xuICAgIC8qKlxuICAgICogZmFyZ2F0ZVByb2ZpbGVOYW1lcyBjYW4gYmUgbm8gbGVzcyB0aGFuIDEgY2hhcmFjdGVyIGxvbmcsIGFuZCBubyBncmVhdGVyIHRoYW4gNjMgY2hhcmFjdGVycyBsb25nIGR1ZSB0byBETlMgc3lzdGVtIGxpbWl0YXRpb25zLlxuICAgICogaHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd29ya2luZy13aXRoLW9iamVjdHMvbmFtZXMvXG4gICAgKi9cbiAgICBmYXJnYXRlUHJvZmlsZU5hbWUgPSBuZXcgdXRpbHMuU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG59XG5cbmV4cG9ydCBjbGFzcyBHZW5lcmljQ2x1c3RlclByb3BzQ29uc3RyYWludHMgaW1wbGVtZW50cyB1dGlscy5Db25zdHJhaW50c1R5cGU8R2VuZXJpY0NsdXN0ZXJQcm92aWRlclByb3BzPiB7XG4gICAgLyoqXG4gICAgKiBtYW5hZ2VkTm9kZUdyb3VwcyBwZXIgY2x1c3RlciBoYXZlIGEgc29mdCBsaW1pdCBvZiAzMCBtYW5hZ2VkIG5vZGUgZ3JvdXBzIHBlciBFS1MgY2x1c3RlciwgYW5kIGFzIGxpdHRsZSBhcyAwLiBCdXQgd2UgbXVsdGlwbHkgdGhhdFxuICAgICogYnkgYSBmYWN0b3Igb2YgNSB0byAxNTAgaW4gY2FzZSBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZC5cbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9la3MvbGF0ZXN0L3VzZXJndWlkZS9zZXJ2aWNlLXF1b3Rhcy5odG1sXG4gICAgKi9cbiAgICBtYW5hZ2VkTm9kZUdyb3VwcyA9IG5ldyB1dGlscy5BcnJheUNvbnN0cmFpbnQoMCwgMTUwKTtcbiAgICAvKipcbiAgICAqIGF1dG9zY2FsaW5nTm9kZUdyb3VwcyBwZXIgY2x1c3RlciBoYXZlIGEgc29mdCBsaW1pdCBvZiA1MDAgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMgcGVyIEVLUyBjbHVzdGVyLCBhbmQgYXMgbGl0dGxlIGFzIDAuIEJ1dCB3ZSBtdWx0aXBseSB0aGF0XG4gICAgKiBieSBhIGZhY3RvciBvZiA1IHRvIDI1MDAgaW4gY2FzZSBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZC5cbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hdXRvc2NhbGluZy9lYzIvdXNlcmd1aWRlL2VjMi1hdXRvLXNjYWxpbmctcXVvdGFzLmh0bWxcbiAgICAqL1xuICAgIGF1dG9zY2FsaW5nTm9kZUdyb3VwcyA9IG5ldyB1dGlscy5BcnJheUNvbnN0cmFpbnQoMCwgNTAwMCk7XG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgICB2ZXJzaW9uOiBla3MuS3ViZXJuZXRlc1ZlcnNpb24uVjFfMjVcbn07XG5cbmV4cG9ydCBjbGFzcyBDbHVzdGVyQnVpbGRlciB7XG5cbiAgICBwcml2YXRlIHByb3BzOiBQYXJ0aWFsPEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJQcm9wcz4gPSB7fTtcbiAgICBwcml2YXRlIHByaXZhdGVDbHVzdGVyID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBtYW5hZ2VkTm9kZUdyb3VwczogTWFuYWdlZE5vZGVHcm91cFtdID0gW107XG4gICAgcHJpdmF0ZSBhdXRvc2NhbGluZ05vZGVHcm91cHM6IEF1dG9zY2FsaW5nTm9kZUdyb3VwW10gPSBbXTtcbiAgICBwcml2YXRlIGZhcmdhdGVQcm9maWxlczoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zO1xuICAgIH0gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IHZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbi5WMV8yNSB9IH07XG4gICAgfVxuXG4gICAgd2l0aENvbW1vbk9wdGlvbnMob3B0aW9uczogUGFydGlhbDxla3MuQ2x1c3Rlck9wdGlvbnM+KTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLm9wdGlvbnMgfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgbWFuYWdlZE5vZGVHcm91cCguLi5ub2RlR3JvdXBzOiBNYW5hZ2VkTm9kZUdyb3VwW10pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5tYW5hZ2VkTm9kZUdyb3VwcyA9IHRoaXMubWFuYWdlZE5vZGVHcm91cHMuY29uY2F0KG5vZGVHcm91cHMpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhdXRvc2NhbGluZ0dyb3VwKC4uLm5vZGVHcm91cHM6IEF1dG9zY2FsaW5nTm9kZUdyb3VwW10pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5hdXRvc2NhbGluZ05vZGVHcm91cHMgPSB0aGlzLmF1dG9zY2FsaW5nTm9kZUdyb3Vwcy5jb25jYXQobm9kZUdyb3Vwcyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGZhcmdhdGVQcm9maWxlKG5hbWU6IHN0cmluZywgb3B0aW9uczogZWtzLkZhcmdhdGVQcm9maWxlT3B0aW9ucyk6IHRoaXMge1xuICAgICAgICB0aGlzLmZhcmdhdGVQcm9maWxlc1tuYW1lXSA9IG9wdGlvbnM7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGJ1aWxkKCkge1xuICAgICAgICByZXR1cm4gbmV3IEdlbmVyaWNDbHVzdGVyUHJvdmlkZXIoe1xuICAgICAgICAgICAgLi4udGhpcy5wcm9wcyxcbiAgICAgICAgICAgIHZlcnNpb246IHRoaXMucHJvcHMudmVyc2lvbixcbiAgICAgICAgICAgIHByaXZhdGVDbHVzdGVyOiB0aGlzLnByaXZhdGVDbHVzdGVyLFxuICAgICAgICAgICAgbWFuYWdlZE5vZGVHcm91cHM6IHRoaXMubWFuYWdlZE5vZGVHcm91cHMsXG4gICAgICAgICAgICBhdXRvc2NhbGluZ05vZGVHcm91cHM6IHRoaXMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzLFxuICAgICAgICAgICAgZmFyZ2F0ZVByb2ZpbGVzOiB0aGlzLmZhcmdhdGVQcm9maWxlc1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbi8qKlxuICogQ2x1c3RlciBwcm92aWRlciBpbXBsZW1lbnRhdGlvbiB0aGF0IHN1cHBvcnRzIG11bHRpcGxlIG5vZGUgZ3JvdXBzLlxuICovXG5leHBvcnQgY2xhc3MgR2VuZXJpY0NsdXN0ZXJQcm92aWRlciBpbXBsZW1lbnRzIENsdXN0ZXJQcm92aWRlciB7XG5cbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSBwcm9wczogR2VuZXJpY0NsdXN0ZXJQcm92aWRlclByb3BzKSB7XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUlucHV0KHByb3BzKTtcblxuICAgICAgICBhc3NlcnQoIShwcm9wcy5tYW5hZ2VkTm9kZUdyb3VwcyAmJiBwcm9wcy5tYW5hZ2VkTm9kZUdyb3Vwcy5sZW5ndGggPiAwXG4gICAgICAgICAgICAmJiBwcm9wcy5hdXRvc2NhbGluZ05vZGVHcm91cHMgJiYgcHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzLmxlbmd0aCA+IDApLFxuICAgICAgICAgICAgXCJNaXhpbmcgbWFuYWdlZCBhbmQgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIGZpbGUgYSByZXF1ZXN0IG9uIEdpdEh1YiB0byBhZGQgdGhpcyBzdXBwb3J0IGlmIG5lZWRlZC5cIik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG92ZXJyaWRlXG4gICAgICovXG4gICAgY3JlYXRlQ2x1c3RlcihzY29wZTogQ29uc3RydWN0LCB2cGM6IGVjMi5JVnBjLCBzZWNyZXRzRW5jcnlwdGlvbktleTogSUtleSB8IHVuZGVmaW5lZCwga3ViZXJuZXRlc1ZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbiB8IHVuZGVmaW5lZCk6IENsdXN0ZXJJbmZvIHtcbiAgICAgICAgY29uc3QgaWQgPSBzY29wZS5ub2RlLmlkO1xuXG4gICAgICAgIC8vIFByb3BzIGZvciB0aGUgY2x1c3Rlci5cbiAgICAgICAgY29uc3QgY2x1c3Rlck5hbWUgPSB0aGlzLnByb3BzLmNsdXN0ZXJOYW1lID8/IGlkO1xuICAgICAgICBjb25zdCBvdXRwdXRDbHVzdGVyTmFtZSA9IHRydWU7XG4gICAgICAgIGlmKCFrdWJlcm5ldGVzVmVyc2lvbiAmJiAhdGhpcy5wcm9wcy52ZXJzaW9uKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJWZXJzaW9uIHdhcyBub3Qgc3BlY2lmaWVkIGJ5IGNsdXN0ZXIgYnVpbGRlciBvciBpbiBjbHVzdGVyIHByb3ZpZGVyIHByb3BzLCBtdXN0IGJlIHNwZWNpZmllZCBpbiBvbmUgb2YgdGhlc2VcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uID0ga3ViZXJuZXRlc1ZlcnNpb24gfHwgdGhpcy5wcm9wcy52ZXJzaW9uIHx8IGVrcy5LdWJlcm5ldGVzVmVyc2lvbi5WMV8yNztcblxuICAgICAgICBjb25zdCBwcml2YXRlQ2x1c3RlciA9IHRoaXMucHJvcHMucHJpdmF0ZUNsdXN0ZXIgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChzY29wZSwgY29uc3RhbnRzLlBSSVZBVEVfQ0xVU1RFUiwgZmFsc2UpO1xuICAgICAgICBjb25zdCBlbmRwb2ludEFjY2VzcyA9IChwcml2YXRlQ2x1c3RlciA9PT0gdHJ1ZSkgPyBla3MuRW5kcG9pbnRBY2Nlc3MuUFJJVkFURSA6IGVrcy5FbmRwb2ludEFjY2Vzcy5QVUJMSUNfQU5EX1BSSVZBVEU7XG4gICAgICAgIGNvbnN0IHZwY1N1Ym5ldHMgPSB0aGlzLnByb3BzLnZwY1N1Ym5ldHMgPz8gKHByaXZhdGVDbHVzdGVyID09PSB0cnVlID8gW3sgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX0VHUkVTUyB9XSA6IHVuZGVmaW5lZCk7XG4gICAgICAgIGNvbnN0IG1hc3RlcnNSb2xlID0gdGhpcy5wcm9wcy5tYXN0ZXJzUm9sZSA/PyBuZXcgUm9sZShzY29wZSwgYCR7Y2x1c3Rlck5hbWV9LUFjY2Vzc1JvbGVgLCB7XG4gICAgICAgICAgICBhc3N1bWVkQnk6IG5ldyBBY2NvdW50Um9vdFByaW5jaXBhbCgpIFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBrdWJlY3RsTGF5ZXIgPSB0aGlzLmdldEt1YmVjdGxMYXllcihzY29wZSwgdmVyc2lvbik7XG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLnByb3BzLnRhZ3M7XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbnM6IFBhcnRpYWw8ZWtzLkNsdXN0ZXJQcm9wcz4gPSB7XG4gICAgICAgICAgICB2cGMsXG4gICAgICAgICAgICBzZWNyZXRzRW5jcnlwdGlvbktleSxcbiAgICAgICAgICAgIGNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgb3V0cHV0Q2x1c3Rlck5hbWUsXG4gICAgICAgICAgICB2ZXJzaW9uLFxuICAgICAgICAgICAgdnBjU3VibmV0cyxcbiAgICAgICAgICAgIGVuZHBvaW50QWNjZXNzLFxuICAgICAgICAgICAga3ViZWN0bExheWVyLFxuICAgICAgICAgICAgdGFncyxcbiAgICAgICAgICAgIG1hc3RlcnNSb2xlLFxuICAgICAgICAgICAgZGVmYXVsdENhcGFjaXR5OiAwIC8vIHdlIHdhbnQgdG8gbWFuYWdlIGNhcGFjaXR5IG91cnNlbHZlc1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJPcHRpb25zID0geyAuLi5kZWZhdWx0T3B0aW9ucywgLi4udGhpcy5wcm9wcyB9O1xuICAgICAgICAvLyBDcmVhdGUgYW4gRUtTIENsdXN0ZXJcbiAgICAgICAgY29uc3QgY2x1c3RlciA9IHRoaXMuaW50ZXJuYWxDcmVhdGVDbHVzdGVyKHNjb3BlLCBpZCwgY2x1c3Rlck9wdGlvbnMpO1xuICAgICAgICBjbHVzdGVyLm5vZGUuYWRkRGVwZW5kZW5jeSh2cGMpO1xuXG4gICAgICAgIGNvbnN0IG5vZGVHcm91cHM6IGVrcy5Ob2RlZ3JvdXBbXSA9IFtdO1xuXG4gICAgICAgIHRoaXMucHJvcHMubWFuYWdlZE5vZGVHcm91cHM/LmZvckVhY2gobiA9PiB7XG4gICAgICAgICAgICBjb25zdCBub2RlR3JvdXAgPSB0aGlzLmFkZE1hbmFnZWROb2RlR3JvdXAoY2x1c3Rlciwgbik7XG4gICAgICAgICAgICBub2RlR3JvdXBzLnB1c2gobm9kZUdyb3VwKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgYXV0b3NjYWxpbmdHcm91cHM6IGF1dG9zY2FsaW5nLkF1dG9TY2FsaW5nR3JvdXBbXSA9IFtdO1xuICAgICAgICB0aGlzLnByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3Vwcz8uZm9yRWFjaChuID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGF1dG9zY2FsaW5nR3JvdXAgPSB0aGlzLmFkZEF1dG9TY2FsaW5nR3JvdXAoY2x1c3Rlciwgbik7XG4gICAgICAgICAgICBhdXRvc2NhbGluZ0dyb3Vwcy5wdXNoKGF1dG9zY2FsaW5nR3JvdXApO1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBmYXJnYXRlUHJvZmlsZXMgPSBPYmplY3QuZW50cmllcyh0aGlzLnByb3BzLmZhcmdhdGVQcm9maWxlcyA/PyB7fSk7XG4gICAgICAgIGNvbnN0IGZhcmdhdGVDb25zdHJ1Y3RzIDogZWtzLkZhcmdhdGVQcm9maWxlW10gPSBbXTtcbiAgICAgICAgZmFyZ2F0ZVByb2ZpbGVzPy5mb3JFYWNoKChba2V5LCBvcHRpb25zXSkgPT4gZmFyZ2F0ZUNvbnN0cnVjdHMucHVzaCh0aGlzLmFkZEZhcmdhdGVQcm9maWxlKGNsdXN0ZXIsIGtleSwgb3B0aW9ucykpKTtcblxuICAgICAgICByZXR1cm4gbmV3IENsdXN0ZXJJbmZvKGNsdXN0ZXIsIHZlcnNpb24sIG5vZGVHcm91cHMsIGF1dG9zY2FsaW5nR3JvdXBzLCBmYXJnYXRlQ29uc3RydWN0cyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGVtcGxhdGUgbWV0aG9kIHRoYXQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgc3ViY2xhc3NlcyB0byBjcmVhdGUgYSBzcGVjaWZpYyBjbHVzdGVyIGZsYXZvciAoZS5nLiBGYXJnYXRlQ2x1c3RlciB2cyBla3MuQ2x1c3RlcilcbiAgICAgKiBAcGFyYW0gc2NvcGVcbiAgICAgKiBAcGFyYW0gaWRcbiAgICAgKiBAcGFyYW0gY2x1c3Rlck9wdGlvbnNcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBpbnRlcm5hbENyZWF0ZUNsdXN0ZXIoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgY2x1c3Rlck9wdGlvbnM6IGFueSk6IGVrcy5DbHVzdGVyIHtcbiAgICAgICAgcmV0dXJuIG5ldyBla3MuQ2x1c3RlcihzY29wZSwgaWQsIGNsdXN0ZXJPcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYW4gYmUgb3ZlcnJpZGRlbiB0byBwcm92aWRlIGEgY3VzdG9tIGt1YmVjdGwgbGF5ZXIuIFxuICAgICAqIEBwYXJhbSBzY29wZSBcbiAgICAgKiBAcGFyYW0gdmVyc2lvbiBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgZ2V0S3ViZWN0bExheWVyKHNjb3BlOiBDb25zdHJ1Y3QsIHZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbikgOiBJTGF5ZXJWZXJzaW9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICByZXR1cm4gc2VsZWN0S3ViZWN0bExheWVyKHNjb3BlLCB2ZXJzaW9uKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGFuIGF1dG9zY2FsaW5nIGdyb3VwIHRvIHRoZSBjbHVzdGVyLlxuICAgICAqIEBwYXJhbSBjbHVzdGVyXG4gICAgICogQHBhcmFtIG5vZGVHcm91cFxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgYWRkQXV0b1NjYWxpbmdHcm91cChjbHVzdGVyOiBla3MuQ2x1c3Rlciwgbm9kZUdyb3VwOiBBdXRvc2NhbGluZ05vZGVHcm91cCk6IGF1dG9zY2FsaW5nLkF1dG9TY2FsaW5nR3JvdXAge1xuICAgICAgICBjb25zdCBtYWNoaW5lSW1hZ2VUeXBlID0gbm9kZUdyb3VwLm1hY2hpbmVJbWFnZVR5cGUgPz8gZWtzLk1hY2hpbmVJbWFnZVR5cGUuQU1BWk9OX0xJTlVYXzI7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlVHlwZUNvbnRleHQgPSB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5JTlNUQU5DRV9UWVBFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfSU5TVEFOQ0VfVFlQRSk7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlVHlwZSA9IG5vZGVHcm91cC5pbnN0YW5jZVR5cGUgPz8gKHR5cGVvZiBpbnN0YW5jZVR5cGVDb250ZXh0ID09PSAnc3RyaW5nJyA/IG5ldyBlYzIuSW5zdGFuY2VUeXBlKGluc3RhbmNlVHlwZUNvbnRleHQpIDogaW5zdGFuY2VUeXBlQ29udGV4dCk7XG4gICAgICAgIGNvbnN0IG1pblNpemUgPSBub2RlR3JvdXAubWluU2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5NSU5fU0laRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX05HX01JTlNJWkUpO1xuICAgICAgICBjb25zdCBtYXhTaXplID0gbm9kZUdyb3VwLm1heFNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuTUFYX1NJWkVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9OR19NQVhTSVpFKTtcbiAgICAgICAgY29uc3QgZGVzaXJlZFNpemUgPSBub2RlR3JvdXAuZGVzaXJlZFNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuREVTSVJFRF9TSVpFX0tFWSwgbWluU2l6ZSk7XG4gICAgICAgIGNvbnN0IHVwZGF0ZVBvbGljeSA9IG5vZGVHcm91cC51cGRhdGVQb2xpY3kgPz8gYXV0b3NjYWxpbmcuVXBkYXRlUG9saWN5LnJvbGxpbmdVcGRhdGUoKTtcblxuICAgICAgICAvLyBDcmVhdGUgYW4gYXV0b3NjYWxpbmcgZ3JvdXBcbiAgICAgICAgcmV0dXJuIGNsdXN0ZXIuYWRkQXV0b1NjYWxpbmdHcm91cENhcGFjaXR5KG5vZGVHcm91cC5pZCwge1xuICAgICAgICAgICAgLi4ubm9kZUdyb3VwLFxuICAgICAgICAgICAgLi4uIHtcbiAgICAgICAgICAgICAgICBhdXRvU2NhbGluZ0dyb3VwTmFtZTogbm9kZUdyb3VwLmF1dG9TY2FsaW5nR3JvdXBOYW1lID8/IG5vZGVHcm91cC5pZCxcbiAgICAgICAgICAgICAgICBtYWNoaW5lSW1hZ2VUeXBlLFxuICAgICAgICAgICAgICAgIGluc3RhbmNlVHlwZSxcbiAgICAgICAgICAgICAgICBtaW5DYXBhY2l0eTogbWluU2l6ZSxcbiAgICAgICAgICAgICAgICBtYXhDYXBhY2l0eTogbWF4U2l6ZSxcbiAgICAgICAgICAgICAgICBkZXNpcmVkQ2FwYWNpdHk6IGRlc2lyZWRTaXplLFxuICAgICAgICAgICAgICAgIHVwZGF0ZVBvbGljeSxcbiAgICAgICAgICAgICAgICB2cGNTdWJuZXRzOiBub2RlR3JvdXAubm9kZUdyb3VwU3VibmV0cyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGZhcmdhdGUgcHJvZmlsZSB0byB0aGUgY2x1c3RlclxuICAgICAqL1xuICAgIGFkZEZhcmdhdGVQcm9maWxlKGNsdXN0ZXI6IGVrcy5DbHVzdGVyLCBuYW1lOiBzdHJpbmcsIHByb2ZpbGVPcHRpb25zOiBla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zKTogZWtzLkZhcmdhdGVQcm9maWxlIHtcbiAgICAgICAgcmV0dXJuIGNsdXN0ZXIuYWRkRmFyZ2F0ZVByb2ZpbGUobmFtZSwgcHJvZmlsZU9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBtYW5hZ2VkIG5vZGUgZ3JvdXAgdG8gdGhlIGNsdXN0ZXIuXG4gICAgICogQHBhcmFtIGNsdXN0ZXJcbiAgICAgKiBAcGFyYW0gbm9kZUdyb3VwXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBhZGRNYW5hZ2VkTm9kZUdyb3VwKGNsdXN0ZXI6IGVrcy5DbHVzdGVyLCBub2RlR3JvdXA6IE1hbmFnZWROb2RlR3JvdXApOiBla3MuTm9kZWdyb3VwIHtcbiAgICAgICAgY29uc3QgY2FwYWNpdHlUeXBlID0gbm9kZUdyb3VwLm5vZGVHcm91cENhcGFjaXR5VHlwZTtcbiAgICAgICAgY29uc3QgcmVsZWFzZVZlcnNpb24gPSBub2RlR3JvdXAuYW1pUmVsZWFzZVZlcnNpb247XG4gICAgICAgIGNvbnN0IGluc3RhbmNlVHlwZUNvbnRleHQgPSB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5JTlNUQU5DRV9UWVBFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfSU5TVEFOQ0VfVFlQRSk7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlVHlwZXMgPSBub2RlR3JvdXAuaW5zdGFuY2VUeXBlcyA/PyAoW3R5cGVvZiBpbnN0YW5jZVR5cGVDb250ZXh0ID09PSAnc3RyaW5nJyA/IG5ldyBlYzIuSW5zdGFuY2VUeXBlKGluc3RhbmNlVHlwZUNvbnRleHQpIDogaW5zdGFuY2VUeXBlQ29udGV4dF0pO1xuICAgICAgICBjb25zdCBtaW5TaXplID0gbm9kZUdyb3VwLm1pblNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuTUlOX1NJWkVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9OR19NSU5TSVpFKTtcbiAgICAgICAgY29uc3QgbWF4U2l6ZSA9IG5vZGVHcm91cC5tYXhTaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLk1BWF9TSVpFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfTkdfTUFYU0laRSk7XG4gICAgICAgIGNvbnN0IGRlc2lyZWRTaXplID0gbm9kZUdyb3VwLmRlc2lyZWRTaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLkRFU0lSRURfU0laRV9LRVksIG1pblNpemUpO1xuXG4gICAgICAgIC8vIENyZWF0ZSBhIG1hbmFnZWQgbm9kZSBncm91cC5cbiAgICAgICAgY29uc3Qgbm9kZWdyb3VwT3B0aW9uczogdXRpbHMuV3JpdGVhYmxlPGVrcy5Ob2RlZ3JvdXBPcHRpb25zPiA9IHtcbiAgICAgICAgICAgIC4uLm5vZGVHcm91cCxcbiAgICAgICAgICAgIC4uLntcbiAgICAgICAgICAgICAgICBub2RlZ3JvdXBOYW1lOiBub2RlR3JvdXAubm9kZWdyb3VwTmFtZSA/PyBub2RlR3JvdXAuaWQsXG4gICAgICAgICAgICAgICAgY2FwYWNpdHlUeXBlLFxuICAgICAgICAgICAgICAgIGluc3RhbmNlVHlwZXMsXG4gICAgICAgICAgICAgICAgbWluU2l6ZSxcbiAgICAgICAgICAgICAgICBtYXhTaXplLFxuICAgICAgICAgICAgICAgIGRlc2lyZWRTaXplLFxuICAgICAgICAgICAgICAgIHJlbGVhc2VWZXJzaW9uLFxuICAgICAgICAgICAgICAgIHN1Ym5ldHM6IG5vZGVHcm91cC5ub2RlR3JvdXBTdWJuZXRzXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKG5vZGVHcm91cC5sYXVuY2hUZW1wbGF0ZSkge1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGxhdW5jaCB0ZW1wbGF0ZSB3aXRoIHByb3ZpZGVkIGxhdW5jaCB0ZW1wbGF0ZSBwcm9wZXJ0aWVzXG4gICAgICAgICAgICBjb25zdCBsdCA9IG5ldyBlYzIuTGF1bmNoVGVtcGxhdGUoY2x1c3RlciwgYCR7bm9kZUdyb3VwLmlkfS1sdGAsIHtcbiAgICAgICAgICAgICAgICBibG9ja0RldmljZXM6IG5vZGVHcm91cC5sYXVuY2hUZW1wbGF0ZS5ibG9ja0RldmljZXMsXG4gICAgICAgICAgICAgICAgbWFjaGluZUltYWdlOiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGU/Lm1hY2hpbmVJbWFnZSxcbiAgICAgICAgICAgICAgICBzZWN1cml0eUdyb3VwOiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGUuc2VjdXJpdHlHcm91cCxcbiAgICAgICAgICAgICAgICB1c2VyRGF0YTogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlPy51c2VyRGF0YSxcbiAgICAgICAgICAgICAgICByZXF1aXJlSW1kc3YyOiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGU/LnJlcXVpcmVJbWRzdjIsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHV0aWxzLnNldFBhdGgobm9kZWdyb3VwT3B0aW9ucywgXCJsYXVuY2hUZW1wbGF0ZVNwZWNcIiwge1xuICAgICAgICAgICAgICAgIGlkOiBsdC5sYXVuY2hUZW1wbGF0ZUlkISxcbiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBsdC5sYXRlc3RWZXJzaW9uTnVtYmVyLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCB0YWdzID0gT2JqZWN0LmVudHJpZXMobm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlLnRhZ3MgPz8ge30pO1xuICAgICAgICAgICAgdGFncy5mb3JFYWNoKChba2V5LCBvcHRpb25zXSkgPT4gVGFncy5vZihsdCkuYWRkKGtleSxvcHRpb25zKSk7XG4gICAgICAgICAgICBpZiAobm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlPy5tYWNoaW5lSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgbm9kZWdyb3VwT3B0aW9ucy5hbWlUeXBlO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBub2RlZ3JvdXBPcHRpb25zLnJlbGVhc2VWZXJzaW9uO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBub2RlR3JvdXAuYW1pUmVsZWFzZVZlcnNpb247XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBjbHVzdGVyLmFkZE5vZGVncm91cENhcGFjaXR5KG5vZGVHcm91cC5pZCArIFwiLW5nXCIsIG5vZGVncm91cE9wdGlvbnMpO1xuXG4gICAgICAgIGlmKG5vZGVHcm91cC5lbmFibGVTc21QZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgcmVzdWx0LnJvbGUuYWRkTWFuYWdlZFBvbGljeShNYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnQW1hem9uU1NNTWFuYWdlZEluc3RhbmNlQ29yZScpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KHByb3BzOiBHZW5lcmljQ2x1c3RlclByb3ZpZGVyUHJvcHMpIHtcblxuICAgICAgICB1dGlscy52YWxpZGF0ZUNvbnN0cmFpbnRzKG5ldyBHZW5lcmljQ2x1c3RlclByb3BzQ29uc3RyYWludHMsIEdlbmVyaWNDbHVzdGVyUHJvdmlkZXIubmFtZSwgcHJvcHMpO1xuICAgICAgICBpZiAocHJvcHMubWFuYWdlZE5vZGVHcm91cHMgIT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgdXRpbHMudmFsaWRhdGVDb25zdHJhaW50cyhuZXcgTWFuYWdlZE5vZGVHcm91cENvbnN0cmFpbnRzLCBcIk1hbmFnZWROb2RlR3JvdXBcIiwgLi4ucHJvcHMubWFuYWdlZE5vZGVHcm91cHMpO1xuICAgICAgICBpZiAocHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEF1dG9zY2FsaW5nTm9kZUdyb3VwQ29uc3RyYWludHMsIFwiQXV0b3NjYWxpbmdOb2RlR3JvdXBzXCIsIC4uLnByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3Vwcyk7XG4gICAgICAgIGlmIChwcm9wcy5mYXJnYXRlUHJvZmlsZXMgYXMgYW55ICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEZhcmdhdGVQcm9maWxlQ29uc3RyYWludHMsIFwiRmFyZ2F0ZVByb2ZpbGVzXCIsIC4uLk9iamVjdC52YWx1ZXMocHJvcHMuZmFyZ2F0ZVByb2ZpbGVzIGFzIGFueSkpO1xuICAgIH1cbn1cbiJdfQ==