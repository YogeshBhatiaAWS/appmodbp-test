"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationStage = exports.CodePipelineStack = exports.CodePipelineBuilder = exports.DEFAULT_BUILD_POLICIES = exports.isCodeStarConnection = exports.isCodeCommitRepo = exports.cdkpipelines = void 0;
const assert = require("assert");
const cdk = require("aws-cdk-lib");
const codecommit = require("aws-cdk-lib/aws-codecommit");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const cdkpipelines = require("aws-cdk-lib/pipelines");
exports.cdkpipelines = cdkpipelines;
const usage_utils_1 = require("../utils/usage-utils");
function isCodeCommitRepo(repo) {
    return Object.prototype.hasOwnProperty.call(repo, 'codeCommitRepoName');
}
exports.isCodeCommitRepo = isCodeCommitRepo;
function isCodeStarConnection(repo) {
    return Object.prototype.hasOwnProperty.call(repo, 'codeStarConnectionArn');
}
exports.isCodeStarConnection = isCodeStarConnection;
/**
 * Default policy for the CodeBuild role generated.
 * It allows look-ups, including access to AWS Secrets Manager.
 * Not recommended for production. For production use case, CodeBuild policies
 * must be restricted to particular resources. Outbound access from the build should be
 * controlled by ACL.
 */
exports.DEFAULT_BUILD_POLICIES = [new aws_iam_1.PolicyStatement({
        resources: ["*"],
        actions: [
            "sts:AssumeRole",
            "secretsmanager:GetSecretValue",
            "secretsmanager:DescribeSecret",
            "cloudformation:*"
        ]
    })];
/**
 * Builder for CodePipeline.
 */
class CodePipelineBuilder {
    constructor() {
        this.props = { crossAccountKeys: false, stages: [], waves: [] };
    }
    application(app) {
        this.props.application = app;
        return this;
    }
    name(name) {
        this.props.name = name;
        return this;
    }
    owner(owner) {
        this.props.owner = owner;
        return this;
    }
    /**
     * For production use cases, make sure all policies are tied to concrete resources.
     * @param policies
     * @returns
     */
    codeBuildPolicies(policies) {
        this.props.codeBuildPolicies = policies;
        return this;
    }
    enableCrossAccountKeys() {
        this.props.crossAccountKeys = true;
        return this;
    }
    repository(repo) {
        this.props.repository = repo;
        if (isCodeCommitRepo(repo)) {
            this.props.repository = repo;
        }
        if (isCodeStarConnection(repo)) {
            this.props.repository = repo;
        }
        return this;
    }
    /**
     * Adds standalone pipeline stages (in the order of invocation and elements in the input array)
     * @param stackStages
     * @returns
     */
    stage(...stackStages) {
        stackStages.forEach(stage => this.props.stages.push(stage));
        return this;
    }
    /**
     * Adds wave(s) in the order specified. All stages in the wave can be executed in parallel, while standalone stages are executed sequentially.
     * @param waves
     * @returns
     */
    wave(...waves) {
        waves.forEach(wave => {
            this.props.waves.push(wave);
            wave.stages.forEach(stage => { var _a; return (_a = this.props.stages) === null || _a === void 0 ? void 0 : _a.push({ ...stage, ...{ waveId: wave.id } }); });
        });
        return this;
    }
    build(scope, id, stackProps) {
        assert(this.props.name, 'name field is required for the pipeline stack. Please provide value.');
        assert(this.props.stages, 'Stage field is required for the pipeline stack. Please provide value.');
        if (this.props.repository) {
            let gitHubRepo = this.props.repository;
            if (!isCodeCommitRepo(this.props.repository)) {
                assert(this.props.owner || gitHubRepo.owner, 'repository.owner field is required for the GitHub or CodeStar connection pipeline stack. Please provide value.');
            }
        }
        const fullProps = this.props;
        return new CodePipelineStack(scope, fullProps, id, stackProps);
    }
}
exports.CodePipelineBuilder = CodePipelineBuilder;
/**
 * Pipeline stack is generating a self-mutating pipeline to faciliate full CI/CD experience with the platform
 * for infrastructure changes.
 */
class CodePipelineStack extends cdk.Stack {
    static builder() {
        return new CodePipelineBuilder();
    }
    constructor(scope, pipelineProps, id, props) {
        if (pipelineProps.crossAccountKeys) {
            super(scope, id, (0, usage_utils_1.withUsageTracking)(CodePipelineStack.USAGE_ID_MULTI_ACCOUNT, props));
        }
        else {
            super(scope, id, (0, usage_utils_1.withUsageTracking)(CodePipelineStack.USAGE_ID, props));
        }
        const pipeline = CodePipeline.build(this, pipelineProps);
        let promises = [];
        for (let stage of pipelineProps.stages) {
            const appStage = new ApplicationStage(this, stage.id, stage.stackBuilder);
            promises.push(appStage.waitForAsyncTasks());
        }
        Promise.all(promises).then(stages => {
            let currentWave;
            for (let i in stages) {
                const stage = pipelineProps.stages[i];
                if (stage.waveId) {
                    if (currentWave == null || currentWave.id != stage.waveId) {
                        const waveProps = pipelineProps.waves.find(wave => wave.id === stage.waveId);
                        assert(waveProps, `Specified wave ${stage.waveId} is not found in the pipeline definition ${id}`);
                        currentWave = pipeline.addWave(stage.waveId, { ...waveProps.props });
                    }
                    currentWave.addStage(stages[i], stage.stageProps);
                }
                else {
                    pipeline.addStage(stages[i], stage.stageProps);
                }
            }
        });
    }
}
exports.CodePipelineStack = CodePipelineStack;
CodePipelineStack.USAGE_ID = "qs-1s1r465k6";
CodePipelineStack.USAGE_ID_MULTI_ACCOUNT = "qs-1s1r465f2";
class ApplicationStage extends cdk.Stage {
    constructor(scope, id, builder, props) {
        super(scope, id, props);
        if (builder.buildAsync !== undefined) {
            this.asyncTask = builder.buildAsync(this, `${id}-blueprint`, props);
        }
        else {
            builder.build(this, `${id}-blueprint`, props);
        }
    }
    async waitForAsyncTasks() {
        if (this.asyncTask) {
            return this.asyncTask.then(() => {
                return this;
            });
        }
        return Promise.resolve(this);
    }
}
exports.ApplicationStage = ApplicationStage;
/**
 * CodePipeline deploys a new CodePipeline resource that is integrated with a GitHub repository.
 */
class CodePipeline {
    static build(scope, props) {
        var _a, _b, _c, _d, _e;
        let codePipelineSource = undefined;
        switch (true) {
            case isCodeCommitRepo(props.repository): {
                let codeCommitRepo = props.repository;
                codePipelineSource = cdkpipelines.CodePipelineSource.codeCommit(codecommit.Repository.fromRepositoryName(scope, 'cdk-eks-blueprints', codeCommitRepo.codeCommitRepoName), (_a = codeCommitRepo.targetRevision) !== null && _a !== void 0 ? _a : 'master', codeCommitRepo.codeCommitOptions);
                break;
            }
            case isCodeStarConnection(props.repository): {
                let codeStarConnection = props.repository;
                const repoOwner = (_b = codeStarConnection.owner) !== null && _b !== void 0 ? _b : props.owner;
                codePipelineSource = cdkpipelines.CodePipelineSource.connection(`${repoOwner}/${codeStarConnection.repoUrl}`, (_c = codeStarConnection.targetRevision) !== null && _c !== void 0 ? _c : 'main', { connectionArn: codeStarConnection.codeStarConnectionArn });
                break;
            }
            default: {
                let gitHubRepo = props.repository;
                let githubProps = undefined;
                const gitHubOwner = (_d = gitHubRepo.owner) !== null && _d !== void 0 ? _d : props.owner;
                if (gitHubRepo.credentialsSecretName) {
                    githubProps = {
                        authentication: cdk.SecretValue.secretsManager(gitHubRepo.credentialsSecretName),
                    };
                }
                codePipelineSource = cdkpipelines.CodePipelineSource.gitHub(`${gitHubOwner}/${gitHubRepo.repoUrl}`, (_e = gitHubRepo.targetRevision) !== null && _e !== void 0 ? _e : 'main', githubProps);
                break;
            }
        }
        const app = props.application ? `--app '${props.application}'` : "";
        return new cdkpipelines.CodePipeline(scope, props.name, {
            pipelineName: props.name,
            synth: new cdkpipelines.ShellStep(`${props.name}-synth`, {
                input: codePipelineSource,
                installCommands: [
                    'n stable',
                    'npm install -g aws-cdk@2.91.0',
                    'npm install',
                ],
                commands: ['npm run build', 'npx cdk synth ' + app]
            }),
            crossAccountKeys: props.crossAccountKeys,
            codeBuildDefaults: {
                rolePolicy: props.codeBuildPolicies
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1waXBlbGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9waXBlbGluZXMvY29kZS1waXBlbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBaUM7QUFDakMsbUNBQW1DO0FBRW5DLHlEQUF5RDtBQUN6RCxpREFBc0Q7QUFDdEQsc0RBQXNEO0FBTWxELG9DQUFZO0FBSGhCLHNEQUF5RDtBQTREekQsU0FBZ0IsZ0JBQWdCLENBQzlCLElBR2dDO0lBRWhDLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0FBQzFFLENBQUM7QUFQRCw0Q0FPQztBQUVELFNBQWdCLG9CQUFvQixDQUNsQyxJQUdnQztJQUVoQyxPQUFPLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztBQUU3RSxDQUFDO0FBUkQsb0RBUUM7QUFnR0Q7Ozs7OztHQU1HO0FBQ1UsUUFBQSxzQkFBc0IsR0FBRyxDQUFFLElBQUkseUJBQWUsQ0FBQztRQUN4RCxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7UUFDaEIsT0FBTyxFQUFFO1lBQ0wsZ0JBQWdCO1lBQ2hCLCtCQUErQjtZQUMvQiwrQkFBK0I7WUFDL0Isa0JBQWtCO1NBQ3JCO0tBQ0osQ0FBQyxDQUFDLENBQUM7QUFFSjs7R0FFRztBQUNILE1BQWEsbUJBQW1CO0lBSTVCO1FBQ0ksSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRU0sV0FBVyxDQUFDLEdBQVc7UUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDO1FBQzdCLE9BQU8sSUFBSSxDQUFDO0lBQ2Qs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SSxFQUFFO1lBQ3BELFlBQVksRUFBRSxLQUFLLENBQUMsSUFBSTtZQUN4QixLQUFLLEVBQUUsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksUUFBUSxFQUFFO2dCQUN2RCxLQUFLLEVBQUUsa0JBQWtCO2dCQUN6QixlQUFlLEVBQUU7b0JBQ2YsVUFBVTtvQkFDViwrQkFBK0I7b0JBQy9CLGFBQWE7aUJBQ2Q7Z0JBQ0QsUUFBUSxFQUFFLENBQUMsZUFBZSxFQUFFLGdCQUFnQixHQUFHLEdBQUcsQ0FBQzthQUNwRCxDQUFDO1lBQ0YsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLGdCQUFnQjtZQUN4QyxpQkFBaUIsRUFBRTtnQkFDZixVQUFVLEVBQUUsS0FBSyxDQUFDLGlCQUFpQjthQUN0QztTQUNGLENBQUMsQ0FBQztJQUNULENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgU3RhY2tQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGNvZGVjb21taXQgZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZGVjb21taXQnO1xuaW1wb3J0IHsgUG9saWN5U3RhdGVtZW50IH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGNka3BpcGVsaW5lcyBmcm9tICdhd3MtY2RrLWxpYi9waXBlbGluZXMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEFwcGxpY2F0aW9uUmVwb3NpdG9yeSwgQXN5bmNTdGFja0J1aWxkZXIsIFN0YWNrQnVpbGRlciB9IGZyb20gJy4uL3NwaSc7XG5pbXBvcnQgeyB3aXRoVXNhZ2VUcmFja2luZyB9IGZyb20gJy4uL3V0aWxzL3VzYWdlLXV0aWxzJztcblxuZXhwb3J0IHtcbiAgICBjZGtwaXBlbGluZXNcbn07XG5cbi8qKlxuICogY3JlZGVudGlhbHNUeXBlIGlzIGV4Y2x1ZGVkIGFuZCB0aGUgb25seSBzdXBwb3J0ZWQgY3JlZGVudGlhbHNTZWNyZXQgaXMgYSBwbGFpbnRleHQgR2l0SHViIE9BdXRoIHRva2VuLlxuICogcmVwb1VybFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEdpdEh1YlNvdXJjZVJlcG9zaXRvcnkgZXh0ZW5kcyBPbWl0PEFwcGxpY2F0aW9uUmVwb3NpdG9yeSwgXCJjcmVkZW50aWFsc1R5cGVcIj4ge1xuICAgIC8qKlxuICAgICAqIEEgR2l0SHViIE9BdXRoIHRva2VuIHRvIHVzZSBmb3IgYXV0aGVudGljYXRpb24gc3RvcmVkIHdpdGggQVdTIFNlY3JldCBNYW5hZ2VyLlxuICAgICAqIFRoZSBwcm92aWRlZCBuYW1lIHdpbGwgYmUgbG9va2VkIHVwIHVzaW5nIHRoZSBmb2xsb3dpbmc6XG4gICAgICogYGBgdHNcbiAgICAgKiBjb25zdCBjcmVkZW50aWFscyA9IGNkay5TZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcignbXktZ2l0aHViLXRva2VuJyk7XG4gICAgICogYGBgXG4gICAgICpcbiAgICAgKiBUaGUgR2l0SHViIFBlcnNvbmFsIEFjY2VzcyBUb2tlbiBzaG91bGQgaGF2ZSB0aGVzZSBzY29wZXM6XG4gICAgICpcbiAgICAgKiAqICoqcmVwbyoqIC0gdG8gcmVhZCB0aGUgcmVwb3NpdG9yeVxuICAgICAqICogKiphZG1pbjpyZXBvX2hvb2sqKiAtIGlmIHlvdSBwbGFuIHRvIHVzZSB3ZWJob29rcyAodHJ1ZSBieSBkZWZhdWx0KVxuICAgICAqXG4gICAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29kZXBpcGVsaW5lL2xhdGVzdC91c2VyZ3VpZGUvR2l0SHViLWNyZWF0ZS1wZXJzb25hbC10b2tlbi1DTEkuaHRtbFxuICAgICAqL1xuICAgIGNyZWRlbnRpYWxzU2VjcmV0TmFtZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBvd25lciBvZiB0aGUgcmVwb3NpdG9yeSBmb3IgdGhlIHBpcGVsaW5lIChHaXRIdWIgaGFuZGxlKS5cbiAgICAqL1xuICAgIG93bmVyPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5XG4gICAgZXh0ZW5kcyBPbWl0PEFwcGxpY2F0aW9uUmVwb3NpdG9yeSwgXCJjcmVkZW50aWFsc1R5cGVcIiB8IFwiY3JlZGVudGlhbHNTZWNyZXROYW1lIFwiIHwgXCJyZXBvVXJsXCI+IHtcbiAgICAvKipcbiAgICAgKiBUaGUgbmFtZSBvZiB0aGUgQ29kZUNvbW1pdCByZXBvc2l0b3J5LlxuICAgICAqL1xuICAgIGNvZGVDb21taXRSZXBvTmFtZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgQ29kZUNvbW1pdFNvdXJjZU9wdGlvbnMuXG4gICAgICovXG4gICAgY29kZUNvbW1pdE9wdGlvbnM/OiBjZGtwaXBlbGluZXMuQ29kZUNvbW1pdFNvdXJjZU9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29kZVN0YXJDb25uZWN0aW9uUmVwb3NpdG9yeVxuICBleHRlbmRzIE9taXQ8XG4gICAgQXBwbGljYXRpb25SZXBvc2l0b3J5LFxuICAgICdjcmVkZW50aWFsc1R5cGUnIHwgJ2NyZWRlbnRpYWxzU2VjcmV0TmFtZSAnXG4gID4ge1xuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgQ29kZVN0YXIgQ29ubmVjdGlvbi5cbiAgICovXG4gIGNvZGVTdGFyQ29ubmVjdGlvbkFybjogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG93bmVyIG9mIHRoZSByZXBvc2l0b3J5IGZvciB0aGUgcGlwZWxpbmVcbiAgICovXG4gIG93bmVyPzogc3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNDb2RlQ29tbWl0UmVwbyhcbiAgcmVwbzpcbiAgICB8IEdpdEh1YlNvdXJjZVJlcG9zaXRvcnlcbiAgICB8IENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5XG4gICAgfCBDb2RlU3RhckNvbm5lY3Rpb25SZXBvc2l0b3J5XG4pOiBib29sZWFuIHtcbiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChyZXBvLCAnY29kZUNvbW1pdFJlcG9OYW1lJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NvZGVTdGFyQ29ubmVjdGlvbihcbiAgcmVwbzpcbiAgICB8IEdpdEh1YlNvdXJjZVJlcG9zaXRvcnlcbiAgICB8IENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5XG4gICAgfCBDb2RlU3RhckNvbm5lY3Rpb25SZXBvc2l0b3J5XG4pOiBib29sZWFuIHtcbiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChyZXBvLCAnY29kZVN0YXJDb25uZWN0aW9uQXJuJyk7XG4gIFxufVxuXG4vKipcbiAqIFByb3BzIGZvciB0aGUgUGlwZWxpbmUuXG4gKi9cbmV4cG9ydCB0eXBlIFBpcGVsaW5lUHJvcHMgPSB7XG5cbiAgLyoqXG4gICAqIEFwcGxpY2F0aW9uIG5hbWUgKG9wdGlvbmFsLCBkZWZhdWx0IHRvIHRoZSBhcHAgc2V0IGluIHRoZSBjZGsuanNvbilcbiAgICovXG4gIGFwcGxpY2F0aW9uPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgZm9yIHRoZSBwaXBlbGluZS5cbiAgICAgKi9cbiAgICBuYW1lOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgb3duZXIgb2YgdGhlIHJlcG9zaXRvcnkgZm9yIHRoZSBwaXBlbGluZSAoR2l0SHViIGhhbmRsZSkuXG4gICAgICovXG4gICAgb3duZXI/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBFbmFibGUvRGlzYWJsZSBhbGxvd2luZyBjcm9zcy1hY2NvdW50IGRlcGxveW1lbnRzLlxuICAgICAqL1xuICAgIGNyb3NzQWNjb3VudEtleXM6IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBJQU0gcG9saWNpZXMgdG8gYXR0YWNoIHRvIHRoZSBjb2RlIGJ1aWxkIHJvbGUuIFxuICAgICAqIEJ5IGRlZmF1bHQgaXQgYWxsb3dzIGFjY2VzcyBmb3IgbG9va3VwcywgaW5jbHVkaW5nIHNlY3JldCBsb29rLXVwcy5cbiAgICAgKiBQYXNzaW5nIGFuIGVtcHR5IGxpc3Qgd2lsbCByZXN1bHQgaW4gbm8gZXh0cmEtcG9saWNpZXMgcGFzc2VkIHRvIHRoZSBidWlsZCByb2xlLlxuICAgICAqIExlYXZpbmcgdGhpcyB1bnNwZWNpZmllZCB3aWxsIHJlc3VsdCBpbiB0aGUgZGVmYXVsdCBwb2xpY3kgYXBwbGllZCAobm90IHJlY29tbWVuZGVkIGZvciBwcm91ZGN0aW9uKS5cbiAgICAgKi9cbiAgICBjb2RlQnVpbGRQb2xpY2llcz86IFBvbGljeVN0YXRlbWVudFtdO1xuXG4gIC8qKlxuICAgKiBSZXBvc2l0b3J5IGZvciB0aGUgcGlwZWxpbmUgKEdpdEh1YiBvciBDb2RlQ29tbWl0UmVwb3NpdG9yeSkuXG4gICAqL1xuICByZXBvc2l0b3J5OlxuICAgIHwgR2l0SHViU291cmNlUmVwb3NpdG9yeVxuICAgIHwgQ29kZUNvbW1pdFNvdXJjZVJlcG9zaXRvcnlcbiAgICB8IENvZGVTdGFyQ29ubmVjdGlvblJlcG9zaXRvcnk7XG5cbiAgICAvKipcbiAgICAgKiBQaXBlbGluZSBzdGFnZXMgYW5kIG9wdGlvbnMuXG4gICAgICovXG4gICAgc3RhZ2VzOiBXYXZlU3RhZ2VbXTtcblxuICAgIC8qKlxuICAgICAqIFdhdmVzIGZvciB0aGUgcGlwZWxpbmUuIFN0YWdlcyBpbnNpZGUgdGhlIHdhdmUgYXJlIGV4ZWN1dGVkIGluIHBhcmFsbGVsLlxuICAgICAqL1xuICAgIHdhdmVzOiBQaXBlbGluZVdhdmVbXTtcbn1cblxuLyoqXG4gKiBTdGFjayBzdGFnZSBpcyBhIGJ1aWxkZXIgY29uc3RydWN0IHRvIGFsbG93IGFkZGluZyBzdGFnZXMgdG8gYSBwaXBlbGluZS4gRWFjaCBzdGFnZSBpcyBleHBlY3RlZCB0byBwcm9kdWNlIGEgc3RhY2suXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3RhY2tTdGFnZSB7XG4gICAgLyoqXG4gICAgICogaWQgb2YgdGhlIHN0YWdlXG4gICAgICovXG4gICAgaWQ6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEJ1aWxkZXIgdGhhdCBjYW4gcHJvZHVjZSBhIHN0YWNrIHdoaWNoIHdpbGwgYmUgZGVwbG95ZWQgYXMgcGFydCBvZiB0aGUgc3RhZ2VcbiAgICAgKi9cbiAgICBzdGFja0J1aWxkZXI6IFN0YWNrQnVpbGRlcjtcblxuICAgIC8qKlxuICAgICAqIE9wdGlvbmFsIHN0YWdlIHByb3BlcnRpZXMsIHN1Y2ggYXMge21hbnVhbEFwcHJvdmFsczogdHJ1ZX0gd2hpY2ggY2FuIGNvbnRyb2wgc3RhZ2UgdHJhbnNpdGlvbnMuXG4gICAgICovXG4gICAgc3RhZ2VQcm9wcz86IGNka3BpcGVsaW5lcy5BZGRTdGFnZU9wdHM7XG59XG5cbi8qKlxuICogSW50ZXJuYWwgaW50ZXJmYWNlIGZvciB3YXZlIHN0YWdlc1xuICovXG5pbnRlcmZhY2UgV2F2ZVN0YWdlIGV4dGVuZHMgU3RhY2tTdGFnZSB7XG4gICAgLyoqXG4gICAgICogV2F2ZSBpZCBpZiB0aGlzIHN0YWdlIGlzIHBhcnQgb2YgYSB3YXZlLiBOb3QgcmVxdWlyZWQgaWYgc3RhZ2UgaXMgc3VwcGxpZWRcbiAgICAgKi9cbiAgICB3YXZlSWQ/OiBzdHJpbmcsXG59XG5cbi8qKlxuICogUmVwcmVzZW50cyB3YXZlIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBQaXBlbGluZVdhdmUge1xuXG4gICAgaWQ6IHN0cmluZyxcblxuICAgIHN0YWdlczogU3RhY2tTdGFnZVtdLFxuXG4gICAgcHJvcHM/OiBjZGtwaXBlbGluZXMuV2F2ZVByb3BzXG59XG5cbi8qKlxuICogRGVmYXVsdCBwb2xpY3kgZm9yIHRoZSBDb2RlQnVpbGQgcm9sZSBnZW5lcmF0ZWQuIFxuICogSXQgYWxsb3dzIGxvb2stdXBzLCBpbmNsdWRpbmcgYWNjZXNzIHRvIEFXUyBTZWNyZXRzIE1hbmFnZXIuIFxuICogTm90IHJlY29tbWVuZGVkIGZvciBwcm9kdWN0aW9uLiBGb3IgcHJvZHVjdGlvbiB1c2UgY2FzZSwgQ29kZUJ1aWxkIHBvbGljaWVzIFxuICogbXVzdCBiZSByZXN0cmljdGVkIHRvIHBhcnRpY3VsYXIgcmVzb3VyY2VzLiBPdXRib3VuZCBhY2Nlc3MgZnJvbSB0aGUgYnVpbGQgc2hvdWxkIGJlIFxuICogY29udHJvbGxlZCBieSBBQ0wuXG4gKi9cbmV4cG9ydCBjb25zdCBERUZBVUxUX0JVSUxEX1BPTElDSUVTID0gWyBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgYWN0aW9uczogWyAgICBcbiAgICAgICAgXCJzdHM6QXNzdW1lUm9sZVwiLFxuICAgICAgICBcInNlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlXCIsXG4gICAgICAgIFwic2VjcmV0c21hbmFnZXI6RGVzY3JpYmVTZWNyZXRcIixcbiAgICAgICAgXCJjbG91ZGZvcm1hdGlvbjoqXCJcbiAgICBdXG59KV07XG5cbi8qKlxuICogQnVpbGRlciBmb3IgQ29kZVBpcGVsaW5lLlxuICovXG5leHBvcnQgY2xhc3MgQ29kZVBpcGVsaW5lQnVpbGRlciBpbXBsZW1lbnRzIFN0YWNrQnVpbGRlciB7XG5cbiAgICBwcml2YXRlIHByb3BzOiBQYXJ0aWFsPFBpcGVsaW5lUHJvcHM+O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IGNyb3NzQWNjb3VudEtleXM6IGZhbHNlLCBzdGFnZXM6IFtdLCB3YXZlczogW119O1xuICAgIH1cblxuICAgIHB1YmxpYyBhcHBsaWNhdGlvbihhcHA6IHN0cmluZyk6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgdGhpcy5wcm9wcy5hcHBsaWNhdGlvbiA9IGFwcDtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBuYW1lKG5hbWU6IHN0cmluZyk6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICB0aGlzLnByb3BzLm5hbWUgPSBuYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgb3duZXIob3duZXI6IHN0cmluZykgOiBDb2RlUGlwZWxpbmVCdWlsZGVyIHtcbiAgICAgICAgdGhpcy5wcm9wcy5vd25lciA9IG93bmVyO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGb3IgcHJvZHVjdGlvbiB1c2UgY2FzZXMsIG1ha2Ugc3VyZSBhbGwgcG9saWNpZXMgYXJlIHRpZWQgdG8gY29uY3JldGUgcmVzb3VyY2VzLlxuICAgICAqIEBwYXJhbSBwb2xpY2llcyBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBwdWJsaWMgY29kZUJ1aWxkUG9saWNpZXMocG9saWNpZXM6IFBvbGljeVN0YXRlbWVudFtdKSA6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICB0aGlzLnByb3BzLmNvZGVCdWlsZFBvbGljaWVzID0gcG9saWNpZXM7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiBcbiAgICBwdWJsaWMgZW5hYmxlQ3Jvc3NBY2NvdW50S2V5cygpIDogQ29kZVBpcGVsaW5lQnVpbGRlciB7XG4gICAgICAgIHRoaXMucHJvcHMuY3Jvc3NBY2NvdW50S2V5cyA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICBwdWJsaWMgcmVwb3NpdG9yeShcbiAgICByZXBvOlxuICAgICAgfCBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5XG4gICAgICB8IENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5XG4gICAgICB8IENvZGVTdGFyQ29ubmVjdGlvblJlcG9zaXRvcnlcbiAgKTogQ29kZVBpcGVsaW5lQnVpbGRlciB7XG4gICAgdGhpcy5wcm9wcy5yZXBvc2l0b3J5ID0gcmVwbyBhcyBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5O1xuICAgIGlmIChpc0NvZGVDb21taXRSZXBvKHJlcG8pKSB7XG4gICAgICB0aGlzLnByb3BzLnJlcG9zaXRvcnkgPSByZXBvIGFzIENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5O1xuICAgIH1cbiAgICBpZiAoaXNDb2RlU3RhckNvbm5lY3Rpb24ocmVwbykpIHtcbiAgICAgIHRoaXMucHJvcHMucmVwb3NpdG9yeSA9IHJlcG8gYXMgQ29kZVN0YXJDb25uZWN0aW9uUmVwb3NpdG9yeTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgc3RhbmRhbG9uZSBwaXBlbGluZSBzdGFnZXMgKGluIHRoZSBvcmRlciBvZiBpbnZvY2F0aW9uIGFuZCBlbGVtZW50cyBpbiB0aGUgaW5wdXQgYXJyYXkpXG4gICAgICogQHBhcmFtIHN0YWNrU3RhZ2VzXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhZ2UoLi4uc3RhY2tTdGFnZXM6IFN0YWNrU3RhZ2VbXSkgOiBDb2RlUGlwZWxpbmVCdWlsZGVyIHtcbiAgICAgICAgc3RhY2tTdGFnZXMuZm9yRWFjaChzdGFnZSA9PiB0aGlzLnByb3BzLnN0YWdlcyEucHVzaChzdGFnZSkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIHdhdmUocykgaW4gdGhlIG9yZGVyIHNwZWNpZmllZC4gQWxsIHN0YWdlcyBpbiB0aGUgd2F2ZSBjYW4gYmUgZXhlY3V0ZWQgaW4gcGFyYWxsZWwsIHdoaWxlIHN0YW5kYWxvbmUgc3RhZ2VzIGFyZSBleGVjdXRlZCBzZXF1ZW50aWFsbHkuXG4gICAgICogQHBhcmFtIHdhdmVzXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwdWJsaWMgd2F2ZSguLi53YXZlczogUGlwZWxpbmVXYXZlW10pIDogQ29kZVBpcGVsaW5lQnVpbGRlciB7XG4gICAgICAgIHdhdmVzLmZvckVhY2god2F2ZSA9PiB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLndhdmVzIS5wdXNoKHdhdmUpO1xuICAgICAgICAgICAgd2F2ZS5zdGFnZXMuZm9yRWFjaChzdGFnZSA9PiB0aGlzLnByb3BzLnN0YWdlcz8ucHVzaCh7Li4uc3RhZ2UsIC4uLnsgd2F2ZUlkOiB3YXZlLmlkfX0pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGJ1aWxkKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHN0YWNrUHJvcHM/OiBjZGsuU3RhY2tQcm9wcyk6IGNkay5TdGFjayB7XG4gICAgICBhc3NlcnQoXG4gICAgICAgIHRoaXMucHJvcHMubmFtZSxcbiAgICAgICAgJ25hbWUgZmllbGQgaXMgcmVxdWlyZWQgZm9yIHRoZSBwaXBlbGluZSBzdGFjay4gUGxlYXNlIHByb3ZpZGUgdmFsdWUuJ1xuICAgICAgKTtcbiAgICAgIGFzc2VydChcbiAgICAgICAgdGhpcy5wcm9wcy5zdGFnZXMsXG4gICAgICAgICdTdGFnZSBmaWVsZCBpcyByZXF1aXJlZCBmb3IgdGhlIHBpcGVsaW5lIHN0YWNrLiBQbGVhc2UgcHJvdmlkZSB2YWx1ZS4nXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMucHJvcHMucmVwb3NpdG9yeSkge1xuICAgICAgICBsZXQgZ2l0SHViUmVwbyA9IHRoaXMucHJvcHMucmVwb3NpdG9yeSBhcyBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5O1xuICAgICAgICBpZiAoIWlzQ29kZUNvbW1pdFJlcG8odGhpcy5wcm9wcy5yZXBvc2l0b3J5KSkge1xuICAgICAgICAgIGFzc2VydChcbiAgICAgICAgICAgIHRoaXMucHJvcHMub3duZXIgfHwgZ2l0SHViUmVwby5vd25lcixcbiAgICAgICAgICAgICdyZXBvc2l0b3J5Lm93bmVyIGZpZWxkIGlzIHJlcXVpcmVkIGZvciB0aGUgR2l0SHViIG9yIENvZGVTdGFyIGNvbm5lY3Rpb24gcGlwZWxpbmUgc3RhY2suIFBsZWFzZSBwcm92aWRlIHZhbHVlLidcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBmdWxsUHJvcHMgPSB0aGlzLnByb3BzIGFzIFBpcGVsaW5lUHJvcHM7XG4gICAgICByZXR1cm4gbmV3IENvZGVQaXBlbGluZVN0YWNrKHNjb3BlLCBmdWxsUHJvcHMsIGlkLCBzdGFja1Byb3BzKTtcbiAgICB9XG59XG5cblxuLyoqXG4gKiBQaXBlbGluZSBzdGFjayBpcyBnZW5lcmF0aW5nIGEgc2VsZi1tdXRhdGluZyBwaXBlbGluZSB0byBmYWNpbGlhdGUgZnVsbCBDSS9DRCBleHBlcmllbmNlIHdpdGggdGhlIHBsYXRmb3JtXG4gKiBmb3IgaW5mcmFzdHJ1Y3R1cmUgY2hhbmdlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIENvZGVQaXBlbGluZVN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcblxuICAgIHN0YXRpYyByZWFkb25seSBVU0FHRV9JRCA9IFwicXMtMXMxcjQ2NWs2XCI7XG4gICAgc3RhdGljIHJlYWRvbmx5IFVTQUdFX0lEX01VTFRJX0FDQ09VTlQgPSBcInFzLTFzMXI0NjVmMlwiO1xuXG4gICAgc3RhdGljIGJ1aWxkZXIoKSB7XG4gICAgICAgIHJldHVybiBuZXcgQ29kZVBpcGVsaW5lQnVpbGRlcigpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIHBpcGVsaW5lUHJvcHM6IFBpcGVsaW5lUHJvcHMsIGlkOiBzdHJpbmcsICBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICAgICAgaWYgKHBpcGVsaW5lUHJvcHMuY3Jvc3NBY2NvdW50S2V5cyl7XG4gICAgICAgICAgICBzdXBlcihzY29wZSwgaWQsIHdpdGhVc2FnZVRyYWNraW5nKENvZGVQaXBlbGluZVN0YWNrLlVTQUdFX0lEX01VTFRJX0FDQ09VTlQsIHByb3BzKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlcihzY29wZSwgaWQsIHdpdGhVc2FnZVRyYWNraW5nKENvZGVQaXBlbGluZVN0YWNrLlVTQUdFX0lELCBwcm9wcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGlwZWxpbmUgPSBDb2RlUGlwZWxpbmUuYnVpbGQodGhpcywgcGlwZWxpbmVQcm9wcyk7XG5cbiAgICAgICAgbGV0IHByb21pc2VzIDogUHJvbWlzZTxBcHBsaWNhdGlvblN0YWdlPltdID0gW107XG5cbiAgICAgICAgZm9yKGxldCBzdGFnZSBvZiBwaXBlbGluZVByb3BzLnN0YWdlcykge1xuICAgICAgICAgICAgY29uc3QgYXBwU3RhZ2UgPSBuZXcgQXBwbGljYXRpb25TdGFnZSh0aGlzLCBzdGFnZS5pZCwgc3RhZ2Uuc3RhY2tCdWlsZGVyKTtcbiAgICAgICAgICAgIHByb21pc2VzLnB1c2goYXBwU3RhZ2Uud2FpdEZvckFzeW5jVGFza3MoKSk7XG4gICAgICAgIH1cblxuICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihzdGFnZXMgPT4ge1xuICAgICAgICAgICAgbGV0IGN1cnJlbnRXYXZlIDogY2RrcGlwZWxpbmVzLldhdmUgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgICAgIGZvcihsZXQgaSBpbiBzdGFnZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFnZSA9IHBpcGVsaW5lUHJvcHMuc3RhZ2VzW2ldO1xuICAgICAgICAgICAgICAgIGlmKHN0YWdlLndhdmVJZCkge1xuICAgICAgICAgICAgICAgICAgICBpZihjdXJyZW50V2F2ZSA9PSBudWxsIHx8IGN1cnJlbnRXYXZlLmlkICE9IHN0YWdlLndhdmVJZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2F2ZVByb3BzID0gcGlwZWxpbmVQcm9wcy53YXZlcy5maW5kKHdhdmUgPT4gd2F2ZS5pZCA9PT0gc3RhZ2Uud2F2ZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCh3YXZlUHJvcHMsIGBTcGVjaWZpZWQgd2F2ZSAke3N0YWdlLndhdmVJZH0gaXMgbm90IGZvdW5kIGluIHRoZSBwaXBlbGluZSBkZWZpbml0aW9uICR7aWR9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50V2F2ZSA9IHBpcGVsaW5lLmFkZFdhdmUoc3RhZ2Uud2F2ZUlkLCB7IC4uLndhdmVQcm9wcy5wcm9wcyB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50V2F2ZS5hZGRTdGFnZShzdGFnZXNbaV0sIHN0YWdlLnN0YWdlUHJvcHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmUuYWRkU3RhZ2Uoc3RhZ2VzW2ldLCBzdGFnZS5zdGFnZVByb3BzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25TdGFnZSBleHRlbmRzIGNkay5TdGFnZSB7XG5cbiAgICBwcml2YXRlIGFzeW5jVGFzazogUHJvbWlzZTxhbnk+O1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5TdGFjaywgaWQ6IHN0cmluZywgYnVpbGRlcjogU3RhY2tCdWlsZGVyIHwgQXN5bmNTdGFja0J1aWxkZXIsIHByb3BzPzogY2RrLlN0YWdlUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgICAgIGlmKCg8QXN5bmNTdGFja0J1aWxkZXI+YnVpbGRlcikuYnVpbGRBc3luYyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmFzeW5jVGFzayA9ICg8QXN5bmNTdGFja0J1aWxkZXI+YnVpbGRlcikuYnVpbGRBc3luYyh0aGlzLCBgJHtpZH0tYmx1ZXByaW50YCwgcHJvcHMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYnVpbGRlci5idWlsZCh0aGlzLCBgJHtpZH0tYmx1ZXByaW50YCwgcHJvcHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHdhaXRGb3JBc3luY1Rhc2tzKCkgOiBQcm9taXNlPEFwcGxpY2F0aW9uU3RhZ2U+IHtcbiAgICAgICAgaWYodGhpcy5hc3luY1Rhc2spIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFzeW5jVGFzay50aGVuKCgpPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzKTtcbiAgICB9XG59XG5cbi8qKlxuICogQ29kZVBpcGVsaW5lIGRlcGxveXMgYSBuZXcgQ29kZVBpcGVsaW5lIHJlc291cmNlIHRoYXQgaXMgaW50ZWdyYXRlZCB3aXRoIGEgR2l0SHViIHJlcG9zaXRvcnkuXG4gKi9cbmNsYXNzIENvZGVQaXBlbGluZSB7XG5cbiAgICBwdWJsaWMgc3RhdGljIGJ1aWxkKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBQaXBlbGluZVByb3BzKSA6IGNka3BpcGVsaW5lcy5Db2RlUGlwZWxpbmUge1xuICAgICAgICBsZXQgY29kZVBpcGVsaW5lU291cmNlIDogY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZVNvdXJjZSB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICAgICAgICBzd2l0Y2ggKHRydWUpIHtcbiAgICAgICAgICBjYXNlIGlzQ29kZUNvbW1pdFJlcG8ocHJvcHMucmVwb3NpdG9yeSk6e1xuICAgICAgICAgICAgbGV0IGNvZGVDb21taXRSZXBvID0gcHJvcHMucmVwb3NpdG9yeSBhcyBDb2RlQ29tbWl0U291cmNlUmVwb3NpdG9yeTtcbiAgICAgICAgICAgIGNvZGVQaXBlbGluZVNvdXJjZSA9IGNka3BpcGVsaW5lcy5Db2RlUGlwZWxpbmVTb3VyY2UuY29kZUNvbW1pdChcbiAgICAgICAgICAgICAgY29kZWNvbW1pdC5SZXBvc2l0b3J5LmZyb21SZXBvc2l0b3J5TmFtZShcbiAgICAgICAgICAgICAgICBzY29wZSxcbiAgICAgICAgICAgICAgICAnY2RrLWVrcy1ibHVlcHJpbnRzJyxcbiAgICAgICAgICAgICAgICBjb2RlQ29tbWl0UmVwby5jb2RlQ29tbWl0UmVwb05hbWVcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgY29kZUNvbW1pdFJlcG8udGFyZ2V0UmV2aXNpb24gPz8gJ21hc3RlcicsXG4gICAgICAgICAgICAgIGNvZGVDb21taXRSZXBvLmNvZGVDb21taXRPcHRpb25zXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhc2UgaXNDb2RlU3RhckNvbm5lY3Rpb24ocHJvcHMucmVwb3NpdG9yeSk6e1xuICAgICAgICAgICAgbGV0IGNvZGVTdGFyQ29ubmVjdGlvbiA9XG4gICAgICAgICAgICAgIHByb3BzLnJlcG9zaXRvcnkgYXMgQ29kZVN0YXJDb25uZWN0aW9uUmVwb3NpdG9yeTtcbiAgICAgICAgICAgIGNvbnN0IHJlcG9Pd25lciA9IGNvZGVTdGFyQ29ubmVjdGlvbi5vd25lciA/PyBwcm9wcy5vd25lcjtcbiAgICAgICAgICAgIGNvZGVQaXBlbGluZVNvdXJjZSA9IGNka3BpcGVsaW5lcy5Db2RlUGlwZWxpbmVTb3VyY2UuY29ubmVjdGlvbihcbiAgICAgICAgICAgICAgYCR7cmVwb093bmVyfS8ke2NvZGVTdGFyQ29ubmVjdGlvbi5yZXBvVXJsfWAsXG4gICAgICAgICAgICAgIGNvZGVTdGFyQ29ubmVjdGlvbi50YXJnZXRSZXZpc2lvbiA/PyAnbWFpbicsXG4gICAgICAgICAgICAgIHsgY29ubmVjdGlvbkFybjogY29kZVN0YXJDb25uZWN0aW9uLmNvZGVTdGFyQ29ubmVjdGlvbkFybiB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGVmYXVsdDp7XG4gICAgICAgICAgICBsZXQgZ2l0SHViUmVwbyA9IHByb3BzLnJlcG9zaXRvcnkgYXMgR2l0SHViU291cmNlUmVwb3NpdG9yeTtcbiAgICAgICAgICAgIGxldCBnaXRodWJQcm9wczogY2RrcGlwZWxpbmVzLkdpdEh1YlNvdXJjZU9wdGlvbnMgfCB1bmRlZmluZWQgPVxuICAgICAgICAgICAgICB1bmRlZmluZWQ7XG4gICAgICAgICAgICBjb25zdCBnaXRIdWJPd25lciA9IGdpdEh1YlJlcG8ub3duZXIgPz8gcHJvcHMub3duZXI7XG5cbiAgICAgICAgICAgIGlmIChnaXRIdWJSZXBvLmNyZWRlbnRpYWxzU2VjcmV0TmFtZSkge1xuICAgICAgICAgICAgICBnaXRodWJQcm9wcyA9IHtcbiAgICAgICAgICAgICAgICBhdXRoZW50aWNhdGlvbjogY2RrLlNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKFxuICAgICAgICAgICAgICAgICAgZ2l0SHViUmVwby5jcmVkZW50aWFsc1NlY3JldE5hbWUhXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvZGVQaXBlbGluZVNvdXJjZSA9IGNka3BpcGVsaW5lcy5Db2RlUGlwZWxpbmVTb3VyY2UuZ2l0SHViKFxuICAgICAgICAgICAgICBgJHtnaXRIdWJPd25lcn0vJHtnaXRIdWJSZXBvLnJlcG9Vcmx9YCxcbiAgICAgICAgICAgICAgZ2l0SHViUmVwby50YXJnZXRSZXZpc2lvbiA/PyAnbWFpbicsXG4gICAgICAgICAgICAgIGdpdGh1YlByb3BzXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXBwID0gcHJvcHMuYXBwbGljYXRpb24gPyBgLS1hcHAgJyR7cHJvcHMuYXBwbGljYXRpb259J2AgOiBcIlwiO1xuXG4gICAgICAgIHJldHVybiBuZXcgY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZShzY29wZSwgcHJvcHMubmFtZSwge1xuICAgICAgICAgICAgcGlwZWxpbmVOYW1lOiBwcm9wcy5uYW1lLFxuICAgICAgICAgICAgc3ludGg6IG5ldyBjZGtwaXBlbGluZXMuU2hlbGxTdGVwKGAke3Byb3BzLm5hbWV9LXN5bnRoYCwge1xuICAgICAgICAgICAgICBpbnB1dDogY29kZVBpcGVsaW5lU291cmNlLFxuICAgICAgICAgICAgICBpbnN0YWxsQ29tbWFuZHM6IFtcbiAgICAgICAgICAgICAgICAnbiBzdGFibGUnLFxuICAgICAgICAgICAgICAgICducG0gaW5zdGFsbCAtZyBhd3MtY2RrQDIuOTEuMCcsXG4gICAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsJyxcbiAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgY29tbWFuZHM6IFsnbnBtIHJ1biBidWlsZCcsICducHggY2RrIHN5bnRoICcgKyBhcHBdXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNyb3NzQWNjb3VudEtleXM6IHByb3BzLmNyb3NzQWNjb3VudEtleXMsXG4gICAgICAgICAgICBjb2RlQnVpbGREZWZhdWx0czoge1xuICAgICAgICAgICAgICAgIHJvbGVQb2xpY3k6IHByb3BzLmNvZGVCdWlsZFBvbGljaWVzXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==