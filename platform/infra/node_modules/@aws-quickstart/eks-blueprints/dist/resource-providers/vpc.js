"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LookupSubnetProvider = exports.DirectVpcProvider = exports.VpcProvider = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
/**
 * VPC resource provider
 */
class VpcProvider {
    constructor(vpcId, vpcProps) {
        this.vpcProps = vpcProps;
        this.vpcId = vpcId;
        this.primaryCidr = vpcProps === null || vpcProps === void 0 ? void 0 : vpcProps.primaryCidr;
        this.secondaryCidr = vpcProps === null || vpcProps === void 0 ? void 0 : vpcProps.secondaryCidr;
        this.secondarySubnetCidrs = vpcProps === null || vpcProps === void 0 ? void 0 : vpcProps.secondarySubnetCidrs;
    }
    provide(context) {
        const id = context.scope.node.id;
        let vpc = undefined;
        if (this.vpcId) {
            if (this.vpcId === "default") {
                console.log(`looking up completely default VPC`);
                vpc = ec2.Vpc.fromLookup(context.scope, id + "-vpc", { isDefault: true });
            }
            else {
                console.log(`looking up non-default ${this.vpcId} VPC`);
                vpc = ec2.Vpc.fromLookup(context.scope, id + "-vpc", { vpcId: this.vpcId });
            }
        }
        if (vpc == null) {
            // It will automatically divide the provided VPC CIDR range, and create public and private subnets per Availability Zone.
            // If VPC CIDR range is not provided, uses `10.0.0.0/16` as the range and creates public and private subnets per Availability Zone.
            // Network routing for the public subnets will be configured to allow outbound access directly via an Internet Gateway.
            // Network routing for the private subnets will be configured to allow outbound access via a set of resilient NAT Gateways (one per AZ).
            // Creates Secondary CIDR and Secondary subnets if passed.
            if (this.primaryCidr) {
                vpc = new ec2.Vpc(context.scope, id + "-vpc", {
                    ipAddresses: ec2.IpAddresses.cidr(this.primaryCidr)
                });
            }
            else {
                vpc = new ec2.Vpc(context.scope, id + "-vpc");
            }
        }
        if (this.secondaryCidr) {
            this.createSecondarySubnets(context, id, vpc);
        }
        return vpc;
    }
    createSecondarySubnets(context, id, vpc) {
        const secondarySubnets = [];
        const secondaryCidr = new ec2.CfnVPCCidrBlock(context.scope, id + "-secondaryCidr", {
            vpcId: vpc.vpcId,
            cidrBlock: this.secondaryCidr
        });
        secondaryCidr.node.addDependency(vpc);
        if (this.secondarySubnetCidrs) {
            for (let i = 0; i < vpc.availabilityZones.length; i++) {
                if (this.secondarySubnetCidrs[i]) {
                    secondarySubnets[i] = new ec2.PrivateSubnet(context.scope, id + "private-subnet-" + i, {
                        availabilityZone: vpc.availabilityZones[i],
                        cidrBlock: this.secondarySubnetCidrs[i],
                        vpcId: vpc.vpcId
                    });
                    secondarySubnets[i].node.addDependency(secondaryCidr);
                    context.add("secondary-cidr-subnet-" + i, {
                        provide(_context) { return secondarySubnets[i]; }
                    });
                }
            }
            for (let secondarySubnet of secondarySubnets) {
                aws_cdk_lib_1.Tags.of(secondarySubnet).add("kubernetes.io/role/internal-elb", "1", { applyToLaunchedInstances: true });
                aws_cdk_lib_1.Tags.of(secondarySubnet).add("Name", `blueprint-construct-dev-PrivateSubnet-${secondarySubnet}`, { applyToLaunchedInstances: true });
            }
        }
    }
}
exports.VpcProvider = VpcProvider;
class DirectVpcProvider {
    constructor(vpc) {
        this.vpc = vpc;
    }
    provide(_context) {
        return this.vpc;
    }
}
exports.DirectVpcProvider = DirectVpcProvider;
/**
 * Direct import secondary subnet provider, based on a known subnet ID.
 * Recommended method if secondary subnet id is known, as it avoids extra look-ups.
 */
class LookupSubnetProvider {
    constructor(subnetId) {
        this.subnetId = subnetId;
    }
    provide(context) {
        return ec2.Subnet.fromSubnetAttributes(context.scope, `${this.subnetId}-secondarysubnet`, { subnetId: this.subnetId });
    }
}
exports.LookupSubnetProvider = LookupSubnetProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3Jlc291cmNlLXByb3ZpZGVycy92cGMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQW1DO0FBQ25DLDJDQUEyQztBQWEzQzs7R0FFRztBQUNILE1BQWEsV0FBVztJQU1wQixZQUFZLEtBQWMsRUFBVSxRQUFtQjtRQUFuQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25ELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLEdBQUcsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLFdBQVcsQ0FBQztRQUN6QyxJQUFJLENBQUMsYUFBYSxHQUFHLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxhQUFhLENBQUM7UUFDN0MsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxvQkFBb0IsQ0FBQztJQUMvRCxDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQXdCO1FBQzVCLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUNqQyxJQUFJLEdBQUcsR0FBRyxTQUFTLENBQUM7UUFFcEIsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1osSUFBSSxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtnQkFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO2dCQUNqRCxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQUcsTUFBTSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7YUFDN0U7aUJBQU07Z0JBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsSUFBSSxDQUFDLEtBQUssTUFBTSxDQUFDLENB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QUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLHlDQUF5QyxlQUFlLEVBQUUsRUFBRSxFQUFFLHdCQUF3QixFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7YUFDeEk7U0FDSjtJQUNMLENBQUM7Q0FDSjtBQTlFRCxrQ0E4RUM7QUFFRCxNQUFhLGlCQUFpQjtJQUN6QixZQUFxQixHQUFhO1FBQWIsUUFBRyxHQUFILEdBQUcsQ0FBVTtJQUFJLENBQUM7SUFFeEMsT0FBTyxDQUFDLFFBQXlCO1FBQzdCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNwQixDQUFDO0NBQ0o7QUFORCw4Q0FNQztBQUVEOzs7R0FHRztBQUNILE1BQWEsb0JBQW9CO0lBQzdCLFlBQW9CLFFBQWdCO1FBQWhCLGFBQVEsR0FBUixRQUFRLENBQVE7SUFBSSxDQUFDO0lBRXpDLE9BQU8sQ0FBQyxPQUF3QjtRQUM1QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLGtCQUFrQixFQUFFLEVBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUMsQ0FBQyxDQUFDO0lBQ3pILENBQUM7Q0FDSjtBQU5ELG9EQU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7IElTdWJuZXQsIFByaXZhdGVTdWJuZXQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7IFJlc291cmNlQ29udGV4dCwgUmVzb3VyY2VQcm92aWRlciB9IGZyb20gXCIuLi9zcGlcIjtcblxuLyoqXG4gKiBJbnRlcmZhY2UgZm9yIE1hcHBpbmcgZm9yIGZpZWxkcyBzdWNoIGFzIFByaW1hcnkgQ0lEUiwgU2Vjb25kYXJ5IENJRFIsIFNlY29uZGFyeSBTdWJuZXQgQ0lEUi5cbiAqL1xuaW50ZXJmYWNlIFZwY1Byb3BzIHtcbiAgIHByaW1hcnlDaWRyOiBzdHJpbmcsIFxuICAgc2Vjb25kYXJ5Q2lkcj86IHN0cmluZyxcbiAgIHNlY29uZGFyeVN1Ym5ldENpZHJzPzogc3RyaW5nW11cbn1cblxuLyoqXG4gKiBWUEMgcmVzb3VyY2UgcHJvdmlkZXIgXG4gKi9cbmV4cG9ydCBjbGFzcyBWcGNQcm92aWRlciBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8ZWMyLklWcGM+IHtcbiAgICByZWFkb25seSB2cGNJZD86IHN0cmluZztcbiAgICByZWFkb25seSBwcmltYXJ5Q2lkcj86IHN0cmluZztcbiAgICByZWFkb25seSBzZWNvbmRhcnlDaWRyPzogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHNlY29uZGFyeVN1Ym5ldENpZHJzPzogc3RyaW5nW107XG5cbiAgICBjb25zdHJ1Y3Rvcih2cGNJZD86IHN0cmluZywgcHJpdmF0ZSB2cGNQcm9wcz86IFZwY1Byb3BzKSB7XG4gICAgICAgIHRoaXMudnBjSWQgPSB2cGNJZDtcbiAgICAgICAgdGhpcy5wcmltYXJ5Q2lkciA9IHZwY1Byb3BzPy5wcmltYXJ5Q2lkcjtcbiAgICAgICAgdGhpcy5zZWNvbmRhcnlDaWRyID0gdnBjUHJvcHM/LnNlY29uZGFyeUNpZHI7XG4gICAgICAgIHRoaXMuc2Vjb25kYXJ5U3VibmV0Q2lkcnMgPSB2cGNQcm9wcz8uc2Vjb25kYXJ5U3VibmV0Q2lkcnM7XG4gICAgfVxuXG4gICAgcHJvdmlkZShjb250ZXh0OiBSZXNvdXJjZUNvbnRleHQpOiBlYzIuSVZwYyB7XG4gICAgICAgIGNvbnN0IGlkID0gY29udGV4dC5zY29wZS5ub2RlLmlkO1xuICAgICAgICBsZXQgdnBjID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIGlmICh0aGlzLnZwY0lkKSB7XG4gICAgICAgICAgICBpZiAodGhpcy52cGNJZCA9PT0gXCJkZWZhdWx0XCIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9va2luZyB1cCBjb21wbGV0ZWx5IGRlZmF1bHQgVlBDYCk7XG4gICAgICAgICAgICAgICAgdnBjID0gZWMyLlZwYy5mcm9tTG9va3VwKGNvbnRleHQuc2NvcGUsIGlkICsgXCItdnBjXCIsIHsgaXNEZWZhdWx0OiB0cnVlIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9va2luZyB1cCBub24tZGVmYXVsdCAke3RoaXMudnBjSWR9IFZQQ2ApO1xuICAgICAgICAgICAgICAgIHZwYyA9IGVjMi5WcGMuZnJvbUxvb2t1cChjb250ZXh0LnNjb3BlLCBpZCArIFwiLXZwY1wiLCB7IHZwY0lkOiB0aGlzLnZwY0lkIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHZwYyA9PSBudWxsKSB7XG4gICAgICAgICAgICAvLyBJdCB3aWxsIGF1dG9tYXRpY2FsbHkgZGl2aWRlIHRoZSBwcm92aWRlZCBWUEMgQ0lEUiByYW5nZSwgYW5kIGNyZWF0ZSBwdWJsaWMgYW5kIHByaXZhdGUgc3VibmV0cyBwZXIgQXZhaWxhYmlsaXR5IFpvbmUuXG4gICAgICAgICAgICAvLyBJZiBWUEMgQ0lEUiByYW5nZSBpcyBub3QgcHJvdmlkZWQsIHVzZXMgYDEwLjAuMC4wLzE2YCBhcyB0aGUgcmFuZ2UgYW5kIGNyZWF0ZXMgcHVibGljIGFuZCBwcml2YXRlIHN1Ym5ldHMgcGVyIEF2YWlsYWJpbGl0eSBab25lLlxuICAgICAgICAgICAgLy8gTmV0d29yayByb3V0aW5nIGZvciB0aGUgcHVibGljIHN1Ym5ldHMgd2lsbCBiZSBjb25maWd1cmVkIHRvIGFsbG93IG91dGJvdW5kIGFjY2VzcyBkaXJlY3RseSB2aWEgYW4gSW50ZXJuZXQgR2F0ZXdheS5cbiAgICAgICAgICAgIC8vIE5ldHdvcmsgcm91dGluZyBmb3IgdGhlIHByaXZhdGUgc3VibmV0cyB3aWxsIGJlIGNvbmZpZ3VyZWQgdG8gYWxsb3cgb3V0Ym91bmQgYWNjZXNzIHZpYSBhIHNldCBvZiByZXNpbGllbnQgTkFUIEdhdGV3YXlzIChvbmUgcGVyIEFaKS5cbiAgICAgICAgICAgIC8vIENyZWF0ZXMgU2Vjb25kYXJ5IENJRFIgYW5kIFNlY29uZGFyeSBzdWJuZXRzIGlmIHBhc3NlZC5cbiAgICAgICAgICAgIGlmICh0aGlzLnByaW1hcnlDaWRyKSB7XG4gICAgICAgICAgICAgICAgdnBjID0gbmV3IGVjMi5WcGMoY29udGV4dC5zY29wZSwgaWQgKyBcIi12cGNcIix7XG4gICAgICAgICAgICAgICAgICAgIGlwQWRkcmVzc2VzOiBlYzIuSXBBZGRyZXNzZXMuY2lkcih0aGlzLnByaW1hcnlDaWRyKVxuICAgICAgICAgICAgICAgIH0pOyAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZwYyA9IG5ldyBlYzIuVnBjKGNvbnRleHQuc2NvcGUsIGlkICsgXCItdnBjXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLnNlY29uZGFyeUNpZHIpIHtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlU2Vjb25kYXJ5U3VibmV0cyhjb250ZXh0LCBpZCwgdnBjKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICByZXR1cm4gdnBjO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVTZWNvbmRhcnlTdWJuZXRzKGNvbnRleHQ6IFJlc291cmNlQ29udGV4dCwgaWQ6IHN0cmluZywgdnBjOiBlYzIuSVZwYykge1xuICAgICAgICBjb25zdCBzZWNvbmRhcnlTdWJuZXRzOiBBcnJheTxQcml2YXRlU3VibmV0PiA9IFtdO1xuICAgICAgICBjb25zdCBzZWNvbmRhcnlDaWRyID0gbmV3IGVjMi5DZm5WUENDaWRyQmxvY2soY29udGV4dC5zY29wZSwgaWQgKyBcIi1zZWNvbmRhcnlDaWRyXCIsIHtcbiAgICAgICAgICAgIHZwY0lkOiB2cGMudnBjSWQsXG4gICAgICAgICAgICBjaWRyQmxvY2s6IHRoaXMuc2Vjb25kYXJ5Q2lkclxuICAgICAgICB9KTtcbiAgICAgICAgc2Vjb25kYXJ5Q2lkci5ub2RlLmFkZERlcGVuZGVuY3kodnBjKTtcbiAgICAgICAgaWYgKHRoaXMuc2Vjb25kYXJ5U3VibmV0Q2lkcnMpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdnBjLmF2YWlsYWJpbGl0eVpvbmVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2Vjb25kYXJ5U3VibmV0Q2lkcnNbaV0pIHtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5U3VibmV0c1tpXSA9IG5ldyBlYzIuUHJpdmF0ZVN1Ym5ldChjb250ZXh0LnNjb3BlLCBpZCArIFwicHJpdmF0ZS1zdWJuZXQtXCIgKyBpLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdmFpbGFiaWxpdHlab25lOiB2cGMuYXZhaWxhYmlsaXR5Wm9uZXNbaV0sXG4gICAgICAgICAgICAgICAgICAgICAgICBjaWRyQmxvY2s6IHRoaXMuc2Vjb25kYXJ5U3VibmV0Q2lkcnNbaV0sXG4gICAgICAgICAgICAgICAgICAgICAgICB2cGNJZDogdnBjLnZwY0lkXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlTdWJuZXRzW2ldLm5vZGUuYWRkRGVwZW5kZW5jeShzZWNvbmRhcnlDaWRyKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5hZGQoXCJzZWNvbmRhcnktY2lkci1zdWJuZXQtXCIgKyBpLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlKF9jb250ZXh0KTogSVN1Ym5ldCB7IHJldHVybiBzZWNvbmRhcnlTdWJuZXRzW2ldOyB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAobGV0IHNlY29uZGFyeVN1Ym5ldCBvZiBzZWNvbmRhcnlTdWJuZXRzKSB7XG4gICAgICAgICAgICAgICAgVGFncy5vZihzZWNvbmRhcnlTdWJuZXQpLmFkZChcImt1YmVybmV0ZXMuaW8vcm9sZS9pbnRlcm5hbC1lbGJcIiwgXCIxXCIsIHsgYXBwbHlUb0xhdW5jaGVkSW5zdGFuY2VzOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIFRhZ3Mub2Yoc2Vjb25kYXJ5U3VibmV0KS5hZGQoXCJOYW1lXCIsIGBibHVlcHJpbnQtY29uc3RydWN0LWRldi1Qcml2YXRlU3VibmV0LSR7c2Vjb25kYXJ5U3VibmV0fWAsIHsgYXBwbHlUb0xhdW5jaGVkSW5zdGFuY2VzOiB0cnVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGlyZWN0VnBjUHJvdmlkZXIgaW1wbGVtZW50cyBSZXNvdXJjZVByb3ZpZGVyPGVjMi5JVnBjPiB7XG4gICAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHZwYzogZWMyLklWcGMpIHsgfVxuXG4gICAgcHJvdmlkZShfY29udGV4dDogUmVzb3VyY2VDb250ZXh0KTogZWMyLklWcGMge1xuICAgICAgICByZXR1cm4gdGhpcy52cGM7XG4gICAgfSAgICBcbn1cblxuLyoqXG4gKiBEaXJlY3QgaW1wb3J0IHNlY29uZGFyeSBzdWJuZXQgcHJvdmlkZXIsIGJhc2VkIG9uIGEga25vd24gc3VibmV0IElELiBcbiAqIFJlY29tbWVuZGVkIG1ldGhvZCBpZiBzZWNvbmRhcnkgc3VibmV0IGlkIGlzIGtub3duLCBhcyBpdCBhdm9pZHMgZXh0cmEgbG9vay11cHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBMb29rdXBTdWJuZXRQcm92aWRlciBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8SVN1Ym5ldD4ge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgc3VibmV0SWQ6IHN0cmluZykgeyB9XG5cbiAgICBwcm92aWRlKGNvbnRleHQ6IFJlc291cmNlQ29udGV4dCk6IGVjMi5JU3VibmV0IHtcbiAgICAgICAgcmV0dXJuIGVjMi5TdWJuZXQuZnJvbVN1Ym5ldEF0dHJpYnV0ZXMoY29udGV4dC5zY29wZSwgYCR7dGhpcy5zdWJuZXRJZH0tc2Vjb25kYXJ5c3VibmV0YCwge3N1Ym5ldElkOiB0aGlzLnN1Ym5ldElkfSk7XG4gICAgfVxufVxuIl19