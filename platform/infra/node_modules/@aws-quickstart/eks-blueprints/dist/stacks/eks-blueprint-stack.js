"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EksBlueprint = exports.BlueprintBuilder = exports.BlueprintPropsConstraints = exports.EksBlueprintProps = void 0;
const cdk = require("aws-cdk-lib");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const mng_cluster_provider_1 = require("../cluster-providers/mng-cluster-provider");
const vpc_1 = require("../resource-providers/vpc");
const spi = require("../spi");
const constraints = require("../utils/constraints-utils");
const utils = require("../utils");
const utils_1 = require("../utils");
const kms_key_1 = require("../resource-providers/kms-key");
const argo_gitops_factory_1 = require("../addons/argocd/argo-gitops-factory");
class EksBlueprintProps {
    constructor() {
        /**
         * Add-ons if any.
         */
        this.addOns = [];
        /**
         * Teams if any
         */
        this.teams = [];
        /**
         * EC2 or Fargate are supported in the blueprint but any implementation conforming the interface
         * will work
         */
        this.clusterProvider = new mng_cluster_provider_1.MngClusterProvider();
        /**
         * Named resource providers to leverage for cluster resources.
         * The resource can represent Vpc, Hosting Zones or other resources, see {@link spi.ResourceType}.
         * VPC for the cluster can be registered under the name of 'vpc' or as a single provider of type
         */
        this.resourceProviders = new Map();
        /**
         * If set to true and no resouce provider for KMS key is defined (under GlobalResources.KmsKey),
         * a default KMS encryption key will be used for envelope encryption of Kubernetes secrets (AWS managed new KMS key).
         * If set to false, and no resouce provider for KMS key is defined (under GlobalResources.KmsKey), then no secrets
         * encyrption is applied.
         *
         * Default is true.
         */
        this.useDefaultSecretEncryption = true;
    }
}
exports.EksBlueprintProps = EksBlueprintProps;
class BlueprintPropsConstraints {
    constructor() {
        /**
        * id can be no less than 1 character long, and no greater than 63 characters long.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.id = new constraints.StringConstraint(1, 63);
        /**
        * name can be no less than 1 character long, and no greater than 63 characters long.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.name = new constraints.StringConstraint(1, 63);
    }
}
exports.BlueprintPropsConstraints = BlueprintPropsConstraints;
/**
 * Blueprint builder implements a builder pattern that improves readability (no bloated constructors)
 * and allows creating a blueprint in an abstract state that can be applied to various instantiations
 * in accounts and regions.
 */
class BlueprintBuilder {
    constructor() {
        this.props = { addOns: new Array(), teams: new Array(), resourceProviders: new Map() };
        this.env = {
            account: process.env.CDK_DEFAULT_ACCOUNT,
            region: process.env.CDK_DEFAULT_REGION
        };
    }
    name(name) {
        this.props = { ...this.props, ...{ name } };
        return this;
    }
    account(account) {
        this.env.account = account;
        return this;
    }
    region(region) {
        this.env.region = region;
        return this;
    }
    version(version) {
        this.props = { ...this.props, ...{ version: version } };
        return this;
    }
    enableControlPlaneLogTypes(...types) {
        this.props = { ...this.props, ...{ enableControlPlaneLogTypes: types } };
        return this;
    }
    enableGitOps(mode) {
        this.props = { ...this.props, ...{ enableGitOpsMode: mode !== null && mode !== void 0 ? mode : spi.GitOpsMode.APP_OF_APPS } };
        return this;
    }
    withBlueprintProps(props) {
        const resourceProviders = this.props.resourceProviders;
        this.props = { ...this.props, ...(0, utils_1.cloneDeep)(props) };
        if (props.resourceProviders) {
            this.props.resourceProviders = new Map([...resourceProviders.entries(), ...props.resourceProviders.entries()]);
        }
        return this;
    }
    addOns(...addOns) {
        var _a;
        this.props = { ...this.props, ...{ addOns: (_a = this.props.addOns) === null || _a === void 0 ? void 0 : _a.concat(addOns) } };
        return this;
    }
    clusterProvider(clusterProvider) {
        this.props = { ...this.props, ...{ clusterProvider: clusterProvider } };
        return this;
    }
    id(id) {
        this.props = { ...this.props, ...{ id } };
        return this;
    }
    teams(...teams) {
        var _a;
        this.props = { ...this.props, ...{ teams: (_a = this.props.teams) === null || _a === void 0 ? void 0 : _a.concat(teams) } };
        return this;
    }
    resourceProvider(name, provider) {
        var _a;
        (_a = this.props.resourceProviders) === null || _a === void 0 ? void 0 : _a.set(name, provider);
        return this;
    }
    useDefaultSecretEncryption(useDefault) {
        this.props = { ...this.props, ...{ useDefaultSecretEncryption: useDefault } };
        return this;
    }
    clone(region, account) {
        return new BlueprintBuilder().withBlueprintProps(this.props)
            .account(account !== null && account !== void 0 ? account : this.env.account).region(region !== null && region !== void 0 ? region : this.env.region);
    }
    withEnv(env) {
        this.env.account = env.account;
        this.env.region = env.region;
        return this;
    }
    build(scope, id, stackProps) {
        return new EksBlueprint(scope, { ...this.props, ...{ id } }, { ...{ env: this.env }, ...stackProps });
    }
    async buildAsync(scope, id, stackProps) {
        return this.build(scope, id, stackProps).waitForAsyncTasks();
    }
}
exports.BlueprintBuilder = BlueprintBuilder;
/**
 * Entry point to the platform provisioning. Creates a CFN stack based on the provided configuration
 * and orchestrates provisioning of add-ons, teams and post deployment hooks.
 */
class EksBlueprint extends cdk.Stack {
    static builder() {
        return new BlueprintBuilder();
    }
    constructor(scope, blueprintProps, props) {
        var _a, _b, _c;
        super(scope, blueprintProps.id, utils.withUsageTracking(EksBlueprint.USAGE_ID, props));
        this.validateInput(blueprintProps);
        const resourceContext = this.provideNamedResources(blueprintProps);
        let vpcResource = resourceContext.get(spi.GlobalResources.Vpc);
        if (!vpcResource) {
            vpcResource = resourceContext.add(spi.GlobalResources.Vpc, new vpc_1.VpcProvider());
        }
        let version = blueprintProps.version;
        if (version == "auto") {
            version = aws_eks_1.KubernetesVersion.V1_27;
        }
        let kmsKeyResource = resourceContext.get(spi.GlobalResources.KmsKey);
        if (!kmsKeyResource && blueprintProps.useDefaultSecretEncryption != false) {
            kmsKeyResource = resourceContext.add(spi.GlobalResources.KmsKey, new kms_key_1.CreateKmsKeyProvider());
        }
        blueprintProps = this.resolveDynamicProxies(blueprintProps, resourceContext);
        const clusterProvider = (_a = blueprintProps.clusterProvider) !== null && _a !== void 0 ? _a : new mng_cluster_provider_1.MngClusterProvider({
            id: `${(_b = blueprintProps.name) !== null && _b !== void 0 ? _b : blueprintProps.id}-ng`,
            version
        });
        this.clusterInfo = clusterProvider.createCluster(this, vpcResource, kmsKeyResource, version);
        this.clusterInfo.setResourceContext(resourceContext);
        let enableLogTypes = blueprintProps.enableControlPlaneLogTypes;
        if (enableLogTypes) {
            utils.setupClusterLogging(this.clusterInfo.cluster.stack, this.clusterInfo.cluster, enableLogTypes);
        }
        if (blueprintProps.enableGitOpsMode == spi.GitOpsMode.APPLICATION) {
            argo_gitops_factory_1.ArgoGitOpsFactory.enableGitOps();
        }
        else if (blueprintProps.enableGitOpsMode == spi.GitOpsMode.APP_OF_APPS) {
            argo_gitops_factory_1.ArgoGitOpsFactory.enableGitOpsAppOfApps();
        }
        const postDeploymentSteps = Array();
        for (let addOn of ((_c = blueprintProps.addOns) !== null && _c !== void 0 ? _c : [])) { // must iterate in the strict order
            const result = addOn.deploy(this.clusterInfo);
            if (result) {
                const addOnKey = utils.getAddOnNameOrId(addOn);
                this.clusterInfo.addScheduledAddOn(addOnKey, result, utils.isOrderedAddOn(addOn));
            }
            const postDeploy = addOn;
            if (postDeploy.postDeploy !== undefined) {
                postDeploymentSteps.push(postDeploy);
            }
        }
        const scheduledAddOns = this.clusterInfo.getAllScheduledAddons();
        const addOnKeys = [...scheduledAddOns.keys()];
        const promises = scheduledAddOns.values();
        this.asyncTasks = Promise.all(promises).then((constructs) => {
            var _a;
            constructs.forEach((construct, index) => {
                this.clusterInfo.addProvisionedAddOn(addOnKeys[index], construct);
            });
            if (blueprintProps.teams != null) {
                for (let team of blueprintProps.teams) {
                    team.setup(this.clusterInfo);
                }
            }
            for (let step of postDeploymentSteps) {
                step.postDeploy(this.clusterInfo, (_a = blueprintProps.teams) !== null && _a !== void 0 ? _a : []);
            }
        });
        this.asyncTasks.catch(err => {
            console.error(err);
            throw new Error(err);
        });
    }
    /**
     * Since constructor cannot be marked as async, adding a separate method to wait
     * for async code to finish.
     * @returns Promise that resolves to the blueprint
     */
    async waitForAsyncTasks() {
        if (this.asyncTasks) {
            return this.asyncTasks.then(() => {
                return this;
            });
        }
        return Promise.resolve(this);
    }
    /**
     * This method returns all the constructs produced by during the cluster creation (e.g. add-ons).
     * May be used in testing for verification.
     * @returns cluster info object
     */
    getClusterInfo() {
        return this.clusterInfo;
    }
    provideNamedResources(blueprintProps) {
        var _a;
        const result = new spi.ResourceContext(this, blueprintProps);
        for (let [key, value] of (_a = blueprintProps.resourceProviders) !== null && _a !== void 0 ? _a : []) {
            result.add(key, value);
        }
        return result;
    }
    /**
     * Resolves all dynamic proxies, that substitutes resource provider proxies with the resolved values.
     * @param blueprintProps
     * @param resourceContext
     * @returns a copy of blueprint props with resolved values
     */
    resolveDynamicProxies(blueprintProps, resourceContext) {
        return utils.cloneDeep(blueprintProps, (value) => {
            return utils.resolveTarget(value, resourceContext);
        });
    }
    /**
     * Validates input against basic defined constraints.
     * @param blueprintProps
     */
    validateInput(blueprintProps) {
        const teamNames = new Set();
        constraints.validateConstraints(new BlueprintPropsConstraints, EksBlueprintProps.name, blueprintProps);
        if (blueprintProps.teams) {
            blueprintProps.teams.forEach(e => {
                if (teamNames.has(e.name)) {
                    throw new Error(`Team ${e.name} is registered more than once`);
                }
                teamNames.add(e.name);
            });
        }
    }
}
exports.EksBlueprint = EksBlueprint;
EksBlueprint.USAGE_ID = "qs-1s1r465hk";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWtzLWJsdWVwcmludC1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zdGFja3MvZWtzLWJsdWVwcmludC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFFbkMsaURBQXdEO0FBRXhELG9GQUErRTtBQUMvRSxtREFBd0Q7QUFDeEQsOEJBQThCO0FBQzlCLDBEQUEwRDtBQUMxRCxrQ0FBa0M7QUFDbEMsb0NBQXFDO0FBRXJDLDJEQUFtRTtBQUNuRSw4RUFBeUU7QUFFekUsTUFBYSxpQkFBaUI7SUFBOUI7UUFXSTs7V0FFRztRQUNNLFdBQU0sR0FBNkIsRUFBRSxDQUFDO1FBRS9DOztXQUVHO1FBQ00sVUFBSyxHQUFxQixFQUFFLENBQUM7UUFFdEM7OztXQUdHO1FBQ00sb0JBQWUsR0FBeUIsSUFBSSx5Q0FBa0IsRUFBRSxDQUFDO1FBTzFFOzs7O1dBSUc7UUFDSCxzQkFBaUIsR0FBdUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQVFsRTs7Ozs7OztXQU9HO1FBQ00sK0JBQTBCLEdBQWUsSUFBSSxDQUFDO0lBTTNELENBQUM7Q0FBQTtBQTNERCw4Q0EyREM7QUFFRCxNQUFhLHlCQUF5QjtJQUF0QztRQUNJOzs7VUFHRTtRQUNGLE9BQUUsR0FBRyxJQUFJLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFN0M7OztVQUdFO1FBQ0YsU0FBSSxHQUFHLElBQUksV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0NBQUE7QUFaRCw4REFZQztBQVdEOzs7O0dBSUc7QUFDSCxNQUFhLGdCQUFnQjtJQVF6QjtRQUNJLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxNQUFNLEVBQUUsSUFBSSxLQUFLLEVBQW9CLEVBQUUsS0FBSyxFQUFFLElBQUksS0FBSyxFQUFZLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxH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QUFDLENBQUMsRUFBRTtnQkFDN0IsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLCtCQUErQixDQUFDLENBQUM7aUJBQ2xFO2dCQUNELFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFCLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDOztBQTVKTCxvQ0E2SkM7QUEzSm1CLHFCQUFRLEdBQUcsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IElWcGMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7IEt1YmVybmV0ZXNWZXJzaW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IE1uZ0NsdXN0ZXJQcm92aWRlciB9IGZyb20gJy4uL2NsdXN0ZXItcHJvdmlkZXJzL21uZy1jbHVzdGVyLXByb3ZpZGVyJztcbmltcG9ydCB7IFZwY1Byb3ZpZGVyIH0gZnJvbSAnLi4vcmVzb3VyY2UtcHJvdmlkZXJzL3ZwYyc7XG5pbXBvcnQgKiBhcyBzcGkgZnJvbSAnLi4vc3BpJztcbmltcG9ydCAqIGFzIGNvbnN0cmFpbnRzIGZyb20gJy4uL3V0aWxzL2NvbnN0cmFpbnRzLXV0aWxzJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IElLZXkgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWttc1wiO1xuaW1wb3J0IHtDcmVhdGVLbXNLZXlQcm92aWRlcn0gZnJvbSBcIi4uL3Jlc291cmNlLXByb3ZpZGVycy9rbXMta2V5XCI7XG5pbXBvcnQgeyBBcmdvR2l0T3BzRmFjdG9yeSB9IGZyb20gXCIuLi9hZGRvbnMvYXJnb2NkL2FyZ28tZ2l0b3BzLWZhY3RvcnlcIjtcblxuZXhwb3J0IGNsYXNzIEVrc0JsdWVwcmludFByb3BzIHtcbiAgICAvKipcbiAgICAgKiBUaGUgaWQgZm9yIHRoZSBibHVlcHJpbnQuXG4gICAgICovXG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIERlZmF1bHRzIHRvIGlkIGlmIG5vdCBwcm92aWRlZFxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5hbWU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBZGQtb25zIGlmIGFueS5cbiAgICAgKi9cbiAgICByZWFkb25seSBhZGRPbnM/OiBBcnJheTxzcGkuQ2x1c3RlckFkZE9uPiA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogVGVhbXMgaWYgYW55XG4gICAgICovXG4gICAgcmVhZG9ubHkgdGVhbXM/OiBBcnJheTxzcGkuVGVhbT4gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIEVDMiBvciBGYXJnYXRlIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGJsdWVwcmludCBidXQgYW55IGltcGxlbWVudGF0aW9uIGNvbmZvcm1pbmcgdGhlIGludGVyZmFjZVxuICAgICAqIHdpbGwgd29ya1xuICAgICAqL1xuICAgIHJlYWRvbmx5IGNsdXN0ZXJQcm92aWRlcj86IHNwaS5DbHVzdGVyUHJvdmlkZXIgPSBuZXcgTW5nQ2x1c3RlclByb3ZpZGVyKCk7XG5cbiAgICAvKipcbiAgICAgKiBLdWJlcm5ldGVzIHZlcnNpb24gKG11c3QgYmUgaW5pdGlhbGl6ZWQgZm9yIGFkZG9ucyB0byB3b3JrIHByb3Blcmx5KVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHZlcnNpb24/OiBLdWJlcm5ldGVzVmVyc2lvbiB8IFwiYXV0b1wiO1xuXG4gICAgLyoqXG4gICAgICogTmFtZWQgcmVzb3VyY2UgcHJvdmlkZXJzIHRvIGxldmVyYWdlIGZvciBjbHVzdGVyIHJlc291cmNlcy5cbiAgICAgKiBUaGUgcmVzb3VyY2UgY2FuIHJlcHJlc2VudCBWcGMsIEhvc3RpbmcgWm9uZXMgb3Igb3RoZXIgcmVzb3VyY2VzLCBzZWUge0BsaW5rIHNwaS5SZXNvdXJjZVR5cGV9LlxuICAgICAqIFZQQyBmb3IgdGhlIGNsdXN0ZXIgY2FuIGJlIHJlZ2lzdGVyZWQgdW5kZXIgdGhlIG5hbWUgb2YgJ3ZwYycgb3IgYXMgYSBzaW5nbGUgcHJvdmlkZXIgb2YgdHlwZVxuICAgICAqL1xuICAgIHJlc291cmNlUHJvdmlkZXJzPzogTWFwPHN0cmluZywgc3BpLlJlc291cmNlUHJvdmlkZXI+ID0gbmV3IE1hcCgpO1xuXG4gICAgLyoqXG4gICAgICogQ29udHJvbCBQbGFuZSBsb2cgdHlwZXMgdG8gYmUgZW5hYmxlZCAoaWYgbm90IHBhc3NlZCwgbm9uZSlcbiAgICAgKiBJZiB3cm9uZyB0eXBlcyBhcmUgaW5jbHVkZWQsIHdpbGwgdGhyb3cgYW4gZXJyb3IuXG4gICAgICovXG4gICAgcmVhZG9ubHkgZW5hYmxlQ29udHJvbFBsYW5lTG9nVHlwZXM/OiBDb250cm9sUGxhbmVMb2dUeXBlW107XG5cbiAgICAvKipcbiAgICAgKiBJZiBzZXQgdG8gdHJ1ZSBhbmQgbm8gcmVzb3VjZSBwcm92aWRlciBmb3IgS01TIGtleSBpcyBkZWZpbmVkICh1bmRlciBHbG9iYWxSZXNvdXJjZXMuS21zS2V5KSxcbiAgICAgKiBhIGRlZmF1bHQgS01TIGVuY3J5cHRpb24ga2V5IHdpbGwgYmUgdXNlZCBmb3IgZW52ZWxvcGUgZW5jcnlwdGlvbiBvZiBLdWJlcm5ldGVzIHNlY3JldHMgKEFXUyBtYW5hZ2VkIG5ldyBLTVMga2V5KS5cbiAgICAgKiBJZiBzZXQgdG8gZmFsc2UsIGFuZCBubyByZXNvdWNlIHByb3ZpZGVyIGZvciBLTVMga2V5IGlzIGRlZmluZWQgKHVuZGVyIEdsb2JhbFJlc291cmNlcy5LbXNLZXkpLCB0aGVuIG5vIHNlY3JldHMgXG4gICAgICogZW5jeXJwdGlvbiBpcyBhcHBsaWVkLlxuICAgICAqIFxuICAgICAqIERlZmF1bHQgaXMgdHJ1ZS5cbiAgICAgKi9cbiAgICByZWFkb25seSB1c2VEZWZhdWx0U2VjcmV0RW5jcnlwdGlvbj8gOiBib29sZWFuICA9IHRydWU7XG5cbiAgICAvKipcbiAgICAgKiBHaXRPcHMgbW9kZXMgdG8gYmUgZW5hYmxlZC4gSWYgbm90IHNwZWNpZmllZCwgR2l0T3BzIG1vZGUgaXMgbm90IGVuYWJsZWQuXG4gICAgICovXG4gICAgcmVhZG9ubHkgZW5hYmxlR2l0T3BzTW9kZT86IHNwaS5HaXRPcHNNb2RlO1xufVxuXG5leHBvcnQgY2xhc3MgQmx1ZXByaW50UHJvcHNDb25zdHJhaW50cyBpbXBsZW1lbnRzIGNvbnN0cmFpbnRzLkNvbnN0cmFpbnRzVHlwZTxFa3NCbHVlcHJpbnRQcm9wcz4ge1xuICAgIC8qKlxuICAgICogaWQgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZy5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICovXG4gICAgaWQgPSBuZXcgY29uc3RyYWludHMuU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG5cbiAgICAvKipcbiAgICAqIG5hbWUgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZy5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICovXG4gICAgbmFtZSA9IG5ldyBjb25zdHJhaW50cy5TdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcbn1cblxuZXhwb3J0IGNvbnN0IGVudW0gQ29udHJvbFBsYW5lTG9nVHlwZSB7XG5cbiAgICBBUEkgPSAnYXBpJyxcbiAgICBBVURJVCA9ICdhdWRpdCcsXG4gICAgQVVUSEVOVElDQVRPUiA9ICdhdXRoZW50aWNhdG9yJyxcbiAgICBDT05UUk9MTEVSX01BTkFHRVIgPSAnY29udHJvbGxlck1hbmFnZXInLFxuICAgIFNDSEVEVUxFUiA9ICdzY2hlZHVsZXInXG59XG5cbi8qKlxuICogQmx1ZXByaW50IGJ1aWxkZXIgaW1wbGVtZW50cyBhIGJ1aWxkZXIgcGF0dGVybiB0aGF0IGltcHJvdmVzIHJlYWRhYmlsaXR5IChubyBibG9hdGVkIGNvbnN0cnVjdG9ycylcbiAqIGFuZCBhbGxvd3MgY3JlYXRpbmcgYSBibHVlcHJpbnQgaW4gYW4gYWJzdHJhY3Qgc3RhdGUgdGhhdCBjYW4gYmUgYXBwbGllZCB0byB2YXJpb3VzIGluc3RhbnRpYXRpb25zXG4gKiBpbiBhY2NvdW50cyBhbmQgcmVnaW9ucy5cbiAqL1xuZXhwb3J0IGNsYXNzIEJsdWVwcmludEJ1aWxkZXIgaW1wbGVtZW50cyBzcGkuQXN5bmNTdGFja0J1aWxkZXIge1xuXG4gICAgcHJvcHM6IFBhcnRpYWw8RWtzQmx1ZXByaW50UHJvcHM+O1xuICAgIGVudjoge1xuICAgICAgICBhY2NvdW50Pzogc3RyaW5nLFxuICAgICAgICByZWdpb24/OiBzdHJpbmdcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IGFkZE9uczogbmV3IEFycmF5PHNwaS5DbHVzdGVyQWRkT24+KCksIHRlYW1zOiBuZXcgQXJyYXk8c3BpLlRlYW0+KCksIHJlc291cmNlUHJvdmlkZXJzOiBuZXcgTWFwKCkgfTtcbiAgICAgICAgdGhpcy5lbnYgPSB7XG4gICAgICAgICAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgICAgICAgICAgcmVnaW9uOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT05cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbmFtZShuYW1lOiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyBuYW1lIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGFjY291bnQoYWNjb3VudD86IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLmVudi5hY2NvdW50ID0gYWNjb3VudDtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHJlZ2lvbihyZWdpb24/OiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5lbnYucmVnaW9uID0gcmVnaW9uO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgdmVyc2lvbih2ZXJzaW9uOiBcImF1dG9cIiB8IEt1YmVybmV0ZXNWZXJzaW9uKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgdmVyc2lvbjogdmVyc2lvbiB9IH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBlbmFibGVDb250cm9sUGxhbmVMb2dUeXBlcyguLi50eXBlczogQ29udHJvbFBsYW5lTG9nVHlwZVtdKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgZW5hYmxlQ29udHJvbFBsYW5lTG9nVHlwZXM6IHR5cGVzIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGVuYWJsZUdpdE9wcyhtb2RlPzogc3BpLkdpdE9wc01vZGUpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyBlbmFibGVHaXRPcHNNb2RlOiBtb2RlID8/IHNwaS5HaXRPcHNNb2RlLkFQUF9PRl9BUFBTIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhCbHVlcHJpbnRQcm9wcyhwcm9wczogUGFydGlhbDxFa3NCbHVlcHJpbnRQcm9wcz4pOiB0aGlzIHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2VQcm92aWRlcnMgPSB0aGlzLnByb3BzLnJlc291cmNlUHJvdmlkZXJzITtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4uY2xvbmVEZWVwKHByb3BzKSB9O1xuICAgICAgICBpZiAocHJvcHMucmVzb3VyY2VQcm92aWRlcnMpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVzb3VyY2VQcm92aWRlcnMgPSBuZXcgTWFwKFsuLi5yZXNvdXJjZVByb3ZpZGVycyEuZW50cmllcygpLCAuLi5wcm9wcy5yZXNvdXJjZVByb3ZpZGVycy5lbnRyaWVzKCldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkT25zKC4uLmFkZE9uczogc3BpLkNsdXN0ZXJBZGRPbltdKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgYWRkT25zOiB0aGlzLnByb3BzLmFkZE9ucz8uY29uY2F0KGFkZE9ucykgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgY2x1c3RlclByb3ZpZGVyKGNsdXN0ZXJQcm92aWRlcjogc3BpLkNsdXN0ZXJQcm92aWRlcikge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IGNsdXN0ZXJQcm92aWRlcjogY2x1c3RlclByb3ZpZGVyIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGlkKGlkOiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyBpZCB9IH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB0ZWFtcyguLi50ZWFtczogc3BpLlRlYW1bXSk6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IHRlYW1zOiB0aGlzLnByb3BzLnRlYW1zPy5jb25jYXQodGVhbXMpIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc291cmNlUHJvdmlkZXIobmFtZTogc3RyaW5nLCBwcm92aWRlcjogc3BpLlJlc291cmNlUHJvdmlkZXIpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcy5yZXNvdXJjZVByb3ZpZGVycz8uc2V0KG5hbWUsIHByb3ZpZGVyKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHVzZURlZmF1bHRTZWNyZXRFbmNyeXB0aW9uKHVzZURlZmF1bHQ6IGJvb2xlYW4pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyB1c2VEZWZhdWx0U2VjcmV0RW5jcnlwdGlvbjogdXNlRGVmYXVsdCB9IH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBjbG9uZShyZWdpb24/OiBzdHJpbmcsIGFjY291bnQ/OiBzdHJpbmcpOiBCbHVlcHJpbnRCdWlsZGVyIHtcbiAgICAgICAgcmV0dXJuIG5ldyBCbHVlcHJpbnRCdWlsZGVyKCkud2l0aEJsdWVwcmludFByb3BzKHRoaXMucHJvcHMpXG4gICAgICAgICAgICAuYWNjb3VudChhY2NvdW50ID8/IHRoaXMuZW52LmFjY291bnQpLnJlZ2lvbihyZWdpb24gPz8gdGhpcy5lbnYucmVnaW9uKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgd2l0aEVudihlbnY6IGNkay5FbnZpcm9ubWVudCk6IHRoaXMge1xuICAgICAgICB0aGlzLmVudi5hY2NvdW50ID0gZW52LmFjY291bnQ7XG4gICAgICAgIHRoaXMuZW52LnJlZ2lvbiA9IGVudi5yZWdpb247XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBidWlsZChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBzdGFja1Byb3BzPzogY2RrLlN0YWNrUHJvcHMpOiBFa3NCbHVlcHJpbnQge1xuICAgICAgICByZXR1cm4gbmV3IEVrc0JsdWVwcmludChzY29wZSwgeyAuLi50aGlzLnByb3BzLCAuLi57IGlkIH0gfSxcbiAgICAgICAgICAgIHsgLi4ueyBlbnY6IHRoaXMuZW52IH0sIC4uLnN0YWNrUHJvcHMgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGJ1aWxkQXN5bmMoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgc3RhY2tQcm9wcz86IGNkay5TdGFja1Byb3BzKTogUHJvbWlzZTxFa3NCbHVlcHJpbnQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGQoc2NvcGUsIGlkLCBzdGFja1Byb3BzKS53YWl0Rm9yQXN5bmNUYXNrcygpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBFbnRyeSBwb2ludCB0byB0aGUgcGxhdGZvcm0gcHJvdmlzaW9uaW5nLiBDcmVhdGVzIGEgQ0ZOIHN0YWNrIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBjb25maWd1cmF0aW9uXG4gKiBhbmQgb3JjaGVzdHJhdGVzIHByb3Zpc2lvbmluZyBvZiBhZGQtb25zLCB0ZWFtcyBhbmQgcG9zdCBkZXBsb3ltZW50IGhvb2tzLlxuICovXG5leHBvcnQgY2xhc3MgRWtzQmx1ZXByaW50IGV4dGVuZHMgY2RrLlN0YWNrIHtcblxuICAgIHN0YXRpYyByZWFkb25seSBVU0FHRV9JRCA9IFwicXMtMXMxcjQ2NWhrXCI7XG5cbiAgICBwcml2YXRlIGFzeW5jVGFza3M6IFByb21pc2U8dm9pZCB8IENvbnN0cnVjdFtdPjtcblxuICAgIHByaXZhdGUgY2x1c3RlckluZm86IHNwaS5DbHVzdGVySW5mbztcblxuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRlcigpOiBCbHVlcHJpbnRCdWlsZGVyIHtcbiAgICAgICAgcmV0dXJuIG5ldyBCbHVlcHJpbnRCdWlsZGVyKCk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgYmx1ZXByaW50UHJvcHM6IEVrc0JsdWVwcmludFByb3BzLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBibHVlcHJpbnRQcm9wcy5pZCwgdXRpbHMud2l0aFVzYWdlVHJhY2tpbmcoRWtzQmx1ZXByaW50LlVTQUdFX0lELCBwcm9wcykpO1xuICAgICAgICB0aGlzLnZhbGlkYXRlSW5wdXQoYmx1ZXByaW50UHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IHJlc291cmNlQ29udGV4dCA9IHRoaXMucHJvdmlkZU5hbWVkUmVzb3VyY2VzKGJsdWVwcmludFByb3BzKTtcblxuICAgICAgICBsZXQgdnBjUmVzb3VyY2U6IElWcGMgfCB1bmRlZmluZWQgPSByZXNvdXJjZUNvbnRleHQuZ2V0KHNwaS5HbG9iYWxSZXNvdXJjZXMuVnBjKTtcblxuICAgICAgICBpZiAoIXZwY1Jlc291cmNlKSB7XG4gICAgICAgICAgICB2cGNSZXNvdXJjZSA9IHJlc291cmNlQ29udGV4dC5hZGQoc3BpLkdsb2JhbFJlc291cmNlcy5WcGMsIG5ldyBWcGNQcm92aWRlcigpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB2ZXJzaW9uID0gYmx1ZXByaW50UHJvcHMudmVyc2lvbjtcbiAgICAgICAgaWYgKHZlcnNpb24gPT0gXCJhdXRvXCIpIHtcbiAgICAgICAgICAgIHZlcnNpb24gPSBLdWJlcm5ldGVzVmVyc2lvbi5WMV8yNztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBrbXNLZXlSZXNvdXJjZTogSUtleSB8IHVuZGVmaW5lZCA9IHJlc291cmNlQ29udGV4dC5nZXQoc3BpLkdsb2JhbFJlc291cmNlcy5LbXNLZXkpO1xuXG4gICAgICAgIGlmICgha21zS2V5UmVzb3VyY2UgJiYgYmx1ZXByaW50UHJvcHMudXNlRGVmYXVsdFNlY3JldEVuY3J5cHRpb24gIT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGttc0tleVJlc291cmNlID0gcmVzb3VyY2VDb250ZXh0LmFkZChzcGkuR2xvYmFsUmVzb3VyY2VzLkttc0tleSwgbmV3IENyZWF0ZUttc0tleVByb3ZpZGVyKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgYmx1ZXByaW50UHJvcHMgPSB0aGlzLnJlc29sdmVEeW5hbWljUHJveGllcyhibHVlcHJpbnRQcm9wcywgcmVzb3VyY2VDb250ZXh0KTtcblxuICAgICAgICBjb25zdCBjbHVzdGVyUHJvdmlkZXIgPSBibHVlcHJpbnRQcm9wcy5jbHVzdGVyUHJvdmlkZXIgPz8gbmV3IE1uZ0NsdXN0ZXJQcm92aWRlcih7XG4gICAgICAgICAgICBpZDogYCR7Ymx1ZXByaW50UHJvcHMubmFtZSA/PyBibHVlcHJpbnRQcm9wcy5pZH0tbmdgLFxuICAgICAgICAgICAgdmVyc2lvblxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNsdXN0ZXJJbmZvID0gY2x1c3RlclByb3ZpZGVyLmNyZWF0ZUNsdXN0ZXIodGhpcywgdnBjUmVzb3VyY2UhLCBrbXNLZXlSZXNvdXJjZSwgdmVyc2lvbik7XG4gICAgICAgIHRoaXMuY2x1c3RlckluZm8uc2V0UmVzb3VyY2VDb250ZXh0KHJlc291cmNlQ29udGV4dCk7XG5cbiAgICAgICAgbGV0IGVuYWJsZUxvZ1R5cGVzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCA9IGJsdWVwcmludFByb3BzLmVuYWJsZUNvbnRyb2xQbGFuZUxvZ1R5cGVzO1xuICAgICAgICBpZiAoZW5hYmxlTG9nVHlwZXMpIHtcbiAgICAgICAgICAgIHV0aWxzLnNldHVwQ2x1c3RlckxvZ2dpbmcodGhpcy5jbHVzdGVySW5mby5jbHVzdGVyLnN0YWNrLCB0aGlzLmNsdXN0ZXJJbmZvLmNsdXN0ZXIsIGVuYWJsZUxvZ1R5cGVzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChibHVlcHJpbnRQcm9wcy5lbmFibGVHaXRPcHNNb2RlID09IHNwaS5HaXRPcHNNb2RlLkFQUExJQ0FUSU9OKSB7XG4gICAgICAgICAgICBBcmdvR2l0T3BzRmFjdG9yeS5lbmFibGVHaXRPcHMoKTtcbiAgICAgICAgfSBlbHNlIGlmIChibHVlcHJpbnRQcm9wcy5lbmFibGVHaXRPcHNNb2RlID09IHNwaS5HaXRPcHNNb2RlLkFQUF9PRl9BUFBTKSB7XG4gICAgICAgICAgICBBcmdvR2l0T3BzRmFjdG9yeS5lbmFibGVHaXRPcHNBcHBPZkFwcHMoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBvc3REZXBsb3ltZW50U3RlcHMgPSBBcnJheTxzcGkuQ2x1c3RlclBvc3REZXBsb3k+KCk7XG5cbiAgICAgICAgZm9yIChsZXQgYWRkT24gb2YgKGJsdWVwcmludFByb3BzLmFkZE9ucyA/PyBbXSkpIHsgLy8gbXVzdCBpdGVyYXRlIGluIHRoZSBzdHJpY3Qgb3JkZXJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGFkZE9uLmRlcGxveSh0aGlzLmNsdXN0ZXJJbmZvKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhZGRPbktleSA9IHV0aWxzLmdldEFkZE9uTmFtZU9ySWQoYWRkT24pO1xuICAgICAgICAgICAgICAgIHRoaXMuY2x1c3RlckluZm8uYWRkU2NoZWR1bGVkQWRkT24oYWRkT25LZXksIHJlc3VsdCwgdXRpbHMuaXNPcmRlcmVkQWRkT24oYWRkT24pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHBvc3REZXBsb3k6IGFueSA9IGFkZE9uO1xuICAgICAgICAgICAgaWYgKChwb3N0RGVwbG95IGFzIHNwaS5DbHVzdGVyUG9zdERlcGxveSkucG9zdERlcGxveSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcG9zdERlcGxveW1lbnRTdGVwcy5wdXNoKDxzcGkuQ2x1c3RlclBvc3REZXBsb3k+cG9zdERlcGxveSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzY2hlZHVsZWRBZGRPbnMgPSB0aGlzLmNsdXN0ZXJJbmZvLmdldEFsbFNjaGVkdWxlZEFkZG9ucygpO1xuICAgICAgICBjb25zdCBhZGRPbktleXMgPSBbLi4uc2NoZWR1bGVkQWRkT25zLmtleXMoKV07XG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gc2NoZWR1bGVkQWRkT25zLnZhbHVlcygpO1xuXG4gICAgICAgIHRoaXMuYXN5bmNUYXNrcyA9IFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKChjb25zdHJ1Y3RzKSA9PiB7XG4gICAgICAgICAgICBjb25zdHJ1Y3RzLmZvckVhY2goKGNvbnN0cnVjdCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNsdXN0ZXJJbmZvLmFkZFByb3Zpc2lvbmVkQWRkT24oYWRkT25LZXlzW2luZGV4XSwgY29uc3RydWN0KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoYmx1ZXByaW50UHJvcHMudGVhbXMgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHRlYW0gb2YgYmx1ZXByaW50UHJvcHMudGVhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVhbS5zZXR1cCh0aGlzLmNsdXN0ZXJJbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IHN0ZXAgb2YgcG9zdERlcGxveW1lbnRTdGVwcykge1xuICAgICAgICAgICAgICAgIHN0ZXAucG9zdERlcGxveSh0aGlzLmNsdXN0ZXJJbmZvLCBibHVlcHJpbnRQcm9wcy50ZWFtcyA/PyBbXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYXN5bmNUYXNrcy5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNpbmNlIGNvbnN0cnVjdG9yIGNhbm5vdCBiZSBtYXJrZWQgYXMgYXN5bmMsIGFkZGluZyBhIHNlcGFyYXRlIG1ldGhvZCB0byB3YWl0XG4gICAgICogZm9yIGFzeW5jIGNvZGUgdG8gZmluaXNoLlxuICAgICAqIEByZXR1cm5zIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byB0aGUgYmx1ZXByaW50XG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHdhaXRGb3JBc3luY1Rhc2tzKCk6IFByb21pc2U8RWtzQmx1ZXByaW50PiB7XG4gICAgICAgIGlmICh0aGlzLmFzeW5jVGFza3MpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFzeW5jVGFza3MudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgbWV0aG9kIHJldHVybnMgYWxsIHRoZSBjb25zdHJ1Y3RzIHByb2R1Y2VkIGJ5IGR1cmluZyB0aGUgY2x1c3RlciBjcmVhdGlvbiAoZS5nLiBhZGQtb25zKS5cbiAgICAgKiBNYXkgYmUgdXNlZCBpbiB0ZXN0aW5nIGZvciB2ZXJpZmljYXRpb24uXG4gICAgICogQHJldHVybnMgY2x1c3RlciBpbmZvIG9iamVjdFxuICAgICAqL1xuICAgIGdldENsdXN0ZXJJbmZvKCk6IHNwaS5DbHVzdGVySW5mbyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNsdXN0ZXJJbmZvO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvdmlkZU5hbWVkUmVzb3VyY2VzKGJsdWVwcmludFByb3BzOiBFa3NCbHVlcHJpbnRQcm9wcyk6IHNwaS5SZXNvdXJjZUNvbnRleHQge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgc3BpLlJlc291cmNlQ29udGV4dCh0aGlzLCBibHVlcHJpbnRQcm9wcyk7XG5cbiAgICAgICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIGJsdWVwcmludFByb3BzLnJlc291cmNlUHJvdmlkZXJzID8/IFtdKSB7XG4gICAgICAgICAgICByZXN1bHQuYWRkKGtleSwgdmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXNvbHZlcyBhbGwgZHluYW1pYyBwcm94aWVzLCB0aGF0IHN1YnN0aXR1dGVzIHJlc291cmNlIHByb3ZpZGVyIHByb3hpZXMgd2l0aCB0aGUgcmVzb2x2ZWQgdmFsdWVzLiBcbiAgICAgKiBAcGFyYW0gYmx1ZXByaW50UHJvcHMgXG4gICAgICogQHBhcmFtIHJlc291cmNlQ29udGV4dCBcbiAgICAgKiBAcmV0dXJucyBhIGNvcHkgb2YgYmx1ZXByaW50IHByb3BzIHdpdGggcmVzb2x2ZWQgdmFsdWVzXG4gICAgICovXG4gICAgcHJpdmF0ZSByZXNvbHZlRHluYW1pY1Byb3hpZXMoYmx1ZXByaW50UHJvcHM6IEVrc0JsdWVwcmludFByb3BzLCByZXNvdXJjZUNvbnRleHQ6IHNwaS5SZXNvdXJjZUNvbnRleHQpIDogRWtzQmx1ZXByaW50UHJvcHMge1xuICAgICAgICByZXR1cm4gdXRpbHMuY2xvbmVEZWVwKGJsdWVwcmludFByb3BzLCAodmFsdWUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB1dGlscy5yZXNvbHZlVGFyZ2V0KHZhbHVlLCByZXNvdXJjZUNvbnRleHQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgaW5wdXQgYWdhaW5zdCBiYXNpYyBkZWZpbmVkIGNvbnN0cmFpbnRzLlxuICAgICAqIEBwYXJhbSBibHVlcHJpbnRQcm9wcyBcbiAgICAgKi9cbiAgICBwcml2YXRlIHZhbGlkYXRlSW5wdXQoYmx1ZXByaW50UHJvcHM6IEVrc0JsdWVwcmludFByb3BzKSB7XG4gICAgICAgIGNvbnN0IHRlYW1OYW1lcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgICAgICBjb25zdHJhaW50cy52YWxpZGF0ZUNvbnN0cmFpbnRzKG5ldyBCbHVlcHJpbnRQcm9wc0NvbnN0cmFpbnRzLCBFa3NCbHVlcHJpbnRQcm9wcy5uYW1lLCBibHVlcHJpbnRQcm9wcyk7XG4gICAgICAgIGlmIChibHVlcHJpbnRQcm9wcy50ZWFtcykge1xuICAgICAgICAgICAgYmx1ZXByaW50UHJvcHMudGVhbXMuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGVhbU5hbWVzLmhhcyhlLm5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGVhbSAke2UubmFtZX0gaXMgcmVnaXN0ZXJlZCBtb3JlIHRoYW4gb25jZWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0ZWFtTmFtZXMuYWRkKGUubmFtZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuIl19