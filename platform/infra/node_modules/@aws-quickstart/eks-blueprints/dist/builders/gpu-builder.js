"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GpuBuilder = void 0;
const stacks_1 = require("../stacks");
const addons = require("../addons");
const utils = require("../utils");
const clusterproviders = require("../cluster-providers");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const eks = require("aws-cdk-lib/aws-eks");
const ec2 = require("aws-cdk-lib/aws-ec2");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const ts_deepmerge_1 = require("ts-deepmerge");
/**
 * Default props to be used when creating the GPU nodes
 * for EKS cluster
 */
const defaultOptions = {
    kubernetesVersion: eks.KubernetesVersion.of("1.27"),
    instanceClass: ec2.InstanceClass.G5,
    instanceSize: ec2.InstanceSize.XLARGE,
    gpuAmiType: aws_eks_1.NodegroupAmiType.AL2_X86_64_GPU,
    desiredNodeSize: 2,
    minNodeSize: 2,
    maxNodeSize: 3,
    blockDeviceSize: 50,
    clusterProviderTags: {
        "Name": "blueprints-gpu-eks-cluster",
        "Type": "generic-gpu-cluster"
    },
    nodeGroupTags: {
        "Name": "Mng-linux-Gpu",
        "Type": "Managed-linux-Gpu-Node-Group",
        "LaunchTemplate": "Linux-Launch-Template",
    }
};
class GpuBuilder extends stacks_1.BlueprintBuilder {
    /**
     * This method helps you prepare a blueprint for setting up observability
     * returning an array of blueprint addons for AWS managed open source services
     */
    enableGpu(values) {
        return this.addOns(new addons.AwsLoadBalancerControllerAddOn(), new addons.CertManagerAddOn(), new addons.CoreDnsAddOn(), new addons.KubeProxyAddOn(), new addons.VpcCniAddOn(), new addons.GpuOperatorAddon({ values }));
    }
    /**
    * This method helps you prepare a blueprint for setting up windows nodes with
    * usage tracking addon
    */
    static builder(options) {
        const builder = new GpuBuilder();
        const mergedOptions = (0, ts_deepmerge_1.default)(defaultOptions, options);
        builder
            .clusterProvider(new clusterproviders.GenericClusterProvider({
            version: mergedOptions.kubernetesVersion,
            tags: mergedOptions.clusterProviderTags,
            managedNodeGroups: [
                addGpuNodeGroup(mergedOptions),
            ]
        }))
            .addOns(new addons.NestedStackAddOn({
            id: "usage-tracking-addon",
            builder: UsageTrackingAddOn.builder(),
        }));
        return builder;
    }
}
exports.GpuBuilder = GpuBuilder;
/**
 * Nested stack that is used as tracker for GPU Accelerator
 */
class UsageTrackingAddOn extends aws_cdk_lib_1.NestedStack {
    static builder() {
        return {
            build(scope, id, props) {
                return new UsageTrackingAddOn(scope, id, props);
            }
        };
    }
    constructor(scope, id, props) {
        super(scope, id, utils.withUsageTracking(UsageTrackingAddOn.USAGE_ID, props));
    }
}
UsageTrackingAddOn.USAGE_ID = "qs-1ug68anj6";
/**
 * This function adds a GPU node group to the cluster.
 * @param: options: GpuOptions
 * @returns: blueprints.ManagedNodeGroup
 */
function addGpuNodeGroup(options) {
    return {
        id: "mng-linux-gpu",
        amiType: aws_eks_1.NodegroupAmiType.AL2_X86_64_GPU,
        instanceTypes: [new ec2.InstanceType('g5.xlarge')],
        desiredSize: options.desiredNodeSize,
        minSize: options.minNodeSize,
        maxSize: options.maxNodeSize,
        nodeGroupSubnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
        launchTemplate: {
            tags: options.nodeGroupTags,
            requireImdsv2: false
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3B1LWJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvYnVpbGRlcnMvZ3B1LWJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsc0NBQTZDO0FBQzdDLG9DQUFvQztBQUNwQyxrQ0FBa0M7QUFFbEMseURBQXlEO0FBQ3pELDZDQUE0RDtBQUU1RCwyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBQzNDLGlEQUF1RDtBQUN2RCwrQ0FBaUM7QUF3RGpDOzs7R0FHRztBQUNILE1BQU0sY0FBYyxHQUFlO0lBQy9CLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDO0lBQ25ELGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUU7SUFDbkMsWUFBWSxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsTUFBTTtJQUNyQyxVQUFVLEVBQUUsMEJBQWdCLENBQUMsY0FBYztJQUMzQyxlQUFlLEVBQUUsQ0FBQztJQUNsQixXQUFXLEVBQUUsQ0FBQztJQUNkLFdBQVcsRUFBRSxDQUFDO0lBQ2QsZUFBZSxFQUFFLEVBQUU7SUFDbkIsbUJBQW1CLEVBQUU7UUFDakIsTUFBTSxFQUFFLDRCQUE0QjtRQUNwQyxNQUFNLEVBQUUscUJBQXFCO0tBQ2hDO0lBQ0QsYUFBYSxFQUFFO1FBQ1gsTUFBTSxFQUFFLGVBQWU7UUFDdkIsTUFBTSxFQUFFLDhCQUE4QjtRQUN0QyxnQkFBZ0IsRUFBRSx1QkFBdUI7S0FDNUM7Q0FDRixDQUFDO0FBQ0osTUFBYSxVQUFXLFNBQVEseUJBQWdCO0lBQzVDOzs7T0FHRztJQUNJLFNBQVMsQ0FBQyxNQUFxQjtRQUN0QyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQ2QsSUFBSSxNQUFNLENBQUMsOEJBQThCLEVBQUUsRUFDM0MsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsRUFDN0IsSUFBSSxNQUFNLENBQUMsWUFBWSxFQUFFLEVBQ3pCLElBQUksTUFBTSxDQUFDLGNBQWMsRUFBRSxFQUMzQixJQUFJLE1BQU0sQ0FBQyxXQUFXLEVBQUUsRUFDeEIsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBQyxNQUFNLEVBQUMsQ0FBQyxDQUNwQyxDQUFDO0lBQ04sQ0FBQztJQUNBOzs7TUFHRTtJQUNLLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBbUI7UUFDdEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUNqQyxNQUFNLGFBQWEsR0FBRyxJQUFBLHNCQUFLLEVBQUMsY0FBYyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JELE9BQU87YUFDTixlQUFlLENBQ1osSUFBSSxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FBQztZQUN4QyxPQUFPLEVBQUUsYUFBYSxDQUFDLGlCQUFpQjtZQUN4QyxJQUFJLEVBQUUsYUFBYSxDQUFDLG1CQUFtQjtZQUN2QyxpQkFBaUIsRUFBRTtnQkFDZixlQUFlLENBQUMsYUFBYSxDQUFDO2FBQ2pDO1NBQ0osQ0FBQyxDQUNMO2FBQ0EsTUFBTSxDQUNILElBQUksTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQ3hCLEVBQUUsRUFBRSxzQkFBc0I7WUFDMUIsT0FBTyxFQUFFLGtCQUFrQixDQUFDLE9BQU8sRUFBRTtTQUN4QyxDQUFDLENBQUMsQ0FBQztRQUNSLE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7Q0FDSjtBQXZDRCxnQ0F1Q0M7QUFFRDs7R0FFRztBQUNILE1BQU0sa0JBQW1CLFNBQVEseUJBQVc7SUFJakMsTUFBTSxDQUFDLE9BQU87UUFDakIsT0FBTztZQUNILEtBQUssQ0FBQyxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF1QjtnQkFDdkQsT0FBTyxJQUFJLGtCQUFrQixDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDcEQsQ0FBQztTQUNKLENBQUM7SUFDTixDQUFDO0lBRUQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF1QjtRQUM3RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsaUJBQWlCLENBQUMsa0JBQWtCLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDbEYsQ0FBQzs7QUFaZSwyQkFBUSxHQUFHLGNBQWMsQ0FBQztBQWU5Qzs7OztHQUlHO0FBQ0gsU0FBUyxlQUFlLENBQUMsT0FBbUI7SUFFeEMsT0FBTztRQUNILEVBQUUsRUFBRSxlQUFlO1FBQ25CLE9BQU8sRUFBRSwwQkFBZ0IsQ0FBQyxjQUFjO1FBQ3hDLGFBQWEsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRCxXQUFXLEVBQUUsT0FBTyxDQUFDLGVBQWU7UUFDcEMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxXQUFXO1FBQzVCLE9BQU8sRUFBRSxPQUFPLENBQUMsV0FBVztRQUM1QixnQkFBZ0IsRUFBRSxFQUFFLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLG1CQUFtQixFQUFFO1FBQ3BFLGNBQWMsRUFBRTtZQUNaLElBQUksRUFBRSxPQUFPLENBQUMsYUFBYTtZQUMzQixhQUFhLEVBQUUsS0FBSztTQUN2QjtLQUNKLENBQUM7QUFDTixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmx1ZXByaW50QnVpbGRlciB9IGZyb20gJy4uL3N0YWNrcyc7XG5pbXBvcnQgKiBhcyBhZGRvbnMgZnJvbSAnLi4vYWRkb25zJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gXCIuLi91dGlsc1wiO1xuaW1wb3J0ICogYXMgc3BpIGZyb20gJy4uL3NwaSc7XG5pbXBvcnQgKiBhcyBjbHVzdGVycHJvdmlkZXJzIGZyb20gJy4uL2NsdXN0ZXItcHJvdmlkZXJzJztcbmltcG9ydCB7IE5lc3RlZFN0YWNrLCBOZXN0ZWRTdGFja1Byb3BzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBla3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0IHsgTm9kZWdyb3VwQW1pVHlwZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0IG1lcmdlIGZyb20gJ3RzLWRlZXBtZXJnZSc7XG5pbXBvcnQgeyBWYWx1ZXNTY2hlbWEgfSBmcm9tICcuLi9hZGRvbnMvZ3B1LW9wZXJhdG9yL3ZhbHVlcyc7XG5cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIEdQVSBCdWlsZGVyLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEdwdU9wdGlvbnMge1xuICAgIC8qKlxuICAgICAqIFJlcXVpcmVkLCBLdWJlcm5ldGVzIHZlcnNpb24gdG8gdXNlIGZvciB0aGUgY2x1c3Rlci5cbiAgICAgKi9cbiAgICBrdWJlcm5ldGVzVmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uLFxuICAgIC8qKiBcbiAgICAgKiBSZXF1aXJlZCwgSW5zdGFuY2UgY2xhc3MgdG8gdXNlIGZvciB0aGUgY2x1c3Rlci4gXG4gICAgICovXG4gICAgaW5zdGFuY2VDbGFzczogZWMyLkluc3RhbmNlQ2xhc3MsXG4gICAgLyoqIFxuICAgICAqIFJlcXVpcmVkLCBJbnN0YW5jZSBzaXplIHRvIHVzZSBmb3IgdGhlIGNsdXN0ZXIuIFxuICAgICAqL1xuICAgIGluc3RhbmNlU2l6ZTogZWMyLkluc3RhbmNlU2l6ZSxcbiAgICAvKiogXG4gICAgICogT3B0aW9uYWwsIEFNSSBUeXBlIGZvciBHUFUgTm9kZXMgQCBkZWZhdWx0IEFMMl9YODZfNjRfR1BVIFxuICAgICAqL1xuICAgIGdwdUFtaVR5cGU/OiBOb2RlZ3JvdXBBbWlUeXBlLFxuICAgIC8qKiBcbiAgICAgKiBPcHRpb25hbCwgRGVzaXJlZCBudW1iZXIgb2Ygbm9kZXMgdG8gdXNlIGZvciB0aGUgY2x1c3Rlci4gXG4gICAgICovXG4gICAgZGVzaXJlZE5vZGVTaXplPzogbnVtYmVyLFxuICAgIC8qKiBcbiAgICAgKiBPcHRpb25hbCwgTWluaW11bSBudW1iZXIgb2Ygbm9kZXMgdG8gdXNlIGZvciB0aGUgY2x1c3Rlci4gXG4gICAgICovXG4gICAgbWluTm9kZVNpemU/OiBudW1iZXIsXG4gICAgLyoqIFxuICAgICAqIE9wdGlvbmFsLCBNYXhpbXVtIG51bWJlciBvZiBub2RlcyB0byB1c2UgZm9yIHRoZSBjbHVzdGVyLiBcbiAgICAgKi9cbiAgICBtYXhOb2RlU2l6ZT86IG51bWJlcixcbiAgICAvKiogXG4gICAgICogT3B0aW9uYWwsIEJsb2NrIGRldmljZSBzaXplLlxuICAgICAqL1xuICAgIGJsb2NrRGV2aWNlU2l6ZT86IG51bWJlcixcbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCwgQ2x1c3RlciBQcm92aWRlciBUYWdzLlxuICAgICAqL1xuICAgIGNsdXN0ZXJQcm92aWRlclRhZ3M/OiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwsIE5vZGUgR3JvdXAgVGFncyBmb3IgQUwyIG5vZGVzIFxuICAgICAqIHdoaWNoIHJ1biBzdGFuZGFyZCBjbHVzdGVyIHNvZnR3YXJlLlxuICAgICAqL1xuICAgIG5vZGVHcm91cFRhZ3M/OiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICB9XG59XG5cbi8qKlxuICogRGVmYXVsdCBwcm9wcyB0byBiZSB1c2VkIHdoZW4gY3JlYXRpbmcgdGhlIEdQVSBub2RlcyBcbiAqIGZvciBFS1MgY2x1c3RlclxuICovXG5jb25zdCBkZWZhdWx0T3B0aW9uczogR3B1T3B0aW9ucyA9IHtcbiAgICBrdWJlcm5ldGVzVmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uLm9mKFwiMS4yN1wiKSxcbiAgICBpbnN0YW5jZUNsYXNzOiBlYzIuSW5zdGFuY2VDbGFzcy5HNSxcbiAgICBpbnN0YW5jZVNpemU6IGVjMi5JbnN0YW5jZVNpemUuWExBUkdFLFxuICAgIGdwdUFtaVR5cGU6IE5vZGVncm91cEFtaVR5cGUuQUwyX1g4Nl82NF9HUFUsXG4gICAgZGVzaXJlZE5vZGVTaXplOiAyLFxuICAgIG1pbk5vZGVTaXplOiAyLFxuICAgIG1heE5vZGVTaXplOiAzLFxuICAgIGJsb2NrRGV2aWNlU2l6ZTogNTAsXG4gICAgY2x1c3RlclByb3ZpZGVyVGFnczoge1xuICAgICAgICBcIk5hbWVcIjogXCJibHVlcHJpbnRzLWdwdS1la3MtY2x1c3RlclwiLFxuICAgICAgICBcIlR5cGVcIjogXCJnZW5lcmljLWdwdS1jbHVzdGVyXCJcbiAgICB9LFxuICAgIG5vZGVHcm91cFRhZ3M6IHtcbiAgICAgICAgXCJOYW1lXCI6IFwiTW5nLWxpbnV4LUdwdVwiLFxuICAgICAgICBcIlR5cGVcIjogXCJNYW5hZ2VkLWxpbnV4LUdwdS1Ob2RlLUdyb3VwXCIsXG4gICAgICAgIFwiTGF1bmNoVGVtcGxhdGVcIjogXCJMaW51eC1MYXVuY2gtVGVtcGxhdGVcIixcbiAgICB9XG4gIH07XG5leHBvcnQgY2xhc3MgR3B1QnVpbGRlciBleHRlbmRzIEJsdWVwcmludEJ1aWxkZXIge1xuICAgIC8qKlxuICAgICAqIFRoaXMgbWV0aG9kIGhlbHBzIHlvdSBwcmVwYXJlIGEgYmx1ZXByaW50IGZvciBzZXR0aW5nIHVwIG9ic2VydmFiaWxpdHkgXG4gICAgICogcmV0dXJuaW5nIGFuIGFycmF5IG9mIGJsdWVwcmludCBhZGRvbnMgZm9yIEFXUyBtYW5hZ2VkIG9wZW4gc291cmNlIHNlcnZpY2VzXG4gICAgICovXG4gICAgcHVibGljIGVuYWJsZUdwdSh2YWx1ZXM/OiBWYWx1ZXNTY2hlbWEpOiBHcHVCdWlsZGVyIHtcbiAgICByZXR1cm4gdGhpcy5hZGRPbnMoXG4gICAgICAgIG5ldyBhZGRvbnMuQXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlckFkZE9uKCksXG4gICAgICAgIG5ldyBhZGRvbnMuQ2VydE1hbmFnZXJBZGRPbigpLFxuICAgICAgICBuZXcgYWRkb25zLkNvcmVEbnNBZGRPbigpLFxuICAgICAgICBuZXcgYWRkb25zLkt1YmVQcm94eUFkZE9uKCksXG4gICAgICAgIG5ldyBhZGRvbnMuVnBjQ25pQWRkT24oKSxcbiAgICAgICAgbmV3IGFkZG9ucy5HcHVPcGVyYXRvckFkZG9uKHt2YWx1ZXN9KVxuICAgICAgICApO1xuICAgIH1cbiAgICAgLyoqXG4gICAgICogVGhpcyBtZXRob2QgaGVscHMgeW91IHByZXBhcmUgYSBibHVlcHJpbnQgZm9yIHNldHRpbmcgdXAgd2luZG93cyBub2RlcyB3aXRoIFxuICAgICAqIHVzYWdlIHRyYWNraW5nIGFkZG9uXG4gICAgICovXG4gICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRlcihvcHRpb25zOiBHcHVPcHRpb25zKTogR3B1QnVpbGRlciB7XG4gICAgICAgIGNvbnN0IGJ1aWxkZXIgPSBuZXcgR3B1QnVpbGRlcigpO1xuICAgICAgICBjb25zdCBtZXJnZWRPcHRpb25zID0gbWVyZ2UoZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpO1xuICAgICAgICBidWlsZGVyXG4gICAgICAgIC5jbHVzdGVyUHJvdmlkZXIoXG4gICAgICAgICAgICBuZXcgY2x1c3RlcnByb3ZpZGVycy5HZW5lcmljQ2x1c3RlclByb3ZpZGVyKHtcbiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBtZXJnZWRPcHRpb25zLmt1YmVybmV0ZXNWZXJzaW9uLFxuICAgICAgICAgICAgICAgIHRhZ3M6IG1lcmdlZE9wdGlvbnMuY2x1c3RlclByb3ZpZGVyVGFncyxcbiAgICAgICAgICAgICAgICBtYW5hZ2VkTm9kZUdyb3VwczogW1xuICAgICAgICAgICAgICAgICAgICBhZGRHcHVOb2RlR3JvdXAobWVyZ2VkT3B0aW9ucyksXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICAuYWRkT25zKFxuICAgICAgICAgICAgbmV3IGFkZG9ucy5OZXN0ZWRTdGFja0FkZE9uKHtcbiAgICAgICAgICAgICAgICBpZDogXCJ1c2FnZS10cmFja2luZy1hZGRvblwiLFxuICAgICAgICAgICAgICAgIGJ1aWxkZXI6IFVzYWdlVHJhY2tpbmdBZGRPbi5idWlsZGVyKCksXG4gICAgICAgICAgICB9KSk7IFxuICAgICAgICByZXR1cm4gYnVpbGRlcjtcbiAgICB9XG59XG5cbi8qKlxuICogTmVzdGVkIHN0YWNrIHRoYXQgaXMgdXNlZCBhcyB0cmFja2VyIGZvciBHUFUgQWNjZWxlcmF0b3JcbiAqL1xuY2xhc3MgVXNhZ2VUcmFja2luZ0FkZE9uIGV4dGVuZHMgTmVzdGVkU3RhY2sge1xuXG4gICAgc3RhdGljIHJlYWRvbmx5IFVTQUdFX0lEID0gXCJxcy0xdWc2OGFuajZcIjtcblxuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRlcigpOiBzcGkuTmVzdGVkU3RhY2tCdWlsZGVyIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGJ1aWxkKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBOZXN0ZWRTdGFja1Byb3BzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVc2FnZVRyYWNraW5nQWRkT24oc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE5lc3RlZFN0YWNrUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCB1dGlscy53aXRoVXNhZ2VUcmFja2luZyhVc2FnZVRyYWNraW5nQWRkT24uVVNBR0VfSUQsIHByb3BzKSk7XG4gICAgfVxufVxuXG4vKiogIFxuICogVGhpcyBmdW5jdGlvbiBhZGRzIGEgR1BVIG5vZGUgZ3JvdXAgdG8gdGhlIGNsdXN0ZXIuXG4gKiBAcGFyYW06IG9wdGlvbnM6IEdwdU9wdGlvbnNcbiAqIEByZXR1cm5zOiBibHVlcHJpbnRzLk1hbmFnZWROb2RlR3JvdXBcbiAqL1xuZnVuY3Rpb24gYWRkR3B1Tm9kZUdyb3VwKG9wdGlvbnM6IEdwdU9wdGlvbnMpOiBjbHVzdGVycHJvdmlkZXJzLk1hbmFnZWROb2RlR3JvdXAge1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IFwibW5nLWxpbnV4LWdwdVwiLFxuICAgICAgICBhbWlUeXBlOiBOb2RlZ3JvdXBBbWlUeXBlLkFMMl9YODZfNjRfR1BVLFxuICAgICAgICBpbnN0YW5jZVR5cGVzOiBbbmV3IGVjMi5JbnN0YW5jZVR5cGUoJ2c1LnhsYXJnZScpXSxcbiAgICAgICAgZGVzaXJlZFNpemU6IG9wdGlvbnMuZGVzaXJlZE5vZGVTaXplLCBcbiAgICAgICAgbWluU2l6ZTogb3B0aW9ucy5taW5Ob2RlU2l6ZSwgXG4gICAgICAgIG1heFNpemU6IG9wdGlvbnMubWF4Tm9kZVNpemUsXG4gICAgICAgIG5vZGVHcm91cFN1Ym5ldHM6IHsgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX0VHUkVTUyB9LFxuICAgICAgICBsYXVuY2hUZW1wbGF0ZToge1xuICAgICAgICAgICAgdGFnczogb3B0aW9ucy5ub2RlR3JvdXBUYWdzLFxuICAgICAgICAgICAgcmVxdWlyZUltZHN2MjogZmFsc2VcbiAgICAgICAgfVxuICAgIH07XG59XG5cbiJdfQ==