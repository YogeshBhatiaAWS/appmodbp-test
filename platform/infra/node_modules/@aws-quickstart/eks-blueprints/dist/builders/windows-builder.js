"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WindowsBuilder = void 0;
const stacks_1 = require("../stacks");
const addons = require("../addons");
const utils = require("../utils");
const clusterproviders = require("../cluster-providers");
const resourceproviders = require("../resource-providers");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const eks = require("aws-cdk-lib/aws-eks");
const ec2 = require("aws-cdk-lib/aws-ec2");
const iam = require("aws-cdk-lib/aws-iam");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const ts_deepmerge_1 = require("ts-deepmerge");
/**
 * Default props to be used when creating the non-windows and windows nodes
 * for Windows EKS cluster
 */
const defaultOptions = {
    kubernetesVersion: eks.KubernetesVersion.of("1.27"),
    instanceClass: ec2.InstanceClass.M5,
    instanceSize: ec2.InstanceSize.XLARGE4,
    nodeRole: resourceproviders.getNamedResource("node-role"),
    windowsAmiType: aws_eks_1.NodegroupAmiType.WINDOWS_FULL_2022_X86_64,
    desiredNodeSize: 2,
    minNodeSize: 2,
    maxNodeSize: 3,
    blockDeviceSize: 50,
    noScheduleForWindowsNodes: true,
    clusterProviderTags: {
        "Name": "blueprints-windows-eks-cluster",
        "Type": "generic-windows-cluster"
    },
    genericNodeGroupTags: {
        "Name": "Mng-linux",
        "Type": "Managed-linux-Node-Group",
        "LaunchTemplate": "Linux-Launch-Template",
    },
    windowsNodeGroupTags: {
        "Name": "Managed-Node-Group",
        "Type": "Windows-Node-Group",
        "LaunchTemplate": "WindowsLT",
        "kubernetes.io/cluster/windows-eks-blueprint": "owned"
    }
};
/**
 * This builder class helps you prepare a blueprint for setting up
 * windows nodes with EKS cluster. The `WindowsBuilder` creates the following:
 * 1. An EKS Cluster` with passed k8s version and cluster tags.
 * 2. A non-windows nodegroup for standard software.
 * 3. A windows nodegroup to schedule windows workloads
 */
class WindowsBuilder extends stacks_1.BlueprintBuilder {
    /**
     * This method helps you prepare a blueprint for setting up windows nodes with
     * usage tracking addon
     */
    static builder(options) {
        const builder = new WindowsBuilder();
        const mergedOptions = (0, ts_deepmerge_1.default)(defaultOptions, options);
        builder
            .clusterProvider(new clusterproviders.GenericClusterProvider({
            version: mergedOptions.kubernetesVersion,
            tags: mergedOptions.clusterProviderTags,
            role: resourceproviders.getResource(context => {
                return new iam.Role(context.scope, 'ClusterRole', {
                    assumedBy: new iam.ServicePrincipal("eks.amazonaws.com"),
                    managedPolicies: [
                        iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKSClusterPolicy"),
                        iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKSVPCResourceController")
                    ]
                });
            }),
            managedNodeGroups: [
                addGenericNodeGroup(mergedOptions),
                addWindowsNodeGroup(mergedOptions)
            ]
        }))
            .addOns(new addons.NestedStackAddOn({
            id: "usage-tracking-addon",
            builder: UsageTrackingAddOn.builder(),
        }));
        return builder;
    }
}
exports.WindowsBuilder = WindowsBuilder;
/**
 * Nested stack that is used as tracker for Windows Accelerator
 */
class UsageTrackingAddOn extends aws_cdk_lib_1.NestedStack {
    static builder() {
        return {
            build(scope, id, props) {
                return new UsageTrackingAddOn(scope, id, props);
            }
        };
    }
    constructor(scope, id, props) {
        super(scope, id, utils.withUsageTracking(UsageTrackingAddOn.USAGE_ID, props));
    }
}
UsageTrackingAddOn.USAGE_ID = "qs-1ubotj5kl";
/**
 * This function adds a generic node group to the windows cluster.
 * @param: options: WindowsOptions
 * @returns: blueprints.ManagedNodeGroup
 */
function addGenericNodeGroup(options) {
    return {
        id: "mng-linux",
        amiType: aws_eks_1.NodegroupAmiType.AL2_X86_64,
        instanceTypes: [new ec2.InstanceType('m5.4xlarge')],
        desiredSize: options.desiredNodeSize,
        minSize: options.minNodeSize,
        maxSize: options.maxNodeSize,
        nodeRole: options.nodeRole,
        nodeGroupSubnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
        launchTemplate: {
            tags: options.genericNodeGroupTags,
            requireImdsv2: false
        }
    };
}
/**
 * This function adds a windows node group to the windows cluster.
 * @param options: WindowsOptions
 * @returns: blueprints.ManagedNodeGroup
 */
function addWindowsNodeGroup(options) {
    const result = {
        id: "mng-windows",
        amiType: options.windowsAmiType,
        instanceTypes: [new ec2.InstanceType(`${options.instanceClass}.${options.instanceSize}`)],
        desiredSize: options.desiredNodeSize,
        minSize: options.minNodeSize,
        maxSize: options.maxNodeSize,
        nodeRole: options.nodeRole,
        nodeGroupSubnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
        diskSize: options.blockDeviceSize,
        tags: options.windowsNodeGroupTags
    };
    if (options.noScheduleForWindowsNodes) {
        utils.setPath(result, "taints", [
            {
                key: "os",
                value: "windows",
                effect: eks.TaintEffect.NO_SCHEDULE
            }
        ]);
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93cy1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2J1aWxkZXJzL3dpbmRvd3MtYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQ0FBNkM7QUFDN0Msb0NBQW9DO0FBQ3BDLGtDQUFrQztBQUVsQyx5REFBeUQ7QUFDekQsMkRBQTJEO0FBQzNELDZDQUE0RDtBQUU1RCwyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyxpREFBdUQ7QUFDdkQsK0NBQWlDO0FBa0ZqQzs7O0dBR0c7QUFDSCxNQUFNLGNBQWMsR0FBbUI7SUFDbkMsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUM7SUFDbkQsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRTtJQUNuQyxZQUFZLEVBQUUsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPO0lBQ3RDLFFBQVEsRUFBRSxpQkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQWE7SUFDckUsY0FBYyxFQUFFLDBCQUFnQixDQUFDLHdCQUF3QjtJQUN6RCxlQUFlLEVBQUUsQ0FBQztJQUNsQixXQUFXLEVBQUUsQ0FBQztJQUNkLFdBQVcsRUFBRSxDQUFDO0lBQ2QsZUFBZSxFQUFFLEVBQUU7SUFDbkIseUJBQXlCLEVBQUUsSUFBSTtJQUMvQixtQkFBbUIsRUFBRTtRQUNqQixNQUFNLEVBQUUsZ0NBQWdDO1FBQ3hDLE1BQU0sRUFBRSx5QkFBeUI7S0FDcEM7SUFDRCxvQkFBb0IsRUFBRTtRQUNsQixNQUFNLEVBQUUsV0FBVztRQUNuQixNQUFNLEVBQUUsMEJBQTBCO1FBQ2xDLGdCQUFnQixFQUFFLHVCQUF1QjtLQUM1QztJQUNELG9CQUFvQixFQUFFO1FBQ2xCLE1BQU0sRUFBRSxvQkFBb0I7UUFDNUIsTUFBTSxFQUFFLG9CQUFvQjtRQUM1QixnQkFBZ0IsRUFBRSxXQUFXO1FBQzdCLDZD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QW1CLENBQUMsT0FBdUI7SUFDaEQsTUFBTSxNQUFNLEdBQXVDO1FBQy9DLEVBQUUsRUFBRSxhQUFhO1FBQ2pCLE9BQU8sRUFBRSxPQUFPLENBQUMsY0FBYztRQUMvQixhQUFhLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxPQUFPLENBQUMsYUFBYSxJQUFJLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3pGLFdBQVcsRUFBRSxPQUFPLENBQUMsZUFBZTtRQUNwQyxPQUFPLEVBQUUsT0FBTyxDQUFDLFdBQVc7UUFDNUIsT0FBTyxFQUFFLE9BQU8sQ0FBQyxXQUFXO1FBQzVCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtRQUMxQixnQkFBZ0IsRUFBRSxFQUFFLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLG1CQUFtQixFQUFFO1FBQ3BFLFFBQVEsRUFBRSxPQUFPLENBQUMsZUFBZTtRQUNqQyxJQUFJLEVBQUUsT0FBTyxDQUFDLG9CQUFvQjtLQUNyQyxDQUFDO0lBRUYsSUFBRyxPQUFPLENBQUMseUJBQXlCLEVBQUU7UUFDbEMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFO1lBQzVCO2dCQUNJLEdBQUcsRUFBRSxJQUFJO2dCQUNULEtBQUssRUFBRSxTQUFTO2dCQUNoQixNQUFNLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxXQUFXO2FBQ3RDO1NBQ0osQ0FBQyxDQUFDO0tBQ047SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmx1ZXByaW50QnVpbGRlciB9IGZyb20gJy4uL3N0YWNrcyc7XG5pbXBvcnQgKiBhcyBhZGRvbnMgZnJvbSAnLi4vYWRkb25zJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gXCIuLi91dGlsc1wiO1xuaW1wb3J0ICogYXMgc3BpIGZyb20gJy4uL3NwaSc7XG5pbXBvcnQgKiBhcyBjbHVzdGVycHJvdmlkZXJzIGZyb20gJy4uL2NsdXN0ZXItcHJvdmlkZXJzJztcbmltcG9ydCAqIGFzIHJlc291cmNlcHJvdmlkZXJzIGZyb20gJy4uL3Jlc291cmNlLXByb3ZpZGVycyc7XG5pbXBvcnQgeyBOZXN0ZWRTdGFjaywgTmVzdGVkU3RhY2tQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgZWtzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lYzJcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IE5vZGVncm91cEFtaVR5cGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcbmltcG9ydCBtZXJnZSBmcm9tICd0cy1kZWVwbWVyZ2UnO1xuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgV2luZG93cyBCdWlsZGVyLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFdpbmRvd3NPcHRpb25zIHtcbiAgICAvKipcbiAgICAgKiBSZXF1aXJlZCwgS3ViZXJuZXRlcyB2ZXJzaW9uIHRvIHVzZSBmb3IgdGhlIGNsdXN0ZXIuXG4gICAgICovXG4gICAga3ViZXJuZXRlc1ZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbixcblxuICAgIC8qKiBcbiAgICAgKiBSZXF1aXJlZCwgSW5zdGFuY2UgY2xhc3MgdG8gdXNlIGZvciB0aGUgY2x1c3Rlci4gXG4gICAgICovXG4gICAgaW5zdGFuY2VDbGFzczogZWMyLkluc3RhbmNlQ2xhc3MsXG5cbiAgICAvKiogXG4gICAgICogUmVxdWlyZWQsIEluc3RhbmNlIHNpemUgdG8gdXNlIGZvciB0aGUgY2x1c3Rlci4gXG4gICAgICovXG4gICAgaW5zdGFuY2VTaXplOiBlYzIuSW5zdGFuY2VTaXplLFxuXG4gICAgLyoqIFxuICAgICAqIG9wdGlvbmFsLCBOb2RlIElBTSBSb2xlIHRvIGJlIGF0dGFjaGVkIHRvIFdpbmRvd3MgXG4gICAgICogYW5kIE5vbi13aW5kb3dzIG5vZGVzLlxuICAgICAqL1xuICAgIG5vZGVSb2xlPzogaWFtLlJvbGUsXG5cbiAgICAvKiogXG4gICAgICogT3B0aW9uYWwsIEFNSSBUeXBlIGZvciBXaW5kb3dzIE5vZGVzXG4gICAgICovXG4gICAgd2luZG93c0FtaVR5cGU/OiBOb2RlZ3JvdXBBbWlUeXBlLFxuXG4gICAgLyoqIFxuICAgICAqIE9wdGlvbmFsLCBEZXNpcmVkIG51bWJlciBvZiBub2RlcyB0byB1c2UgZm9yIHRoZSBjbHVzdGVyLiBcbiAgICAgKi9cbiAgICBkZXNpcmVkTm9kZVNpemU/OiBudW1iZXIsXG5cbiAgICAvKiogXG4gICAgICogT3B0aW9uYWwsIE1pbmltdW0gbnVtYmVyIG9mIG5vZGVzIHRvIHVzZSBmb3IgdGhlIGNsdXN0ZXIuIFxuICAgICAqL1xuICAgIG1pbk5vZGVTaXplPzogbnVtYmVyLFxuXG4gICAgLyoqIFxuICAgICAqIE9wdGlvbmFsLCBNYXhpbXVtIG51bWJlciBvZiBub2RlcyB0byB1c2UgZm9yIHRoZSBjbHVzdGVyLiBcbiAgICAgKi9cbiAgICBtYXhOb2RlU2l6ZT86IG51bWJlcixcblxuICAgIC8qKiBcbiAgICAgKiBPcHRpb25hbCwgQmxvY2sgZGV2aWNlIHNpemUuXG4gICAgICovXG4gICAgYmxvY2tEZXZpY2VTaXplPzogbnVtYmVyLFxuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwsIE5vIFNjaGVkdWxlIGZvciBXaW5kb3dzIE5vZGVzLCB0aGlzIGFsbG93cyBXaW5kb3dzIFxuICAgICAqIG5vZGVzIHRvIGJlIG1hcmtlZCBhcyBuby1zY2hlZHVsZSBieSBkZWZhdWx0IHRvIHByZXZlbnQgYW55IFxuICAgICAqIGxpbnV4IHdvcmtsb2FkcyBmcm9tIHNjaGVkdWxpbmcuXG4gICAgICovXG4gICAgbm9TY2hlZHVsZUZvcldpbmRvd3NOb2Rlcz86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCwgQ2x1c3RlciBQcm92aWRlciBUYWdzLlxuICAgICAqL1xuICAgIGNsdXN0ZXJQcm92aWRlclRhZ3M/OiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwsIEdlbmVyaWMgTm9kZSBHcm91cCBUYWdzIGZvciBub24td2luZG93cyBub2RlcyBcbiAgICAgKiB3aGljaCBydW4gc3RhbmRhcmQgY2x1c3RlciBzb2Z0d2FyZS5cbiAgICAgKi9cbiAgICBnZW5lcmljTm9kZUdyb3VwVGFncz86IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wdGlvbmFsLCBXaW5kb3dzIE5vZGUgR3JvdXAgVGFncy5cbiAgICAgKi9cbiAgICB3aW5kb3dzTm9kZUdyb3VwVGFncz86IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgIH1cbn1cblxuLyoqXG4gKiBEZWZhdWx0IHByb3BzIHRvIGJlIHVzZWQgd2hlbiBjcmVhdGluZyB0aGUgbm9uLXdpbmRvd3MgYW5kIHdpbmRvd3Mgbm9kZXMgXG4gKiBmb3IgV2luZG93cyBFS1MgY2x1c3RlclxuICovXG5jb25zdCBkZWZhdWx0T3B0aW9uczogV2luZG93c09wdGlvbnMgPSB7XG4gICAga3ViZXJuZXRlc1ZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbi5vZihcIjEuMjdcIiksXG4gICAgaW5zdGFuY2VDbGFzczogZWMyLkluc3RhbmNlQ2xhc3MuTTUsXG4gICAgaW5zdGFuY2VTaXplOiBlYzIuSW5zdGFuY2VTaXplLlhMQVJHRTQsXG4gICAgbm9kZVJvbGU6IHJlc291cmNlcHJvdmlkZXJzLmdldE5hbWVkUmVzb3VyY2UoXCJub2RlLXJvbGVcIikgYXMgaWFtLlJvbGUsXG4gICAgd2luZG93c0FtaVR5cGU6IE5vZGVncm91cEFtaVR5cGUuV0lORE9XU19GVUxMXzIwMjJfWDg2XzY0LFxuICAgIGRlc2lyZWROb2RlU2l6ZTogMixcbiAgICBtaW5Ob2RlU2l6ZTogMixcbiAgICBtYXhOb2RlU2l6ZTogMyxcbiAgICBibG9ja0RldmljZVNpemU6IDUwLFxuICAgIG5vU2NoZWR1bGVGb3JXaW5kb3dzTm9kZXM6IHRydWUsXG4gICAgY2x1c3RlclByb3ZpZGVyVGFnczoge1xuICAgICAgICBcIk5hbWVcIjogXCJibHVlcHJpbnRzLXdpbmRvd3MtZWtzLWNsdXN0ZXJcIixcbiAgICAgICAgXCJUeXBlXCI6IFwiZ2VuZXJpYy13aW5kb3dzLWNsdXN0ZXJcIlxuICAgIH0sXG4gICAgZ2VuZXJpY05vZGVHcm91cFRhZ3M6IHtcbiAgICAgICAgXCJOYW1lXCI6IFwiTW5nLWxpbnV4XCIsXG4gICAgICAgIFwiVHlwZVwiOiBcIk1hbmFnZWQtbGludXgtTm9kZS1Hcm91cFwiLFxuICAgICAgICBcIkxhdW5jaFRlbXBsYXRlXCI6IFwiTGludXgtTGF1bmNoLVRlbXBsYXRlXCIsXG4gICAgfSxcbiAgICB3aW5kb3dzTm9kZUdyb3VwVGFnczoge1xuICAgICAgICBcIk5hbWVcIjogXCJNYW5hZ2VkLU5vZGUtR3JvdXBcIixcbiAgICAgICAgXCJUeXBlXCI6IFwiV2luZG93cy1Ob2RlLUdyb3VwXCIsXG4gICAgICAgIFwiTGF1bmNoVGVtcGxhdGVcIjogXCJXaW5kb3dzTFRcIixcbiAgICAgICAgXCJrdWJlcm5ldGVzLmlvL2NsdXN0ZXIvd2luZG93cy1la3MtYmx1ZXByaW50XCI6IFwib3duZWRcIiAgXG4gICAgfVxuICB9O1xuXG4vKiogXG4gKiBUaGlzIGJ1aWxkZXIgY2xhc3MgaGVscHMgeW91IHByZXBhcmUgYSBibHVlcHJpbnQgZm9yIHNldHRpbmcgdXAgXG4gKiB3aW5kb3dzIG5vZGVzIHdpdGggRUtTIGNsdXN0ZXIuIFRoZSBgV2luZG93c0J1aWxkZXJgIGNyZWF0ZXMgdGhlIGZvbGxvd2luZzpcbiAqIDEuIEFuIEVLUyBDbHVzdGVyYCB3aXRoIHBhc3NlZCBrOHMgdmVyc2lvbiBhbmQgY2x1c3RlciB0YWdzLlxuICogMi4gQSBub24td2luZG93cyBub2RlZ3JvdXAgZm9yIHN0YW5kYXJkIHNvZnR3YXJlLlxuICogMy4gQSB3aW5kb3dzIG5vZGVncm91cCB0byBzY2hlZHVsZSB3aW5kb3dzIHdvcmtsb2Fkc1xuICovXG5leHBvcnQgY2xhc3MgV2luZG93c0J1aWxkZXIgZXh0ZW5kcyBCbHVlcHJpbnRCdWlsZGVyIHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgbWV0aG9kIGhlbHBzIHlvdSBwcmVwYXJlIGEgYmx1ZXByaW50IGZvciBzZXR0aW5nIHVwIHdpbmRvd3Mgbm9kZXMgd2l0aCBcbiAgICAgKiB1c2FnZSB0cmFja2luZyBhZGRvblxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRlcihvcHRpb25zOiBXaW5kb3dzT3B0aW9ucyk6IFdpbmRvd3NCdWlsZGVyIHtcbiAgICAgICAgY29uc3QgYnVpbGRlciA9IG5ldyBXaW5kb3dzQnVpbGRlcigpO1xuICAgICAgICBjb25zdCBtZXJnZWRPcHRpb25zID0gbWVyZ2UoZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpO1xuXG4gICAgICAgIGJ1aWxkZXJcbiAgICAgICAgICAgIC5jbHVzdGVyUHJvdmlkZXIoXG4gICAgICAgICAgICAgICAgbmV3IGNsdXN0ZXJwcm92aWRlcnMuR2VuZXJpY0NsdXN0ZXJQcm92aWRlcih7XG4gICAgICAgICAgICAgICAgICAgIHZlcnNpb246IG1lcmdlZE9wdGlvbnMua3ViZXJuZXRlc1ZlcnNpb24sXG4gICAgICAgICAgICAgICAgICAgIHRhZ3M6IG1lcmdlZE9wdGlvbnMuY2x1c3RlclByb3ZpZGVyVGFncyxcbiAgICAgICAgICAgICAgICAgICAgcm9sZTogcmVzb3VyY2Vwcm92aWRlcnMuZ2V0UmVzb3VyY2UoY29udGV4dCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGlhbS5Sb2xlKGNvbnRleHQuc2NvcGUsICdDbHVzdGVyUm9sZScsIHsgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJla3MuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUtTQ2x1c3RlclBvbGljeVwiKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUtTVlBDUmVzb3VyY2VDb250cm9sbGVyXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBtYW5hZ2VkTm9kZUdyb3VwczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgYWRkR2VuZXJpY05vZGVHcm91cChtZXJnZWRPcHRpb25zKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZFdpbmRvd3NOb2RlR3JvdXAobWVyZ2VkT3B0aW9ucylcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuYWRkT25zKFxuICAgICAgICAgICAgICAgIG5ldyBhZGRvbnMuTmVzdGVkU3RhY2tBZGRPbih7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBcInVzYWdlLXRyYWNraW5nLWFkZG9uXCIsXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkZXI6IFVzYWdlVHJhY2tpbmdBZGRPbi5idWlsZGVyKCksXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIHJldHVybiBidWlsZGVyO1xuICAgIH1cbn1cblxuLyoqXG4gKiBOZXN0ZWQgc3RhY2sgdGhhdCBpcyB1c2VkIGFzIHRyYWNrZXIgZm9yIFdpbmRvd3MgQWNjZWxlcmF0b3JcbiAqL1xuY2xhc3MgVXNhZ2VUcmFja2luZ0FkZE9uIGV4dGVuZHMgTmVzdGVkU3RhY2sge1xuXG4gICAgc3RhdGljIHJlYWRvbmx5IFVTQUdFX0lEID0gXCJxcy0xdWJvdGo1a2xcIjtcblxuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRlcigpOiBzcGkuTmVzdGVkU3RhY2tCdWlsZGVyIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGJ1aWxkKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBOZXN0ZWRTdGFja1Byb3BzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVc2FnZVRyYWNraW5nQWRkT24oc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE5lc3RlZFN0YWNrUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCB1dGlscy53aXRoVXNhZ2VUcmFja2luZyhVc2FnZVRyYWNraW5nQWRkT24uVVNBR0VfSUQsIHByb3BzKSk7XG4gICAgfVxufVxuXG4vKiogIFxuICogVGhpcyBmdW5jdGlvbiBhZGRzIGEgZ2VuZXJpYyBub2RlIGdyb3VwIHRvIHRoZSB3aW5kb3dzIGNsdXN0ZXIuXG4gKiBAcGFyYW06IG9wdGlvbnM6IFdpbmRvd3NPcHRpb25zXG4gKiBAcmV0dXJuczogYmx1ZXByaW50cy5NYW5hZ2VkTm9kZUdyb3VwXG4gKi9cbmZ1bmN0aW9uIGFkZEdlbmVyaWNOb2RlR3JvdXAob3B0aW9uczogV2luZG93c09wdGlvbnMpOiBjbHVzdGVycHJvdmlkZXJzLk1hbmFnZWROb2RlR3JvdXAge1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IFwibW5nLWxpbnV4XCIsXG4gICAgICAgIGFtaVR5cGU6IE5vZGVncm91cEFtaVR5cGUuQUwyX1g4Nl82NCxcbiAgICAgICAgaW5zdGFuY2VUeXBlczogW25ldyBlYzIuSW5zdGFuY2VUeXBlKCdtNS40eGxhcmdlJyldLFxuICAgICAgICBkZXNpcmVkU2l6ZTogb3B0aW9ucy5kZXNpcmVkTm9kZVNpemUsIFxuICAgICAgICBtaW5TaXplOiBvcHRpb25zLm1pbk5vZGVTaXplLCBcbiAgICAgICAgbWF4U2l6ZTogb3B0aW9ucy5tYXhOb2RlU2l6ZSxcbiAgICAgICAgbm9kZVJvbGU6IG9wdGlvbnMubm9kZVJvbGUsXG4gICAgICAgIG5vZGVHcm91cFN1Ym5ldHM6IHsgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX0VHUkVTUyB9LFxuICAgICAgICBsYXVuY2hUZW1wbGF0ZToge1xuICAgICAgICAgICAgdGFnczogb3B0aW9ucy5nZW5lcmljTm9kZUdyb3VwVGFncyxcbiAgICAgICAgICAgIHJlcXVpcmVJbWRzdjI6IGZhbHNlXG4gICAgICAgIH1cbiAgICB9O1xufVxuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gYWRkcyBhIHdpbmRvd3Mgbm9kZSBncm91cCB0byB0aGUgd2luZG93cyBjbHVzdGVyLlxuICogQHBhcmFtIG9wdGlvbnM6IFdpbmRvd3NPcHRpb25zXG4gKiBAcmV0dXJuczogYmx1ZXByaW50cy5NYW5hZ2VkTm9kZUdyb3VwXG4gKi9cbmZ1bmN0aW9uIGFkZFdpbmRvd3NOb2RlR3JvdXAob3B0aW9uczogV2luZG93c09wdGlvbnMpOiBjbHVzdGVycHJvdmlkZXJzLk1hbmFnZWROb2RlR3JvdXAge1xuICAgIGNvbnN0IHJlc3VsdCA6IGNsdXN0ZXJwcm92aWRlcnMuTWFuYWdlZE5vZGVHcm91cCA9IHtcbiAgICAgICAgaWQ6IFwibW5nLXdpbmRvd3NcIixcbiAgICAgICAgYW1pVHlwZTogb3B0aW9ucy53aW5kb3dzQW1pVHlwZSxcbiAgICAgICAgaW5zdGFuY2VUeXBlczogW25ldyBlYzIuSW5zdGFuY2VUeXBlKGAke29wdGlvbnMuaW5zdGFuY2VDbGFzc30uJHtvcHRpb25zLmluc3RhbmNlU2l6ZX1gKV0sXG4gICAgICAgIGRlc2lyZWRTaXplOiBvcHRpb25zLmRlc2lyZWROb2RlU2l6ZSwgXG4gICAgICAgIG1pblNpemU6IG9wdGlvbnMubWluTm9kZVNpemUsIFxuICAgICAgICBtYXhTaXplOiBvcHRpb25zLm1heE5vZGVTaXplLFxuICAgICAgICBub2RlUm9sZTogb3B0aW9ucy5ub2RlUm9sZSxcbiAgICAgICAgbm9kZUdyb3VwU3VibmV0czogeyBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QUklWQVRFX1dJVEhfRUdSRVNTIH0sXG4gICAgICAgIGRpc2tTaXplOiBvcHRpb25zLmJsb2NrRGV2aWNlU2l6ZSxcbiAgICAgICAgdGFnczogb3B0aW9ucy53aW5kb3dzTm9kZUdyb3VwVGFnc1xuICAgIH07XG5cbiAgICBpZihvcHRpb25zLm5vU2NoZWR1bGVGb3JXaW5kb3dzTm9kZXMpIHtcbiAgICAgICAgdXRpbHMuc2V0UGF0aChyZXN1bHQsIFwidGFpbnRzXCIsIFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBrZXk6IFwib3NcIixcbiAgICAgICAgICAgICAgICB2YWx1ZTogXCJ3aW5kb3dzXCIsXG4gICAgICAgICAgICAgICAgZWZmZWN0OiBla3MuVGFpbnRFZmZlY3QuTk9fU0NIRURVTEVcbiAgICAgICAgICAgIH1cbiAgICAgICAgXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==